const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-o--Dc4yZ.js","assets/ui-core-BpsHYXg8.js","assets/react-CyQK0IK8.js","assets/media-player-Dfptv93o.js","assets/zustand-B8BJfZ-c.js","assets/motion-CEuZ4rxa.js","assets/tiptap-C4n5NkG5.js","assets/ui-form-Ch9CMzqg.js","assets/audio-BlpnjJKR.js","assets/pusher-BvD42uFZ.js","assets/hangul-CIZ_Rl7P.js","assets/three-BOJBN814.js","assets/index-C0Z1We6q.css"])))=>i.map(i=>d[i]);
import{_ as Vt}from"./media-player-Dfptv93o.js";import{j as l,r as g,z as qt,ao as $t,ap as Jt,aq as Zt,ar as Ht,as as Qt}from"./ui-core-BpsHYXg8.js";import{u as Xt,a as Ut,aa as te,ab as ee,ac as re,B as ne,ae,M as se,b as Lt,d as Bt,e as At,f as z,g as St,h as ce,i as ie,j as oe,S as le,l as ue,m as he,a4 as Gt,aP as pe,ba as de,bb as me,E as fe,O as ge,X as xe,Y as ye,Z as we,I as be,H as Ie,J as De,bc as Se,G as Ce,T as ve,U as Me,am as Tt,bd as ke}from"./index-o--Dc4yZ.js";import{m as Re}from"./motion-CEuZ4rxa.js";import{c as je}from"./zustand-B8BJfZ-c.js";import"./react-CyQK0IK8.js";import"./tiptap-C4n5NkG5.js";import"./ui-form-Ch9CMzqg.js";import"./audio-BlpnjJKR.js";import"./pusher-BvD42uFZ.js";import"./hangul-CIZ_Rl7P.js";import"./three-BOJBN814.js";const Fe={select:"apps.paint.toolbar.select","rect-select":"apps.paint.toolbar.rectangleSelect",hand:"apps.paint.toolbar.hand",text:"apps.paint.toolbar.text",bucket:"apps.paint.toolbar.fillColor",spray:"apps.paint.toolbar.spray",brush:"apps.paint.toolbar.brush",pencil:"apps.paint.toolbar.pencil",line:"apps.paint.toolbar.line",eraser:"apps.paint.toolbar.eraser",rectangle:"apps.paint.toolbar.rectangle",oval:"apps.paint.toolbar.oval"},Pe=[{id:"select",icon:"/icons/default/macpaint/lasso.png",labelKey:"select"},{id:"rect-select",icon:"/icons/default/macpaint/select.png",labelKey:"rect-select"},{id:"hand",icon:"/icons/default/macpaint/hand.png",labelKey:"hand"},{id:"text",icon:"/icons/default/macpaint/text.png",labelKey:"text"},{id:"bucket",icon:"/icons/default/macpaint/bucket.png",labelKey:"bucket"},{id:"spray",icon:"/icons/default/macpaint/spray.png",labelKey:"spray"},{id:"brush",icon:"/icons/default/macpaint/brush.png",labelKey:"brush"},{id:"pencil",icon:"/icons/default/macpaint/pencil.png",labelKey:"pencil"},{id:"line",icon:"/icons/default/macpaint/line.png",labelKey:"line"},{id:"eraser",icon:"/icons/default/macpaint/eraser.png",labelKey:"eraser"},{id:"rectangle",icon:"/icons/default/macpaint/rectangle.png",labelKey:"rectangle"},{id:"oval",icon:"/icons/default/macpaint/oval.png",labelKey:"oval"}],Ne=({selectedTool:t,onToolSelect:i})=>{const{t:u}=Xt(),a=Ut(m=>m.current)==="macosx";return l.jsx(te,{children:l.jsx("div",{className:"grid grid-cols-2 gap-0",children:Pe.map(m=>{const w=u(Fe[m.labelKey]);return l.jsxs(ee,{children:[l.jsx(re,{asChild:!0,children:l.jsx(ne,{variant:a?"outline":t===m.id?"secondary":"ghost",className:`p-1 border-1 transition-none ${t===m.id?"invert border-white":""}`,onClick:()=>i(m.id),children:l.jsx("img",{src:m.icon,alt:w,className:"w-[36px] h-[36px] object-contain mix-blend-multiply"})})}),l.jsx(ae,{side:"right",sideOffset:2,children:l.jsx("p",{children:w})})]},m.id)})})})},Ee=g.forwardRef(({selectedTool:t,selectedPattern:i,strokeWidth:u,onCanUndoChange:n,onCanRedoChange:a,onContentChange:m,canvasWidth:w=589,canvasHeight:x=418,isForeground:b=!1},k)=>{const f=g.useRef(null),e=g.useRef(null),N=g.useRef(!1),R=g.useRef([]),D=g.useRef(-1),v=g.useRef(null),C=g.useRef(null),I=g.useRef(null),[nt,F]=g.useState(!1),[at,pt]=g.useState(null),dt=g.useRef(null),[p,$]=g.useState(null),[rt,Z]=g.useState(!1),H=g.useRef(null),O=g.useRef(0),G=g.useRef(null),Q=g.useRef(null),[lt]=g.useState(!1),ut=g.useRef(null),K=g.useRef([]);g.useEffect(()=>{const r=f.current;if(!r)return;const s=new ResizeObserver(c=>{for(const o of c){const{width:d,height:y}=o.contentRect,M=document.createElement("canvas"),P=M.getContext("2d",{willReadFrequently:!0});P&&e.current&&(M.width=r.width,M.height=r.height,P.drawImage(r,0,0)),r.width=d,r.height=y;const E=r.getContext("2d",{willReadFrequently:!0});if(E){if(E.lineCap="round",E.lineJoin="round",E.lineWidth=u,e.current=E,v.current){const _=E.createPattern(v.current,"repeat");_&&(E.strokeStyle=_,E.fillStyle=_)}P&&E.drawImage(M,0,0,M.width,M.height,0,0,d,y)}}});return s.observe(r),()=>s.disconnect()},[u]);const st=g.useCallback(r=>{if(r.key==="Escape"&&p){I.current&&e.current&&e.current.putImageData(I.current,0,0),$(null);return}if((navigator.platform.toUpperCase().indexOf("MAC")>=0?r.metaKey:r.ctrlKey)&&!r.altKey){if(r.key.toLowerCase()==="z"){if(r.preventDefault(),r.shiftKey){if(D.current<R.current.length-1){D.current++;const o=R.current[D.current];e.current&&o&&(e.current.putImageData(o,0,0),n(!0),a(D.current<R.current.length-1))}}else if(D.current>0){D.current--;const o=R.current[D.current];e.current&&o&&(e.current.putImageData(o,0,0),n(D.current>0),a(!0))}}else if(r.key.toLowerCase()==="y"&&!r.shiftKey&&(r.preventDefault(),D.current<R.current.length-1)){D.current++;const o=R.current[D.current];e.current&&o&&(e.current.putImageData(o,0,0),n(!0),a(D.current<R.current.length-1))}}},[p,n,a]);g.useEffect(()=>{if(b)return window.addEventListener("keydown",st),()=>window.removeEventListener("keydown",st)},[b,st]),g.useEffect(()=>{if(!p){G.current!==null&&(cancelAnimationFrame(G.current),G.current=null),I.current&&e.current&&e.current.putImageData(I.current,0,0);return}const r=()=>{if(!(!e.current||!f.current||!p||!I.current)){if(e.current.putImageData(I.current,0,0),e.current.save(),e.current.strokeStyle="#000",e.current.lineWidth=1,e.current.setLineDash([5,5]),e.current.lineDashOffset=O.current,p.type==="rectangle")e.current.strokeRect(p.startX,p.startY,p.width,p.height);else if(p.type==="lasso"&&p.path&&p.path.length>0){e.current.beginPath(),e.current.moveTo(p.path[0].x,p.path[0].y);for(let s=1;s<p.path.length;s++)e.current.lineTo(p.path[s].x,p.path[s].y);e.current.closePath(),e.current.stroke()}e.current.restore(),O.current=(O.current+1)%10,G.current=requestAnimationFrame(r)}};return r(),()=>{G.current!==null&&(cancelAnimationFrame(G.current),G.current=null)}},[p]),g.useEffect(()=>{const r=f.current;if(!r)return;if(!e.current){r.width=w,r.height=x;const o=r.getContext("2d",{willReadFrequently:!0});if(!o)return;o.lineCap="round",o.lineJoin="round",o.lineWidth=u,e.current=o,o.fillStyle="#FFFFFF",o.fillRect(0,0,r.width,r.height),V()}const s=i.split("-")[1],c=new Image;c.crossOrigin="anonymous",c.onload=()=>{const o=document.createElement("canvas"),d=o.getContext("2d");if(!d||!e.current)return;o.width=c.width,o.height=c.height,d.drawImage(c,0,0),v.current=o;const y=e.current.createPattern(o,"repeat");y&&(e.current.strokeStyle=y,e.current.fillStyle=y)},c.onerror=o=>{console.error("Error loading pattern:",o)},c.src=`/patterns/Property 1=${s}.svg`},[i]),g.useEffect(()=>{e.current&&(e.current.lineWidth=u)},[u]);const ft=g.useCallback(r=>{if(!e.current)return;const s=u*2,c=s*2;for(let o=0;o<c;o++){const d=Math.random()*Math.PI*2,y=Math.random()*s,M=r.x+y*Math.cos(d),P=r.y+y*Math.sin(d);e.current.fillRect(M,P,1,1)}},[u]),V=g.useCallback(()=>{const r=f.current;if(!r||!e.current)return;let s;p&&I.current?s=I.current:s=e.current.getImageData(0,0,r.width,r.height),(D.current<0||!R.current[D.current]||!Ct(s,R.current[D.current]))&&(R.current=R.current.slice(0,D.current+1),R.current.push(s),D.current++,R.current.length>50&&(R.current=R.current.slice(-50),D.current=Math.min(D.current,49)),n(D.current>0),a(D.current<R.current.length-1),lt||m==null||m())},[n,a,m,lt,p]),Ct=g.useCallback((r,s)=>{if(r.width!==s.width||r.height!==s.height)return!1;const c=r.data,o=s.data,d=c.length,y=Math.min(1e3,d/4),M=Math.floor(d/(y*4));for(let P=0;P<d;P+=M)if(c[P]!==o[P])return!1;return!0},[]),Nt=g.useCallback(()=>{if(!e.current||!f.current||!p)return null;const{startX:r,startY:s,width:c,height:o,type:d,path:y}=p,M=Math.floor(r),P=Math.floor(s),E=Math.ceil(r+c),_=Math.ceil(s+o),Y=Math.max(1,E-M),q=Math.max(1,_-P),W=document.createElement("canvas");W.width=Y,W.height=q;const et=W.getContext("2d",{willReadFrequently:!0});if(!et)return null;if(d==="rectangle"){const h=e.current.getImageData(M,P,Y,q);et.putImageData(h,0,0)}else if(d==="lasso"&&y&&y.length>0){const h=e.current.getImageData(0,0,f.current.width,f.current.height),S=document.createElement("canvas");S.width=f.current.width,S.height=f.current.height;const j=S.getContext("2d");if(!j)return null;j.beginPath(),j.moveTo(y[0].x,y[0].y);for(let T=1;T<y.length;T++)j.lineTo(y[T].x,y[T].y);j.closePath(),j.fillStyle="white",j.fill();const A=j.getImageData(0,0,S.width,S.height),U=et.createImageData(Y,q);for(let T=0;T<q;T++)for(let L=0;L<Y;L++){const X=M+L,it=((P+T)*f.current.width+X)*4,J=(T*Y+L)*4;A.data[it+3]>0?(U.data[J]=h.data[it],U.data[J+1]=h.data[it+1],U.data[J+2]=h.data[it+2],U.data[J+3]=h.data[it+3]):(U.data[J]=0,U.data[J+1]=0,U.data[J+2]=0,U.data[J+3]=0)}et.putImageData(U,0,0)}return W},[p]),ct=g.useCallback(async()=>{if(!e.current||!f.current){console.error("Canvas not available for copy");return}I.current&&p&&e.current.putImageData(I.current,0,0);let r=null;if(p){if(r=Nt(),!r){console.error("Failed to extract selection region");return}}else{r=document.createElement("canvas"),r.width=f.current.width,r.height=f.current.height;const s=r.getContext("2d");if(!s){console.error("Failed to create temp canvas context");return}s.drawImage(f.current,0,0)}return new Promise((s,c)=>{if(!r){c(new Error("Failed to create temp canvas"));return}r.toBlob(o=>{if(!o){console.error("Failed to create blob from canvas"),c(new Error("Failed to create blob"));return}const d=new ClipboardItem({"image/png":o});navigator.clipboard.write([d]).then(()=>{console.log("Successfully copied to clipboard"),s()}).catch(y=>{console.error("Failed to write to clipboard:",y),c(y)})},"image/png")})},[p,Nt]),gt=g.useCallback(async()=>{if(!e.current||!f.current){console.error("Canvas not available for paste");return}try{I.current&&p&&e.current.putImageData(I.current,0,0);const r=await navigator.clipboard.read();for(const s of r)for(const c of s.types)if(c.startsWith("image/")){const o=await s.getType(c),d=new Image;d.src=URL.createObjectURL(o),await new Promise((y,M)=>{d.onload=()=>{if(!e.current||!f.current){M(new Error("Canvas not available"));return}if(p&&I.current&&e.current.putImageData(I.current,0,0),p){const P=p.width/d.width,E=p.height/d.height,_=Math.min(P,E),Y=d.width*_,q=d.height*_,W=(p.width-Y)/2,et=(p.height-q)/2;if(p.type==="lasso"&&p.path){e.current.save(),e.current.beginPath(),e.current.moveTo(p.path[0].x,p.path[0].y);for(let h=1;h<p.path.length;h++)e.current.lineTo(p.path[h].x,p.path[h].y);e.current.closePath(),e.current.clip(),e.current.drawImage(d,p.startX+W,p.startY+et,Y,q),e.current.restore()}else e.current.drawImage(d,p.startX+W,p.startY+et,Y,q)}else{const P=(f.current.width-d.width)/2,E=(f.current.height-d.height)/2;e.current.drawImage(d,P,E)}$(null),f.current&&e.current&&(I.current=e.current.getImageData(0,0,f.current.width,f.current.height)),V(),m&&m(),y()},d.onerror=()=>{M(new Error("Failed to load image from clipboard"))}}),URL.revokeObjectURL(d.src);break}}catch(r){console.error("Failed to read clipboard contents: ",r),r instanceof Error&&r.name==="NotAllowedError"&&console.error("Clipboard access denied. Please grant clipboard permissions.")}},[p,V,m]),xt=g.useCallback(()=>{if(!(!e.current||!f.current||!p)){if(I.current&&e.current.putImageData(I.current,0,0),e.current.save(),p.type==="lasso"&&p.path&&p.path.length>0){e.current.beginPath(),e.current.moveTo(p.path[0].x,p.path[0].y);for(let r=1;r<p.path.length;r++)e.current.lineTo(p.path[r].x,p.path[r].y);e.current.closePath(),e.current.fillStyle="#FFFFFF",e.current.fill()}else e.current.fillStyle="#FFFFFF",e.current.fillRect(p.startX,p.startY,p.width,p.height);e.current.restore(),f.current&&e.current&&(I.current=e.current.getImageData(0,0,f.current.width,f.current.height)),V(),m&&m(),$(null)}},[p,V,m]);g.useImperativeHandle(k,()=>({undo:()=>{if(D.current>0){D.current--;const r=R.current[D.current];e.current&&r&&(e.current.putImageData(r,0,0),n(D.current>0),a(!0))}},redo:()=>{if(D.current<R.current.length-1){D.current++;const r=R.current[D.current];e.current&&r&&(e.current.putImageData(r,0,0),n(!0),a(D.current<R.current.length-1))}},clear:()=>{!e.current||!f.current||(e.current.fillStyle="#FFFFFF",e.current.fillRect(0,0,f.current.width,f.current.height),V())},exportCanvas:()=>{const r=f.current;return r?new Promise((s,c)=>{if(p&&I.current&&e.current){const o=document.createElement("canvas");o.width=r.width,o.height=r.height;const d=o.getContext("2d");if(!d){c(new Error("Failed to create temp canvas"));return}d.putImageData(I.current,0,0),o.toBlob(y=>{y?s(y):c(new Error("Failed to create blob"))},"image/png");return}r.toBlob(o=>{o?s(o):c(new Error("Failed to create blob from canvas"))},"image/png")}):Promise.reject(new Error("Canvas not available"))},importImage:r=>{const s=new Image;s.src=r,s.onload=()=>{if(!e.current||!f.current)return;const c=f.current,o=e.current;o.fillStyle="#FFFFFF",o.fillRect(0,0,c.width,c.height),o.drawImage(s,0,0,c.width,c.height),V()}},cut:async()=>{if(p)try{await ct(),xt()}catch(r){console.error("Failed to cut selection:",r)}},copy:async()=>{try{await ct()}catch(r){console.error("Failed to copy selection:",r)}},paste:gt,applyFilter:r=>{f.current&&(V(),r.apply(f.current),m==null||m())}}),[n,a,V,ct,xt,gt,m]),g.useEffect(()=>{if(!b)return;const r=s=>{(navigator.platform.toUpperCase().indexOf("MAC")>=0?s.metaKey:s.ctrlKey)&&!s.shiftKey&&!s.altKey&&(s.key.toLowerCase()==="x"?(s.preventDefault(),ct(),xt()):s.key.toLowerCase()==="c"?(s.preventDefault(),ct()):s.key.toLowerCase()==="v"&&(s.preventDefault(),gt()))};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[b,ct,xt,gt]);const vt=r=>{var y;const s=f.current;if(!s)return{x:0,y:0};const c=s.getBoundingClientRect();let o,d;if("touches"in r)if(r.touches.length===0&&((y=r.changedTouches)==null?void 0:y.length)>0)o=r.changedTouches[0].clientX,d=r.changedTouches[0].clientY;else if(r.touches.length>0)o=r.touches[0].clientX,d=r.touches[0].clientY;else return C.current||{x:0,y:0};else o=r.clientX,d=r.clientY;return{x:o-c.left,y:d-c.top}},B=(r,s)=>s.type==="rectangle"?r.x>=s.startX&&r.x<=s.startX+s.width&&r.y>=s.startY&&r.y<=s.startY+s.height:s.type==="lasso"&&s.path?yt(r,s.path):!1,yt=g.useCallback((r,s)=>{if(s.length<3)return!1;let c=!1;for(let o=0,d=s.length-1;o<s.length;d=o++){const y=s[o].x,M=s[o].y,P=s[d].x,E=s[d].y;M>r.y!=E>r.y&&r.x<(P-y)*(r.y-M)/(E-M)+y&&(c=!c)}return c},[]),Mt=(r,s)=>{const c=f.current,o=e.current;if(!c||!o||!v.current)return;const d=o.getImageData(0,0,c.width,c.height),y=d.data,M=(s*c.width+r)*4,P=y[M],E=y[M+1],_=y[M+2],Y=y[M+3],q=document.createElement("canvas");q.width=c.width,q.height=c.height;const W=q.getContext("2d",{willReadFrequently:!0});if(!W)return;const et=W.createPattern(v.current,"repeat");if(!et)return;W.fillStyle=et,W.fillRect(0,0,c.width,c.height);const h=W.getImageData(0,0,c.width,c.height),S=(s*c.width+r)*4;if(y[S]===h.data[S]&&y[S+1]===h.data[S+1]&&y[S+2]===h.data[S+2]&&y[S+3]===h.data[S+3])return;const j=Math.floor(c.width*c.height*.8);let A=0;const U=X=>y[X]===P&&y[X+1]===E&&y[X+2]===_&&y[X+3]===Y,T=X=>{y[X]=h.data[X],y[X+1]=h.data[X+1],y[X+2]=h.data[X+2],y[X+3]=h.data[X+3],A++},L=[];for(L.push({y:s,leftX:r,rightX:r,direction:1}),L.push({y:s,leftX:r,rightX:r,direction:-1});L.length>0&&A<j;){const{y:X,leftX:bt,rightX:it,direction:J}=L.pop(),It=X+J;if(It<0||It>=c.height)continue;let Ft=bt,Dt=it;for(;Ft>0&&U((X*c.width+(Ft-1))*4);)Ft--;for(;Dt<c.width-1&&U((X*c.width+(Dt+1))*4);)Dt++;for(let ot=Ft;ot<=Dt;ot++)T((X*c.width+ot)*4);let Pt=!1;for(let ot=Ft;ot<=Dt;ot++){const zt=(It*c.width+ot)*4,Yt=U(zt);!Pt&&Yt?(L.push({y:It,leftX:ot,rightX:ot,direction:J}),Pt=!0):Pt&&!Yt&&(L[L.length-1].rightX=ot-1,Pt=!1)}Pt&&(L[L.length-1].rightX=Dt)}o.putImageData(d,0,0),V()},ht=r=>{if(!e.current||!v.current||!at)return;const s=e.current;s.save(),s.font="16px Geneva-12",s.textBaseline="top";const c=s.createPattern(v.current,"repeat");c&&(s.fillStyle=c,s.fillText(r,at.x,at.y)),s.restore(),V()},Et=r=>{if(r.key==="Enter"){const s=r.currentTarget.value;if(!s){F(!1);return}ht(s),r.currentTarget.value="",F(!1)}},tt=r=>{const s=r.currentTarget.value;s&&ht(s),F(!1)},kt=g.useCallback(r=>{const s=f.current;if(!s||!e.current)return;const c=vt(r);if(t!=="hand"){if("touches"in r&&(Q.current=c,t==="bucket")){Mt(Math.floor(c.x),Math.floor(c.y));return}if(t==="rect-select"){if(p&&!B(c,p)&&(I.current&&e.current.putImageData(I.current,0,0),$(null)),p&&B(c,p)){Z(!0),H.current=c;return}C.current=c,I.current=e.current.getImageData(0,0,s.width,s.height);return}if(t==="select"){if(p&&p.type==="lasso"&&p.path)if(!yt(c,p.path))I.current&&e.current.putImageData(I.current,0,0),$(null);else{Z(!0),H.current=c;return}K.current=[c],I.current=e.current.getImageData(0,0,s.width,s.height),N.current=!0;return}if(p&&(I.current&&e.current.putImageData(I.current,0,0),$(null)),t==="text"){nt||pt(c),F(!0),setTimeout(()=>{dt.current&&dt.current.focus()},0);return}if(t==="bucket"&&!("touches"in r)){Mt(Math.floor(c.x),Math.floor(c.y));return}if(["line","rectangle","oval"].includes(t))I.current=e.current.getImageData(0,0,s.width,s.height),C.current=c;else{if(t==="eraser")e.current.globalCompositeOperation="destination-out",e.current.strokeStyle="#FFFFFF";else if(e.current.globalCompositeOperation="source-over",v.current){const o=e.current.createPattern(v.current,"repeat");o&&(e.current.strokeStyle=o,e.current.fillStyle=o)}e.current.beginPath(),t!=="spray"?e.current.moveTo(c.x,c.y):ft(c)}N.current=!0}},[t,p,nt,Mt,B,yt,$,pt,F]),Ot=g.useCallback(r=>{if(!e.current||!f.current)return;const s=vt(r);if(t!=="hand"){if(rt&&p&&H.current){const c=s.x-H.current.x,o=s.y-H.current.y;$(d=>{if(!d)return null;if(d.type==="rectangle")return{...d,startX:d.startX+c,startY:d.startY+o};if(d.type==="lasso"&&d.path){const y=d.path.map(M=>({x:M.x+c,y:M.y+o}));return{...d,startX:d.startX+c,startY:d.startY+o,path:y}}return d}),H.current=s;return}if(t==="select"&&N.current&&I.current){if(K.current.push(s),e.current.putImageData(I.current,0,0),e.current.save(),e.current.strokeStyle="#000",e.current.lineWidth=1,e.current.setLineDash([5,5]),e.current.lineDashOffset=O.current,K.current.length>1){e.current.beginPath(),e.current.moveTo(K.current[0].x,K.current[0].y);for(let c=1;c<K.current.length;c++)e.current.lineTo(K.current[c].x,K.current[c].y);K.current.length>2&&e.current.lineTo(K.current[0].x,K.current[0].y),e.current.stroke()}e.current.restore();return}if(t==="rect-select"&&C.current&&I.current){e.current.putImageData(I.current,0,0);const c=s.x-C.current.x,o=s.y-C.current.y;e.current.save(),e.current.strokeStyle="#000",e.current.lineWidth=1,e.current.setLineDash([5,5]),e.current.strokeRect(C.current.x,C.current.y,c,o),e.current.restore();return}if(N.current)if(["line","rectangle","oval"].includes(t)&&C.current&&I.current){if(e.current.putImageData(I.current,0,0),e.current.globalCompositeOperation="source-over",v.current){const c=e.current.createPattern(v.current,"repeat");c&&(e.current.strokeStyle=c)}if(e.current.beginPath(),t==="line")e.current.moveTo(C.current.x,C.current.y),e.current.lineTo(s.x,s.y);else if(t==="rectangle"){const c=s.x-C.current.x,o=s.y-C.current.y;e.current.rect(C.current.x,C.current.y,c,o)}else if(t==="oval"){const c=(C.current.x+s.x)/2,o=(C.current.y+s.y)/2,d=Math.abs(s.x-C.current.x)/2,y=Math.abs(s.y-C.current.y)/2;e.current.ellipse(c,o,d,y,0,0,2*Math.PI)}e.current.stroke()}else["line","rectangle","oval"].includes(t)||(t==="spray"?ft(s):(e.current.lineTo(s.x,s.y),e.current.stroke()))}},[t,rt,p]),wt=g.useCallback(r=>{if(!f.current||!e.current||t==="hand")return;const c=vt(r);if(Q.current=null,t==="select"&&K.current.length>2){const o=[...K.current];let d=o[0].x,y=o[0].y,M=o[0].x,P=o[0].y;for(const Y of o)d=Math.min(d,Y.x),y=Math.min(y,Y.y),M=Math.max(M,Y.x),P=Math.max(P,Y.y);const E=M-d,_=P-y;if(E>0&&_>0){I.current&&e.current.putImageData(I.current,0,0);const Y=e.current.getImageData(d,y,E,_);$({type:"lasso",startX:d,startY:y,width:E,height:_,path:o,imageData:Y})}else I.current&&e.current.putImageData(I.current,0,0),$(null);K.current=[],N.current=!1}if(t==="rect-select"&&C.current){const o=c.x-C.current.x,d=c.y-C.current.y,y=Math.min(c.x,C.current.x),M=Math.min(c.y,C.current.y),P=Math.abs(o),E=Math.abs(d);if(P>0&&E>0){I.current&&e.current.putImageData(I.current,0,0);const _=e.current.getImageData(y,M,P,E);$({type:"rectangle",startX:y,startY:M,width:P,height:E,imageData:_})}else I.current&&e.current.putImageData(I.current,0,0),$(null)}if(rt&&(Z(!1),H.current=null),(N.current||rt||t==="bucket")&&V(),N.current=!1,C.current=null,e.current&&t==="eraser"&&(e.current.globalCompositeOperation="source-over",v.current)){const o=e.current.createPattern(v.current,"repeat");o&&(e.current.strokeStyle=o)}},[t,rt,$,Z,V]),Rt=g.useCallback(r=>{r.preventDefault(),kt(r)},[kt]),jt=g.useCallback(r=>{r.preventDefault(),Ot(r)},[Ot]),mt=g.useCallback(r=>{r.preventDefault(),wt(r)},[wt]);return g.useEffect(()=>{const r=f.current;if(!r)return;const s=d=>Rt(d),c=d=>jt(d),o=d=>mt(d);return r.addEventListener("touchstart",s,{passive:!1}),r.addEventListener("touchmove",c,{passive:!1}),r.addEventListener("touchend",o,{passive:!1}),()=>{r.removeEventListener("touchstart",s),r.removeEventListener("touchmove",c),r.removeEventListener("touchend",o)}},[Rt,jt,mt]),l.jsx("div",{ref:ut,className:"relative w-full h-full overflow-auto",style:{cursor:t==="hand"?"grab":t==="rect-select"?"crosshair":p?"move":"crosshair"},children:l.jsx(Re.div,{className:"bg-white",style:{minWidth:`${w}px`,minHeight:`${x}px`},drag:t==="hand",dragConstraints:ut,dragElastic:.2,dragMomentum:!0,dragTransition:{bounceStiffness:300,bounceDamping:20,min:0,max:100},children:l.jsxs("div",{className:"relative",style:{width:`${w}px`,height:`${x}px`},children:[l.jsx("canvas",{ref:f,style:{imageRendering:"pixelated",width:"100%",height:"100%",touchAction:"none",cursor:t==="hand"?"grab":"crosshair"},className:`${t==="rect-select"?"cursor-crosshair":p?"cursor-move":"cursor-crosshair"}`,onMouseDown:Rt,onMouseMove:jt,onMouseUp:mt,onMouseLeave:mt}),nt&&at&&l.jsx("input",{ref:dt,type:"text",className:"absolute bg-transparent border-none outline-none font-geneva-12 text-black pointer-events-auto",style:{left:`${at.x}px`,top:`${at.y}px`,fontSize:"16px",minWidth:"100px",padding:0,margin:0,transform:"translateZ(0)"},onKeyDown:Et,onBlur:tt})]})})})}),Oe=[{name:"Brightness +",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=i.getImageData(0,0,t.width,t.height),n=u.data;for(let a=0;a<n.length;a+=4)n[a]=Math.min(255,n[a]+30),n[a+1]=Math.min(255,n[a+1]+30),n[a+2]=Math.min(255,n[a+2]+30);i.putImageData(u,0,0)}},{name:"Brightness -",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=i.getImageData(0,0,t.width,t.height),n=u.data;for(let a=0;a<n.length;a+=4)n[a]=Math.max(0,n[a]-30),n[a+1]=Math.max(0,n[a+1]-30),n[a+2]=Math.max(0,n[a+2]-30);i.putImageData(u,0,0)}},{name:"Pixelate",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=8,n=document.createElement("canvas");n.width=t.width,n.height=t.height;const a=n.getContext("2d");if(a){a.drawImage(t,0,0),i.clearRect(0,0,t.width,t.height);for(let m=0;m<t.height;m+=u)for(let w=0;w<t.width;w+=u){const x=a.getImageData(w,m,1,1),b=x.data[0],k=x.data[1],f=x.data[2];i.fillStyle=`rgb(${b},${k},${f})`,i.fillRect(w,m,u,u)}}}},{name:"Edge Detect",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=i.getImageData(0,0,t.width,t.height),n=u.data,a=t.width,m=t.height,w=[-1,0,1,-2,0,2,-1,0,1],x=[-1,-2,-1,0,0,0,1,2,1],b=new Uint8ClampedArray(n);for(let k=1;k<m-1;k++)for(let f=1;f<a-1;f++){let e=0,N=0;for(let v=-1;v<=1;v++)for(let C=-1;C<=1;C++){const I=((k+v)*a+(f+C))*4,nt=(v+1)*3+(C+1),F=(b[I]+b[I+1]+b[I+2])/3;e+=F*w[nt],N+=F*x[nt]}const R=Math.min(255,Math.sqrt(e*e+N*N)),D=(k*a+f)*4;n[D]=R,n[D+1]=R,n[D+2]=R}i.putImageData(u,0,0)}},{name:"Noise",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=i.getImageData(0,0,t.width,t.height),n=u.data;for(let a=0;a<n.length;a+=4){const m=Math.random()*50-25;n[a]=Math.min(255,Math.max(0,n[a]+m)),n[a+1]=Math.min(255,Math.max(0,n[a+1]+m)),n[a+2]=Math.min(255,Math.max(0,n[a+2]+m))}i.putImageData(u,0,0)}},{name:"Old Photo",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=i.getImageData(0,0,t.width,t.height),n=u.data;for(let a=0;a<n.length;a+=4){const m=n[a],w=n[a+1],x=n[a+2];n[a]=Math.min(255,m*.393+w*.769+x*.189+40),n[a+1]=Math.min(255,m*.349+w*.686+x*.168+20),n[a+2]=Math.min(255,m*.272+w*.534+x*.131);const b=Math.random()*20-10;n[a]=Math.min(255,Math.max(0,n[a]+b)),n[a+1]=Math.min(255,Math.max(0,n[a+1]+b)),n[a+2]=Math.min(255,Math.max(0,n[a+2]+b))}i.putImageData(u,0,0)}},{name:"Blur",apply:t=>{const i=t.getContext("2d");if(!i)return;i.filter="blur(2px)";const u=document.createElement("canvas");u.width=t.width,u.height=t.height;const n=u.getContext("2d");n&&(n.drawImage(t,0,0),i.clearRect(0,0,t.width,t.height),i.drawImage(u,0,0),i.filter="none")}},{name:"Sharpen",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=document.createElement("canvas");if(u.width=t.width,u.height=t.height,!u.getContext("2d"))return;const m=i.getImageData(0,0,t.width,t.height).data,w=[0,-1,0,-1,5,-1,0,-1,0],x=new ImageData(t.width,t.height);for(let b=1;b<t.height-1;b++)for(let k=1;k<t.width-1;k++){const f=(b*t.width+k)*4;let e=0,N=0,R=0;for(let D=-1;D<=1;D++)for(let v=-1;v<=1;v++){const C=((b+D)*t.width+(k+v))*4,I=w[(D+1)*3+(v+1)];e+=m[C]*I,N+=m[C+1]*I,R+=m[C+2]*I}x.data[f]=Math.min(255,Math.max(0,e)),x.data[f+1]=Math.min(255,Math.max(0,N)),x.data[f+2]=Math.min(255,Math.max(0,R)),x.data[f+3]=m[f+3]}i.putImageData(x,0,0)}},{name:"Grayscale",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=i.getImageData(0,0,t.width,t.height),n=u.data;for(let a=0;a<n.length;a+=4){const m=(n[a]+n[a+1]+n[a+2])/3;n[a]=m,n[a+1]=m,n[a+2]=m}i.putImageData(u,0,0)}},{name:"Invert",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=i.getImageData(0,0,t.width,t.height),n=u.data;for(let a=0;a<n.length;a+=4)n[a]=255-n[a],n[a+1]=255-n[a+1],n[a+2]=255-n[a+2];i.putImageData(u,0,0)}},{name:"Sepia",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=i.getImageData(0,0,t.width,t.height),n=u.data;for(let a=0;a<n.length;a+=4){const m=n[a],w=n[a+1],x=n[a+2];n[a]=Math.min(255,m*.393+w*.769+x*.189),n[a+1]=Math.min(255,m*.349+w*.686+x*.168),n[a+2]=Math.min(255,m*.272+w*.534+x*.131)}i.putImageData(u,0,0)}},{name:"Gaussian Blur",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=i.getImageData(0,0,t.width,t.height),n=u.data,a=t.width,m=t.height,w=[1/16,2/16,1/16,2/16,4/16,2/16,1/16,2/16,1/16],x=new Uint8ClampedArray(n);for(let b=1;b<m-1;b++)for(let k=1;k<a-1;k++){let f=0,e=0,N=0;for(let D=-1;D<=1;D++)for(let v=-1;v<=1;v++){const C=((b+D)*a+(k+v))*4,I=w[(D+1)*3+(v+1)];f+=x[C]*I,e+=x[C+1]*I,N+=x[C+2]*I}const R=(b*a+k)*4;n[R]=f,n[R+1]=e,n[R+2]=N}i.putImageData(u,0,0)}},{name:"Motion Blur",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=45,n=15,a=u*Math.PI/180,m=Math.cos(a)*n,w=Math.sin(a)*n;i.filter="blur(1px)";const x=document.createElement("canvas");x.width=t.width,x.height=t.height;const b=x.getContext("2d");if(!b)return;const k=10;for(let f=0;f<k;f++){const e=m*f/k,N=w*f/k;b.globalAlpha=1/k,b.drawImage(t,e,N)}i.clearRect(0,0,t.width,t.height),i.filter="none",i.drawImage(x,0,0)}},{name:"Radial Blur",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=t.width/2,n=t.height/2,a=document.createElement("canvas");a.width=t.width,a.height=t.height;const m=a.getContext("2d");if(!m)return;m.drawImage(t,0,0),i.clearRect(0,0,t.width,t.height);const w=10;for(let x=0;x<w;x++){const b=1+x*.004;i.globalAlpha=1/w,i.save(),i.translate(u,n),i.scale(b,b),i.translate(-u,-n),i.drawImage(a,0,0),i.restore()}i.globalAlpha=1}},{name:"VHS",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=i.getImageData(0,0,t.width,t.height),n=u.data,a=2,m=new Uint8ClampedArray(n);for(let w=0;w<t.height;w++)for(let x=0;x<t.width;x++){const b=(w*t.width+x)*4,k=w%2===0?.9:1,f=x>a?m[b-a*4]:m[b],e=x<t.width-a?m[b+a*4+2]:m[b+2];n[b]=f*k,n[b+1]=m[b+1]*k,n[b+2]=e*k}i.putImageData(u,0,0)}},{name:"CRT",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=i.getImageData(0,0,t.width,t.height),n=u.data;for(let a=0;a<t.height;a++){const m=a%3;for(let w=0;w<t.width;w++){const x=(a*t.width+w)*4,b=m===0?1:.7,k=w%3;k===0?(n[x]*=b*1.1,n[x+1]*=b*.9,n[x+2]*=b*.9):k===1?(n[x]*=b*.9,n[x+1]*=b*1.1,n[x+2]*=b*.9):(n[x]*=b*.9,n[x+1]*=b*.9,n[x+2]*=b*1.1)}}i.putImageData(u,0,0)}},{name:"Glitch",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=i.getImageData(0,0,t.width,t.height),n=u.data,a=new Uint8ClampedArray(n),m=10;for(let w=0;w<m;w++){const x=Math.floor(Math.random()*t.height),b=Math.floor(Math.random()*20)+5,k=Math.floor(Math.random()*20)-10;for(let f=0;f<b&&x+f<t.height;f++){const e=x+f;for(let N=0;N<t.width;N++){const R=Math.max(0,Math.min(t.width-1,N+k)),D=(e*t.width+R)*4,v=(e*t.width+N)*4;n[v]=a[D+w%3*1],n[v+1]=a[D+(w+1)%3*1],n[v+2]=a[D+(w+2)%3*1]}}}i.putImageData(u,0,0)}},{name:"Dither",apply:t=>{const i=t.getContext("2d");if(!i)return;const u=i.getImageData(0,0,t.width,t.height),n=u.data;for(let w=0;w<n.length;w+=4){const x=(n[w]+n[w+1]+n[w+2])/3;n[w]=n[w+1]=n[w+2]=x}const a=[[0,8,2,10],[12,4,14,6],[3,11,1,9],[15,7,13,5]],m=4;for(let w=0;w<t.height;w++)for(let x=0;x<t.width;x++){const b=(w*t.width+x)*4,f=a[w%m][x%m]/16*255;n[b]=n[b+1]=n[b+2]=n[b]>f?255:0}i.putImageData(u,0,0)}}],Le={Color:["Brightness +","Brightness -","Grayscale","Invert","Sepia"],Artistic:["Pixelate","Edge Detect","Sharpen"],Blur:["Blur","Gaussian Blur","Motion Blur","Radial Blur"],Retro:["Noise","Old Photo","VHS","CRT","Glitch","Dither"]};function Be({isWindowOpen:t,onClose:i,onShowHelp:u,onShowAbout:n,canUndo:a,canRedo:m,onUndo:w,onRedo:x,onClear:b,onNewFile:k,onSave:f,onImportFile:e,onExportFile:N,currentFilePath:R,handleFileSelect:D,onCut:v,onCopy:C,onPaste:I,onApplyFilter:nt}){var G;const{t:F}=Xt(),[at,pt]=g.useState(!1),dt="paint",p=(G=he[dt])==null?void 0:G.name;if(!t)return null;const $=Ut(Q=>Q.current),rt=$==="xp"||$==="win98",Z=qt.useRef(null),H={Color:"apps.paint.menu.filterCategoryColor",Artistic:"apps.paint.menu.filterCategoryArtistic",Blur:"apps.paint.menu.filterCategoryBlur",Retro:"apps.paint.menu.filterCategoryRetro"},O={"Brightness +":"apps.paint.menu.filterBrightnessPlus","Brightness -":"apps.paint.menu.filterBrightnessMinus",Grayscale:"apps.paint.menu.filterGrayscale",Invert:"apps.paint.menu.filterInvert",Sepia:"apps.paint.menu.filterSepia",Pixelate:"apps.paint.menu.filterPixelate","Edge Detect":"apps.paint.menu.filterEdgeDetect",Sharpen:"apps.paint.menu.filterSharpen",Blur:"apps.paint.menu.filterBlur","Gaussian Blur":"apps.paint.menu.filterGaussianBlur","Motion Blur":"apps.paint.menu.filterMotionBlur","Radial Blur":"apps.paint.menu.filterRadialBlur",Noise:"apps.paint.menu.filterNoise","Old Photo":"apps.paint.menu.filterOldPhoto",VHS:"apps.paint.menu.filterVhs",CRT:"apps.paint.menu.filterCrt",Glitch:"apps.paint.menu.filterGlitch",Dither:"apps.paint.menu.filterDither"};return l.jsxs(se,{inWindowFrame:rt,children:[l.jsx("input",{type:"file",ref:Z,onChange:D,accept:".png,.jpg,.jpeg",className:"hidden"}),l.jsxs(Lt,{children:[l.jsx(Bt,{className:"text-md px-2 py-1 border-none focus-visible:ring-0",children:F("common.menu.file")}),l.jsxs(At,{align:"start",sideOffset:1,className:"px-0",children:[l.jsx(z,{onClick:k,className:"text-md h-6 px-3",children:F("apps.paint.menu.newFile")}),l.jsx(St,{className:"h-[2px] bg-black my-1"}),l.jsx(z,{onClick:e,className:"text-md h-6 px-3",children:F("apps.paint.menu.open")}),l.jsx(z,{onClick:f,className:"text-md h-6 px-3",children:F(R?"apps.paint.menu.save":"apps.paint.menu.saveEllipsis")}),l.jsx(St,{className:"h-[2px] bg-black my-1"}),l.jsx(z,{onClick:()=>{var Q;return(Q=Z.current)==null?void 0:Q.click()},className:"text-md h-6 px-3",children:F("apps.paint.menu.importFromDevice")}),l.jsx(z,{onClick:N,className:"text-md h-6 px-3",children:F("apps.paint.menu.export")}),l.jsx(St,{className:"h-[2px] bg-black my-1"}),l.jsx(z,{onClick:i,className:"text-md h-6 px-3",children:F("common.menu.close")})]})]}),l.jsxs(Lt,{children:[l.jsx(Bt,{className:"text-md px-2 py-1 border-none focus-visible:ring-0",children:F("common.menu.edit")}),l.jsxs(At,{align:"start",sideOffset:1,className:"px-0",children:[l.jsx(z,{onClick:w,disabled:!a,className:`text-md h-6 px-3 ${a?"":"text-gray-500"}`,children:F("common.menu.undo")}),l.jsx(z,{onClick:x,disabled:!m,className:`text-md h-6 px-3 ${m?"":"text-gray-500"}`,children:F("common.menu.redo")}),l.jsx(St,{className:"h-[2px] bg-black my-1"}),l.jsx(z,{onClick:v,className:"text-md h-6 px-3",children:F("common.menu.cut")}),l.jsx(z,{onClick:C,className:"text-md h-6 px-3",children:F("common.menu.copy")}),l.jsx(z,{onClick:I,className:"text-md h-6 px-3",children:F("common.menu.paste")}),l.jsx(St,{className:"h-[2px] bg-black my-1"}),l.jsx(z,{onClick:b,className:"text-md h-6 px-3",children:F("common.menu.clear")})]})]}),l.jsxs(Lt,{children:[l.jsx(Bt,{className:"text-md px-2 py-1 border-none focus-visible:ring-0",children:F("apps.paint.menu.filters")}),l.jsx(At,{align:"start",sideOffset:1,className:"px-0",children:Object.entries(Le).map(([Q,lt])=>l.jsxs(ce,{children:[l.jsx(ie,{className:"text-md h-6 px-3",children:F(H[Q]||Q)}),l.jsx(oe,{children:lt.map(ut=>{const K=Oe.find(st=>st.name===ut);return K?l.jsx(z,{onClick:()=>nt(K),className:"text-md h-6 px-3",children:F(O[ut]||ut)},ut):null})})]},Q))})]}),l.jsxs(Lt,{children:[l.jsx(Bt,{className:"text-md px-2 py-1 border-none focus-visible:ring-0",children:F("common.menu.help")}),l.jsxs(At,{align:"start",sideOffset:1,className:"px-0",children:[l.jsx(z,{onClick:u,className:"text-md h-6 px-3",children:F("apps.paint.menu.paintHelp")}),l.jsx(z,{onSelect:()=>pt(!0),className:"text-md h-6 px-3",children:F("common.menu.shareApp")}),l.jsx(St,{className:"h-[2px] bg-black my-1"}),l.jsx(z,{onClick:n,className:"text-md h-6 px-3",children:F("apps.paint.menu.aboutPaint")})]})]}),l.jsx(le,{isOpen:at,onClose:()=>pt(!1),itemType:"App",itemIdentifier:dt,title:p,generateShareUrl:ue})]})}const Wt=g.forwardRef(({className:t,children:i,...u},n)=>l.jsxs($t,{ref:n,className:Gt("relative overflow-hidden",t),...u,children:[l.jsx(Jt,{className:"h-full w-full rounded-[inherit]",children:i}),l.jsx(Kt,{}),l.jsx(Zt,{})]}));Wt.displayName=$t.displayName;const Kt=g.forwardRef(({className:t,orientation:i="vertical",...u},n)=>l.jsx(Ht,{ref:n,orientation:i,className:Gt("flex touch-none select-none transition-colors",i==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",i==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",t),...u,children:l.jsx(Qt,{className:"relative flex-1 rounded-full bg-border"})}));Kt.displayName=Ht.displayName;const Ae=({selectedPattern:t,onPatternSelect:i})=>{const u=Array.from({length:38},(n,a)=>a+1);return l.jsxs(Wt,{className:"w-full h-[72px]",children:[l.jsx("div",{className:"grid grid-flow-col auto-cols-[28px] grid-rows-2 gap-0 h-full",children:u.map(n=>l.jsx("button",{className:` hover:opacity-70 border-1 border-black ${t===`pattern-${n}`?"":"border-gray-800"}`,onClick:()=>i(`pattern-${n}`),children:l.jsx("img",{src:`/patterns/Property 1=${n}.svg`,alt:`Pattern ${n}`,className:"w-full h-full object-cover"})},n))}),l.jsx(Kt,{orientation:"horizontal"})]})},Te=({strokeWidth:t,onStrokeWidthChange:i})=>l.jsx("div",{className:"space-y-2 p-2 py-3 border-t border-gray-200",children:l.jsx(pe,{value:[t],onValueChange:u=>i(u[0]),min:1,max:20,step:1,className:"w-full"})}),_t=1,Xe="ryos:paint",Ue=je()(de(t=>({lastFilePath:null,setLastFilePath:i=>t({lastFilePath:i}),reset:()=>t({lastFilePath:null})}),{name:Xe,version:_t,storage:me(()=>localStorage),partialize:t=>({lastFilePath:t.lastFilePath}),migrate:(t,i)=>{if(!t||i<_t){const u=localStorage.getItem("paint:lastFilePath");if(u)return localStorage.removeItem("paint:lastFilePath"),{lastFilePath:u}}return t}})),Qe=({isWindowOpen:t,onClose:i,isForeground:u=!1,skipInitialSound:n,initialData:a,instanceId:m,onNavigateNext:w,onNavigatePrevious:x})=>{const{t:b}=Xt(),k=fe("paint",ke),[f,e]=g.useState("pencil"),[N,R]=g.useState("pattern-1"),[D,v]=g.useState(1),[C,I]=g.useState(!1),[nt,F]=g.useState(!1),[at,pt]=g.useState(!1),[dt,p]=g.useState(!1),[$,rt]=g.useState(!1),[Z,H]=g.useState(!1),{lastFilePath:O,setLastFilePath:G}=Ue(),[Q,lt]=g.useState(!1),[ut,K]=g.useState(""),[st,ft]=g.useState(!1),[V,Ct]=g.useState(589),[Nt,ct]=g.useState(418),[gt,xt]=g.useState(null),vt=h=>{h==="spray"&&D<10?v(10):h==="brush"&&D<4?v(4):h==="pencil"&&D>1&&v(1),e(h)},B=g.useRef(null),{saveFile:yt}=ge("/Images"),Mt=xe(),ht=g.useRef(null),Et=ye(h=>h.clearInitialData),tt=g.useRef(null),[kt,Ot]=g.useState(!1),wt=g.useCallback((h,S)=>{const j=new Image;j.onload=()=>{var T;let A=j.width,U=j.height;if(A>589){const L=589/A;A=589,U=Math.round(j.height*L)}Ct(A),ct(U),ft(!0),(T=B.current)==null||T.importImage(S),G(h),H(!1),ft(!1),xt(null),console.log("[Paint] Revoking Blob URL after successful load:",S),URL.revokeObjectURL(S),tt.current===S&&(tt.current=null)},j.onerror=A=>{console.error("Error loading image for import:",A,"URL:",S),xt("Failed to load image content."),console.log("[Paint] Revoking Blob URL after load error:",S),URL.revokeObjectURL(S),tt.current===S&&(tt.current=null)},j.src=S},[]);g.useEffect(()=>{if(a!=null&&a.path&&(a!=null&&a.content)&&B.current){const{path:h,content:S}=a;if(console.log("[Paint] Loading content from initialData:",h),S instanceof Blob){const j=URL.createObjectURL(S);console.log("[Paint] Created Blob URL from initialData:",j),tt.current&&URL.revokeObjectURL(tt.current),tt.current=j,wt(h,j)}else console.error("[Paint] Received initialData content is not a Blob:",S);Et("paint")}},[a,wt,Et]),g.useEffect(()=>{if(B.current&&Z&&O&&!st){const h=window.setTimeout(async()=>{if(B.current)try{const S=await B.current.exportCanvas(),j=O.split("/").pop()||"untitled.png";yt({name:j,path:O,content:S});const A=new CustomEvent("saveFile",{detail:{name:j,path:O,content:S}});window.dispatchEvent(A),H(!1)}catch(S){console.error("Error auto-saving file:",S)}},2e3);return()=>window.clearTimeout(h)}},[Z,O,st]);const Rt=()=>{var h;(h=B.current)==null||h.undo()},jt=()=>{var h;(h=B.current)==null||h.redo()},mt=()=>{var h;(h=B.current)==null||h.clear(),G(null),H(!1),Ct(589),ct(418)},r=()=>{if(Z){rt(!0);return}mt(),G(null),H(!1)},s=async()=>{if(B.current)if(O)try{const h=await B.current.exportCanvas(),S=O.split("/").pop()||"untitled.png";await yt({name:S,path:O,content:h,type:"png"}),H(!1),Tt.success("Image saved successfully")}catch(h){console.error("Error saving image:",h),Tt.error("Failed to save image")}else{const h=`${b("apps.paint.untitled")}.png`;lt(!0),K(h)}},c=async h=>{if(B.current)try{const S=await B.current.exportCanvas(),j=`/Images/${h}${h.endsWith(".png")?"":".png"}`;await yt({name:h,path:j,content:S,type:"png"});const A=new CustomEvent("saveFile",{detail:{name:h,path:j,content:S}});window.dispatchEvent(A),G(j),H(!1),lt(!1),Tt.success("Image saved successfully")}catch(S){console.error("Error saving file:",S),Tt.error("Failed to save image")}},o=()=>{Mt("finder",{initialPath:"/Images"})},d=async()=>{if(B.current)try{const h=await B.current.exportCanvas(),S=URL.createObjectURL(h),j=(O==null?void 0:O.split("/").pop())||"untitled.png",A=document.createElement("a");A.download=j,A.href=S,document.body.appendChild(A),A.click(),document.body.removeChild(A),setTimeout(()=>URL.revokeObjectURL(S),100)}catch(h){console.error("Error exporting file:",h)}},y=h=>{var j;const S=(j=h.target.files)==null?void 0:j[0];if(S){const A=new FileReader;A.onload=U=>{var X;const T=(X=U.target)==null?void 0:X.result,L=new Image;L.onload=()=>{var J;let bt=L.width,it=L.height;if(bt>589){const It=589/bt;bt=589,it=Math.round(L.height*It)}Ct(bt),ct(it),ft(!0),(J=B.current)==null||J.importImage(T),ft(!1),K(S.name),lt(!0)},L.src=T},A.readAsDataURL(S)}},M=()=>{var h;(h=B.current)==null||h.cut()},P=()=>{var h;(h=B.current)==null||h.copy()},E=()=>{var h;(h=B.current)==null||h.paste()},_=g.useCallback(()=>{ht.current&&clearTimeout(ht.current),ht.current=window.setTimeout(()=>{st||H(!0),ht.current=null},300)},[st]);g.useEffect(()=>()=>{ht.current&&window.clearTimeout(ht.current)},[]),g.useEffect(()=>()=>{tt.current&&(console.warn("[Paint] Revoking leftover Blob URL on unmount (should have been revoked earlier):",tt.current),URL.revokeObjectURL(tt.current),tt.current=null)},[]),g.useEffect(()=>{(async()=>{if(!(kt||!O||!B.current||!O.split("/").pop()))try{const{useFilesStore:j}=await Vt(async()=>{const{useFilesStore:T}=await import("./index-o--Dc4yZ.js").then(L=>L.bZ);return{useFilesStore:T}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12])),U=j.getState().getItem(O);if(U&&U.uuid){const T=await ve.get(Me.IMAGES,U.uuid);if(T&&T.content instanceof Blob){const L=URL.createObjectURL(T.content);console.log("[Paint] Loading persisted file",O),wt(O,L),Ot(!0)}}else console.warn("[Paint] File metadata or UUID not found for:",O)}catch(j){console.warn("[Paint] Could not load persisted file",j)}})()},[O,kt,wt]);const Y=g.useCallback(h=>{var S;(S=B.current)==null||S.applyFilter(h)},[]),q=Ut(h=>h.current),W=q==="xp"||q==="win98",et=l.jsx(Be,{isWindowOpen:t,isForeground:u,onClose:i,canUndo:C,canRedo:nt,onUndo:Rt,onRedo:jt,onClear:mt,onShowHelp:()=>pt(!0),onShowAbout:()=>p(!0),onNewFile:r,onSave:s,onImportFile:o,onExportFile:d,hasUnsavedChanges:Z,currentFilePath:O,handleFileSelect:y,onCut:M,onCopy:P,onPaste:E,onApplyFilter:Y});return t?l.jsxs(l.Fragment,{children:[!W&&u&&et,l.jsx(we,{title:O?O.split("/").pop()||"Untitled":`Untitled${Z?" â€¢":""}`,onClose:i,isForeground:u,appId:"paint",skipInitialSound:n,instanceId:m,onNavigateNext:w,onNavigatePrevious:x,menuBar:W?et:void 0,children:l.jsx("div",{className:"flex flex-col h-full w-full min-h-0 p-2",style:{backgroundImage:'url("/patterns/Property 1=7.svg")',backgroundRepeat:"repeat",backgroundColor:"#c0c0c0"},children:l.jsxs("div",{className:"flex flex-1 gap-2 w-full min-h-0 px-1",children:[l.jsxs("div",{className:"flex flex-col gap-2 w-[84px] shrink-0",children:[l.jsx("div",{className:"bg-white border border-black w-full shadow-[2px_2px_0px_0px_rgba(0,0,0,0.5)]",children:l.jsx(Ne,{selectedTool:f,onToolSelect:vt})}),l.jsx("div",{className:"bg-white border-2 border-black shadow-[2px_2px_0px_0px_rgba(0,0,0,0.5)]",children:l.jsx(Te,{strokeWidth:D,onStrokeWidthChange:v})})]}),l.jsxs("div",{className:"flex flex-col flex-1 gap-2 min-h-0 min-w-0",children:[l.jsxs("div",{className:"flex-1 bg-white min-h-0 min-w-0 border border-black border-2 shadow-[2px_2px_0px_0px_rgba(0,0,0,0.5)] overflow-auto relative",children:[gt&&l.jsxs("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-200 text-red-500 p-4",children:["Error: ",gt]}),l.jsx(Ee,{ref:h=>{h&&(B.current={undo:h.undo,redo:h.redo,clear:h.clear,exportCanvas:h.exportCanvas,importImage:h.importImage,cut:h.cut,copy:h.copy,paste:h.paste,applyFilter:h.applyFilter})},selectedTool:f,selectedPattern:N,strokeWidth:D,onCanUndoChange:I,onCanRedoChange:F,onContentChange:_,canvasWidth:V,canvasHeight:Nt,isForeground:u})]}),l.jsxs("div",{className:"h-[58px] bg-white border-black flex items-center border-2 shadow-[2px_2px_0px_0px_rgba(0,0,0,0.5)]",children:[l.jsx("div",{className:"border-r border-black h-full px-3 flex items-center",children:l.jsx("div",{className:"w-[36px] h-[32px] border border-black shrink-0",children:l.jsx("img",{src:`/patterns/Property 1=${N.split("-")[1]}.svg`,alt:"Selected Pattern",className:"w-full h-full object-cover"})})}),l.jsx("div",{className:"flex-1 h-full min-w-0 translate-y-[-1px]",children:l.jsx(Ae,{selectedPattern:N,onPatternSelect:R})})]})]})]})})}),l.jsx(be,{isOpen:Q,onOpenChange:lt,onSubmit:c,title:"Save Image",description:"Enter a name for your image",value:ut,onChange:K}),l.jsx(Ie,{isOpen:at,onOpenChange:pt,helpItems:k,appId:"paint"}),l.jsx(De,{isOpen:dt,onOpenChange:p,metadata:Se,appId:"paint"}),l.jsx(Ce,{isOpen:$,onOpenChange:rt,onConfirm:()=>{mt(),G(null),H(!1),rt(!1)},title:"Discard Changes",description:"You have unsaved changes. Create new file anyway?"})]}):null};export{Qe as PaintAppComponent};
