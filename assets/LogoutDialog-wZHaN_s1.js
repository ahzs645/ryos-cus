import{c as D,Y as h,b1 as j,u as M,G as q}from"./index-CqMK2L8S.js";import{r as c,j as R}from"./ui-core-D0pDhx0h.js";import{c as s,s as F,C as N,a as _,n as $,F as z,T as O,R as U,P as Y,S as G}from"./audio-DxkJfdUY.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=[["path",{d:"M9 18V5l12-2v13",key:"1jmyc2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["circle",{cx:"18",cy:"16",r:"3",key:"1hluhg"}]],W=D("Music",H);let g=null,v="classic";const V=-12,A={classic:{name:"Classic",oscillator:{type:"triangle"},envelope:{attack:.01,decay:.2,sustain:.2,release:.3},effects:{filter:{frequency:2e3,rolloff:-12},tremolo:{frequency:.8,depth:.3},reverb:{decay:1.5,wet:.7}}},ethereal:{name:"Ethereal",oscillator:{type:"sine"},envelope:{attack:.1,decay:.4,sustain:.4,release:.8},effects:{filter:{frequency:3e3,rolloff:-24},tremolo:{frequency:.5,depth:.5},reverb:{decay:2.5,wet:.8}}},digital:{name:"Digital",oscillator:{type:"square"},envelope:{attack:.005,decay:.1,sustain:.1,release:.1},effects:{filter:{frequency:4e3,rolloff:-12},tremolo:{frequency:1.2,depth:.2},reverb:{decay:.8,wet:.3}}},retro:{name:"Retro",oscillator:{type:"sawtooth"},envelope:{attack:.02,decay:.3,sustain:.3,release:.4},effects:{filter:{frequency:1500,rolloff:-24},tremolo:{frequency:.6,depth:.4},reverb:{decay:1.2,wet:.5}}},off:{name:"Off",oscillator:{type:"sine"},envelope:{attack:.001,decay:.001,sustain:0,release:.001},effects:{filter:{frequency:100,rolloff:-12},tremolo:{frequency:0,depth:0},reverb:{decay:0,wet:0}}}},T=["C4","D4","F4","G4","A4","C5","D5"],P=.09,E=16;function p(o){const r=A[o];r||(console.error(`Preset ${o} not found. Defaulting to classic.`),o="classic");const l=new z({frequency:r.effects.filter.frequency,type:"lowpass",rolloff:r.effects.filter.rolloff}).toDestination(),f=new O({frequency:r.effects.tremolo.frequency,depth:r.effects.tremolo.depth}).connect(l).start(),n=new U({decay:r.effects.reverb.decay,wet:r.effects.reverb.wet}).connect(f),a=h.getState().chatSynthVolume??1,e=h.getState().masterVolume??1,m=a*e,d=o==="off"||m===0?-1/0:V+20*Math.log10(m),y=new Y(G,{oscillator:r.oscillator,envelope:r.envelope,volume:d});return y.maxPolyphony=E,y.connect(n),{synth:y,filter:l,tremolo:f,reverb:n}}function X(){const[o,r]=c.useState(!1),{synthPreset:l,setSynthPreset:f}=h(),[n,a]=c.useState(()=>l||"classic"),e=c.useRef(null),m=c.useRef(0),d=c.useRef(!1),y=j(50,30),u=c.useCallback(async()=>{if(s.state==="closed")try{F(new N),g=null,e.current=null,r(!1),console.debug("AudioContext was closed â€“ recreated new Tone context")}catch(t){console.error("Failed to reset Tone context:",t)}if(g&&!e.current){console.log("Reusing existing synth instance..."),e.current=g,e.current.filter.toDestination(),r(!0);return}if(o&&s.state!=="running"&&r(!1),d.current||o&&s.state==="running"){s.state==="running"&&!o&&r(!0),s.state==="running"&&!e.current&&n!=="off"&&(console.log("Audio context running, recreating synth..."),e.current=p(n),r(!0));return}d.current=!0;try{console.log("Attempting to start Tone.js..."),await _(),console.log("Tone.js started successfully. State:",s.state),s.state==="running"?(!e.current&&n!=="off"&&(e.current=p(n)),r(!0),console.log("Audio ready, synth created.")):(console.warn("Tone.js context did not start or is suspended."),s.state==="suspended"&&(await s.resume(),s.state==="running"?(!e.current&&n!=="off"&&(e.current=p(n)),r(!0),console.log("Audio resumed and ready.")):console.error("Failed to resume Tone.js context.")))}catch(t){console.error("Error initializing Tone.js:",t),r(!1)}finally{d.current=!1}},[o,n]);c.useEffect(()=>{(s.state==="running"||s.state==="suspended")&&u();const t=()=>{u(),window.removeEventListener("click",t),window.removeEventListener("keydown",t)};return o||(window.addEventListener("click",t,{once:!0}),window.addEventListener("keydown",t,{once:!0})),()=>{window.removeEventListener("click",t),window.removeEventListener("keydown",t)}},[u,o]),c.useEffect(()=>{const t=()=>{document.visibilityState==="visible"&&s.state!=="running"&&u()},i=()=>{s.state!=="running"&&u()};return document.addEventListener("visibilitychange",t),window.addEventListener("focus",i),()=>{document.removeEventListener("visibilitychange",t),window.removeEventListener("focus",i)}},[u]),c.useEffect(()=>{e.current&&v!==n&&(console.log(`Applying preset change from ${v} to ${n}`),v=n)},[n]),c.useEffect(()=>()=>{e.current&&(console.log("Storing synth for reuse on unmount..."),g=e.current)},[]);const w=c.useCallback(t=>{if(!A[t]){console.error(`Invalid preset key: ${t}`);return}if(t===n){if(t==="off"&&e.current&&e.current.synth.volume.value!==-1/0)try{e.current.synth.volume.value=-1/0,console.log("Forcing 'Off' preset volume to -Infinity")}catch(i){console.error("Error setting volume to -Infinity:",i)}return}if(console.log("Changing preset to",t),e.current){try{e.current.synth.releaseAll(),e.current.filter&&(e.current.filter.disconnect(),e.current.filter.dispose()),e.current.tremolo&&e.current.tremolo.dispose(),e.current.reverb&&e.current.reverb.dispose(),e.current.synth&&e.current.synth.dispose()}catch(i){console.error("Error disposing synth components:",i)}e.current=null}if(o)try{e.current=p(t)}catch(i){console.error("Error creating new synth instance:",i),e.current=null}else t==="off"&&(e.current=null);g=e.current,v=t,a(t),f(t)},[n,o,f]);c.useEffect(()=>{l&&l!==n&&w(l)},[l,n,w]);const C=c.useCallback(()=>{var x;if(!o||!e.current||s.state!=="running"||n==="off"){s.state!=="running"&&!d.current&&n!=="off"&&(console.warn("Audio context not running. Attempting to initialize..."),u());return}const{synth:t}=e.current;if(n==="off"||t.volume.value===-1/0)return;if((((x=t._voices)==null?void 0:x.length)||0)>=E){console.debug(`Skipping note: Voice limit (${E}) reached.`);return}const b=$();if(b-m.current>=P){const I=T[Math.floor(Math.random()*T.length)];try{t.triggerAttackRelease(I,"32n",b),y(),m.current=b}catch(L){console.debug("Skipping note due to timing or error:",L)}}},[o,y,u]),k=h(t=>t.chatSynthVolume),S=h(t=>t.masterVolume);return c.useEffect(()=>{if(e.current){const t=k*S,i=t===0?-1/0:V+20*Math.log10(t);e.current.synth.volume.value=i}},[k,S]),{playNote:C,currentPreset:n,changePreset:w,isAudioReady:o}}function Z({isOpen:o,onOpenChange:r,onConfirm:l,hasPassword:f,onSetPassword:n}){const{t:a}=M();return f===!1?R.jsx(q,{isOpen:o,onOpenChange:r,onConfirm:()=>{r(!1),n==null||n()},title:a("common.auth.setPasswordRequired"),description:a("common.auth.setPasswordRequiredDescription")}):R.jsx(q,{isOpen:o,onOpenChange:r,onConfirm:l,title:a("common.auth.logOut"),description:a("common.auth.logOutDescription")})}export{Z as L,W as M,A as S,X as u};
