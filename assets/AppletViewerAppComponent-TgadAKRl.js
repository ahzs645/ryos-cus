import{r as i,z as Pt,j as e}from"./ui-core-D0pDhx0h.js";import{c as At,u as at,a as st,X as jt,Y as Ee,aC as He,M as Ot,b as Ze,d as Qe,e as et,f as ne,g as tt,h as $t,i as zt,j as Yt,k as Vt,S as St,l as _t,m as qt,bU as nt,a0 as ge,B as Le,am as b,ao as Gt,af as Xt,aq as Wt,E as Jt,bK as dt,T as ut,U as ht,ai as Kt,bV as Zt,bW as Qt,O as ea,Z as ta,H as aa,J as sa,bX as na,bY as ra,bZ as oa,b_ as ia,b$ as la}from"./index-BxS3VOwZ.js";import{L as ca}from"./LoginDialog-C5RW6JD2.js";import{A as Xe,a as Ge}from"./appletAuthBridge-gdg5QSWM.js";import{A as pa,m as da}from"./motion-DC7C-474.js";import{C as ua}from"./chevron-left-CfkfifUm.js";import{T as ha}from"./trash-2-BDO1oP8N.js";import{u as fa}from"./useAuth-_DNnPYJD.js";import"./react-CyQK0IK8.js";import"./media-player-Dfptv93o.js";import"./zustand-CwjPl1Tm.js";import"./tiptap-CPHiBm_b.js";import"./ui-form-Bg85K0S3.js";import"./audio-DxkJfdUY.js";import"./pusher-BvD42uFZ.js";import"./hangul-CIZ_Rl7P.js";import"./three-BOJBN814.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ma=[["path",{d:"M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z",key:"4pj2yx"}],["path",{d:"M20 3v4",key:"1olli1"}],["path",{d:"M22 5h-4",key:"1gvqau"}],["path",{d:"M4 17v2",key:"vumght"}],["path",{d:"M5 18H3",key:"zchphs"}]],ga=At("Sparkles",ma);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xa=[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]],wa=At("Star",xa);function ya({onClose:re,onShowHelp:V,onShowAbout:k,onExportAsApp:d,onExportAsHtml:w,onShareApplet:E,hasAppletContent:xe,handleFileSelect:we,instanceId:oe,onSetUsername:f,onVerifyToken:Y,onLogout:_,updateCount:X=0,onCheckForUpdates:K,onUpdateAll:de}){var W;const{t:C}=at(),[ye,pe]=i.useState(!1),ee="applet-viewer",Se=(W=qt[ee])==null?void 0:W.name,Z=st(I=>I.current),Q=Z==="xp"||Z==="win98",le=jt(),ce=Pt.useRef(null),P=Ee(I=>I.bringInstanceToForeground),ue=Ee(I=>I.instances),U=He(I=>I.username),se=He(I=>I.authToken),A=!!(U&&se),ie=Object.values(ue).filter(I=>I.appId==="applet-viewer"&&I.isOpen);return e.jsxs(Ot,{inWindowFrame:Q,children:[e.jsx("input",{type:"file",ref:ce,onChange:we,accept:".html,.htm,.app,.gz",className:"hidden"}),e.jsxs(Ze,{children:[e.jsx(Qe,{className:"text-md px-2 py-1 border-none focus-visible:ring-0",children:C("common.menu.file")}),e.jsxs(et,{align:"start",sideOffset:1,className:"px-0",children:[e.jsx(ne,{onClick:()=>le("finder",{initialPath:"/Applets"}),className:"text-md h-6 px-3",children:C("apps.applet-viewer.menu.open")}),xe&&A&&e.jsx(ne,{onClick:E,className:"text-md h-6 px-3",children:C("apps.applet-viewer.menu.shareApplet")}),e.jsx(tt,{className:"h-[2px] bg-black my-1"}),e.jsx(ne,{onClick:()=>{var I;return(I=ce.current)==null?void 0:I.click()},className:"text-md h-6 px-3",children:C("apps.applet-viewer.menu.importFromDevice")}),xe&&e.jsxs($t,{children:[e.jsx(zt,{className:"text-md h-6 px-3",children:C("apps.applet-viewer.menu.exportAs")}),e.jsxs(Yt,{children:[e.jsx(ne,{onClick:d,className:"text-md h-6 px-3",children:C("apps.applet-viewer.menu.ryosApp")}),e.jsx(ne,{onClick:w,className:"text-md h-6 px-3",children:C("apps.applet-viewer.menu.html")})]})]}),e.jsx(tt,{className:"h-[2px] bg-black my-1"}),e.jsx(ne,{onClick:re,className:"text-md h-6 px-3",children:C("common.menu.close")})]})]}),e.jsxs(Ze,{children:[e.jsx(Qe,{className:"text-md px-2 py-1 border-none focus-visible:ring-0",children:C("apps.applet-viewer.menu.store")}),e.jsxs(et,{align:"start",sideOffset:1,className:"px-0",children:[e.jsx(ne,{onClick:()=>le("applet-viewer",{initialData:{path:"",content:""}}),className:"text-md h-6 px-3",children:C("apps.applet-viewer.menu.openAppletStore")}),e.jsx(ne,{onClick:async()=>{X>0&&de?await de():K&&await K()},className:"text-md h-6 px-3",children:X>0?X===1?C("apps.applet-viewer.menu.updateApplets",{count:X}):C("apps.applet-viewer.menu.updateAppletsPlural",{count:X}):C("apps.applet-viewer.menu.checkForUpdates")}),e.jsx(tt,{className:"h-[2px] bg-black my-1"}),U&&se?e.jsx(ne,{onClick:()=>_==null?void 0:_(),className:"text-md h-6 px-3",children:C("apps.applet-viewer.menu.logOut")}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{onClick:f,className:"text-md h-6 px-3",children:C("apps.applet-viewer.menu.createAccount")}),e.jsx(ne,{onClick:Y,className:"text-md h-6 px-3",children:C("apps.applet-viewer.menu.login")})]})]})]}),e.jsxs(Ze,{children:[e.jsx(Qe,{className:"px-2 py-1 text-md focus-visible:ring-0",children:C("apps.applet-viewer.menu.window")}),e.jsx(et,{align:"start",sideOffset:1,className:"px-0",children:ie.length>0?ie.map(I=>{var ve;const ke=I.initialData,Ce=(ke==null?void 0:ke.path)||"",te=Ce?((ve=Ce.split("/").pop())==null?void 0:ve.replace(/\.(html|app)$/i,""))||C("apps.applet-viewer.menu.untitled"):C("apps.applet-viewer.menu.appletStore"),Fe=I.instanceId===oe;return e.jsx(Vt,{checked:Fe,onCheckedChange:be=>{be&&P(I.instanceId)},className:"text-md h-6 px-3",children:te},I.instanceId)}):e.jsx(ne,{disabled:!0,className:"text-md h-6 px-3 opacity-50",children:C("apps.applet-viewer.menu.noAppletsOpen")})})]}),e.jsxs(Ze,{children:[e.jsx(Qe,{className:"px-2 py-1 text-md focus-visible:ring-0",children:C("common.menu.help")}),e.jsxs(et,{align:"start",sideOffset:1,className:"px-0",children:[e.jsx(ne,{onClick:V,className:"text-md h-6 px-3",children:C("apps.applet-viewer.menu.appletsHelp")}),e.jsx(ne,{onSelect:()=>pe(!0),className:"text-md h-6 px-3",children:C("common.menu.shareApp")}),e.jsx(tt,{className:"h-[2px] bg-black my-1"}),e.jsx(ne,{onClick:k,className:"text-md h-6 px-3",children:C("apps.applet-viewer.menu.aboutApplets")})]})]}),e.jsx(St,{isOpen:ye,onClose:()=>pe(!1),itemType:"App",itemIdentifier:ee,title:Se,generateShareUrl:_t})]})}const va=i.forwardRef(({theme:re,focusWindow:V,onAppletSelect:k},d)=>{const{t:w}=at(),[E,xe]=i.useState([]),[we,oe]=i.useState(!0),[f,Y]=i.useState(0),[_,X]=i.useState("none"),[K,de]=i.useState(new Map),[C,ye]=i.useState(new Set),pe=i.useRef(null),ee=i.useRef(new Set),Se=i.useRef(new Set),Z=i.useRef(f),Q=i.useRef(E.length),le=i.useRef(!1),ce=i.useRef(Math.floor(Math.random()*1e6)),P=st(n=>n.current),{username:ue,authToken:U}=He(),se=4,A=-80,ie=.05,W=-28,I=re==="macosx"||P==="macosx",ke=re==="system7"||P==="system7",Ce=P==="xp"||P==="win98",te=nt(),Fe=`
    .applet-icon {
      font-size: 2.25rem !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
  `,ve=n=>{if(!n)return n;const u=`${Ge}<link rel="stylesheet" href="/fonts/fonts.css">${I?`<style data-ryos-applet-font-fix>
      html,body{font-family:"LucidaGrande","Lucida Grande",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Noto Color Emoji",sans-serif!important}
      *{font-family:inherit!important}
      h1,h2,h3,h4,h5,h6,p,div,span,a,li,ul,ol,button,input,select,textarea,label,code,pre,blockquote,small,strong,em,table,th,td{font-family:"LucidaGrande","Lucida Grande",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Noto Color Emoji",sans-serif!important}
    </style>`:""}`,x=n.toLowerCase().lastIndexOf("</head>");if(x!==-1)return n.slice(0,x)+u+n.slice(x);const N=n.toLowerCase().indexOf("<body");if(N!==-1){const v=n.indexOf(">",N)+1;return n.slice(0,v)+u+n.slice(v)}return u+n},be=i.useCallback(n=>{if(n)try{n.postMessage({type:Xe,action:"response",payload:{username:ue??null,authToken:U??null}},"*")}catch(l){console.warn("[AppStoreFeed] Failed to post auth payload:",l)}},[ue,U]);i.useEffect(()=>{const n=l=>{var v;const p=l==null?void 0:l.data;if(!p||p.type!==Xe||p.action!=="request")return;const u=l.source;if(!u)return;const x=(v=pe.current)==null?void 0:v.querySelectorAll("iframe"),N=[];x==null||x.forEach(L=>{L.contentWindow&&N.push(L.contentWindow)}),N.includes(u)&&be(u)};return window.addEventListener("message",n),()=>{window.removeEventListener("message",n)}},[be]),i.useEffect(()=>{var l;const n=(l=pe.current)==null?void 0:l.querySelectorAll("iframe");n==null||n.forEach(p=>{be(p.contentWindow||void 0)})},[ue,U,be,K]);const Ue=i.useCallback(async()=>{if(typeof navigator<"u"&&"onLine"in navigator&&!navigator.onLine){oe(!1);return}const n=p=>{let u=p;return()=>(u=(u*9301+49297)%233280,u/233280)},l=(p,u)=>{if(p.length===0)return p;const x=(ce.current+u)%1e6,N=n(x),v=[...p];for(let L=v.length-1;L>0;L--){const M=Math.floor(N()*(L+1));[v[L],v[M]]=[v[M],v[L]]}return v};try{const p=await fetch(ge("/api/share-applet?list=true"));if(p.ok){const x=(await p.json()).applets||[],N=[],v=[],L=[],M=[];x.forEach(D=>{const S=te.isAppletInstalled(D.id),H=te.needsUpdate(D);D.featured===!0?N.push(D):H&&S?v.push(D):S?M.push(D):L.push(D)});const R=[...l(N,1),...l(v,2),...l(L,3),...l(M,4)];xe(R)}}catch(p){console.error("Error fetching applets:",p)}finally{oe(!1)}},[te]);i.useEffect(()=>{le.current||(le.current=!0,Ue())},[Ue]),i.useEffect(()=>{const n=async l=>{if(!(Se.current.has(l)||ee.current.has(l))){ee.current.add(l),ye(p=>new Set(p).add(l));try{const p=await fetch(ge(`/api/share-applet?id=${encodeURIComponent(l)}`));if(p.ok){const u=await p.json();Se.current.add(l),de(x=>{const N=new Map(x);return N.set(l,u.content||""),N})}}catch(p){console.error(`Error fetching applet content for ${l}:`,p)}finally{ee.current.delete(l),ye(p=>{const u=new Set(p);return u.delete(l),u})}}};E.length>0&&E[f]&&n(E[f].id)},[f,E.length]),i.useEffect(()=>{const n=pe.current;if(!n)return;const l=p=>{const u=n.getBoundingClientRect();p.clientY-u.top<60&&Math.abs(p.deltaY)>30&&(p.preventDefault(),p.deltaY>0&&f<E.length-1?T(f+1):p.deltaY<0&&f>0&&T(f-1))};return n.addEventListener("wheel",l,{passive:!1}),()=>{n.removeEventListener("wheel",l)}},[f,E.length]),i.useEffect(()=>{const n=l=>{l.key==="ArrowDown"||l.key==="PageDown"?(l.preventDefault(),f<E.length-1&&T(f+1)):(l.key==="ArrowUp"||l.key==="PageUp")&&(l.preventDefault(),f>0&&T(f-1))};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[f,E.length]);const T=n=>{if(n>=0&&n<Q.current){const l=Z.current;Y(n),Z.current=n,n>l?X("forward"):n<l?X("backward"):X("none")}};i.useEffect(()=>{Z.current=f},[f]),i.useEffect(()=>{Q.current=E.length},[E.length]),i.useImperativeHandle(d,()=>({goToNext:()=>{Z.current<Q.current-1&&T(Z.current+1)},goToPrevious:()=>{Z.current>0&&T(Z.current-1)}}),[]);const Me=async n=>{V==null||V(),await te.handleInstall(n,()=>{le.current=!1,Ue()})},Re=async n=>{V==null||V();const l=await te.handleAppletClick(n);l&&k&&k(l)},Be=async n=>{V==null||V(),te.isAppletInstalled(n.id)&&await Re(n)};if(we)return e.jsx("div",{className:"h-full w-full flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-sm text-gray-600 font-geneva-12 shimmer-gray",children:w("apps.applet-viewer.dialogs.loading")})})});if(E.length===0)return e.jsx("div",{className:"h-full w-full flex items-center justify-center",children:e.jsx("div",{className:"text-center px-6 font-geneva-12",children:e.jsx("p",{className:"text-[11px] text-gray-600 font-geneva-12",children:w("apps.applet-viewer.dialogs.noAppletsAvailable")})})});const Pe=(n,l)=>{const p=n.title||n.name||w("apps.applet-viewer.dialogs.untitledApplet"),u=n.icon||"ðŸ“±",x=te.isAppletInstalled(n.id),N=te.needsUpdate(n),v=K.get(n.id),L=C.has(n.id);return e.jsxs("div",{"data-applet-index":l,"data-applet-card":!0,className:"h-full w-full relative",style:{minHeight:"100%"},children:[e.jsx("div",{className:"absolute inset-0",style:{paddingTop:"54px"},onClick:()=>{l===f&&Be(n)},onWheel:M=>{if(l!==f)return;const R=M.currentTarget.querySelector("iframe");R&&setTimeout(()=>{var D;try{const S=R.contentDocument||((D=R.contentWindow)==null?void 0:D.document);if(!S)return;const H=S.documentElement.scrollTop||S.body.scrollTop||0,m=S.documentElement.scrollHeight||S.body.scrollHeight||0,ae=S.documentElement.clientHeight||S.body.clientHeight||0,he=H<=5,O=H+ae>=m-5,$=m>ae;M.deltaY<0&&he&&f>0&&$?T(f-1):M.deltaY>0&&O&&f<E.length-1&&$?T(f+1):!$&&Math.abs(M.deltaY)>30&&(M.deltaY>0&&f<E.length-1?T(f+1):M.deltaY<0&&f>0&&T(f-1))}catch{Math.abs(M.deltaY)>30&&(M.deltaY>0&&f<E.length-1?T(f+1):M.deltaY<0&&f>0&&T(f-1))}},100)},children:v?e.jsx("iframe",{srcDoc:ve(v),title:p,className:"w-full h-full border-0",sandbox:"allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-top-navigation allow-modals allow-pointer-lock allow-downloads allow-storage-access-by-user-activation",style:{display:"block"}}):L?e.jsx("div",{className:"flex items-center justify-center h-full bg-gray-50",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-sm text-gray-600 font-geneva-12 shimmer-gray",children:w("apps.applet-viewer.dialogs.loading")})})}):e.jsx("div",{className:"h-full w-full bg-gray-50"})}),e.jsxs("div",{className:`absolute top-0 left-0 right-0 z-10 flex items-center gap-3 px-3 py-2 ${Ce?"border-b border-[#919b9c]":P==="macosx"?"":P==="system7"?"bg-gray-100 border-b border-black":"bg-gray-100 border-b border-gray-200"}`,style:{flexWrap:"nowrap",background:Ce?"transparent":void 0,backgroundImage:P==="macosx"?"var(--os-pinstripe-window)":void 0,borderBottom:P==="macosx"?"var(--os-metrics-titlebar-border-width, 1px) solid var(--os-color-titlebar-border-inactive, rgba(0, 0, 0, 0.2))":void 0},children:[e.jsx("div",{className:"!text-2xl flex-shrink-0 applet-icon flex items-center justify-center",style:{fontSize:"1.5rem"},children:u}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-sm font-geneva-12 truncate",children:p}),n.createdBy&&e.jsx("div",{className:"text-[10px] text-gray-500 font-geneva-12 truncate",children:n.createdBy})]}),e.jsx(Le,{size:"sm",variant:N?"default":I?"secondary":ke?"retro":"default",onClick:M=>{M.stopPropagation(),x?N?Me(n):Re(n):Me(n)},className:"flex-shrink-0 whitespace-nowrap",children:w(x?N?"apps.applet-viewer.status.update":"apps.applet-viewer.status.open":"apps.applet-viewer.status.get")})]})]},n.id)},Ae=Math.max(0,f),Ye=Math.min(E.length,f+se+1),Ie=E.slice(Ae,Ye),s={exit:n=>n==="backward"?{opacity:0,z:A,scale:1-ie,y:W,transition:{type:"spring",stiffness:150,damping:25}}:{opacity:0,z:50,scale:1.05,y:28,transition:{type:"spring",stiffness:150,damping:25}}};return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:Fe}),e.jsx("div",{ref:pe,className:"h-full w-full overflow-hidden bg-black/20 flex items-center justify-center",style:{position:"relative",perspective:"calc(100vh * 1.25)",transformStyle:"preserve-3d"},children:e.jsx("div",{className:"relative w-full flex items-center justify-center",style:{transformStyle:"preserve-3d",height:"100%",maxHeight:"1200px"},children:e.jsx(pa,{initial:!1,custom:_,children:Ie.map((n,l)=>{const p=Ae+l,u=p-f,x=1/(u+1),N=E.length-p;return e.jsx(da.div,{className:"absolute w-[90%] h-[75%] max-w-4xl rounded-2xl shadow-2xl overflow-hidden bg-white",style:{boxShadow:"0 0 0 1px rgba(0,0,0,0.05)",transformStyle:"preserve-3d",clipPath:"inset(0 round 1rem)",zIndex:N,transformOrigin:"center center",rotateX:u!==0?-5:0,pointerEvents:u===0?"auto":"none",maxHeight:"720px",top:"12.5%"},initial:(()=>{const v={z:u*A,scale:1-u*ie,y:u*W,opacity:0};return u===0&&_==="forward"?{z:50,scale:1.05,y:28,opacity:0}:v})(),animate:{z:u*A,y:u*W,scale:1-u*ie,opacity:x},variants:s,exit:"exit",transition:{type:"spring",stiffness:150,damping:25},drag:u===0,dragConstraints:{top:0,bottom:0,left:0,right:0},dragElastic:.4,dragPropagation:!1,dragDirectionLock:!0,dragMomentum:!1,onDragStart:v=>{var S;if(u!==0)return;const M=v.target.closest("[data-applet-card]");if(!M)return;const R=M.getBoundingClientRect(),D="touches"in v?(S=v.touches[0])==null?void 0:S.clientY:v.clientY;M.__dragOnToolbar=D&&D-R.top<60},onDrag:(v,L)=>{if(u!==0)return;const R=v.target.closest("[data-applet-card]");if(R){const D=Math.abs(L.offset.x),S=Math.abs(L.offset.y);R._primaryDragAxis=D>S?"x":"y"}},onDragEnd:(v,L)=>{var ae;if(u!==0)return;const R=v.target.closest("[data-applet-card]"),D=R&&R.__dragOnToolbar;if(((R==null?void 0:R._primaryDragAxis)||"y")==="x"){const O=L.velocity.x;if(f<E.length-1){if(Math.abs(O)>300){T(f+1);return}Math.abs(L.offset.x)>30&&T(f+1)}return}if(!D){const he=R==null?void 0:R.querySelector("iframe");if(he)try{const O=he.contentDocument||((ae=he.contentWindow)==null?void 0:ae.document);if(O){const $=O.documentElement.scrollTop||O.body.scrollTop||0,Ve=O.documentElement.scrollHeight||O.body.scrollHeight||0,q=O.documentElement.clientHeight||O.body.clientHeight||0,Te=$<=5,z=$+q>=Ve-5;if(Ve>q){const Oe=L.offset.y<0,ot=L.offset.y>0;if(Oe&&!Te||ot&&!z)return}}}catch{}}const H=30,m=L.velocity.y;if(Math.abs(m)>300){m>0&&f<E.length-1?T(f+1):m<0&&f>0&&T(f-1);return}Math.abs(L.offset.y)>H&&(L.offset.y>0&&f<E.length-1?T(f+1):L.offset.y<0&&f>0&&T(f-1))},whileDrag:{scale:.98,transition:{duration:.1}},children:Pe(n,p)},n.id)})})})})]})});function ba({theme:re,sharedAppletId:V,focusWindow:k}){const{t:d}=at(),[w,E]=i.useState([]),[xe,we]=i.useState(!0),[oe,f]=i.useState(""),[Y,_]=i.useState(null),[X,K]=i.useState(""),[de,C]=i.useState(!1),[ye,pe]=i.useState(!1),[ee,Se]=i.useState(!1),Z=i.useRef(null),Q=He(s=>s.username),le=He(s=>s.authToken),ce=(Q==null?void 0:Q.toLowerCase())==="ryo"&&!!le,P=re==="macosx",ue=re==="system7",U=st(s=>s.current),se=U==="xp"||U==="win98",A=nt(),ie=i.useRef(null),W=i.useRef(null),I=async()=>{try{const s=await fetch(ge("/api/share-applet?list=true"));if(s.ok){const l=((await s.json()).applets||[]).sort((p,u)=>(u.createdAt||0)-(p.createdAt||0));E(l)}}catch(s){console.error("Error fetching applets:",s)}finally{we(!1)}},ke=async s=>{if(ee||s.length===0)return;Se(!0),W.current&&(b.dismiss(W.current),W.current=null);const n=s.length,l=n===1?d("apps.applet-viewer.dialogs.updatingAppletSingle"):d("apps.applet-viewer.dialogs.updatingAppletsPlural",{count:n}),p=b.loading(l,{duration:1/0});try{for(const u of s)await A.handleInstall(u);await I(),b.success(n===1?d("apps.applet-viewer.dialogs.appletUpdated"):d("apps.applet-viewer.dialogs.appletsUpdated",{count:n}),{id:p,duration:3e3}),ie.current=null}catch(u){console.error("Error updating applets:",u),b.error(d("apps.applet-viewer.dialogs.failedToUpdateApplets"),{description:u instanceof Error?u.message:d("apps.applet-viewer.dialogs.pleaseTryAgainLater"),id:p})}finally{Se(!1)}};i.useEffect(()=>{I()},[]),i.useEffect(()=>{if(ee)return;if(!w.length){ie.current=null,W.current&&(b.dismiss(W.current),W.current=null);return}const s=w.filter(x=>A.isAppletInstalled(x.id)&&A.needsUpdate(x));if(s.length===0){ie.current=null,W.current&&(b.dismiss(W.current),W.current=null);return}const n=s.map(x=>x.id).sort().join("|");if(n===ie.current)return;ie.current=n;const l=s.length,p=s.map(x=>x.title||x.name||d("apps.applet-viewer.dialogs.untitledApplet")).join(", "),u=b.info(l===1?d("apps.applet-viewer.dialogs.newAppletUpdates",{count:l}):d("apps.applet-viewer.dialogs.newAppletUpdatesPlural",{count:l}),{description:p,action:{label:d("apps.applet-viewer.status.update"),onClick:()=>ke(s)},duration:8e3});W.current=u},[w,ee,d]),i.useEffect(()=>{V&&(async()=>{try{const n=await fetch(ge(`/api/share-applet?id=${encodeURIComponent(V)}`));if(n.ok){const l=await n.json(),p={id:V,title:l.title,name:l.name,icon:l.icon,createdAt:l.createdAt||Date.now(),createdBy:l.createdBy};_(p),K(l.content||""),C(!0)}else b.error(d("apps.applet-viewer.dialogs.appletNotFound"),{description:d("apps.applet-viewer.dialogs.appletNotFoundDescription")})}catch(n){console.error("Error fetching shared applet:",n),b.error(d("apps.applet-viewer.dialogs.failedToLoadSharedApplet"),{description:d("apps.applet-viewer.dialogs.pleaseCheckConnection")})}})()},[V]),i.useEffect(()=>{if(Y){if(X&&de)return;if(typeof navigator<"u"&&"onLine"in navigator&&!navigator.onLine){K("");return}K(""),fetch(ge(`/api/share-applet?id=${encodeURIComponent(Y.id)}`)).then(s=>{if(s.ok)return s.json();throw new Error("Failed to fetch applet content")}).then(s=>{K(s.content||"")}).catch(s=>{console.error("Error fetching applet content:",s),K("")})}else K("")},[Y,de]);const Ce=s=>{if(!P||!s)return s;const n='<link rel="stylesheet" href="/fonts/fonts.css">',l=`<style data-ryos-applet-font-fix>
      html,body{font-family:"LucidaGrande","Lucida Grande",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Noto Color Emoji",sans-serif!important}
      *{font-family:inherit!important}
      h1,h2,h3,h4,h5,h6,p,div,span,a,li,ul,ol,button,input,select,textarea,label,code,pre,blockquote,small,strong,em,table,th,td{font-family:"LucidaGrande","Lucida Grande",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Noto Color Emoji",sans-serif!important}
    </style>`,p=s.toLowerCase().lastIndexOf("</head>");if(p!==-1)return s.slice(0,p)+n+l+s.slice(p);const u=s.toLowerCase().indexOf("<body");if(u!==-1){const x=s.indexOf(">",u)+1;return s.slice(0,x)+n+l+s.slice(x)}return n+l+s},te=async s=>{k==null||k();const n=await A.handleAppletClick(s);n&&_(n)},Fe=async s=>{k==null||k(),A.isAppletInstalled(s.id)&&await te(s)},ve=async s=>{ee||(k==null||k(),await A.handleInstall(s,async()=>{await I(),_(null)}))},be=async s=>{if(ce&&confirm(d("apps.applet-viewer.dialogs.areYouSureDeleteApplet")))try{if(!(await fetch(ge(`/api/share-applet?id=${encodeURIComponent(s)}`),{method:"DELETE",headers:{Authorization:`Bearer ${le}`,"X-Username":Q}})).ok)throw new Error("Failed to delete applet");b.success(d("apps.applet-viewer.dialogs.appletDeleted")),I()}catch(n){console.error("Error deleting applet:",n),b.error(d("apps.applet-viewer.dialogs.failedToDeleteApplet"),{description:d("apps.applet-viewer.dialogs.pleaseTryAgainLater")})}},Ue=async(s,n)=>{if(ce)try{if(!(await fetch(ge(`/api/share-applet?id=${encodeURIComponent(s)}`),{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${le}`,"X-Username":Q},body:JSON.stringify({featured:!n})})).ok)throw new Error("Failed to update featured status");b.success(d(n?"apps.applet-viewer.dialogs.removedFromFeatured":"apps.applet-viewer.dialogs.addedToFeatured")),I()}catch(l){console.error("Error updating featured status:",l),b.error(d("apps.applet-viewer.dialogs.failedToUpdateFeaturedStatus"),{description:d("apps.applet-viewer.dialogs.pleaseTryAgainLater")})}},T=i.useMemo(()=>w.filter(s=>{if(!oe.trim())return!0;const n=oe.toLowerCase(),l=(s.title||s.name||d("apps.applet-viewer.dialogs.untitledApplet")).toLowerCase(),p=(s.createdBy||"").toLowerCase();return l.includes(n)||p.includes(n)}),[w,oe]),Me=i.useMemo(()=>T.filter(s=>A.isAppletInstalled(s.id)&&A.needsUpdate(s)).sort((s,n)=>(n.createdAt||0)-(s.createdAt||0)),[T,A]),Re=i.useMemo(()=>T.filter(s=>A.isAppletInstalled(s.id)&&!A.needsUpdate(s)).sort((s,n)=>(n.createdAt||0)-(s.createdAt||0)),[T,A]),Be=i.useMemo(()=>T.filter(s=>s.featured&&!A.isAppletInstalled(s.id)).sort((s,n)=>(n.createdAt||0)-(s.createdAt||0)),[T,A]),Pe=i.useMemo(()=>T.filter(s=>!s.featured&&!A.isAppletInstalled(s.id)).sort((s,n)=>(n.createdAt||0)-(s.createdAt||0)),[T,A]),Ae=`
    .applet-icon {
      font-size: 2.25rem !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
  `;if(xe)return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:Ae}),e.jsx("div",{className:"h-full w-full flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-sm text-gray-600 font-geneva-12 shimmer-gray",children:d("apps.applet-viewer.dialogs.loading")})})})]});const Ye=s=>{const l=Date.now()-s,p=Math.floor(l/6e4),u=Math.floor(p/60),x=Math.floor(u/24),N=new Date(s),v=new Date;if(N.getDate()===v.getDate()&&N.getMonth()===v.getMonth()&&N.getFullYear()===v.getFullYear())return p<1?d("apps.applet-viewer.status.updatedJustNow"):p<60?d("apps.applet-viewer.status.updatedMinutesAgo",{minutes:p}):d("apps.applet-viewer.status.updatedHoursAgo",{hours:u});if(x===1)return d("apps.applet-viewer.status.updatedYesterday");if(x<7)return d("apps.applet-viewer.status.updatedDaysAgo",{days:x});if(x<30){const R=Math.floor(x/7);return d("apps.applet-viewer.status.updatedWeeksAgo",{weeks:R})}if(x<365){const R=Math.floor(x/30);return d("apps.applet-viewer.status.updatedMonthsAgo",{months:R})}const M=Math.floor(x/365);return d("apps.applet-viewer.status.updatedYearsAgo",{years:M})},Ie=s=>{const n=s.title||s.name||d("apps.applet-viewer.dialogs.untitledApplet"),l=s.icon||"ðŸ“±",p=A.isAppletInstalled(s.id),u=A.needsUpdate(s);return e.jsxs("div",{className:"group flex items-center gap-3 px-3 py-2 rounded transition-colors cursor-pointer hover:bg-gray-100",onClick:x=>{const N=x.target;N.closest("button")||N.closest('[role="button"]')||(k==null||k(),te(s))},children:[e.jsx("div",{className:"!text-4xl flex-shrink-0 applet-icon flex items-center justify-center",style:{fontSize:"2.25rem",width:"3rem"},children:l}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"font-medium text-sm font-geneva-12 truncate",children:n})}),u&&s.createdAt?e.jsx("div",{className:"text-[10px] text-gray-500 font-geneva-12 truncate",children:Ye(s.createdAt)}):s.createdBy?e.jsx("div",{className:"text-[10px] text-gray-500 font-geneva-12 truncate",children:s.createdBy}):null]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[ce&&e.jsxs("div",{className:"flex items-center gap-0",children:[e.jsx("button",{onClick:x=>{x.stopPropagation(),Ue(s.id,s.featured||!1)},className:"p-1 hover:bg-gray-200 rounded transition-all inline-flex md:hidden md:group-hover:inline-flex",title:s.featured?d("apps.applet-viewer.labels.removeFromFeatured"):d("apps.applet-viewer.labels.addToFeatured"),children:e.jsx(wa,{className:`h-4 w-4 ${s.featured?"fill-yellow-400 text-yellow-400":"text-gray-400"}`})}),e.jsx("button",{onClick:x=>{x.stopPropagation(),be(s.id)},className:"p-1 hover:bg-gray-200 rounded transition-all text-gray-400 inline-flex md:hidden md:group-hover:inline-flex",title:d("apps.applet-viewer.labels.deleteApplet"),children:e.jsx(ha,{className:"h-4 w-4"})})]}),e.jsx(Le,{size:"sm",variant:u?"default":P?"secondary":ue?"retro":"default",onClick:x=>{x.stopPropagation(),k==null||k(),p?u?ve(s):te(s):ve(s)},disabled:ee,children:d(p?u?"apps.applet-viewer.status.update":"apps.applet-viewer.status.open":"apps.applet-viewer.status.get")})]})]},s.id)};if(w.length===0)return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:Ae}),e.jsx("div",{className:"h-full w-full flex items-center justify-center",children:e.jsx("div",{className:"text-center px-6 font-geneva-12",children:e.jsx("p",{className:"text-[11px] text-gray-600 font-geneva-12",children:d("apps.applet-viewer.dialogs.noAppletsAvailable")})})})]});if(Y){const s=Y.title||Y.name||d("apps.applet-viewer.dialogs.untitledApplet"),n=Y.icon||"ðŸ“±";return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:Ae}),e.jsxs("div",{className:"h-full w-full flex flex-col",children:[e.jsxs("div",{className:`flex items-center gap-3 px-3 py-2 ${se?"border-b border-[#919b9c]":U==="macosx"?"":U==="system7"?"bg-gray-100 border-b border-black":"bg-gray-100 border-b border-gray-200"}`,style:{background:se?"transparent":void 0,backgroundImage:U==="macosx"?"var(--os-pinstripe-window)":void 0,borderBottom:U==="macosx"?"var(--os-metrics-titlebar-border-width, 1px) solid var(--os-color-titlebar-border-inactive, rgba(0, 0, 0, 0.2))":void 0},children:[e.jsx(Le,{variant:"ghost",size:"icon",onClick:()=>{_(null),C(!1)},className:"h-7 w-7 flex-shrink-0",children:e.jsx(Gt,{className:"h-4 w-4"})}),e.jsx("div",{className:"!text-2xl flex-shrink-0 applet-icon flex items-center justify-center",style:{fontSize:"1.5rem"},children:n}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("div",{className:"font-medium text-sm font-geneva-12 truncate",children:s})}),e.jsx(Le,{size:"sm",variant:P?"secondary":ue?"retro":"default",onClick:()=>ve(Y),className:"w-[60px]",disabled:ee,children:d("apps.applet-viewer.status.get")})]}),e.jsx("div",{className:"flex-1 overflow-hidden bg-white",onClick:()=>{Y&&(k==null||k(),Fe(Y))},children:X?e.jsx("iframe",{srcDoc:Ce(X),title:s,className:"w-full h-full border-0",sandbox:"allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-top-navigation allow-modals allow-pointer-lock allow-downloads allow-storage-access-by-user-activation",style:{display:"block"}}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-sm text-gray-600 font-geneva-12 shimmer-gray",children:d("apps.applet-viewer.dialogs.loading")})})})})]})]})}return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:Ae}),e.jsx("div",{className:"h-full w-full flex flex-col",children:ye?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`px-3 py-2 flex items-center gap-1 ${se?"border-b border-[#919b9c]":U==="macosx"?"":U==="system7"?"bg-gray-100 border-b border-black":"bg-gray-100 border-b border-gray-200"}`,style:{background:se?"transparent":void 0,backgroundImage:U==="macosx"?"var(--os-pinstripe-window)":void 0,borderBottom:U==="macosx"?"var(--os-metrics-titlebar-border-width, 1px) solid var(--os-color-titlebar-border-inactive, rgba(0, 0, 0, 0.2))":void 0},children:[e.jsx(Wt,{type:"text",placeholder:d("apps.applet-viewer.labels.searchApplets"),value:oe,onChange:s=>f(s.target.value),className:`flex-1 pl-2 ${se?"!text-[11px]":U==="macosx"?"!text-[12px] h-[26px]":"!text-[16px]"}`,style:U==="macosx"?{paddingTop:"2px",paddingBottom:"2px"}:void 0}),e.jsxs(Le,{variant:"ghost",size:"sm",onClick:()=>pe(!1),className:"flex items-center gap-1 px-1",children:[e.jsx(ga,{className:"h-4 w-4"}),e.jsx("span",{className:"text-xs font-geneva-12",children:d("apps.applet-viewer.labels.discover")})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto bg-white",children:e.jsx("div",{className:"space-y-1",children:T.length===0?e.jsx("div",{className:"px-3 py-4 text-center",children:e.jsx("p",{className:"text-[11px] text-gray-600 font-geneva-12",children:d("apps.applet-viewer.dialogs.noAppletsFound",{query:oe})})}):e.jsxs(e.Fragment,{children:[Me.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-2 px-4 pt-2 pb-1 w-full flex items-center",children:e.jsx("h3",{className:"!text-[11px] uppercase tracking-wide text-black/50 font-geneva-12",children:d("apps.applet-viewer.sections.updatesAvailable")})}),Me.map(s=>Ie(s))]}),Be.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-2 px-4 pt-2 pb-1 w-full flex items-center",children:e.jsx("h3",{className:"!text-[11px] uppercase tracking-wide text-black/50 font-geneva-12",children:d("apps.applet-viewer.sections.featured")})}),Be.map(s=>Ie(s))]}),Pe.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-2 px-4 pt-2 pb-1 w-full flex items-center",children:e.jsx("h3",{className:"!text-[11px] uppercase tracking-wide text-black/50 font-geneva-12",children:d("apps.applet-viewer.sections.newApplets")})}),Pe.map(s=>Ie(s))]}),Re.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-2 px-4 pt-2 pb-1 w-full flex items-center",children:e.jsx("h3",{className:"!text-[11px] uppercase tracking-wide text-black/50 font-geneva-12",children:d("apps.applet-viewer.sections.installed")})}),Re.map(s=>Ie(s))]})]})})})]}):e.jsxs("div",{className:"flex-1 overflow-hidden relative",children:[e.jsx(va,{ref:Z,theme:re,focusWindow:k,onAppletSelect:s=>{k==null||k(),_(s)}}),e.jsxs("div",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 z-20 flex items-center gap-2",children:[e.jsx(Le,{variant:P?"aqua":"default",size:"sm",onClick:()=>{var s;return(s=Z.current)==null?void 0:s.goToPrevious()},className:`h-7 w-7 p-0 flex items-center justify-center ${P?"rounded-full":"rounded-none"}`,style:{height:"28px",width:"28px"},children:e.jsx(ua,{className:"h-4 w-4"})}),e.jsx(Le,{variant:P?"aqua":"default",size:"sm",onClick:()=>pe(!0),style:{height:"28px"},children:e.jsx("span",{className:"text-sm font-medium font-geneva-12",children:d("apps.applet-viewer.labels.showAll")})}),e.jsx(Le,{variant:P?"aqua":"default",size:"sm",onClick:()=>{var s;return(s=Z.current)==null?void 0:s.goToNext()},className:`h-7 w-7 p-0 flex items-center justify-center ${P?"rounded-full":"rounded-none"}`,style:{height:"28px",width:"28px"},children:e.jsx(Xt,{className:"h-4 w-4"})})]})]})})]})}function Aa(){const[re,V]=i.useState([]),[k,d]=i.useState(!1),w=nt(),E=i.useCallback(async()=>{if(typeof navigator<"u"&&"onLine"in navigator&&!navigator.onLine)return d(!1),[];d(!0);try{const f=await fetch(ge("/api/share-applet?list=true"));if(f.ok){const _=((await f.json()).applets||[]).sort((X,K)=>(K.createdAt||0)-(X.createdAt||0));return V(_),_}return[]}catch(f){return console.error("Error fetching applets:",f),[]}finally{d(!1)}},[]),xe=i.useCallback(async()=>{const Y=(await E()).filter(_=>w.isAppletInstalled(_.id)&&w.needsUpdate(_));return{count:Y.length,updates:Y}},[E,w]),we=i.useMemo(()=>re.filter(f=>w.isAppletInstalled(f.id)&&w.needsUpdate(f)),[re,w]);return{updateCount:we.length,updatesAvailable:we,isLoading:k,checkForUpdates:xe,fetchApplets:E}}function $a({onClose:re,isWindowOpen:V,isForeground:k=!0,skipInitialSound:d,instanceId:w,initialData:E}){const xe=Jt("applet-viewer",oa),[we,oe]=i.useState(!1),[f,Y]=i.useState(!1),[_,X]=i.useState(!1),[K,de]=i.useState(""),[C,ye]=i.useState(""),[pe,ee]=i.useState(void 0),[Se,Z]=i.useState(void 0),Q=i.useRef(null),le=i.useRef(null),ce=st(t=>t.current),P=ce==="xp"||ce==="win98",ue=ce==="macosx",U=He(t=>t.username),se=He(t=>t.authToken),{t:A}=at(),ie=fa(),{promptSetUsername:W,promptVerifyToken:I,logout:ke,isUsernameDialogOpen:Ce,setIsUsernameDialogOpen:te,newUsername:Fe,setNewUsername:ve,newPassword:be,setNewPassword:Ue,isSettingUsername:T,usernameError:Me,submitUsernameDialog:Re,isVerifyDialogOpen:Be,setVerifyDialogOpen:Pe,verifyPasswordInput:Ae,setVerifyPasswordInput:Ye,verifyUsernameInput:Ie,setVerifyUsernameInput:s,isVerifyingToken:n,verifyError:l,handleVerifyTokenSubmit:p}=ie,{updateCount:u,updatesAvailable:x,checkForUpdates:N}=Aa(),v=nt(),L=i.useCallback(async t=>{try{const o=await fetch(ge("/api/share-applet?list=true"));if(!o.ok)return null;const c=((await o.json()).applets||[]).find(h=>h.id===t);return c&&v.isAppletInstalled(c.id)&&v.needsUpdate(c)?c:null}catch(o){return console.error("[AppletViewer] Error checking for applet update:",o),null}},[v]),M=i.useCallback(async()=>{const t=await N();if(t.count>0){const o=t.updates.map(a=>a.title||a.name||"Untitled Applet").join(", ");b.info(`${t.count} new applet update${t.count>1?"s":""}`,{description:o,action:{label:"Update",onClick:async()=>{const a=t.updates.length,c=a===1?"Updating 1 applet...":`Updating ${a} applets...`,h=b.loading(c,{duration:1/0});try{for(const y of t.updates)await v.handleInstall(y);await N(),b.success(a===1?"Applet updated":`${a} applets updated`,{id:h,duration:3e3})}catch(y){console.error("Error updating applets:",y),b.error("Failed to update applets",{description:y instanceof Error?y.message:"Please try again later.",id:h})}}},duration:8e3})}else b.success("All applets are up to date")},[N,v]),R=i.useCallback(async()=>{if(x.length===0)return;const t=x.length,o=t===1?"Updating 1 applet...":`Updating ${t} applets...`,a=b.loading(o,{duration:1/0});try{for(const c of x)await v.handleInstall(c);await N(),b.success(t===1?"Applet updated":`${t} applets updated`,{id:a,duration:3e3})}catch(c){console.error("Error updating applets:",c),b.error("Failed to update applets",{description:c instanceof Error?c.message:"Please try again later.",id:a})}},[x,v,N]),D=i.useCallback(t=>{if(t)try{t.postMessage({type:Xe,action:"response",payload:{username:U??null,authToken:se??null}},"*")}catch(o){console.warn("[applet-viewer] Failed to post auth payload:",o)}},[U,se]),S=i.useCallback(()=>{const t=Ee.getState();if(w){const o=t.instances[w];(!o||!o.isForeground)&&t.bringInstanceToForeground(w)}else{const o=t.apps["applet-viewer"];(!o||!o.isForeground)&&t.bringToForeground("applet-viewer")}},[w]),H=E,m=(H==null?void 0:H.path)||"",ae=H==null?void 0:H.shareCode,[he,O]=i.useState(""),$=dt();i.useEffect(()=>{const t=o=>{var h;const a=o==null?void 0:o.data;if(!a||a.type!==Xe||a.action!=="request")return;const c=o.source;c&&c===((h=Q.current)==null?void 0:h.contentWindow)&&D(c)};return window.addEventListener("message",t),()=>{window.removeEventListener("message",t)}},[D]);const Ve=i.useCallback(async(t,o)=>{const{shareId:a,uuid:c,name:h}=o;if(!a||!c)return console.warn(`[AppletViewer] Cannot fetch shared applet for ${t}: missing shareId or uuid`),null;if(typeof navigator<"u"&&"onLine"in navigator&&!navigator.onLine)return console.warn("[AppletViewer] Cannot fetch applet: offline"),null;try{const y=await fetch(`/api/share-applet?id=${encodeURIComponent(a)}`);if(!y.ok)return console.error(`[AppletViewer] Failed to fetch applet content for shareId ${a}: ${y.status}`),null;const r=await y.json(),F=typeof r.content=="string"?r.content:"";await ut.put(ht.APPLETS,{name:h||t.split("/").pop()||a,content:F},c);const g={};return typeof r.icon=="string"&&r.icon!==o.icon&&(g.icon=r.icon),typeof r.createdBy=="string"&&r.createdBy!==o.createdBy&&(g.createdBy=r.createdBy),typeof r.windowWidth=="number"&&typeof r.windowHeight=="number"&&(g.windowWidth=r.windowWidth,g.windowHeight=r.windowHeight),typeof r.createdAt=="number"&&(g.storeCreatedAt=r.createdAt),Object.keys(g).length>0&&$.updateItemMetadata(t,g),{content:F,windowWidth:typeof r.windowWidth=="number"?r.windowWidth:void 0,windowHeight:typeof r.windowHeight=="number"?r.windowHeight:void 0}}catch(y){return console.error(`[AppletViewer] Error fetching shared applet content for ${a}:`,y),null}},[$]),q=ae&&!m?"":he||(H==null?void 0:H.content)||C||"",Te=q.trim().length>0;i.useEffect(()=>{var t;D((t=Q.current)==null?void 0:t.contentWindow)},[D,q]),i.useEffect(()=>{(async()=>{if(!m||m.startsWith("/Applets/")===!1){O("");return}if(H!=null&&H.content&&H.content.trim().length>0){O(H.content),w&&Ee.getState().updateInstanceInitialData(w,{...H,content:""});return}try{const o=$.getItem(m);if(o!=null&&o.uuid){const a=await ut.get(ht.APPLETS,o.uuid);if(a!=null&&a.content){let c;a.content instanceof Blob?c=await a.content.text():c=a.content,O(c)}else if(o.shareId){const c=await Ve(m,o);if(c){if(O(c.content),w&&c.windowWidth&&c.windowHeight){const h=Ee.getState(),y=h.instances[w];if(y){const r=y.position||{x:0,y:0};h.updateInstanceWindowState(w,r,{width:c.windowWidth,height:c.windowHeight})}}}else O("")}else O("")}else O("")}catch(o){console.error("[AppletViewer] Error loading content from IndexedDB:",o),O("")}})()},[m,w,$,H,Ve]),i.useEffect(()=>{console.log("[AppletViewer] Loaded applet:",{path:m,contentLength:q.length,hasContent:!!q,loadedFromIndexedDB:!!he})},[m,q,he]);const z=m?$.getItem(m):void 0,rt=i.useRef(new Set);i.useEffect(()=>{if(!m||!q||q.trim().length===0||rt.current.has(m))return;rt.current.add(m);const t=z==null?void 0:z.shareId,o=m.split("/"),a=o[o.length-1],c=(z==null?void 0:z.name)||a.replace(/\.(html|app)$/i,""),h=(z==null?void 0:z.createdBy)||"";Kt(Zt.VIEW,{appletId:t||m,title:c,createdBy:h})},[m,q,z]);const Oe=i.useRef(new Set);i.useEffect(()=>{if(!m)return;const t=async(a=0)=>{const c=$.getItem(m),h=c==null?void 0:c.shareId;if(!h){a<5&&setTimeout(()=>t(a+1),500);return}if(Oe.current.has(h))return;Oe.current.add(h);const y=await L(h);if(y){const r=y.title||y.name||A("apps.applet-viewer.dialogs.untitledApplet");b.info(A("apps.applet-viewer.dialogs.appletUpdateAvailable"),{description:A("apps.applet-viewer.dialogs.appletUpdateAvailableDescription",{appletName:r}),action:{label:A("apps.applet-viewer.status.update"),onClick:async()=>{const F=b.loading(A("apps.applet-viewer.dialogs.updatingApplet"),{duration:1/0});try{await v.handleInstall(y);const g=$.getItem(m);if(g!=null&&g.uuid){const G=await ut.get(ht.APPLETS,g.uuid);if(G!=null&&G.content){let B;G.content instanceof Blob?B=await G.content.text():B=G.content,O(B)}}b.success(A("apps.applet-viewer.dialogs.appletUpdated"),{id:F,duration:3e3}),Oe.current.delete(h)}catch(g){console.error("Error updating applet:",g),b.error(A("apps.applet-viewer.dialogs.failedToUpdateApplet"),{description:g instanceof Error?g.message:A("apps.applet-viewer.dialogs.pleaseTryAgainLater"),id:F}),Oe.current.delete(h)}}},duration:8e3})}},o=setTimeout(()=>t(0),1e3);return()=>clearTimeout(o)},[m,he,L,v,$,A]);const{getAppletWindowSize:ot,setAppletWindowSize:ft}=Qt(),kt=z!=null&&z.windowWidth&&(z!=null&&z.windowHeight)?{width:z.windowWidth,height:z.windowHeight}:void 0,Ct=m?ot(m):void 0,Ne=kt||Ct,je=Ee(t=>w?t.instances[w]:t.apps["applet-viewer"]),mt=i.useRef(!1);i.useEffect(()=>{if(mt.current||!w||!Ne)return;const t=Ee.getState(),o=t.instances[w];if(!o)return;const a=o.size;if(!a||a.width!==Ne.width||a.height!==Ne.height){const c=o.position||{x:0,y:0};t.updateInstanceWindowState(w,c,Ne)}mt.current=!0},[w,Ne]),i.useEffect(()=>{if(!m||!(je!=null&&je.size))return;const t=je.size;(!Ne||Ne.width!==t.width||Ne.height!==t.height)&&(z&&$.updateItemMetadata(m,{windowWidth:t.width,windowHeight:t.height}),ft(m,t))},[m,je==null?void 0:je.size,Ne,z,$,ft]);const it=t=>{const o=t.split("/");return o[o.length-1].replace(/\.(html|app)$/i,"")},We=(t,o=!1)=>{if(!t)return"";const a=t.match(/<!--\s*TITLE:\s*([^>]+)-->/i);if(a&&a[1])return a[1].trim();const c=t.match(/<title[^>]*>([^<]+)<\/title>/i);return c&&c[1]?c[1].trim():o&&!m?"":m?it(m):"Untitled"},Nt=t=>{if(!ue||!t)return t;const o='<link rel="stylesheet" href="/fonts/fonts.css">',a=`<style data-ryos-applet-font-fix>
      html,body{font-family:"LucidaGrande","Lucida Grande",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Noto Color Emoji",sans-serif!important}
      *{font-family:inherit!important}
      h1,h2,h3,h4,h5,h6,p,div,span,a,li,ul,ol,button,input,select,textarea,label,code,pre,blockquote,small,strong,em,table,th,td{font-family:"LucidaGrande","Lucida Grande",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Noto Color Emoji",sans-serif!important}
    </style>`,c=t.toLowerCase().lastIndexOf("</head>");if(c!==-1)return t.slice(0,c)+o+a+t.slice(c);const h=/<head[^>]*>/i.exec(t);if(h){const r=h.index+h[0].length;return t.slice(0,r)+o+a+t.slice(r)}const y=/<html[^>]*>/i.exec(t);if(y){const r=y.index+y[0].length;return t.slice(0,r)+`<head>${o}${a}</head>`+t.slice(r)}return`<!DOCTYPE html><html><head>${o}${a}</head><body>${t}</body></html>`},Et=i.useCallback(t=>{if(!t||t.includes(Xe))return t;const a=t.toLowerCase().lastIndexOf("</head>");if(a!==-1)return t.slice(0,a)+Ge+t.slice(a);const c=/<head[^>]*>/i.exec(t);if(c){const y=c.index+c[0].length;return t.slice(0,y)+Ge+t.slice(y)}const h=/<html[^>]*>/i.exec(t);if(h){const y=h.index+h[0].length;return t.slice(0,y)+`<head>${Ge}</head>`+t.slice(y)}return`<!DOCTYPE html><html><head>${Ge}</head><body>${t}</body></html>`},[]),It=jt(),{saveFile:lt,files:gt}=ea("/Applets"),xt=t=>{const o=/^([\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F000}-\u{1F02F}\u{1F0A0}-\u{1F0FF}\u{1F100}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2300}-\u{23FF}\u{2B50}\u{2B55}\u{3030}\u{303D}\u{3297}\u{3299}]+)\s*/u,a=t.match(o);return a?{emoji:a[1],remainingText:t.slice(a[0].length)}:{emoji:null,remainingText:t}},Tt=async t=>{var a;const o=(a=t.target.files)==null?void 0:a[0];if(o)try{let c;const h=o.name.toLowerCase();if(h.endsWith(".app")||h.endsWith(".gz"))try{if(typeof DecompressionStream>"u")throw new Error("DecompressionStream API not available");const j=await o.arrayBuffer(),Mt=new Blob([j]).stream(),Rt=new DecompressionStream("gzip"),Bt=Mt.pipeThrough(Rt),pt=[],Dt=Bt.getReader();for(;;){const{done:ze,value:Ke}=await Dt.read();if(ze)break;Ke&&pt.push(Ke)}const Ht=pt.reduce((ze,Ke)=>ze+Ke.length,0),vt=new Uint8Array(Ht);let bt=0;for(const ze of pt)vt.set(ze,bt),bt+=ze.length;c=new TextDecoder().decode(vt)}catch(j){console.warn("Failed to decompress, treating as plain text:",j),c=await o.text()}else c=await o.text();let y,r,F,g,G,B,J,fe,me;try{const j=JSON.parse(c);j.content&&typeof j.content=="string"?(y=j.content,r=j.name||o.name,F=j.icon,g=j.shareId,G=j.createdBy,B=j.windowWidth,J=j.windowHeight,fe=j.createdAt,me=j.modifiedAt):(y=c,r=o.name)}catch{const{metadata:j,content:qe}=ia(c);y=qe,r=o.name,j.shareId&&(g=j.shareId),j.name&&(r=j.name),j.icon&&(F=j.icon),j.createdBy&&(G=j.createdBy),j.windowWidth!==void 0&&(B=j.windowWidth),j.windowHeight!==void 0&&(J=j.windowHeight),j.createdAt!==void 0&&(fe=j.createdAt),j.modifiedAt!==void 0&&(me=j.modifiedAt)}const{emoji:_e,remainingText:ct}=xt(r);!F&&_e&&(F=_e),r=ct,r.endsWith(".html")||r.endsWith(".htm")||r.endsWith(".json")||r.endsWith(".gz")?r=r.replace(/\.(html|htm|json|gz)$/i,".app"):r.endsWith(".app")||(r=`${r}.app`);const $e=`/Applets/${r}`,Je=dt.getState();await lt({name:r,path:$e,content:y,type:"html",icon:F,shareId:g,createdBy:G||U||void 0}),(B||J||fe||me)&&Je.updateItemMetadata($e,{...B&&{windowWidth:B},...J&&{windowHeight:J},...fe&&{createdAt:fe},...me&&{modifiedAt:me}});const De=new CustomEvent("saveFile",{detail:{name:r,path:$e,content:y,icon:F}});window.dispatchEvent(De),It("applet-viewer",{initialData:{path:$e,content:y}}),b.success("Applet imported!",{description:`${r} saved to /Applets${F?` with ${F} icon`:""}`})}catch(c){console.error("Import failed:",c),b.error("Import failed",{description:"Could not import the file."})}le.current&&(le.current.value="")},Lt=async()=>{var F;if(!Te)return;let t=m&&((F=m.split("/").pop())==null?void 0:F.replace(/\.(html|app)$/i,""))||"Untitled";const a=dt.getState().getItem(m),c={name:(a==null?void 0:a.name)||t,content:q,icon:a==null?void 0:a.icon,shareId:a==null?void 0:a.shareId,createdBy:a==null?void 0:a.createdBy,windowWidth:a==null?void 0:a.windowWidth,windowHeight:a==null?void 0:a.windowHeight,createdAt:a==null?void 0:a.createdAt,modifiedAt:a==null?void 0:a.modifiedAt},h=a==null?void 0:a.icon;t=`${h&&!h.startsWith("/")&&!h.startsWith("http")&&h.length<=10?h:"ðŸ“¦"} ${t}`;try{if(typeof CompressionStream>"u")throw new Error("CompressionStream API not available in this browser");const g=new TextEncoder,G=JSON.stringify(c,null,2),B=g.encode(G),J=new ReadableStream({start(j){j.enqueue(B),j.close()}}),fe=new CompressionStream("gzip"),me=J.pipeThrough(fe),_e=[],ct=me.getReader();for(;;){const{done:j,value:qe}=await ct.read();if(j)break;qe&&_e.push(qe)}const $e=new Blob(_e,{type:"application/gzip"}),Je=URL.createObjectURL($e),De=document.createElement("a");De.href=Je,De.download=`${t}.app`,document.body.appendChild(De),De.click(),document.body.removeChild(De),URL.revokeObjectURL(Je),b.success("Applet exported!",{description:`${t}.app exported successfully.`})}catch(g){console.error("Compression failed:",g),b.error("Export failed",{description:g instanceof Error?g.message:"Could not compress the applet file."})}},Ft=()=>{Te&&la(q,m)},Ut=async()=>{if(!Te){b.error("No applet to share",{description:"Please open an applet first."});return}if(!U||!se){b.error("Login required",{description:"You must be logged in to share applets."});return}try{const t=gt.find(J=>J.path===m),o=m?$.getItem(m):null,a=o==null?void 0:o.shareId,c=o==null?void 0:o.createdBy,h=c&&U&&c.toLowerCase()===U.toLowerCase();if(a&&!h){de(a),X(!0),b.success("Applet already shared",{description:"Showing existing share link."});return}const y=We(q),r=t==null?void 0:t.icon,F=(t==null?void 0:t.name)||(m?it(m):void 0),g=je==null?void 0:je.size,G=await fetch(ge("/api/share-applet"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${se}`,"X-Username":U},body:JSON.stringify({content:q,title:y||void 0,icon:r||void 0,name:F||void 0,windowWidth:g==null?void 0:g.width,windowHeight:g==null?void 0:g.height,shareId:a&&h?a:void 0})});if(!G.ok){const J=await G.json().catch(()=>({}));throw new Error(J.error||"Failed to share applet")}const B=await G.json();if(de(B.id),X(!0),m&&B.id){const J=$.getItem(m);if(J){const fe=B.updated||!a;await lt({path:m,name:J.name,content:q,type:"html",icon:J.icon,shareId:fe?B.id:a||B.id,createdBy:J.createdBy||U}),B.createdAt&&$.updateItemMetadata(m,{storeCreatedAt:B.createdAt})}}b.success(B.updated?"Applet updated!":"Applet shared!",{description:B.updated?"Share link updated successfully.":"Share link generated successfully.",duration:3e3})}catch(t){console.error("Error sharing applet:",t),b.error("Failed to share applet",{description:t instanceof Error?t.message:"Please try again later."})}};i.useEffect(()=>{ae&&m?(ye(""),(async()=>{try{const o=await fetch(ge(`/api/share-applet?id=${encodeURIComponent(ae)}`));if(!o.ok){if(o.status===404)b.error("Applet not found",{description:"The shared applet may have been deleted or the link is invalid."});else throw new Error("Failed to fetch shared applet");return}const a=await o.json();if(ye(a.content),ee(a.name),Z(a.title),w&&a.windowWidth&&a.windowHeight){const h=Ee.getState(),y=h.instances[w];if(y){const r=y.position||{x:0,y:0};h.updateInstanceWindowState(w,r,{width:a.windowWidth,height:a.windowHeight})}}if(w&&(a.icon||a.name)){const h=Ee.getState(),y=h.instances[w];if(y){const r=y.initialData,F={path:(r==null?void 0:r.path)??"",content:(r==null?void 0:r.content)??"",shareCode:r==null?void 0:r.shareCode,icon:a.icon||(r==null?void 0:r.icon),name:a.name||(r==null?void 0:r.name)};h.updateInstanceInitialData(w,F)}}const c=a.title||a.name||"Shared Applet";b.success("Shared applet loaded",{description:c,action:{label:"Save",onClick:async()=>{try{let h=a.name||a.title||"shared-applet";const{remainingText:y}=xt(h);h=y;const r=h.endsWith(".app")?h:`${h}.app`,F=`/Applets/${r}`,g=ae?gt.find(fe=>{const me=$.getItem(fe.path);return(me==null?void 0:me.shareId)===ae}):null,G=(g==null?void 0:g.path)||F,B=(g==null?void 0:g.name)||r;await lt({path:G,name:B,content:a.content,type:"html",icon:a.icon||void 0,shareId:ae,createdBy:a.createdBy}),a.windowWidth&&a.windowHeight&&$.updateItemMetadata(G,{windowWidth:a.windowWidth,windowHeight:a.windowHeight});const J=new CustomEvent("saveFile",{detail:{name:B,path:G,content:a.content,icon:a.icon||void 0}});window.dispatchEvent(J),b.success("Applet saved",{description:`Saved to /Applets/${B}`})}catch(h){console.error("Error saving shared applet:",h),b.error("Failed to save applet",{description:h instanceof Error?h.message:"Please try again."})}}},duration:1e4})}catch(o){console.error("Error fetching shared applet:",o),b.error("Failed to load shared applet",{description:"Please check your connection and try again."})}})()):!ae&&C&&(ye(""),ee(void 0),Z(void 0))},[ae]);const wt=e.jsx(ya,{onClose:re,onShowHelp:()=>oe(!0),onShowAbout:()=>Y(!0),onExportAsApp:Lt,onExportAsHtml:Ft,onShareApplet:Ut,hasAppletContent:Te,handleFileSelect:Tt,instanceId:w,onSetUsername:W,onVerifyToken:I,onLogout:ke,updateCount:u,onCheckForUpdates:M,onUpdateAll:R});if(i.useEffect(()=>{const t=Q.current;if(!t||!w)return;const o=()=>{var y;try{const r=t.contentDocument||((y=t.contentWindow)==null?void 0:y.document),F=t.contentWindow,g=()=>{S()};r==null||r.addEventListener("pointerdown",g,!0),r==null||r.addEventListener("mousedown",g,!0),r==null||r.addEventListener("touchstart",g,!0),r==null||r.addEventListener("keydown",g,!0),r==null||r.addEventListener("focusin",g,!0);try{F==null||F.addEventListener("focus",g)}catch{}return()=>{r==null||r.removeEventListener("pointerdown",g,!0),r==null||r.removeEventListener("mousedown",g,!0),r==null||r.removeEventListener("touchstart",g,!0),r==null||r.removeEventListener("keydown",g,!0),r==null||r.removeEventListener("focusin",g,!0);try{F==null||F.removeEventListener("focus",g)}catch{}}}catch{return}};let a=o();const c=()=>{a&&a(),a=o()},h=()=>S();return t.addEventListener("load",c),t.addEventListener("focus",h,!0),()=>{t.removeEventListener("load",c),t.removeEventListener("focus",h,!0),a&&a()}},[w,S]),!V)return null;const yt=Te?ae?We(q,!0)||Se||pe||A("apps.applet-viewer.dialogs.sharedApplet"):m?it(m):We(q,!1)||A("common.dock.appletStore"):A("common.dock.appletStore");return e.jsxs(e.Fragment,{children:[!P&&k&&wt,e.jsx(ta,{title:yt,onClose:re,isForeground:k,appId:"applet-viewer",skipInitialSound:d,instanceId:w,menuBar:P?wt:void 0,children:e.jsx("div",{className:"w-full h-full bg-white overflow-hidden",children:Te?e.jsxs("div",{className:"relative h-full w-full",children:[e.jsx("iframe",{ref:Q,srcDoc:Et(Nt(q)),title:yt,className:"border-0",sandbox:"allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-top-navigation allow-modals allow-pointer-lock allow-downloads allow-storage-access-by-user-activation",style:{display:"block",margin:0,padding:0,width:"calc(100% + 1px)",height:"calc(100% + 1px)"},onLoad:()=>{var t;return D(((t=Q.current)==null?void 0:t.contentWindow)||null)},onFocus:S,onFocusCapture:S}),!k&&e.jsx("div",{className:"absolute inset-0 z-50 bg-transparent","aria-hidden":"true",onClick:S,onMouseDown:S,onTouchStart:S,onWheel:S,onDragStart:S,onKeyDown:S})]}):e.jsxs("div",{className:"relative h-full w-full",style:ue?{backgroundColor:"var(--os-color-window-bg)",backgroundImage:"var(--os-pinstripe-window)"}:void 0,children:[e.jsx(ba,{theme:ce,sharedAppletId:ae||void 0,focusWindow:S}),!k&&e.jsx("div",{className:"absolute inset-0 z-50 bg-transparent","aria-hidden":"true",onClick:S,onMouseDown:S,onTouchStart:S,onWheel:S,onDragStart:S,onKeyDown:S})]})})}),e.jsx(aa,{isOpen:we,onOpenChange:oe,appId:"applet-viewer",helpItems:xe}),e.jsx(sa,{isOpen:f,onOpenChange:Y,metadata:na,appId:"applet-viewer"}),e.jsx(St,{isOpen:_,onClose:()=>{X(!1),de("")},itemType:"Applet",itemIdentifier:K,title:K?We(q):void 0,generateShareUrl:ra}),e.jsx(ca,{initialTab:Be?"login":"signup",isOpen:Ce||Be,onOpenChange:t=>{t||(te(!1),Pe(!1))},usernameInput:Ie,onUsernameInputChange:s,passwordInput:Ae,onPasswordInputChange:Ye,onLoginSubmit:async()=>{await p(Ae,!0)},isLoginLoading:n,loginError:l,newUsername:Fe,onNewUsernameChange:ve,newPassword:be,onNewPasswordChange:Ue,onSignUpSubmit:Re,isSignUpLoading:T,signUpError:Me})]})}export{$a as AppletViewerAppComponent};
