import{r as s,j as e,k as ds}from"./ui-core-D0pDhx0h.js";import{R as us}from"./index-B2E7WcJr.js";import{u as $e,bw as ps,bx as Pe,by as Je,bz as G,a as vt,M as Ds,b as nt,d as at,e as rt,f as ue,g as Ie,k as he,h as ft,i as mt,j as xt,bA as Fs,bB as Vs,a4 as be,S as hs,l as Bs,m as Us,am as fe,bC as _s,Y as fs,aI as k,bD as ts,a0 as ss,n as ns,o as as,b1 as zs,an as jt,bE as Ws,E as Ys,as as rs,ai as Hs,bF as Xs,Z as Ks,aD as qs,H as Gs,J as Js,bG as Zs,G as Qs,I as en,bH as tn,bI as sn}from"./index-CdY3Xrkk.js";import{C as nn}from"./opencc-DdAalh07.js";import{m as Oe,A as Ze}from"./motion-DC7C-474.js";import"./react-CyQK0IK8.js";import"./media-player-Dfptv93o.js";import"./zustand-CwjPl1Tm.js";import"./tiptap-CPHiBm_b.js";import"./ui-form-Bg85K0S3.js";import"./audio-DxkJfdUY.js";import"./pusher-BvD42uFZ.js";import"./hangul-CIZ_Rl7P.js";import"./three-BOJBN814.js";function an({onClose:a,onShowHelp:r,onShowAbout:h,onClearLibrary:N,onSyncLibrary:y,onAddTrack:m,onShareSong:I}){var xe;const{t:l}=$e(),[c,x]=s.useState(!1),L="ipod",C=(xe=Us[L])==null?void 0:xe.name,d=[{label:l("apps.ipod.translationLanguages.original"),code:null},{label:"English",code:"en"},{label:"中文",code:"zh-TW"},{label:"日本語",code:"ja"},{label:"한국어",code:"ko"},{label:"Español",code:"es"},{label:"Français",code:"fr"},{label:"Deutsch",code:"de"},{label:"Português",code:"pt"},{label:"Italiano",code:"it"},{label:"Русский",code:"ru"}],{tracks:g,currentIndex:R,isLoopAll:Z,isLoopCurrent:Y,isPlaying:D,isShuffled:B,isBacklightOn:v,isVideoOn:H,isLcdFilterOn:J,currentTheme:Q,showLyrics:ee,isFullScreen:U,lyricsAlignment:S,chineseVariant:b,koreanDisplay:p,lyricsTranslationLanguage:E,setCurrentIndex:j,setIsPlaying:X,toggleLoopAll:T,toggleLoopCurrent:w,toggleShuffle:F,togglePlay:P,nextTrack:z,previousTrack:se,toggleBacklight:Se,toggleVideo:Ce,toggleLcdFilter:me,toggleFullScreen:f,setTheme:n,toggleLyrics:V,setLyricsAlignment:te,refreshLyrics:K,setChineseVariant:ce,setKoreanDisplay:ie,setLyricsTranslationLanguage:_,importLibrary:q,exportLibrary:ae}=ps(i=>({tracks:i.tracks,currentIndex:i.currentIndex,isLoopAll:i.loopAll,isLoopCurrent:i.loopCurrent,isPlaying:i.isPlaying,isShuffled:i.isShuffled,isBacklightOn:i.backlightOn,isVideoOn:i.showVideo,isLcdFilterOn:i.lcdFilterOn,currentTheme:i.theme,showLyrics:i.showLyrics,isFullScreen:i.isFullScreen,lyricsAlignment:i.lyricsAlignment??G.FocusThree,chineseVariant:i.chineseVariant??Je.Traditional,koreanDisplay:i.koreanDisplay??Pe.Original,lyricsTranslationLanguage:i.lyricsTranslationLanguage,setCurrentIndex:i.setCurrentIndex,setIsPlaying:i.setIsPlaying,toggleLoopAll:i.toggleLoopAll,toggleLoopCurrent:i.toggleLoopCurrent,toggleShuffle:i.toggleShuffle,togglePlay:i.togglePlay,nextTrack:i.nextTrack,previousTrack:i.previousTrack,toggleBacklight:i.toggleBacklight,toggleVideo:i.toggleVideo,toggleLcdFilter:i.toggleLcdFilter,toggleFullScreen:i.toggleFullScreen,setTheme:i.setTheme,toggleLyrics:i.toggleLyrics,setLyricsAlignment:i.setLyricsAlignment,refreshLyrics:i.refreshLyrics,setChineseVariant:i.setChineseVariant,setKoreanDisplay:i.setKoreanDisplay,setLyricsTranslationLanguage:i.setLyricsTranslationLanguage,importLibrary:i.importLibrary,exportLibrary:i.exportLibrary})),de=vt(i=>i.current),oe=de==="xp"||de==="win98",ye=i=>{j(i),X(!0)},Le=g.reduce((i,re,we)=>{const ke=re.artist||l("apps.ipod.menu.unknownArtist");return i[ke]||(i[ke]=[]),i[ke].push({track:re,index:we}),i},{}),Ee=Object.keys(Le).sort((i,re)=>i.localeCompare(re,void 0,{sensitivity:"base"})),it=()=>{try{const i=ae(),re=new Blob([i],{type:"application/json"}),we=URL.createObjectURL(re),ke=document.createElement("a");ke.href=we,ke.download="ipod-library.json",document.body.appendChild(ke),ke.click(),document.body.removeChild(ke),URL.revokeObjectURL(we),fe.success(l("apps.ipod.dialogs.libraryExportedSuccessfully"))}catch(i){console.error("Failed to export library:",i),fe.error(l("apps.ipod.dialogs.failedToExportLibrary"))}},Be=()=>{const i=document.createElement("input");i.type="file",i.accept=".json",i.onchange=re=>{var Qe;const we=(Qe=re.target.files)==null?void 0:Qe[0];if(!we)return;const ke=new FileReader;ke.onload=bt=>{var Ue;try{const et=(Ue=bt.target)==null?void 0:Ue.result;q(et),fe.success(l("apps.ipod.dialogs.libraryImportedSuccessfully"))}catch(et){console.error("Failed to import library:",et),fe.error(l("apps.ipod.dialogs.failedToImportLibrary"))}},ke.readAsText(we)},i.click()};return e.jsxs(Ds,{inWindowFrame:oe,children:[e.jsxs(nt,{children:[e.jsx(at,{className:"text-md px-2 py-1 border-none focus-visible:ring-0",children:l("apps.ipod.menu.file")}),e.jsxs(rt,{align:"start",sideOffset:1,className:"px-0",children:[e.jsx(ue,{onClick:m,className:"text-md h-6 px-3",children:l("apps.ipod.menu.addSong")}),e.jsx(ue,{onClick:I,className:"text-md h-6 px-3",disabled:g.length===0||R===-1,children:l("apps.ipod.menu.shareSong")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(ue,{onClick:it,className:"text-md h-6 px-3",disabled:g.length===0,children:l("apps.ipod.menu.exportLibrary")}),e.jsx(ue,{onClick:Be,className:"text-md h-6 px-3",children:l("apps.ipod.menu.importLibrary")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(ue,{onClick:a,className:"text-md h-6 px-3",children:l("common.menu.close")})]})]}),e.jsxs(nt,{children:[e.jsx(at,{className:"px-2 py-1 text-md focus-visible:ring-0",children:l("apps.ipod.menu.controls")}),e.jsxs(rt,{align:"start",sideOffset:1,className:"px-0",children:[e.jsx(ue,{onClick:P,className:"text-md h-6 px-3",disabled:g.length===0,children:l(D?"apps.ipod.menu.pause":"apps.ipod.menu.play")}),e.jsx(ue,{onClick:se,className:"text-md h-6 px-3",disabled:g.length===0,children:l("apps.ipod.menu.previous")}),e.jsx(ue,{onClick:z,className:"text-md h-6 px-3",disabled:g.length===0,children:l("apps.ipod.menu.next")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(he,{checked:B,onCheckedChange:()=>F(),className:"text-md h-6 px-3",children:l("apps.ipod.menu.shuffle")}),e.jsx(he,{checked:Z,onCheckedChange:()=>T(),className:"text-md h-6 px-3",children:l("apps.ipod.menu.repeatAll")}),e.jsx(he,{checked:Y,onCheckedChange:()=>w(),className:"text-md h-6 px-3",children:l("apps.ipod.menu.repeatOne")})]})]}),e.jsxs(nt,{children:[e.jsx(at,{className:"px-2 py-1 text-md focus-visible:ring-0",children:l("apps.ipod.menu.view")}),e.jsxs(rt,{align:"start",sideOffset:1,className:"px-0",children:[e.jsxs(ft,{children:[e.jsx(mt,{className:"text-md h-6 px-3",children:l("apps.ipod.menu.lyrics")}),e.jsxs(xt,{className:"px-0",children:[e.jsx(he,{checked:ee,onCheckedChange:()=>V(),className:"text-md h-6 px-3",children:l("apps.ipod.menu.showLyrics")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(he,{checked:b===Je.Traditional,onCheckedChange:i=>ce(i?Je.Traditional:Je.Original),className:"text-md h-6 px-3",children:l("apps.ipod.menu.traditionalChinese")}),e.jsx(he,{checked:p===Pe.Original,onCheckedChange:i=>ie(i?Pe.Original:Pe.Romanized),className:"text-md h-6 px-3",children:l("apps.ipod.menu.korean")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(he,{checked:S===G.FocusThree,onCheckedChange:i=>{i&&te(G.FocusThree)},className:"text-md h-6 pr-3",children:l("apps.ipod.menu.multi")}),e.jsx(he,{checked:S===G.Center,onCheckedChange:i=>{i&&te(G.Center)},className:"text-md h-6 pr-3",children:l("apps.ipod.menu.single")}),e.jsx(he,{checked:S===G.Alternating,onCheckedChange:i=>{i&&te(G.Alternating)},className:"text-md h-6 pr-3",children:l("apps.ipod.menu.alternating")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(ue,{onClick:K,className:"text-md h-6 px-3",disabled:g.length===0||R===-1,children:l("apps.ipod.menu.refreshLyrics")})]})]}),e.jsxs(ft,{children:[e.jsx(mt,{className:"text-md h-6 px-3",children:l("apps.ipod.menu.translate")}),e.jsx(xt,{className:"px-0 max-h-[400px] overflow-y-auto",children:e.jsx(Fs,{value:E||"off",onValueChange:i=>{_(i==="off"?null:i)},children:d.map(i=>{const re=i.code||"off";return e.jsx(Vs,{value:re,className:"text-md h-6 pr-3",children:i.label},re)})})})]}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(he,{checked:v,onCheckedChange:()=>Se(),className:"text-md h-6 px-3",children:l("apps.ipod.menu.backlight")}),e.jsx(he,{checked:J,onCheckedChange:()=>me(),className:"text-md h-6 px-3",children:l("apps.ipod.menu.lcdFilter")}),e.jsx(he,{checked:H,onCheckedChange:()=>Ce(),className:"text-md h-6 px-3",disabled:!D,children:l("apps.ipod.menu.video")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(he,{checked:Q==="classic",onCheckedChange:i=>{i&&n("classic")},className:"text-md h-6 pr-3",children:l("apps.ipod.menu.classic")}),e.jsx(he,{checked:Q==="black",onCheckedChange:i=>{i&&n("black")},className:"text-md h-6 pr-3",children:l("apps.ipod.menu.black")}),e.jsx(he,{checked:Q==="u2",onCheckedChange:i=>{i&&n("u2")},className:"text-md h-6 pr-3",children:l("apps.ipod.menu.u2")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(he,{checked:U,onCheckedChange:()=>f(),className:"text-md h-6 px-3",children:l("apps.ipod.menu.fullScreen")})]})]}),e.jsxs(nt,{children:[e.jsx(at,{className:"px-2 py-1 text-md focus-visible:ring-0",children:l("apps.ipod.menu.library")}),e.jsxs(rt,{align:"start",sideOffset:1,className:"px-0 max-w-[180px] sm:max-w-[220px]",children:[e.jsx(ue,{onClick:m,className:"text-md h-6 px-3",children:l("apps.ipod.menu.addToLibrary")}),g.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsxs(ft,{children:[e.jsx(mt,{className:"text-md h-6 px-3",children:e.jsx("div",{className:"flex justify-between w-full items-center overflow-hidden",children:e.jsx("span",{className:"truncate min-w-0",children:l("apps.ipod.menu.allSongs")})})}),e.jsx(xt,{className:"px-0 max-w-[180px] sm:max-w-[220px] max-h-[400px] overflow-y-auto",children:g.map((i,re)=>e.jsx(ue,{onClick:()=>ye(re),className:be("text-md h-6 px-3 max-w-[220px] truncate",re===R&&"bg-gray-200"),children:e.jsxs("div",{className:"flex items-center w-full",children:[e.jsx("span",{className:be("flex-none whitespace-nowrap",re===R?"mr-1":"pl-5"),children:re===R?"♪ ":""}),e.jsx("span",{className:"truncate min-w-0",children:i.title})]})},`all-${i.id}`))})]}),e.jsx("div",{className:"max-h-[300px] overflow-y-auto",children:Ee.map(i=>e.jsxs(ft,{children:[e.jsx(mt,{className:"text-md h-6 px-3",children:e.jsx("div",{className:"flex justify-between w-full items-center overflow-hidden",children:e.jsx("span",{className:"truncate min-w-0",children:i})})}),e.jsx(xt,{className:"px-0 max-w-[180px] sm:max-w-[220px] max-h-[200px] overflow-y-auto",children:Le[i].map(({track:re,index:we})=>e.jsx(ue,{onClick:()=>ye(we),className:be("text-md h-6 px-3 max-w-[160px] sm:max-w-[200px] truncate",we===R&&"bg-gray-200"),children:e.jsxs("div",{className:"flex items-center w-full",children:[e.jsx("span",{className:be("flex-none whitespace-nowrap",we===R?"mr-1":"pl-5"),children:we===R?"♪ ":""}),e.jsx("span",{className:"truncate min-w-0",children:re.title})]})},`${i}-${re.id}`))})]},i))}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"})]}),e.jsx(ue,{onClick:N,className:"text-md h-6 px-3",children:l("apps.ipod.menu.clearLibrary")}),e.jsx(ue,{onClick:y,className:"text-md h-6 px-3",children:l("apps.ipod.menu.syncLibrary")})]})]}),e.jsxs(nt,{children:[e.jsx(at,{className:"px-2 py-1 text-md focus-visible:ring-0",children:l("common.menu.help")}),e.jsxs(rt,{align:"start",sideOffset:1,className:"px-0",children:[e.jsx(ue,{onClick:r,className:"text-md h-6 px-3",children:l("apps.ipod.menu.ipodHelp")}),e.jsx(ue,{onSelect:()=>x(!0),className:"text-md h-6 px-3",children:l("apps.ipod.menu.shareApp")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(ue,{onClick:h,className:"text-md h-6 px-3",children:l("apps.ipod.menu.aboutIpod")})]})]}),e.jsx(hs,{isOpen:c,onClose:()=>x(!1),itemType:"App",itemIdentifier:L,title:C,generateShareUrl:Bs})]})}const gt={spring:{type:"spring",stiffness:200,damping:30,mass:1},fade:{duration:.2}},rn=({bottomPaddingClass:a="pb-5",textSizeClass:r="text-[12px]",fontClassName:h="font-geneva-12"})=>{const{t:N}=$e();return e.jsx("div",{className:`absolute inset-x-0 top-0 left-0 right-0 bottom-0 pointer-events-none flex items-end justify-center z-40 ${a}`,children:e.jsx("div",{className:`${r} ${h} shimmer opacity-60`,children:N("apps.ipod.status.loadingLyrics")})})},on=({bottomPaddingClass:a="pb-5",textSizeClass:r="text-[12px]",fontClassName:h="font-geneva-12"})=>{const{t:N}=$e();return e.jsx("div",{className:`absolute inset-x-0 top-0 left-0 right-0 bottom-0 pointer-events-none flex items-end justify-center z-40 ${a}`,children:e.jsx("div",{className:`${r} ${h} shimmer opacity-60`,children:N("apps.ipod.status.translatingLyrics")})})},is=({bottomPaddingClass:a="pb-5",textSizeClass:r="text-[12px]",fontClassName:h="font-geneva-12"})=>e.jsx("div",{className:`absolute inset-x-0 top-0 left-0 right-0 bottom-0 pointer-events-none flex items-end justify-center z-40 ${a}`,children:e.jsx("div",{className:`text-white/70 ${r} ${h}`})}),ln=(a,r,h)=>({initial:{opacity:0,scale:.93,filter:"none",y:10,textShadow:"0 0 2px black, 0 0 2px black, 0 0 2px black, 0 0 0px rgba(255,255,255,0)"},animate:{opacity:r?h?1:.5:h?1:a===1||a===-1?.5:.1,scale:r||h||a===1||a===-1?1:.9,filter:"none",y:0,textShadow:h?"0 0 8px rgba(255,255,255,0.9), 0 0 2px black, 0 0 2px black, 0 0 2px black":"0 0 2px black, 0 0 2px black, 0 0 2px black"},exit:{opacity:0,scale:.9,filter:"none",y:-10,textShadow:"0 0 2px black, 0 0 2px black, 0 0 2px black, 0 0 0px rgba(255,255,255,0)"}});function ms({lines:a,currentLine:r,isLoading:h,error:N,visible:y=!0,videoVisible:m=!0,alignment:I=G.FocusThree,chineseVariant:l=Je.Traditional,koreanDisplay:c=Pe.Original,onAdjustOffset:x,isTranslating:L=!1,textSizeClass:C="text-[12px]",lineHeightClass:d="leading-[1.1]",interactive:g=!0,bottomPaddingClass:R="pb-5",gapClass:Z="gap-2",fontClassName:Y="font-geneva-12",containerStyle:D}){const B=s.useMemo(()=>nn({from:"cn",to:"tw"}),[]),v=T=>{const w=/[\u4E00-\u9FFF]/,F=/[\u3040-\u309F\u30A0-\u30FF]/;return w.test(T)&&!F.test(T)},H=T=>{let w=T;return l===Je.Traditional&&v(w)&&(w=B(w)),c===Pe.Romanized&&/[\u3131-\u314e\u314f-\u3163\uac00-\ud7a3]/.test(w)&&(w=_s.convert(w)),w},J=(T,w,F)=>T===G.Center||T===G.FocusThree?"center":T===G.Alternating?F===1?"center":w===0?"left":"right":F===1?"center":F===2?w===0?"left":"right":w===0?"left":w===1?"center":w===2?"right":"center",Q=(T,w)=>{if(!T.length)return[];if(w<0)return T.slice(0,2).filter(Boolean);const F=Math.min(w,T.length-1),P=T[F+1];return F%2===0?[T[F],P].filter(Boolean):[P,T[F]].filter(Boolean)},[ee,U]=s.useState(()=>Q(a,r));s.useEffect(()=>{if(I!==G.Alternating)return;const T=Math.min(Math.max(0,r),a.length-1),w=T>=0&&a[T]?parseInt(a[T].startTimeMs):null,F=T+1<a.length&&a[T+1]?parseInt(a[T+1].startTimeMs):null,P=w!==null&&F!==null?F-w:0,z=Math.max(20,Math.floor(P*.2)),se=setTimeout(()=>{U(Q(a,r))},z);return()=>clearTimeout(se)},[I,a,r]);const S=s.useMemo(()=>{if(!a.length)return[];if(r<0)return a.slice(0,1).filter(Boolean);if(I===G.Center){const T=Math.min(Math.max(0,r),a.length-1),w=a[T];return w?[w]:[]}return a.slice(Math.max(0,r-1),r+2)},[a,r,I]),b=I===G.Alternating?ee:S,p=s.useRef(null),E=T=>{if(!g||!x||!m)return;const P=T.deltaY>0?50:-50;x(P)},j=T=>{g&&T.touches.length===1&&(p.current=T.touches[0].clientY)},X=T=>{if(!g||p.current===null||!x||!m)return;const w=T.touches[0].clientY,F=w-p.current;if(Math.abs(F)>10){const z=F>0?50:-50;x(z),p.current=w}};return y?h?e.jsx(rn,{bottomPaddingClass:R,textSizeClass:C,fontClassName:Y}):L?e.jsx(on,{bottomPaddingClass:R,textSizeClass:C,fontClassName:Y}):N?e.jsx(is,{bottomPaddingClass:R,textSizeClass:C,fontClassName:Y}):!a.length&&!h&&!L?e.jsx(is,{bottomPaddingClass:R,textSizeClass:C,fontClassName:Y}):e.jsx(Oe.div,{layout:I===G.Alternating,transition:gt.spring,className:`absolute inset-x-0 mx-auto top-0 left-0 right-0 bottom-0 w-full h-full overflow-hidden flex flex-col items-center justify-end ${Z} z-40 select-none px-0 ${R}`,style:{...D||{},pointerEvents:g?"auto":"none"},onWheel:E,onTouchStart:j,onTouchMove:X,children:e.jsx(Ze,{mode:"popLayout",children:b.map((T,w)=>{const F=T===a[r];let P=0;if(I===G.Alternating)P=F?0:1;else{const Ce=a.indexOf(a[r]);P=a.indexOf(T)-Ce}const z=ln(P,I===G.Alternating,F),se={...gt.spring,opacity:gt.fade,filter:gt.fade,duration:.15},Se=J(I,w,b.length);return e.jsx(Oe.div,{layoutId:`${T.startTimeMs}-${T.words.substring(0,10)}`,initial:"initial",animate:"animate",exit:"exit",variants:z,transition:se,className:`px-2 md:px-6 ${C} ${Y} ${d} whitespace-pre-wrap break-words max-w-full text-white`,style:{textAlign:Se,width:"100%",paddingLeft:I===G.Alternating&&w===0&&b.length>1?"5%":void 0,paddingRight:I===G.Alternating&&w===1&&b.length>1?"5%":void 0},children:H(T.words)},T.startTimeMs)})})}):null}function cn({backlightOn:a}){const[r,h]=s.useState(null),[N,y]=s.useState(!1),[m,I]=s.useState(1);s.useEffect(()=>{(async()=>{try{if("getBattery"in navigator){const L=await navigator.getBattery();h(L.level),y(L.charging);const C=()=>h(L.level),d=()=>y(L.charging);return L.addEventListener("levelchange",C),L.addEventListener("chargingchange",d),()=>{L.removeEventListener("levelchange",C),L.removeEventListener("chargingchange",d)}}}catch{h(1),y(!1)}})()},[]),s.useEffect(()=>{if(!N)return;const x=setInterval(()=>{I(L=>L%4+1)},500);return()=>clearInterval(x)},[N]);const c=N?m:Math.ceil((r??1)*4);return e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"relative w-[19px] h-[10px] border border-[#0a3667] bg-transparent",children:e.jsx("div",{className:"absolute inset-[1px] flex gap-[1px]",children:[1,2,3,4].map(x=>e.jsx("div",{className:`flex-1 h-full transition-colors duration-200 ${x<=c?"bg-[#0a3667]":"bg-transparent"}`},x))})}),e.jsx("div",{className:"w-[2px] h-[4px] bg-[#0a3667] relative",children:e.jsx("div",{className:`w-[2px] h-[2px] absolute top-[1px] left-[-2px] right-[0px] mx-auto ${a?"bg-[#c5e0f5]":"bg-[#8a9da9]"}`})})]})}function dn({containerRef:a,backlightOn:r,menuMode:h}){const N=s.useRef(null),y=s.useRef(null);return s.useLayoutEffect(()=>{const m=a.current,I=N.current,l=y.current;if(!m||!I||!l||!h)return;const c=()=>{const{scrollTop:L,scrollHeight:C,clientHeight:d}=m;if(C>d){l.style.opacity="1",I.style.display="block";const R=d+3,Z=Math.max(d/C*R,20),Y=C-d,D=R-Z,B=Y>0?L/Y*D:0;I.style.height=`${Z-4}px`,I.style.top=`${B+2}px`}else l.style.opacity="0",I.style.display="none"};c(),m.addEventListener("scroll",c,{passive:!0});const x=new ResizeObserver(c);return x.observe(m),()=>{m.removeEventListener("scroll",c),x.disconnect()}},[a,h]),h?e.jsxs("div",{className:"absolute right-0 top-[-1px] bottom-[-2px] w-2 z-20",children:[e.jsx("div",{ref:y,className:be("w-full h-full border border-[#0a3667] transition-all duration-500",r?"bg-[#c5e0f5] bg-gradient-to-b from-[#d1e8fa] to-[#e0f0fc]":"bg-[#8a9da9]"),style:{opacity:0}}),e.jsx("div",{ref:N,className:"absolute right-0 bg-[#0a3667]",style:{marginLeft:"2px",marginRight:"2px",width:"calc(100% - 4px)",display:"none"}})]}):null}function un({text:a,isSelected:r,onClick:h,backlightOn:N=!0,showChevron:y=!0,value:m}){return e.jsxs("div",{onClick:h,className:be("pl-2 cursor-pointer font-chicago text-[16px] flex justify-between items-center",y||m?"pr-4":"pr-2",r?N?"bg-[#0a3667] text-[#c5e0f5] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)]":"bg-[#0a3667] text-[#8a9da9] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)]":"text-[#0a3667] hover:bg-[#c0d8f0] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)]"),children:[e.jsx("span",{className:"whitespace-nowrap overflow-hidden text-ellipsis flex-1 mr-2",children:a}),m?e.jsx("span",{className:"flex-shrink-0",children:m}):y&&e.jsx("span",{className:"flex-shrink-0",children:">"})]})}function os({text:a,className:r,isPlaying:h=!0}){const N=s.useRef(null),y=s.useRef(null),[m,I]=s.useState(!1),[l,c]=s.useState(0),x=20;return s.useEffect(()=>{if(N.current&&y.current){const L=N.current.clientWidth,C=y.current.scrollWidth;c(C),I(C>L)}},[a,N,y]),e.jsx("div",{ref:N,className:be("relative overflow-hidden",!m&&"flex justify-center",r),children:m?e.jsx("div",{className:"inline-block whitespace-nowrap",children:e.jsxs(Oe.div,{animate:{x:h?[0,-(l+x)]:0},transition:h?{duration:Math.max(a.length*.15,8),ease:"linear",repeat:1/0}:{duration:.3},style:{display:"inline-flex"},children:[e.jsx("span",{ref:y,style:{paddingRight:`${x}px`},children:a}),e.jsx("span",{style:{paddingRight:`${x}px`},"aria-hidden":!0,children:a})]})}):e.jsx("div",{ref:y,className:"whitespace-nowrap text-center",children:a})})}function pn({message:a}){return e.jsx("div",{className:"absolute top-4 left-4 pointer-events-none",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"font-chicago text-white text-xl relative z-10",children:a}),e.jsx("div",{className:"font-chicago text-black text-xl absolute inset-0",style:{WebkitTextStroke:"3px black",textShadow:"none"},children:a})]})})}function hn({currentTrack:a,isPlaying:r,elapsedTime:h,totalTime:N,menuMode:y,menuHistory:m,selectedMenuItem:I,onSelectMenuItem:l,currentIndex:c,tracksLength:x,backlightOn:L,menuDirection:C,onMenuItemAction:d,showVideo:g,playerRef:R,handleTrackEnd:Z,handleProgress:Y,handleDuration:D,handlePlay:B,handlePause:v,handleReady:H,loopCurrent:J,statusMessage:Q,onToggleVideo:ee,lcdFilterOn:U,ipodVolume:S,showStatusCallback:b,showLyrics:p,lyricsAlignment:E,chineseVariant:j,koreanDisplay:X,lyricOffset:T,adjustLyricOffset:w,registerActivity:F,isFullScreen:P,lyricsControls:z}){const{t:se}=$e(),Se={enter:_=>({x:_==="forward"?"100%":"-100%"}),center:{x:0},exit:_=>({x:_==="forward"?"-100%":"100%"})},Ce=y?m.length>0?m[m.length-1].title:se("apps.ipod.menuItems.ipod"):se("apps.ipod.menuItems.nowPlaying"),me=s.useRef(null),f=s.useRef([]),n=s.useRef(!1),V=fs(_=>_.masterVolume),te=S*V,K=_=>{f.current=Array(_).fill(null)},ce=()=>{if(!y||m.length===0)return;const _=document.querySelector(".ipod-menu-container");if(!_)return;const q=Array.from(_.querySelectorAll(".ipod-menu-item"));if(!q.length||I<0||I>=q.length)return;const ae=q[I];if(!ae)return;const de=_.clientHeight,oe=ae.offsetTop,ye=ae.offsetHeight,Le=_.scrollTop,Ee=2;oe+ye>Le+de-Ee?_.scrollTo({top:oe+ye-de+Ee,behavior:"instant"}):oe<Le+Ee&&_.scrollTo({top:Math.max(0,oe-Ee),behavior:"instant"}),I===0&&_.scrollTo({top:0,behavior:"instant"}),I===q.length-1&&_.scrollTo({top:Math.max(0,oe-(de-ye)+Ee),behavior:"instant"}),n.current=!1};s.useEffect(()=>{y&&m.length>0&&(n.current=!0,ce(),[50,100,250,500,1e3].forEach(q=>{setTimeout(()=>{n.current&&ce()},q)}))},[y,I,m.length]),s.useEffect(()=>{if(y&&m.length>0){const _=m[m.length-1];K(_.items.length)}},[y,m.length]);const ie=p;return e.jsxs("div",{className:be("relative w-full h-[150px] border border-black border-2 rounded-[2px] overflow-hidden transition-all duration-500 select-none",U?"lcd-screen":"",L?"bg-[#c5e0f5] bg-gradient-to-b from-[#d1e8fa] to-[#e0f0fc]":"bg-[#8a9da9] contrast-65 saturate-50",U&&L&&"shadow-[0_0_10px_2px_rgba(197,224,245,0.05)]"),style:{minWidth:"100%",minHeight:"150px",maxWidth:"100%",maxHeight:"150px",position:"relative",contain:"layout style paint"},children:[U&&e.jsx("div",{className:"absolute inset-0 pointer-events-none z-25 lcd-scan-lines"}),U&&e.jsx("div",{className:"absolute inset-0 pointer-events-none z-25 lcd-reflection"}),a&&e.jsx("div",{className:be("absolute inset-0 transition-opacity duration-300 overflow-hidden",y?"z-0":"z-20",y||!g?"opacity-0 pointer-events-none":"opacity-100"),children:e.jsxs("div",{className:"w-full h-[calc(100%+120px)] mt-[-60px]",onClick:_=>{_.stopPropagation(),F(),r?ee():g?B():(ee(),setTimeout(()=>{B()},100))},children:[e.jsx(us,{ref:R,url:a.url,playing:r,controls:g,width:"100%",height:"100%",onEnded:P?void 0:Z,onProgress:P?void 0:Y,onDuration:P?void 0:D,onPlay:P?void 0:B,onPause:P?void 0:v,onReady:P?void 0:H,loop:J,volume:te,playsinline:!0,config:{youtube:{playerVars:{modestbranding:1,rel:0,showinfo:0,iv_load_policy:3,fs:0,disablekb:1,playsinline:1,enablejsapi:1,origin:window.location.origin},embedOptions:{referrerPolicy:"strict-origin-when-cross-origin"}}}}),g&&ie&&e.jsx("div",{className:"absolute inset-0 bg-black/30 z-25"}),g&&e.jsx("div",{className:"absolute inset-0 z-30",onClick:_=>{_.stopPropagation(),r?ee():B()}}),e.jsx(Ze,{children:Q&&e.jsx(Oe.div,{className:"absolute inset-0 z-40",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},children:e.jsx(pn,{message:Q})})}),e.jsx(ms,{lines:z.lines,currentLine:z.currentLine,isLoading:z.isLoading,error:z.error,visible:ie,videoVisible:g,alignment:E,chineseVariant:j,koreanDisplay:X,isTranslating:z.isTranslating,onAdjustOffset:_=>{w(_);const q=T+_,ae=q>0?"+":(q<0,"");b(`${se("apps.ipod.status.offset")} ${ae}${(q/1e3).toFixed(2)}s`);const de=h+q/1e3;z.updateCurrentTimeManually(de)}})]})}),e.jsxs("div",{className:"border-b border-[#0a3667] py-0 px-2 font-chicago text-[16px] flex items-center sticky top-0 z-10 text-[#0a3667] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)]",children:[e.jsx("div",{className:`w-6 flex items-center justify-start font-chicago ${r?"text-xs":"text-[18px]"}`,children:e.jsx("div",{className:"w-4 h-4 mt-0.5 flex items-center justify-center",children:r?"▶":"⏸︎"})}),e.jsx("div",{className:"flex-1 truncate text-center",children:Ce}),e.jsx("div",{className:"w-6 flex items-center justify-end",children:e.jsx(cn,{backlightOn:L})})]}),e.jsx("div",{className:"relative h-[calc(100%-26px)]",children:e.jsx(Ze,{initial:!1,custom:C,mode:"sync",children:y?e.jsx(Oe.div,{className:"absolute inset-0 flex flex-col h-full",initial:"enter",animate:"center",exit:"exit",variants:Se,transition:{duration:.2,ease:"easeInOut"},custom:C,onAnimationComplete:()=>{n.current=!0,ce()},children:e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("div",{ref:me,className:"absolute inset-0 overflow-auto ipod-menu-container",children:m.length>0&&m[m.length-1].items.map((_,q)=>e.jsx("div",{ref:ae=>{f.current[q]=ae},className:`ipod-menu-item ${q===I?"selected":""}`,children:e.jsx(un,{text:_.label,isSelected:q===I,backlightOn:L,onClick:()=>{l(q),d(_.action)},showChevron:_.showChevron!==!1,value:_.value})},q))}),e.jsx(dn,{containerRef:me,backlightOn:L,menuMode:y})]})},`menu-${m.length}-${Ce}`):e.jsx(Oe.div,{className:"absolute inset-0 flex flex-col h-full",initial:"enter",animate:"center",exit:"exit",variants:Se,transition:{duration:.2,ease:"easeInOut"},custom:C,onClick:()=>{!y&&a&&(F(),r?ee():g?B():(ee(),setTimeout(()=>{B()},100)))},children:e.jsx("div",{className:"flex-1 flex flex-col p-1 px-2 overflow-auto",children:a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"font-chicago text-[12px] mb-1 text-[#0a3667] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)]",children:[c+1," of ",x]}),e.jsxs("div",{className:"font-chicago text-[16px] text-center text-[#0a3667] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)]",children:[e.jsx(os,{text:a.title,isPlaying:r}),e.jsx(os,{text:a.artist||"",isPlaying:r})]}),e.jsx("div",{className:"mt-auto w-full h-[8px] rounded-full border border-[#0a3667] overflow-hidden",children:e.jsx("div",{className:"h-full bg-[#0a3667]",style:{width:`${N>0?h/N*100:0}%`}})}),e.jsxs("div",{className:"font-chicago text-[16px] w-full h-[22px] flex justify-between text-[#0a3667] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)]",children:[e.jsxs("span",{children:[Math.floor(h/60),":",String(Math.floor(h%60)).padStart(2,"0")]}),e.jsxs("span",{children:["-",Math.floor((N-h)/60),":",String(Math.floor((N-h)%60)).padStart(2,"0")]})]})]}):e.jsxs("div",{className:"text-center font-geneva-12 text-[12px] text-[#0a3667] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)] h-full flex flex-col justify-center items-center",children:[e.jsx("p",{children:"Don't steal music"}),e.jsx("p",{children:"Ne volez pas la musique"}),e.jsx("p",{children:"Bitte keine Musik stehlen"}),e.jsx("p",{children:"音楽を盗用しないでください"})]})})},"nowplaying")})})]})}const ls=15;function fn({theme:a,onWheelClick:r,onWheelRotation:h,onMenuButton:N}){const{t:y}=$e(),m=s.useRef(null),[I,l]=s.useState(0),c=s.useRef(null),x=s.useRef(0),L=s.useRef(!1),C=s.useRef(!1),d=s.useRef(null),g=s.useRef(!1),R=s.useRef(!1),Z=s.useRef(!1),Y=(S,b)=>{if(!m.current)return 0;const p=m.current.getBoundingClientRect(),E=p.left+p.width/2,j=p.top+p.height/2;return Math.atan2(b-j,S-E)*180/Math.PI},D=(S,b)=>{if(!m.current)return 0;const p=m.current.getBoundingClientRect(),E=p.left+p.width/2,j=p.top+p.height/2;return Math.atan2(b-j,S-E)},B=S=>{const b=S*Math.PI/180;return b>=-Math.PI/4&&b<Math.PI/4?"right":b>=Math.PI/4&&b<3*Math.PI/4?"bottom":b>=3*Math.PI/4||b<-3*Math.PI/4?"left":"top"},v=(S,b)=>{if(!m.current)return!1;const p=m.current.getBoundingClientRect(),E=p.left+p.width/2,j=p.top+p.height/2;return Math.sqrt((S-E)**2+(b-j)**2)<=32},H=S=>{S.preventDefault();const b=S.touches[0];if(v(b.clientX,b.clientY))return;const p=D(b.clientX,b.clientY);c.current=p,x.current=0,C.current=!1,d.current={x:b.clientX,y:b.clientY}},J=S=>{if(S.preventDefault(),c.current===null)return;const b=S.touches[0],p=D(b.clientX,b.clientY);let E=p-c.current;E>Math.PI&&(E-=2*Math.PI),E<-Math.PI&&(E+=2*Math.PI),x.current+=E,c.current=p;const j=ls*Math.PI/180;for(!C.current&&Math.abs(x.current)>j&&(C.current=!0,Z.current=!0);x.current>j;)h("clockwise"),x.current-=j;for(;x.current<-j;)h("counterclockwise"),x.current+=j},Q=()=>{if(!C.current&&d.current){const S=Y(d.current.x,d.current.y),b=B(S);r(b),g.current=!0,setTimeout(()=>{g.current=!1},500)}c.current=null,x.current=0,C.current=!1,d.current=null,Z.current&&setTimeout(()=>{Z.current=!1},100)},ee=S=>{const b=I+Math.abs(S.deltaY);l(b),b>=50&&(S.deltaY<0?h("counterclockwise"):h("clockwise"),l(0))},U=S=>{if(g.current)return;R.current=S.target&&S.target.classList.contains("menu-button"),S.preventDefault();const b=D(S.clientX,S.clientY);c.current=b,x.current=0,L.current=!1;const p=ls*Math.PI/180,E=X=>{if(c.current===null)return;const T=D(X.clientX,X.clientY);let w=T-c.current;for(w>Math.PI&&(w-=2*Math.PI),w<-Math.PI&&(w+=2*Math.PI),x.current+=w,c.current=T,!L.current&&Math.abs(x.current)>p&&(L.current=!0);x.current>p;)h("clockwise"),x.current-=p;for(;x.current<-p;)h("counterclockwise"),x.current+=p},j=X=>{if(window.removeEventListener("mousemove",E),window.removeEventListener("mouseup",j),!L.current&&!R.current){const T=Y(X.clientX,X.clientY),w=B(T);r(w)}c.current=null,x.current=0,L.current=!1,R.current=!1};window.addEventListener("mousemove",E),window.addEventListener("mouseup",j)};return e.jsxs("div",{className:be("mt-6 relative w-[180px] h-[180px] rounded-full flex items-center justify-center select-none",a==="classic"?"bg-gray-300/60":a==="u2"?"bg-red-700/60":"bg-neutral-800/50"),children:[e.jsx("div",{role:"button",tabIndex:0,"aria-label":y("apps.ipod.ariaLabels.select"),onClick:()=>{g.current||Z.current||r("center")},onKeyDown:S=>{g.current||Z.current||(S.key==="Enter"||S.key===" ")&&(S.preventDefault(),r("center"))},className:be("ipod-wheel-center absolute w-16 h-16 rounded-full z-10 flex items-center justify-center outline-none focus:outline-none focus-visible:outline-none",a==="classic"?"bg-white/30":a==="u2"?"bg-black/70":"bg-black/30")}),e.jsxs("div",{ref:m,className:"absolute w-full h-full rounded-full touch-none select-none",onMouseDown:U,onTouchStart:H,onTouchMove:J,onTouchEnd:Q,onWheel:ee,children:[e.jsx("div",{className:"absolute top-1.5 text-center left-1/2 transform -translate-x-1/2 font-chicago text-xs text-white menu-button cursor-default select-none",onClick:S=>{g.current||Z.current||(S.stopPropagation(),N())},children:"MENU"}),e.jsx("div",{className:"absolute right-2 text-right top-1/2 transform -translate-y-1/2 font-chicago text-[12px] text-white cursor-default select-none",children:"⏭"}),e.jsx("div",{className:"absolute bottom-1 text-center left-1/2 transform -translate-x-1/2 font-chicago text-[12px] text-white cursor-default select-none",children:"⏯"}),e.jsx("div",{className:"absolute left-2 text-left top-1/2 transform -translate-y-1/2 font-chicago text-[12px] text-white cursor-default select-none",children:"⏮"})]})]})}const mn=["作词","作曲","编曲","制作","发行","出品","监制","策划","统筹","录音","混音","母带","和声","版权","吉他","贝斯","鼓","键盘","企划","词","詞：","曲","OP","SP","Produced","Composed","Arranged","Mixed","Lyrics","Keyboard","Guitar","Bass","Drum","Vocal","Original Publisher","Sub-publisher","Electric Piano","Synth by","Recorded by","Mixed by","Mastered by","Produced by","Composed by","Digital Editing by","Mix Assisted by","Mix by","Mix Engineer","Background vocals","Background vocals by","Chorus by","Percussion by","String by","Harp by","Piano by","Piano Arranged by","Written by","Additional Production by","Synthesizer","Programming","Background Vocals","Recording Engineer","Digital Editing"],cs=(a,r,h)=>{const N=[...mn,`${r} - ${h}`,`${h} - ${r}`];return a.split(`
`).map(y=>{const m=y.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.+)/);if(!m)return null;const[,I,l,c,x]=m,L=x.trim();return N.some(d=>L.startsWith(d))?null:{startTimeMs:(parseInt(I)*6e4+parseInt(l)*1e3+parseInt(c.padEnd(3,"0"))).toString(),words:L}}).filter(y=>y!==null)};function xn({title:a="",artist:r="",album:h="",currentTime:N,translateTo:y}){const[m,I]=s.useState([]),[l,c]=s.useState(null),[x,L]=s.useState(-1),[C,d]=s.useState(!1),[g,R]=s.useState(!1),[Z,Y]=s.useState(),D=s.useRef(null),B=s.useRef(N),v=k(U=>U.lyricsRefreshNonce),H=s.useRef(0);s.useEffect(()=>{if(I([]),c(null),L(-1),d(!0),R(!1),Y(void 0),!a&&!r&&!h){d(!1);return}if(ts()){d(!1),Y("iPod requires an internet connection");return}const U=`${a}__${r}__${h}`,S=H.current!==v;if(!S&&U===D.current){d(!1),H.current=v;return}let b=!1;const p=new AbortController,E=setTimeout(()=>{p.abort(),console.warn("Lyrics fetch timed out")},15e3);return fetch(ss("/api/lyrics"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:a,artist:r,album:h,force:S}),signal:p.signal}).then(async j=>{if(clearTimeout(E),!j.ok){if(j.status===404||p.signal.aborted)return null;throw new Error(`Failed to fetch lyrics (status ${j.status})`)}return j.json()}).then(j=>{if(b)return;if(!j)throw new Error("No lyrics found or fetch timed out");const X=j==null?void 0:j.lyrics;if(!X)throw new Error("No lyrics found");const T=X.replace(/\u200b/g,""),w=cs(T,(j==null?void 0:j.title)??a,(j==null?void 0:j.artist)??r);I(w),D.current=U,k.setState({currentLyrics:{lines:w}})}).catch(j=>{b||(console.error("useLyrics original fetch error",j),j instanceof DOMException&&j.name==="AbortError"?Y("Lyrics search timed out."):Y(j instanceof Error?j.message:"Unknown error fetching lyrics"),I([]),L(-1),k.setState({currentLyrics:null}))}).finally(()=>{b||d(!1),H.current=v,clearTimeout(E)}),()=>{b=!0,p.abort(),clearTimeout(E)}},[a,r,h,v]),s.useEffect(()=>{if(!y||m.length===0){c(null),R(!1),y&&m.length>0;return}if(C){R(!1);return}if(ts()){R(!1),Y("iPod requires an internet connection");return}let U=!1;R(!0),Y(void 0);const S=new AbortController,b=setTimeout(()=>{S.abort(),console.warn("Lyrics translation timed out")},12e4);return fetch(ss("/api/translate-lyrics"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lines:m,targetLanguage:y}),signal:S.signal}).then(async p=>{clearTimeout(b);const E=await p.text();if(!p.ok){const j=E.startsWith("Error: ")?E.substring(7):E;throw new Error(j||`Translation request failed with status ${p.status}`)}return E}).then(p=>{if(!U)if(p){const E=cs(p,a,r);c(E)}else c([])}).catch(p=>{U||(console.error("useLyrics translation error",p),p instanceof DOMException&&p.name==="AbortError"?Y("Lyrics translation timed out."):Y(p instanceof Error?p.message:"Unknown error during translation"),c(null))}).finally(()=>{U||R(!1),clearTimeout(b)}),()=>{U=!0,S.abort(),clearTimeout(b)}},[m,y,C,a,r]);const J=l||m,Q=s.useCallback(U=>{if(!J.length)return-1;const S=U*1e3;let b=J.findIndex((p,E)=>{const j=E+1<J.length?parseInt(J[E+1].startTimeMs):1/0;return S>=parseInt(p.startTimeMs)&&S<j});return b===-1&&J.length>0&&S>=parseInt(J[J.length-1].startTimeMs)&&(b=J.length-1),b},[J]);s.useEffect(()=>{B.current=N,L(Q(N))},[N,Q]);const ee=s.useCallback(U=>{B.current=U,L(Q(U))},[Q]);return{lines:J,currentLine:x,isLoading:C,isTranslating:g,error:Z,updateCurrentTimeManually:ee}}const gn=5*60*1e3;function bn(a){const{t:r}=$e(),h=k(l=>l.syncLibrary),N=s.useRef(null),y=s.useRef(0);return s.useEffect(()=>{if(!a){N.current&&(clearInterval(N.current),N.current=null);return}const l=async()=>{try{const x=k.getState().tracks,L=x.length===0,d=await(await fetch("/data/ipod-videos.json")).json(),g=(d.videos||d).map(v=>({id:v.id,url:v.url,title:v.title,artist:v.artist,album:v.album??"",lyricOffset:v.lyricOffset})),R=d.version||1,Z=new Set(x.map(v=>v.id)),Y=g.filter(v=>!Z.has(v.id)).length;let D=0;const B=new Map(g.map(v=>[v.id,v]));if(x.forEach(v=>{const H=B.get(v.id);H&&(v.title!==H.title||v.artist!==H.artist||v.album!==H.album||v.url!==H.url||v.lyricOffset!==H.lyricOffset)&&D++}),console.log("[iPod] Auto update check:",{newTracksCount:Y,tracksUpdated:D,currentTracksCount:x.length,serverTracksCount:g.length,serverVersion:R,currentLastKnownVersion:k.getState().lastKnownVersion}),Y>0||D>0)try{const v=await h(),H=L&&v.newTracksAdded>0?r("apps.ipod.dialogs.addedSongsToTop",{count:v.newTracksAdded,plural:v.newTracksAdded===1?"":"s"}):v.newTracksAdded>0?r("apps.ipod.dialogs.autoUpdatedLibraryAddedSongs",{newCount:v.newTracksAdded,newPlural:v.newTracksAdded===1?"":"s",updatedText:v.tracksUpdated>0?r("apps.ipod.dialogs.andUpdated",{count:v.tracksUpdated,plural:v.tracksUpdated===1?"":"s"}):""}):r("apps.ipod.dialogs.autoUpdatedTrackMetadata",{count:v.tracksUpdated});fe.success(r("apps.ipod.dialogs.libraryAutoUpdated"),{description:H,duration:4e3}),console.log(`[iPod] Auto-updated: ${v.newTracksAdded} new tracks, ${v.tracksUpdated} updated tracks`)}catch(v){console.error("Error auto-updating library:",v),fe.error(r("apps.ipod.dialogs.autoUpdateFailed"),{description:r("apps.ipod.dialogs.failedToAutoUpdateLibrary"),duration:4e3})}}catch(x){console.error("Error checking for library updates:",x)}},c=setTimeout(()=>{console.log("[iPod] Running immediate library update check on app activation"),l(),y.current=Date.now()},100);return N.current=setInterval(()=>{l(),y.current=Date.now()},gn),()=>{clearTimeout(c),N.current&&(clearInterval(N.current),N.current=null)}},[a,h]),{manualCheck:async()=>{try{const l=k.getState().tracks.length===0,c=await h();if(c.newTracksAdded>0||c.tracksUpdated>0){const x=l&&c.newTracksAdded>0?r("apps.ipod.dialogs.addedSongsToTop",{count:c.newTracksAdded,plural:c.newTracksAdded===1?"":"s"}):r("apps.ipod.dialogs.addedNewSongsToTop",{newCount:c.newTracksAdded,newPlural:c.newTracksAdded===1?"":"s",updatedText:c.tracksUpdated>0?r("apps.ipod.dialogs.andUpdated",{count:c.tracksUpdated,plural:c.tracksUpdated===1?"":"s"}):"",total:c.totalTracks});return fe.success(r("apps.ipod.dialogs.libraryUpdated"),{description:x}),!0}else return fe.info(r("apps.ipod.dialogs.noUpdates"),{description:r("apps.ipod.dialogs.libraryAlreadyUpToDate")}),!1}catch(l){return console.error("Error during manual library update check:",l),fe.error(r("apps.ipod.dialogs.updateCheckFailed"),{description:r("apps.ipod.dialogs.failedToCheckForLibraryUpdates")}),!1}},manualSync:async()=>{try{const l=k.getState().tracks.length===0,c=await h();if(c.newTracksAdded>0||c.tracksUpdated>0){const x=l&&c.newTracksAdded>0?r("apps.ipod.dialogs.addedSongsToTop",{count:c.newTracksAdded,plural:c.newTracksAdded===1?"":"s"}):r("apps.ipod.dialogs.addedNewSongsToTop",{newCount:c.newTracksAdded,newPlural:c.newTracksAdded===1?"":"s",updatedText:c.tracksUpdated>0?r("apps.ipod.dialogs.andUpdated",{count:c.tracksUpdated,plural:c.tracksUpdated===1?"":"s"}):"",total:c.totalTracks});fe.success(r("apps.ipod.dialogs.librarySynced"),{description:x})}else fe.info(r("apps.ipod.dialogs.librarySynced"),{description:r("apps.ipod.dialogs.libraryUpToDateWithSongs",{count:c.totalTracks})});return!0}catch(l){return console.error("Error during library sync:",l),fe.error(r("apps.ipod.dialogs.syncFailed"),{description:r("apps.ipod.dialogs.failedToSyncWithServerLibrary")}),!1}}}}function yn(a){const r=a.match(/(?:youtube\.com\/(?:[^/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?/\s]{11})/);return r?r[1]:null}function wn({currentTrack:a,isPlaying:r,onTogglePlay:h,onNextTrack:N,onPreviousTrack:y,onRestore:m}){const{t:I}=$e(),l=jt(),c=vt(d=>d.current),x=s.useMemo(()=>c==="xp"||c==="win98"?"calc(env(safe-area-inset-bottom, 0px) + 42px)":c==="macosx"?"calc(env(safe-area-inset-bottom, 0px) + 72px)":"calc(env(safe-area-inset-bottom, 0px) + 16px)",[c]),L=a!=null&&a.url?(()=>{const d=yn(a.url);return d?`https://img.youtube.com/vi/${d}/mqdefault.jpg`:null})():null,C=c==="macosx";return ds.createPortal(e.jsxs(Oe.div,{initial:{opacity:0,y:20,scale:.9,x:C?"-50%":0},animate:{opacity:1,y:0,scale:1,x:C?"-50%":0},exit:{opacity:0,y:20,scale:.9,x:C?"-50%":0},transition:{duration:.2,ease:"easeOut"},className:`fixed flex items-center gap-3 bg-black/40 backdrop-blur-xl rounded-xl shadow-2xl border border-white/20 p-2 pr-3 cursor-pointer select-none ${C?"left-1/2 z-[4]":"right-3 z-[9998]"}`,style:{maxWidth:"min(400px, calc(100vw - 2rem))",bottom:x},onClick:m,children:[e.jsxs("div",{className:"relative w-14 h-14 flex-shrink-0 overflow-hidden",style:{borderRadius:"8px"},children:[L?e.jsx("img",{src:L,alt:(a==null?void 0:a.title)||"",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-white/10 text-white/40",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"})})}),r&&e.jsx("div",{className:"absolute inset-0 bg-black/30 flex items-center justify-center",children:e.jsx("div",{className:"flex items-end gap-[2px] h-4",children:[0,1,2].map(d=>e.jsx(Oe.div,{className:"w-1 bg-white rounded-full",animate:{height:["40%","100%","40%"]},transition:{duration:.6,repeat:1/0,delay:d*.15,ease:"easeInOut"}},d))})})]}),e.jsxs("div",{className:"flex-1 min-w-0 mr-1",children:[e.jsx("div",{className:"text-white text-sm font-medium truncate",children:(a==null?void 0:a.title)||I("apps.ipod.status.noTrack")}),(a==null?void 0:a.artist)&&e.jsx("div",{className:"text-white/60 text-xs truncate",children:a.artist})]}),e.jsxs("div",{className:"flex items-center gap-1",onClick:d=>d.stopPropagation(),children:[e.jsx("button",{onClick:y,className:"w-8 h-8 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors","aria-label":I("apps.ipod.ariaLabels.previousTrack"),children:e.jsx("span",{className:"text-sm",children:"⏮"})}),e.jsx("button",{onClick:h,disabled:l,className:"w-9 h-9 flex items-center justify-center rounded-full bg-white/10 text-white hover:bg-white/20 transition-colors disabled:opacity-50","aria-label":I("apps.ipod.ariaLabels.playPause"),children:e.jsx("span",{className:"text-base",children:r?"⏸":"▶"})}),e.jsx("button",{onClick:N,className:"w-8 h-8 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors","aria-label":I("apps.ipod.ariaLabels.nextTrack"),children:e.jsx("span",{className:"text-sm",children:"⏭"})})]})]}),document.body)}function kn({children:a,onClose:r,togglePlay:h,nextTrack:N,previousTrack:y,seekTime:m,showStatus:I,showOfflineStatus:l,registerActivity:c,isPlaying:x,statusMessage:L,currentTranslationCode:C,onSelectTranslation:d,currentAlignment:g,onCycleAlignment:R,currentKoreanDisplay:Z,onToggleKoreanDisplay:Y,fullScreenPlayerRef:D}){const{t:B}=$e(),v=s.useRef(null),[H,J]=s.useState(!1),[Q,ee]=s.useState(!0),U=s.useRef(null),S=jt(),[b,p]=s.useState(!1),E=s.useMemo(()=>tn(),[]),j=s.useMemo(()=>[{label:B("apps.ipod.translationLanguages.original"),code:null},{label:"English",code:"en"},{label:"中文",code:"zh-TW"},{label:"日本語",code:"ja"},{label:"한국어",code:"ko"},{label:"Español",code:"es"},{label:"Français",code:"fr"},{label:"Deutsch",code:"de"},{label:"Português",code:"pt"},{label:"Italiano",code:"it"},{label:"Русский",code:"ru"}],[B]),X=s.useCallback(()=>{var n,V;const f=(V=(n=D==null?void 0:D.current)==null?void 0:n.getInternalPlayer)==null?void 0:V.call(n);return f&&typeof f.getPlayerState=="function"?f.getPlayerState()===1:!1},[D]),T=s.useCallback(()=>{ee(!0),U.current&&clearTimeout(U.current),X()&&!H&&(U.current=window.setTimeout(()=>{ee(!1)},2e3))},[X,H]),w=s.useRef({onClose:r,togglePlay:h,nextTrack:N,previousTrack:y,seekTime:m,showStatus:I,registerActivity:c,onSelectTranslation:d,onCycleAlignment:R,onToggleKoreanDisplay:Y,setIsLangMenuOpen:J});s.useEffect(()=>{w.current={onClose:r,togglePlay:h,nextTrack:N,previousTrack:y,seekTime:m,showStatus:I,registerActivity:c,onSelectTranslation:d,onCycleAlignment:R,onToggleKoreanDisplay:Y,setIsLangMenuOpen:J}},[r,h,N,y,m,I,c,d,R,Y]);const F=s.useRef(null),P=80,z=500,se=100,Se=s.useCallback(f=>{if(f.target.closest("[data-toolbar]"))return;b||p(!0);const V=f.touches[0];F.current={x:V.clientX,y:V.clientY,time:Date.now()}},[b]),Ce=s.useCallback(f=>{if(!F.current)return;if(f.target.closest("[data-toolbar]")){F.current=null;return}if(E&&!x&&b){F.current=null;return}const te=f.changedTouches[0],K=te.clientX-F.current.x,ce=te.clientY-F.current.y,ie=Date.now()-F.current.time,_=Math.abs(K)>P&&Math.abs(ce)<se&&ie<z,q=ce>P&&Math.abs(K)<se&&ie<z;if(_){f.preventDefault();const ae=w.current;ae.registerActivity(),K>0?(ae.previousTrack(),setTimeout(()=>{const de=k.getState().currentIndex,oe=k.getState().tracks[de];if(oe){const ye=oe.artist?` - ${oe.artist}`:"";ae.showStatus(`⏮ ${oe.title}${ye}`)}},100)):(ae.nextTrack(),setTimeout(()=>{const de=k.getState().currentIndex,oe=k.getState().tracks[de];if(oe){const ye=oe.artist?` - ${oe.artist}`:"";ae.showStatus(`⏭ ${oe.title}${ye}`)}},100))}else q&&(f.preventDefault(),w.current.onClose());F.current=null},[E,x,b]);s.useEffect(()=>{const f=setTimeout(()=>{v.current&&v.current.requestFullscreen().catch(n=>{console.error("Error attempting to enable fullscreen:",n)})},100);return()=>clearTimeout(f)},[]);const me=s.useMemo(()=>{var f;if(!C)return null;switch(C){case"zh-TW":return"中";case"en":return"En";case"ja":return"日";case"ko":return"한";case"es":return"Es";case"fr":return"Fr";case"de":return"De";case"pt":return"Pt";case"it":return"It";case"ru":return"Ru";default:return((f=C[0])==null?void 0:f.toUpperCase())??"?"}},[C]);return s.useEffect(()=>{const f=v.current;if(f)return f.addEventListener("touchstart",Se),f.addEventListener("touchend",Ce),()=>{f.removeEventListener("touchstart",Se),f.removeEventListener("touchend",Ce)}},[]),s.useEffect(()=>{const f=()=>{b||p(!0);const te=X();E&&!te&&b||w.current.registerActivity(),ee(!0),U.current&&clearTimeout(U.current),te&&!H&&(U.current=window.setTimeout(()=>{ee(!1)},2e3))},n=X();return(H||!n)&&ee(!0),window.addEventListener("mousemove",f,{passive:!0}),window.addEventListener("keydown",f),window.addEventListener("touchstart",f,{passive:!0}),window.addEventListener("click",f,{passive:!0}),X()?f():ee(!0),()=>{window.removeEventListener("mousemove",f),window.removeEventListener("keydown",f),window.removeEventListener("touchstart",f),window.removeEventListener("click",f),U.current&&(clearTimeout(U.current),U.current=null)}},[H,x,b,E,X]),s.useEffect(()=>{const f=n=>{const V=w.current;V.registerActivity(),n.key==="Escape"?V.onClose():n.key===" "?(n.preventDefault(),S?l():(V.togglePlay(),V.showStatus(x?"⏸":"▶"))):n.key==="ArrowLeft"?V.seekTime(-5):n.key==="ArrowRight"?V.seekTime(5):n.key==="ArrowUp"?(V.previousTrack(),setTimeout(()=>{const te=k.getState().currentIndex,K=k.getState().tracks[te];if(K){const ce=K.artist?` - ${K.artist}`:"";V.showStatus(`⏮ ${K.title}${ce}`)}},800)):n.key==="ArrowDown"&&(V.nextTrack(),setTimeout(()=>{const te=k.getState().currentIndex,K=k.getState().tracks[te];if(K){const ce=K.artist?` - ${K.artist}`:"";V.showStatus(`⏭ ${K.title}${ce}`)}},800))};return window.addEventListener("keydown",f),()=>window.removeEventListener("keydown",f)},[x]),ds.createPortal(e.jsxs("div",{ref:v,className:"ipod-force-font fixed inset-0 z-[9999] bg-black select-none flex flex-col",onClick:f=>{var K,ce;if(f.target.closest("[data-toolbar]"))return;b||p(!0);const V=X();if(!(E&&!V&&b)&&!V){const ie=w.current;ie.registerActivity(),S?l():(ie.togglePlay(),ie.showStatus("▶"))}if(E&&x&&b){const ie=(ce=(K=D==null?void 0:D.current)==null?void 0:K.getInternalPlayer)==null?void 0:ce.call(K);if(ie&&typeof ie.getPlayerState=="function"&&ie.getPlayerState()!==1){const q=w.current;q.registerActivity(),typeof ie.playVideo=="function"&&(ie.playVideo(),q.showStatus("▶"))}}},children:[e.jsx(Ze,{children:L&&e.jsx(Oe.div,{className:"absolute inset-0 z-40",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},children:e.jsx("div",{className:"absolute pointer-events-none",style:{top:"calc(max(env(safe-area-inset-top), 0.75rem) + clamp(1rem, 6dvh, 3rem))",left:"calc(max(env(safe-area-inset-left), 0.75rem) + clamp(1rem, 6dvw, 4rem))"},children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"font-chicago text-white text-[min(5vw,5vh)] relative z-10",children:L}),e.jsx("div",{className:"font-chicago text-black text-[min(5vw,5vh)] absolute inset-0",style:{WebkitTextStroke:"5px black",textShadow:"none"},children:L})]})})})}),e.jsx("div",{className:"flex-1 min-h-0",children:typeof a=="function"?a({controlsVisible:Q||H||!X(),isLangMenuOpen:H}):a}),e.jsx("div",{"data-toolbar":!0,className:be("w-full flex justify-center z-[10001] transition-opacity duration-200",Q||H||!X()?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none"),style:{paddingBottom:"calc(max(env(safe-area-inset-bottom), 0.75rem) + clamp(1rem, 6dvh, 4rem))"},onClick:f=>{f.stopPropagation(),T()},children:e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"bg-neutral-800/35 border border-white/10 backdrop-blur-sm rounded-full shadow-lg flex items-center gap-1 md:gap-2 px-2 py-1 font-geneva-12",children:[e.jsx("button",{onClick:f=>{f.stopPropagation(),c(),y(),setTimeout(()=>{const n=k.getState().currentIndex,V=k.getState().tracks[n];if(V){const te=V.artist?` - ${V.artist}`:"";I(`⏮ ${V.title}${te}`)}},100)},"aria-label":B("apps.ipod.ariaLabels.previousTrack"),className:"w-9 h-9 md:w-12 md:h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors focus:outline-none",title:B("apps.ipod.menu.previous"),children:e.jsx("span",{className:"text-[18px] md:text-[22px]",children:"⏮"})}),e.jsx("button",{onClick:f=>{f.stopPropagation(),c();const n=X();if(S)l();else{h();const V=X();I(V?"⏸":"▶"),n||setTimeout(()=>T(),100)}},"aria-label":B("apps.ipod.ariaLabels.playPause"),className:"w-9 h-9 md:w-12 md:h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors focus:outline-none",title:B("apps.ipod.ariaLabels.playPause"),children:e.jsx("span",{className:"text-[18px] md:text-[22px]",children:X()?"⏸":"▶"})}),e.jsx("button",{onClick:f=>{f.stopPropagation(),c(),N(),setTimeout(()=>{const n=k.getState().currentIndex,V=k.getState().tracks[n];if(V){const te=V.artist?` - ${V.artist}`:"";I(`⏭ ${V.title}${te}`)}},100)},"aria-label":B("apps.ipod.ariaLabels.nextTrack"),className:"w-9 h-9 md:w-12 md:h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors focus:outline-none",title:B("apps.ipod.menu.next"),children:e.jsx("span",{className:"text-[18px] md:text-[22px]",children:"⏭"})}),e.jsx("button",{onClick:f=>{f.stopPropagation(),c(),R()},"aria-label":B("apps.ipod.ariaLabels.cycleLyricLayout"),className:"w-9 h-9 md:w-12 md:h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors focus:outline-none",title:g,children:g==="focusThree"?e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"md:w-[26px] md:h-[26px]",children:[e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"6"}),e.jsx("line",{x1:"4",y1:"12",x2:"20",y2:"12"}),e.jsx("line",{x1:"6",y1:"18",x2:"18",y2:"18"})]}):g==="center"?e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"md:w-[26px] md:h-[26px]",children:e.jsx("line",{x1:"6",y1:"12",x2:"18",y2:"12"})}):e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"md:w-[26px] md:h-[26px]",children:[e.jsx("line",{x1:"4",y1:"8",x2:"13",y2:"8"}),e.jsx("line",{x1:"11",y1:"16",x2:"20",y2:"16"})]})}),e.jsx("button",{onClick:f=>{f.stopPropagation(),c(),Y()},"aria-label":B("apps.ipod.ariaLabels.toggleHangulRomanization"),className:"w-9 h-9 md:w-12 md:h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors focus:outline-none",children:e.jsx("span",{className:"text-[16px] md:text-[18px]",children:Z==="romanized"?"Ko":"한"})}),e.jsx("button",{onClick:f=>{f.stopPropagation(),J(n=>!n),c()},"aria-label":B("apps.ipod.ariaLabels.translateLyrics"),className:"w-9 h-9 md:w-12 md:h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors focus:outline-none",children:me?e.jsx("span",{className:"inline-flex items-center justify-center w-[24px] h-[24px] md:w-[28px] md:h-[28px] leading-none text-[16px] md:text-[18px]",children:me}):e.jsx("span",{className:"inline-flex items-center justify-center w-[24px] h-[24px] md:w-[28px] md:h-[28px] leading-none text-[16px] md:text-[18px]",children:"Aa"})}),e.jsx("button",{onClick:r,className:"w-9 h-9 md:w-12 md:h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors focus:outline-none","aria-label":B("apps.ipod.ariaLabels.closeFullscreen"),title:B("common.dialog.close"),children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"22",height:"22",className:"md:w-[26px] md:h-[26px]",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsx(Ze,{children:H&&e.jsx(Oe.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.15},className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 max-h-[50vh] overflow-y-auto rounded-lg border border-white/10 bg-neutral-900/80 backdrop-blur-md shadow-xl",onClick:f=>f.stopPropagation(),children:e.jsx("div",{className:"py-2",children:j.map(f=>{const n=C===f.code||!f.code&&!C;return e.jsxs("button",{onClick:()=>{w.current.onSelectTranslation(f.code),w.current.setIsLangMenuOpen(!1),w.current.registerActivity()},className:be("w-full text-left px-4 py-2 text-[16px] font-geneva-12 transition-colors",n?"text-white bg-white/10":"text-white/80 hover:text-white hover:bg-white/10"),children:[e.jsx("span",{className:"inline-block w-4",children:n?"✓":""}),e.jsx("span",{children:f.label})]},f.code||"off")})})})})]})})]}),document.body)}function $n({isWindowOpen:a,onClose:r,isForeground:h,skipInitialSound:N,initialData:y,instanceId:m,onNavigateNext:I,onNavigatePrevious:l}){var Ht,Xt,Kt,qt,Gt,Jt,Zt,Qt;const{play:c}=ns(as.BUTTON_CLICK),{play:x}=ns(as.IPOD_CLICK_WHEEL),L=zs(100,50),C=jt(),{tracks:d,currentIndex:g,loopCurrent:R,loopAll:Z,isShuffled:Y,isPlaying:D,showVideo:B,backlightOn:v}=k(Ws(t=>({tracks:t.tracks,currentIndex:t.currentIndex,loopCurrent:t.loopCurrent,loopAll:t.loopAll,isShuffled:t.isShuffled,isPlaying:t.isPlaying,showVideo:t.showVideo,backlightOn:t.backlightOn}))),{theme:H,lcdFilterOn:J,showLyrics:Q,lyricsAlignment:ee,chineseVariant:U,koreanDisplay:S,lyricsTranslationLanguage:b,isFullScreen:p,toggleFullScreen:E,setCurrentIndex:j,toggleLoopAll:X,toggleLoopCurrent:T,toggleShuffle:w,togglePlay:F,setIsPlaying:P,toggleVideo:z,toggleBacklight:se,setTheme:Se,clearLibrary:Ce,nextTrack:me,previousTrack:f}=ps(t=>({theme:t.theme,lcdFilterOn:t.lcdFilterOn,showLyrics:t.showLyrics,lyricsAlignment:t.lyricsAlignment,chineseVariant:t.chineseVariant,koreanDisplay:t.koreanDisplay,lyricsTranslationLanguage:t.lyricsTranslationLanguage,isFullScreen:t.isFullScreen,toggleFullScreen:t.toggleFullScreen,setCurrentIndex:t.setCurrentIndex,toggleLoopAll:t.toggleLoopAll,toggleLoopCurrent:t.toggleLoopCurrent,toggleShuffle:t.toggleShuffle,togglePlay:t.togglePlay,setIsPlaying:t.setIsPlaying,toggleVideo:t.toggleVideo,toggleBacklight:t.toggleBacklight,setTheme:t.setTheme,clearLibrary:t.clearLibrary,nextTrack:t.nextTrack,previousTrack:t.previousTrack})),{t:n}=$e(),V=Ys("ipod",sn),te=k(t=>{var o;return((o=t.tracks[t.currentIndex])==null?void 0:o.lyricOffset)??0}),K=s.useRef(h),{bringToForeground:ce,clearIpodInitialData:ie,instances:_,restoreInstance:q}=rs(t=>({bringToForeground:t.bringToForeground,clearIpodInitialData:t.clearInstanceInitialData,instances:t.instances,restoreInstance:t.restoreInstance})),ae=m?((Ht=_[m])==null?void 0:Ht.isMinimized)??!1:!1,de=s.useRef(null),[oe,ye]=s.useState(Date.now()),Le=s.useRef(null),[Ee,it]=s.useState(null),Be=s.useRef(null),[xe,i]=s.useState(0),[re,we]=s.useState(0),[ke,Qe]=s.useState(""),[bt,Ue]=s.useState(!1),[et,St]=s.useState(!1),[xs,Tt]=s.useState(!1),[gs,yt]=s.useState(!1),[bs,It]=s.useState(!1),[ys,Ct]=s.useState(!1),ws=s.useMemo(()=>{const t=k.getState();return!(t.tracks.length>0&&t.currentIndex>=0&&t.currentIndex<t.tracks.length)},[]),[_e,Ne]=s.useState(ws),[ot,Ae]=s.useState(0),[ks,je]=s.useState("forward"),[pe,Te]=s.useState([]),[Lt,De]=s.useState(!1),We=s.useRef(null),Me=s.useRef(null),Nt=s.useRef(null),Ye=s.useRef(!1),lt=s.useRef(!1),{manualSync:vs}=bn(a&&(h??!1)),ct=navigator.userAgent,js=/iP(hone|od|ad)/.test(ct),Ss=/Safari/.test(ct)&&!/Chrome/.test(ct)&&!/CriOS/.test(ct),tt=js&&Ss,O=s.useCallback(t=>{it(t),Be.current&&clearTimeout(Be.current),Be.current=setTimeout(()=>{it(null)},2e3)},[]),Re=s.useCallback(()=>{fe.error(n("apps.ipod.dialogs.youreOffline"),{id:"ipod-offline",description:n("apps.ipod.dialogs.ipodRequiresInternet")}),O("🚫")},[O,n]),W=s.useCallback(()=>{ye(Date.now()),lt.current=!0,k.getState().backlightOn||se()},[se]),dt=s.useCallback(()=>{w(),O(k.getState().isShuffled?n("apps.ipod.status.shuffleOn"):n("apps.ipod.status.shuffleOff")),W()},[w,O,W,n]),He=s.useCallback(()=>{se();const t=k.getState().backlightOn;O(n(t?"apps.ipod.status.lightOn":"apps.ipod.status.lightOff")),t?W():(ye(Date.now()),lt.current=!0)},[se,O,W,ye,n]),At=s.useCallback(t=>{Se(t),O(n(t==="classic"?"apps.ipod.status.themeClassic":t==="black"?"apps.ipod.status.themeBlack":"apps.ipod.status.themeU2")),W()},[Se,O,W,n]),Ts=s.useCallback(t=>{t===He||W(),t()},[W,He]),Mt=s.useCallback(()=>{W();const t=k.getState().loopAll;k.getState().loopCurrent?(T(),O(n("apps.ipod.status.repeatOff"))):t?(X(),T(),O(n("apps.ipod.status.repeatOne"))):(X(),O(n("apps.ipod.status.repeatAll")))},[W,X,T,O,n]),Et=s.useCallback(()=>{const t=k.getState().theme;At(t==="classic"?"black":t==="black"?"u2":"classic")},[At]);s.useEffect(()=>(Le.current&&clearTimeout(Le.current),v&&(Le.current=setTimeout(()=>{const t=k.getState().showVideo,o=k.getState().isPlaying;Date.now()-oe>=5e3&&!(t&&o)&&se()},5e3)),()=>{Le.current&&clearTimeout(Le.current)}),[v,oe,se]),s.useEffect(()=>{h&&!K.current?(k.getState().backlightOn||se(),W()):!h&&K.current&&k.getState().backlightOn&&se(),K.current=h},[h,se,W]),s.useEffect(()=>{i(0),k.setState({currentLyrics:null})},[g]),s.useEffect(()=>()=>{Be.current&&clearTimeout(Be.current)},[]);const[ut,Xe]=s.useState([]),Ke=s.useMemo(()=>{const t=d.reduce((u,A,M)=>{const $=A.artist||n("apps.ipod.menu.unknownArtist");return u[$]||(u[$]=[]),u[$].push({track:A,index:M}),u},{}),o=Object.keys(t).sort((u,A)=>u.localeCompare(A,void 0,{sensitivity:"base"}));return[{label:n("apps.ipod.menuItems.allSongs"),action:()=>{W(),je("forward");const u=n("apps.ipod.menuItems.allSongs"),A=n("apps.ipod.menuItems.music"),M=d.map(($,ne)=>({label:$.title,action:()=>{if(W(),C){Re();return}j(ne),P(!0),je("forward"),Ne(!1),De(!1),Xe([A,u]),k.getState().showVideo&&z()},showChevron:!1}));Te($=>[...$,{title:u,items:M,selectedIndex:0}]),Ae(0)},showChevron:!0},...o.map(u=>({label:u,action:()=>{W(),je("forward");const A=t[u].map(({track:M,index:$})=>({label:M.title,action:()=>{W(),j($),P(!0),je("forward"),Ne(!1),De(!1),Xe([n("apps.ipod.menuItems.music"),u]),k.getState().showVideo&&z()},showChevron:!1}));Te(M=>[...M,{title:u,items:A,selectedIndex:0}]),Ae(0)},showChevron:!0}))]},[d,W,j,P,z,O,n]),pt=s.useMemo(()=>{const t=R,o=Z,u=Y,A=v,M=H;return[{label:n("apps.ipod.menuItems.repeat"),action:Mt,showChevron:!1,value:n(t?"apps.ipod.menuItems.one":o?"apps.ipod.menuItems.all":"apps.ipod.menuItems.off")},{label:n("apps.ipod.menuItems.shuffle"),action:dt,showChevron:!1,value:n(u?"apps.ipod.menuItems.on":"apps.ipod.menuItems.off")},{label:n("apps.ipod.menuItems.backlight"),action:He,showChevron:!1,value:n(A?"apps.ipod.menuItems.on":"apps.ipod.menuItems.off")},{label:n("apps.ipod.menuItems.theme"),action:Et,showChevron:!1,value:n(M==="classic"?"apps.ipod.menu.classic":M==="black"?"apps.ipod.menu.black":"apps.ipod.menu.u2")}]},[R,Z,Y,v,H,Mt,dt,He,Et,n]),qe=s.useMemo(()=>{const t=n("apps.ipod.menuItems.music"),o=n("apps.ipod.menuItems.settings");return[{label:t,action:()=>{W(),k.getState().showVideo&&z(),je("forward"),Te(u=>[...u,{title:t,items:Ke,selectedIndex:0}]),Ae(0)},showChevron:!0},{label:n("apps.ipod.menuItems.extras"),action:()=>{W(),k.getState().showVideo&&z(),Ue(!0)},showChevron:!0},{label:o,action:()=>{W(),k.getState().showVideo&&z(),je("forward"),Te(u=>[...u,{title:o,items:pt,selectedIndex:0}]),Ae(0)},showChevron:!0},{label:n("apps.ipod.menuItems.shuffleSongs"),action:()=>{W(),k.getState().showVideo&&z(),dt(),Ne(!1)},showChevron:!1},{label:n("apps.ipod.menuItems.backlight"),action:()=>{He()},showChevron:!1},{label:n("apps.ipod.menuItems.nowPlaying"),action:()=>{W(),je("forward"),Ne(!1),De(!0)},showChevron:!0}]},[W,z,Ke,pt,dt,He,O,n]);s.useEffect(()=>{pe.length===0&&Te([{title:n("apps.ipod.menuItems.ipod"),items:qe,selectedIndex:0}])},[n,qe,pe.length]),s.useEffect(()=>{Te(t=>{if(t.length===0)return t;const o=t.length-1,u=t[o];let A=null;const M=n("apps.ipod.menuItems.ipod"),$=n("apps.ipod.menuItems.music"),ne=n("apps.ipod.menuItems.settings"),ve=n("apps.ipod.menuItems.allSongs");if(u.title===M)A=qe;else if(u.title===$)A=Ke;else if(u.title===ne)A=pt;else if(u.title===ve)A=d.map((le,ge)=>({label:le.title,action:()=>{W(),j(ge),P(!0),je("forward"),Ne(!1),De(!1),Xe([n("apps.ipod.menuItems.music"),n("apps.ipod.menuItems.allSongs")]),k.getState().showVideo&&z()},showChevron:!1}));else{const le=d.reduce((ge,Ve,st)=>{const Ge=Ve.artist||n("apps.ipod.menu.unknownArtist");return ge[Ge]||(ge[Ge]=[]),ge[Ge].push({track:Ve,index:st}),ge},{});le[u.title]&&(A=le[u.title].map(({track:Ve,index:st})=>({label:Ve.title,action:()=>{W(),j(st),P(!0),je("forward"),Ne(!1),De(!1),Xe([n("apps.ipod.menuItems.music"),u.title]),k.getState().showVideo&&z()},showChevron:!1})))}if(A&&u.items!==A){const le=[...t];return le[o]={...u,items:A},le}return t})},[qe,Ke,pt,pe.length,d,W,j,P,z,n]);const wt=s.useCallback(async t=>{It(!0);try{if(await k.getState().addTrackFromVideoId(t))O(n("apps.ipod.status.added")),Qe(""),Ue(!1);else throw new Error("Failed to add track")}catch(o){console.error("Failed to add track:",o),O(`❌ Error adding: ${o instanceof Error?o.message:"Unknown error"}`)}finally{It(!1)}},[O]),Pt=s.useCallback(async t=>{const o=`https://www.youtube.com/watch?v=${t}`;try{await wt(o)}catch(u){console.error(`[iPod] Error adding track for videoId ${t}:`,u),O(`❌ Error adding ${t}`)}},[wt,O]),ht=s.useCallback(async t=>{const u=k.getState().tracks.findIndex(ve=>ve.id===t),A=navigator.userAgent,M=/iP(hone|od|ad)/.test(A),$=/Safari/.test(A)&&!/Chrome/.test(A)&&!/CriOS/.test(A),ne=!(M||$);if(u!==-1)fe.info(n("apps.ipod.dialogs.openedSharedTrack")),console.log(`[iPod] Video ID ${t} found in tracks. Playing.`),j(u),ne&&P(!0),Ne(!1);else if(fe.info(n("apps.ipod.dialogs.addingNewTrack")),console.log(`[iPod] Video ID ${t} not found. Adding and playing.`),await Pt(t),ne&&!C){const ve=k.getState().currentIndex,le=k.getState().tracks[ve];(le==null?void 0:le.id)===t?P(!0):console.warn("[iPod] Index mismatch after adding track, autoplay skipped.")}else C&&Re()},[j,P,Ne,Pt]);s.useEffect(()=>{if(a&&(y!=null&&y.videoId)&&typeof y.videoId=="string"){if(de.current===y)return;const t=y.videoId;console.log(`[iPod] Processing initialData.videoId on mount: ${t}`),setTimeout(()=>{ht(t).then(()=>{m&&ie(m),console.log(`[iPod] Cleared initialData after processing ${t}`)}).catch(o=>{console.error(`[iPod] Error processing initial videoId ${t}:`,o)})},100),de.current=y}},[a,y,ht,ie,m]),s.useEffect(()=>{const t=o=>{var u;if(o.detail.appId==="ipod"&&((u=o.detail.initialData)!=null&&u.videoId)){if(de.current===o.detail.initialData)return;const A=o.detail.initialData.videoId;console.log(`[iPod] Received updateApp event with videoId: ${A}`),ce("ipod"),ht(A).catch(M=>{console.error(`[iPod] Error processing videoId ${A} from updateApp event:`,M),fe.error("Failed to load shared track",{description:`Video ID: ${A}`})}),de.current=o.detail.initialData}};return window.addEventListener("updateApp",t),()=>{window.removeEventListener("updateApp",t)}},[ht,ce]);const Ot=s.useCallback(()=>{if(R){const t=p?Me.current:We.current;t==null||t.seekTo(0),P(!0)}else me()},[R,me,P,p]),Rt=s.useCallback(t=>{i(Math.floor(t.playedSeconds))},[]),$t=s.useCallback(t=>{we(t)},[]),Dt=s.useCallback(()=>{P(!0),Ye.current||O("▶"),Ye.current=!1;const t=d[g];if(t){const o=Nt.current,u=!o||o.trackId!==t.id,A=xe<1;(u||A)&&(Hs(Xs.SONG_PLAY,{trackId:t.id,title:t.title,artist:t.artist||""}),Nt.current={trackId:t.id,elapsedTime:xe})}},[P,O,d,g,xe]),Ft=s.useCallback(()=>{P(!1),O("⏸︎")},[P,O]),Vt=s.useCallback(()=>{},[]);s.useEffect(()=>{if(!D||!tt||lt.current)return;const t=xe,o=setTimeout(()=>{k.getState().isPlaying&&xe===t&&(P(!1),O("⏸"))},1200);return()=>clearTimeout(o)},[D,xe,P,O,tt]);const kt=s.useCallback(()=>{if(c(),L(),W(),B&&z(),_e)if(pe.length>1){je("backward"),Te(o=>o.slice(0,-1));const t=pe[pe.length-2];t&&Ae(t.selectedIndex)}else c();else{je("backward");const t=k.getState().currentIndex,o=pe.length>0?pe[0]:{title:n("apps.ipod.menuItems.ipod"),items:qe,selectedIndex:0},u=Ke;if(Lt)Te([o]),Ae((o==null?void 0:o.selectedIndex)||0),De(!1);else{const A=d.reduce(($,ne,ve)=>{const le=ne.artist||n("apps.ipod.menu.unknownArtist");return $[le]||($[le]=[]),$[le].push({track:ne,index:ve}),$},{}),M={title:n("apps.ipod.menuItems.allSongs"),items:d.map(($,ne)=>({label:$.title,action:()=>{W(),j(ne),P(!0),je("forward"),Ne(!1),De(!1),Xe([n("apps.ipod.menuItems.music"),n("apps.ipod.menuItems.allSongs")]),k.getState().showVideo&&z()},showChevron:!1})),selectedIndex:t};if(ut.length>0&&ut[1]!==n("apps.ipod.menuItems.allSongs")){const $=ut[1];if(A[$]){const ne=A[$],ve=ne.findIndex(ge=>ge.index===t),le={title:$,items:ne.map(({track:ge,index:Ve})=>({label:ge.title,action:()=>{W(),j(Ve),P(!0),je("forward"),Ne(!1),De(!1),Xe([n("apps.ipod.menuItems.music"),$]),k.getState().showVideo&&z()},showChevron:!1})),selectedIndex:ve!==-1?ve:0};Te([o,{title:n("apps.ipod.menuItems.music"),items:u,selectedIndex:u.findIndex(ge=>ge.label===$)},le]),Ae(ve!==-1?ve:0)}else Te([o,{title:n("apps.ipod.menuItems.music"),items:u,selectedIndex:0},M]),Ae(t)}else Te([o,{title:n("apps.ipod.menuItems.music"),items:u,selectedIndex:0},M]),Ae(t)}Ne(!0)}},[c,L,W,B,z,_e,pe,qe,Ke,d,Lt,ut,n]),Is=s.useCallback(t=>{switch(c(),L(),W(),t){case"top":kt();break;case"right":C?Re():(Ye.current=!0,me(),O("⏭"));break;case"bottom":C?Re():(F(),O(k.getState().isPlaying?"▶":"⏸"));break;case"left":C?Re():(Ye.current=!0,f(),O("⏮"));break;case"center":if(_e){const o=pe[pe.length-1];o&&o.items[ot]&&o.items[ot].action()}else d[g]&&(D?C?Re():z():C?Re():(F(),O("▶"),setTimeout(()=>{k.getState().showVideo||z()},200)));break}},[c,L,W,me,O,F,f,_e,pe,ot,d,g,D,z,kt,C,Re]),Cs=s.useCallback(t=>{if(x(),W(),_e){const o=pe[pe.length-1];if(!o)return;const u=o.items.length;if(u===0)return;let A=null;Ae(M=>{let $=M;return t==="clockwise"?$=Math.min(u-1,M+1):$=Math.max(0,M-1),A=$,$}),A!==null&&Te(M=>{const $=M.length-1,ne=[...M];return ne[$]={...M[$],selectedIndex:A},ne})}else{const o=p?Me.current:We.current,u=(o==null?void 0:o.getCurrentTime())||0,A=5;let M=u;t==="clockwise"?(M=u+A,o==null||o.seekTo(M),O(`⏩︎ ${Math.floor(M/60)}:${String(Math.floor(M%60)).padStart(2,"0")}`)):(M=Math.max(0,u-A),o==null||o.seekTo(M),O(`⏪︎ ${Math.floor(M/60)}:${String(Math.floor(M%60)).padStart(2,"0")}`))}},[x,W,_e,pe,O,p]),ze=s.useRef(null),[Ls,Ns]=s.useState(1),Bt=s.useRef(ae);s.useEffect(()=>{let t;const o=()=>{ze.current&&requestAnimationFrame(()=>{if(!ze.current)return;const A=ze.current.clientWidth,M=ze.current.clientHeight,$=250,ne=400,ve=A-50,le=M-50,ge=ve/$,Ve=le/ne,st=Math.min(ge,Ve,2),Ge=Math.max(1,st);Ns(es=>Math.abs(es-Ge)>.01?Ge:es)})};t=window.setTimeout(o,10),Bt.current&&!ae&&[50,100,200,300,500].forEach(M=>{window.setTimeout(o,M)}),Bt.current=ae;const u=new ResizeObserver(()=>{clearTimeout(t),t=window.setTimeout(o,10)});return ze.current&&u.observe(ze.current),()=>{clearTimeout(t),u.disconnect()}},[a,ae]);const As=s.useCallback(()=>{d.length>0&&g>=0&&Ct(!0)},[d,g]),Ms=t=>`${window.location.origin}/ipod/${t}`,{ipodVolume:Ut}=rs(t=>({ipodVolume:t.ipodVolume})),Fe=xn({title:((Xt=d[g])==null?void 0:Xt.title)??"",artist:((Kt=d[g])==null?void 0:Kt.artist)??"",album:((qt=d[g])==null?void 0:qt.album)??"",currentTime:xe+(((Gt=d[g])==null?void 0:Gt.lyricOffset)??0)/1e3,translateTo:b}),_t=s.useRef(p);s.useEffect(()=>{var t,o;if(p!==_t.current){if(p){const u=((t=We.current)==null?void 0:t.getCurrentTime())||xe,A=D;setTimeout(()=>{Me.current&&(Me.current.seekTo(u),A&&tt&&lt.current&&setTimeout(()=>{var $,ne;const M=(ne=($=Me.current)==null?void 0:$.getInternalPlayer)==null?void 0:ne.call($);M&&typeof M.playVideo=="function"&&M.playVideo()},200))},100)}else{const u=((o=Me.current)==null?void 0:o.getCurrentTime())||xe,A=D;setTimeout(()=>{We.current&&(We.current.seekTo(u),setTimeout(()=>{A&&!k.getState().isPlaying&&P(!0)},50))},200)}_t.current=p}},[p,xe,D,P,tt]);const Es=s.useCallback(t=>{if(Me.current){const o=Me.current.getCurrentTime()||0,u=Math.max(0,o+t);Me.current.seekTo(u),O(`${t>0?"⏩︎":"⏪︎"} ${Math.floor(u/60)}:${String(Math.floor(u%60)).padStart(2,"0")}`)}},[O]),Ps=b,Os=s.useCallback(t=>{const o=k.getState().setLyricsTranslationLanguage;o(t)},[]),Rs=s.useCallback(()=>{const t=k.getState(),o=t.lyricsAlignment;let u;o===G.FocusThree?u=G.Center:o===G.Center?u=G.Alternating:u=G.FocusThree,t.setLyricsAlignment(u),O(u===G.FocusThree?n("apps.ipod.status.layoutFocus"):u===G.Center?n("apps.ipod.status.layoutCenter"):n("apps.ipod.status.layoutAlternating"))},[O,n]),$s=s.useCallback(()=>{const t=k.getState(),u=t.koreanDisplay===Pe.Original?Pe.Romanized:Pe.Original;t.setKoreanDisplay(u),O(u===Pe.Romanized?n("apps.ipod.status.romanizationOn"):n("apps.ipod.status.hangulOn"))},[O,n]);s.useEffect(()=>{const t=()=>{!document.fullscreenElement&&p&&E()};return document.addEventListener("fullscreenchange",t),()=>{document.removeEventListener("fullscreenchange",t)}},[p,E]);const zt=vt(t=>t.current),Wt=zt==="xp"||zt==="win98",Yt=e.jsx(an,{onClose:r,onShowHelp:()=>St(!0),onShowAbout:()=>Tt(!0),onClearLibrary:()=>{yt(!0)},onSyncLibrary:vs,onAddTrack:()=>Ue(!0),onShareSong:As});return a?e.jsxs(e.Fragment,{children:[!Wt&&h&&Yt,e.jsxs(Ks,{title:qs("ipod"),onClose:r,isForeground:h,appId:"ipod",transparentBackground:!0,skipInitialSound:N,instanceId:m,onNavigateNext:I,onNavigatePrevious:l,menuBar:Wt?Yt:void 0,keepMountedWhenMinimized:!0,children:[e.jsx("div",{ref:ze,className:"ipod-force-font flex flex-col items-center justify-center w-full h-full bg-gradient-to-b from-gray-100/20 to-gray-300/20 backdrop-blur-lg p-4 select-none",style:{position:"relative",overflow:"hidden",contain:"layout style paint"},children:e.jsxs("div",{className:be("ipod-force-font w-[250px] h-[400px] rounded-2xl shadow-xl border border-black/40 flex flex-col items-center p-4 pb-8",H==="classic"?"bg-white/85":"bg-black/85"),style:{transform:`scale(${Ls})`,transformOrigin:"center",transition:"transform 0.2s ease",minWidth:"250px",minHeight:"400px",maxWidth:"250px",maxHeight:"400px",contain:"layout style paint",willChange:"transform",backfaceVisibility:"hidden"},children:[e.jsx(hn,{currentTrack:d[g]||null,isPlaying:D&&!p,elapsedTime:xe,totalTime:re,menuMode:_e,menuHistory:pe,selectedMenuItem:ot,onSelectMenuItem:Ae,currentIndex:g,tracksLength:d.length,backlightOn:v,menuDirection:ks,onMenuItemAction:Ts,showVideo:B,playerRef:We,handleTrackEnd:Ot,handleProgress:Rt,handleDuration:$t,handlePlay:Dt,handlePause:Ft,handleReady:Vt,loopCurrent:R,statusMessage:Ee,onToggleVideo:z,lcdFilterOn:J,ipodVolume:Ut,showStatusCallback:O,showLyrics:Q,lyricsAlignment:ee,chineseVariant:U,koreanDisplay:S,lyricOffset:te??0,adjustLyricOffset:t=>k.getState().adjustLyricOffset(g,t),registerActivity:W,isFullScreen:p,lyricsControls:Fe}),e.jsx(fn,{theme:H,onWheelClick:Is,onWheelRotation:Cs,onMenuButton:kt})]})}),p&&e.jsx(kn,{onClose:()=>{E()},togglePlay:F,nextTrack:()=>{Ye.current=!0,me(),setTimeout(()=>{const t=d[k.getState().currentIndex];if(t){const o=t.artist?` - ${t.artist}`:"";O(`⏭ ${t.title}${o}`)}},100)},previousTrack:()=>{Ye.current=!0,f(),setTimeout(()=>{const t=d[k.getState().currentIndex];if(t){const o=t.artist?` - ${t.artist}`:"";O(`⏮ ${t.title}${o}`)}},100)},seekTime:Es,showStatus:O,showOfflineStatus:Re,registerActivity:W,isPlaying:D,statusMessage:Ee,currentTranslationCode:Ps,onSelectTranslation:Os,currentAlignment:ee,onCycleAlignment:Rs,currentKoreanDisplay:S,onToggleKoreanDisplay:$s,fullScreenPlayerRef:Me,children:({controlsVisible:t})=>e.jsx("div",{className:"flex flex-col w-full h-full",children:e.jsx("div",{className:"relative w-full h-full overflow-visible",children:e.jsx("div",{className:"w-full relative",style:{height:"calc(100% + clamp(200px, 30dvh, 360px))",transform:"translateY(-100px)"},children:d[g]&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full h-full pointer-events-none",children:e.jsx(us,{ref:Me,url:d[g].url,playing:D&&p,controls:!0,width:"100%",height:"100%",volume:Ut*fs.getState().masterVolume,loop:R,onEnded:Ot,onProgress:Rt,onDuration:$t,onPlay:Dt,onPause:Ft,onReady:Vt,config:{youtube:{playerVars:{modestbranding:1,rel:0,showinfo:0,iv_load_policy:3,cc_load_policy:0,fs:1,playsinline:1,enablejsapi:1,origin:window.location.origin},embedOptions:{referrerPolicy:"strict-origin-when-cross-origin"}}}})}),Q&&d[g]&&e.jsx("div",{className:"absolute inset-0 bg-black/50 z-10 pointer-events-none"}),Q&&e.jsx("div",{className:"absolute bottom-0 inset-0 pointer-events-none z-20",style:{transform:t?"translateY(-3rem)":"translateY(clamp(1rem, 4dvh, 5rem))",transition:"transform 200ms ease"},children:e.jsx(ms,{lines:Fe.lines,currentLine:Fe.currentLine,isLoading:Fe.isLoading,error:Fe.error,visible:!0,videoVisible:!0,alignment:ee,chineseVariant:U,koreanDisplay:S,fontClassName:"font-lyrics-rounded",onAdjustOffset:o=>{var $;k.getState().adjustLyricOffset(g,o);const u=((($=d[g])==null?void 0:$.lyricOffset)??0)+o,A=u>0?"+":(u<0,"");O(`${n("apps.ipod.status.offset")} ${A}${(u/1e3).toFixed(2)}s`);const M=xe+u/1e3;Fe.updateCurrentTimeManually(M)},isTranslating:Fe.isTranslating,textSizeClass:"text-[min(10vw,10vh)]",gapClass:"gap-0",containerStyle:{gap:"clamp(0.25rem, calc(min(10vw,10vh) * 0.12), 2.5rem)",paddingLeft:"env(safe-area-inset-left, 0px)",paddingRight:"env(safe-area-inset-right, 0px)"},interactive:tt?!1:D,bottomPaddingClass:"pb-[calc(max(env(safe-area-inset-bottom),1.5rem)+clamp(5rem,16dvh,12rem))]"})}),Fe.isTranslating&&!Q&&e.jsx("div",{className:"absolute inset-0 pointer-events-none z-20 flex items-end justify-center pb-[calc(max(env(safe-area-inset-bottom),1.5rem)+clamp(5rem,16dvh,12rem))]",style:{transform:t?"translateY(0)":"translateY(clamp(2rem, 8dvh, 10rem))",transition:"transform 200ms ease"},children:e.jsx("div",{className:be("shimmer opacity-60 text-[min(10vw,10vh)]","font-lyrics-rounded"),children:n("apps.ipod.status.translatingLyrics")})})]})})})})}),e.jsx(Gs,{isOpen:et,onOpenChange:St,helpItems:V,appId:"ipod"}),e.jsx(Js,{isOpen:xs,onOpenChange:Tt,metadata:Zs,appId:"ipod"}),e.jsx(Qs,{isOpen:gs,onOpenChange:yt,onConfirm:()=>{Ce(),yt(!1),O(n("apps.ipod.status.libraryCleared"))},title:n("apps.ipod.dialogs.clearLibraryTitle"),description:n("apps.ipod.dialogs.clearLibraryDescription")}),e.jsx(en,{isOpen:bt,onOpenChange:Ue,onSubmit:wt,title:n("apps.ipod.dialogs.addSongTitle"),description:n("apps.ipod.dialogs.addSongDescription"),value:ke,onChange:Qe,isLoading:bs}),e.jsx(hs,{isOpen:ys,onClose:()=>Ct(!1),itemType:"Song",itemIdentifier:((Jt=d[g])==null?void 0:Jt.id)||"",title:(Zt=d[g])==null?void 0:Zt.title,details:(Qt=d[g])==null?void 0:Qt.artist,generateShareUrl:Ms})]}),e.jsx(Ze,{children:ae&&!p&&d.length>0&&g>=0&&e.jsx(wn,{currentTrack:d[g]||null,isPlaying:D,onTogglePlay:F,onNextTrack:me,onPreviousTrack:f,onRestore:()=>{m&&q(m)}})})]}):null}export{$n as IpodAppComponent};
