const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BxS3VOwZ.js","assets/ui-core-D0pDhx0h.js","assets/react-CyQK0IK8.js","assets/media-player-Dfptv93o.js","assets/zustand-CwjPl1Tm.js","assets/motion-DC7C-474.js","assets/tiptap-CPHiBm_b.js","assets/ui-form-Bg85K0S3.js","assets/audio-DxkJfdUY.js","assets/pusher-BvD42uFZ.js","assets/hangul-CIZ_Rl7P.js","assets/three-BOJBN814.js","assets/index-CNEOBxer.css"])))=>i.map(i=>d[i]);
import{_ as he}from"./media-player-Dfptv93o.js";import{r as N,j as X}from"./ui-core-D0pDhx0h.js";import{D as fe,u as me,l as Ie}from"./ai-sdk-CIHyILzO.js";import{aC as vt,X as Se,Y as ot,O as ye,u as Te,a0 as Mt,am as dt,a3 as f,bK as et,N as bt,$ as Ce,aH as xe,aI as nt,a as te,aJ as ee,P as Yt,aR as ke,T as pt,U as it,Q as zt,m as $t,aD as be,bP as we,a4 as qt}from"./index-BxS3VOwZ.js";import{u as Ae}from"./useTtsQueue-DQIlMCFB.js";import{h as Me,S as Et,U as Pt,T as Dt,a as Ft,b as Lt,g as Wt}from"./tiptap-CPHiBm_b.js";import{M as $e,m as Tt}from"./motion-DC7C-474.js";const _t=new Map,Ne=l=>{_t.set(l,{instanceId:l,timestamp:Date.now()});const c=Date.now()-5*60*1e3;for(const[p,s]of _t.entries())s.timestamp<c&&_t.delete(p)},ve=l=>l.normalize("NFKD").replace(new RegExp("\\p{Diacritic}","gu"),""),Nt=l=>ve(l).toLowerCase(),Ee=(l,c)=>{if(c.length===0)return!0;let p=0;for(const s of c){const E=l.indexOf(s,p);if(E===-1)return!1;p=E+1}return!0},Zt=(l,c)=>{if(l===c)return 0;if(l.length===0)return c.length;if(c.length===0)return l.length;const p=new Array(l.length+1),s=new Array(l.length+1);for(let E=0;E<=l.length;E+=1)p[E]=E;for(let E=1;E<=c.length;E+=1){s[0]=E;const B=c[E-1];for(let y=1;y<=l.length;y+=1){const z=B===l[y-1]?0:1;s[y]=Math.min(s[y-1]+1,p[y]+1,p[y-1]+z)}for(let y=0;y<=l.length;y+=1)p[y]=s[y]}return p[l.length]},Qt=(l,c)=>{const p=l.length,s=c.length;if(s===0)return 0;if(p===0)return s;if(s>=p)return Zt(l,c);let E=Number.MAX_SAFE_INTEGER;const B=p-s;for(let y=0;y<=B;y+=1){const z=l.slice(y,y+s),D=Zt(z,c);if(D<E&&(E=D,E===0))break}return E},Pe=(l,c,p)=>{if(!c)return 1;if(!l)return 0;let s=0;const E=l.indexOf(c);if(E!==-1){const y=.7+(1-E/Math.max(l.length,c.length))*.3;s=Math.max(s,Math.min(1,y))}if(Ee(l,c)){const y=.5+Math.min(.4,c.length/Math.max(l.length,c.length)*.4);s=Math.max(s,Math.min(1,y))}const B=Math.max(c.length,Math.min(l.length,c.length));if(B>0){const z=1-Qt(l,c)/(B+1);s=Math.max(s,Math.max(0,z))}if(p.length>1){let y=0;for(const z of p){if(!z)continue;if(l.indexOf(z)!==-1){y+=1;continue}const L=Math.max(z.length,Math.min(l.length,z.length));if(L===0)continue;const st=1-Qt(l,z)/(L+1);st>.5&&(y+=st)}if(y>0){const z=y/p.length;s=Math.max(s,Math.min(1,z))}}return Math.max(0,Math.min(1,s))},De=l=>l<=2?.65:l<=4?.55:l<=6?.5:l<=8?.45:.4,oe=()=>{if(typeof navigator>"u")return"Unknown";const l=navigator.userAgent,c=navigator.platform||"";return/iPad|iPhone|iPod/.test(l)||c==="MacIntel"&&navigator.maxTouchPoints>1?"iOS":/Android/.test(l)?"Android":/Win/.test(c)?"Windows":/Mac/.test(c)?"macOS":/Linux/.test(c)?"Linux":"Unknown"},Bt=()=>{const l=ot.getState(),c=Ce.getState(),p=xe.getState(),s=nt.getState(),E=bt.getState(),B=vt.getState(),y=te.getState(),z=ee.getState(),D=p.getCurrentVideo(),L=s.tracks&&s.currentIndex>=0&&s.currentIndex<s.tracks.length?s.tracks[s.currentIndex]:null,gt=oe(),st=Object.entries(l.instances).filter(([,w])=>w.isOpen).map(([w,M])=>{const A={instanceId:w,appId:M.appId,isForeground:M.isForeground||!1,title:M.title};if(M.appId==="applet-viewer"&&M.initialData){const C=M.initialData;return{...A,appletPath:C.path||void 0,appletId:C.shareCode||void 0}}return A}),ht=st.find(w=>w.isForeground)||null,Y=st.filter(w=>!w.isForeground),Ct=new Date,q=Intl.DateTimeFormat().resolvedOptions().timeZone||"Unknown",ft=Ct.toLocaleTimeString([],{hour:"numeric",minute:"2-digit",hour12:!0}),at=Ct.toLocaleDateString([],{weekday:"long",year:"numeric",month:"long",day:"numeric"}),mt=Object.values(E.instances).map(w=>{let M=null;if(w.contentJson)try{const C=Me(w.contentJson,[Et,Pt,Dt.configure({types:["heading","paragraph"]}),Ft,Lt.configure({nested:!0})]);M=Yt(C)}catch(C){console.error("Failed to convert TextEdit content to markdown:",C)}let A="Untitled";if(w.filePath)A=(w.filePath.split("/").pop()||"Untitled").replace(/\.md$/,"");else{const C=l.instances[w.instanceId];A=(C==null?void 0:C.title)||"Untitled"}return{instanceId:w.instanceId,filePath:w.filePath,title:A,contentMarkdown:M,hasUnsavedChanges:w.hasUnsavedChanges}});let lt=null;if(c.aiGeneratedHtml)try{lt=Yt(c.aiGeneratedHtml)}catch(w){console.error("Failed to convert IE HTML to markdown:",w)}return{username:B.username,userOS:gt,locale:z.current,userLocalTime:{timeString:ft,dateString:at,timeZone:q},runningApps:{foreground:ht,background:Y,instanceWindowOrder:l.instanceOrder},internetExplorer:{url:c.url,year:c.year,status:c.status,currentPageTitle:c.currentPageTitle,aiGeneratedHtml:c.aiGeneratedHtml,aiGeneratedMarkdown:lt},video:{currentVideo:D?{id:D.id,url:D.url,title:D.title,artist:D.artist}:null,isPlaying:p.isPlaying,loopAll:p.loopAll,loopCurrent:p.loopCurrent,isShuffled:p.isShuffled},ipod:{currentTrack:L?{id:L.id,url:L.url,title:L.title,artist:L.artist}:null,isPlaying:s.isPlaying,loopAll:s.loopAll,loopCurrent:s.loopCurrent,isShuffled:s.isShuffled,currentLyrics:s.currentLyrics},textEdit:{instances:mt},theme:{current:y.current}}},kt=l=>l.parts&&l.parts.length>0?l.parts.filter(c=>c.type==="text").map(c=>{const p=c.text||"";return p.startsWith("!!!!")?p.slice(4).trimStart():p}).join(""):"";function Be(l){const{aiMessages:c,setAiMessages:p,username:s,authToken:E,ensureAuthToken:B}=vt(),y=Se(),z=ot(t=>t.closeApp),D=ot(t=>t.aiModel),L=ot(t=>t.speechEnabled),{saveFile:gt}=ye("/Documents",{skipLoad:!0}),{t:st}=Te(),[ht,Y]=N.useState(""),Ct=N.useCallback(t=>{Y(t.target.value)},[]),q=N.useRef({}),[ft,at]=N.useState(null),G=N.useRef([]);N.useEffect(()=>{c.forEach(t=>{if(t.role==="assistant"){const v=kt(t);q.current[t.id]=v.length}})},[c]);const{speak:mt,stop:lt,isSpeaking:w}=Ae(),M=t=>t.replace(/```[\s\S]*?```/g,"").replace(/<[^>]*>/g,"").replace(/^!+\s*/,"").replace(/^[\s.!?ã€‚ï¼Œï¼ï¼Ÿï¼›ï¼š]+/,"").trim(),[A,C]=N.useState(null),[F,P]=N.useState(!1),R=N.useMemo(()=>new fe({api:Mt("/api/chat"),headers:async()=>{const{username:t,authToken:v}=vt.getState();if(!t)return{};const $={"X-Username":t};return v&&($.Authorization=`Bearer ${v}`),$},body:async()=>({systemState:Bt(),model:ot.getState().aiModel})}),[]),Z=N.useRef(at);Z.current=at;const{messages:j,status:H,error:xt,stop:St,setMessages:ct,sendMessage:yt,regenerate:ne,addToolResult:g}=me({messages:c,experimental_throttle:50,sendAutomaticallyWhen:Ie,transport:R,async onToolCall({toolCall:t}){var v,$,b;await new Promise(a=>setTimeout(a,120)),console.log(`[onToolCall] Executing client-side tool: ${t.toolName}`,t);try{let a="Tool executed successfully";switch(t.toolName){case"aquarium":{a="Aquarium displayed";break}case"launchApp":{const{id:e,url:n,year:r}=t.input;if(!e){console.error("[ToolCall] launchApp: Missing required 'id' parameter"),g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:"No app ID provided"});break}const o=((v=$t[e])==null?void 0:v.name)||e;console.log("[ToolCall] launchApp:",{id:e,url:n,year:r});const d={};if(e==="internet-explorer"&&(n||r)&&(d.initialData={url:n,year:r||"current"}),y(e,d),a=`Launched ${o}`,e==="internet-explorer"){const i=n?` to ${n}`:"",u=r&&r!=="current"?` in ${r}`:"";a+=`${i}${u}`}console.log(`[ToolCall] ${a}`);break}case"closeApp":{const{id:e}=t.input;if(!e){console.error("[ToolCall] closeApp: Missing required 'id' parameter");break}const n=(($=$t[e])==null?void 0:$.name)||e;console.log("[ToolCall] closeApp:",e);const d=ot.getState().getInstancesByAppId(e).filter(i=>i.isOpen);if(d.length===0){console.log(`[ToolCall] ${n} is not currently running.`);break}d.forEach(i=>{we(i.instanceId)}),z(e),console.log(`[ToolCall] Closed ${n} (${d.length} window${d.length===1?"":"s"}).`);break}case"ipodControl":{const{action:e="toggle",id:n,title:r,artist:o,enableVideo:d,enableTranslation:i,enableFullscreen:u}=t.input;console.log("[ToolCall] ipodControl:",{action:e,id:n,title:r,artist:o,enableVideo:d,enableTranslation:i,enableFullscreen:u});const I=oe()==="iOS";(()=>{ot.getState().getInstancesByAppId("ipod").some(m=>m.isOpen)||y("ipod")})();const S=()=>{const h=nt.getState(),k=[];if(d!==void 0&&(d&&!h.showVideo?(h.setShowVideo(!0),k.push(f.t("apps.chats.toolCalls.ipodTurnedOnVideo")),console.log("[ToolCall] Video enabled.")):!d&&h.showVideo&&(h.setShowVideo(!1),k.push(f.t("apps.chats.toolCalls.ipodTurnedOffVideo")),console.log("[ToolCall] Video disabled."))),i!==void 0)if(i===null||i===""||typeof i=="string"&&["original","off","none","disable","disabled","null"].includes(i.toLowerCase()))h.setLyricsTranslationLanguage(null),k.push(f.t("apps.chats.toolCalls.ipodTurnedOffLyricsTranslation")),console.log("[ToolCall] Lyrics translation disabled.");else{h.setLyricsTranslationLanguage(i);const O=h.tracks[h.currentIndex];O!=null&&O.id&&h.setLyricsTranslationRequest(i,O.id);const V={en:"English","zh-TW":"Traditional Chinese","zh-CN":"Simplified Chinese",ja:"Japanese",ko:"Korean",es:"Spanish",fr:"French",de:"German",pt:"Portuguese",it:"Italian",ru:"Russian"}[i]||i;k.push(f.t("apps.chats.toolCalls.ipodTranslatedLyricsTo",{langName:V})),console.log(`[ToolCall] Lyrics translation enabled for language: ${i}.`)}return u!==void 0&&(u&&!h.isFullScreen?(h.toggleFullScreen(),k.push(f.t("apps.chats.toolCalls.ipodTurnedOnFullScreen")),console.log("[ToolCall] Fullscreen enabled.")):!u&&h.isFullScreen&&(h.toggleFullScreen(),k.push(f.t("apps.chats.toolCalls.ipodTurnedOffFullScreen")),console.log("[ToolCall] Fullscreen disabled."))),k},x=e??"toggle";if(x==="toggle"||x==="play"||x==="pause"){const h=nt.getState();if(I&&(x==="play"||x==="toggle")){const J=S(),It=[f.t("apps.chats.toolCalls.ipodReady")];J.length>0&&It.push(...J);const Q=It.length>1?It.join(". ")+".":It[0];g({tool:t.toolName,toolCallId:t.toolCallId,output:Q}),a="",console.log("[ToolCall] iOS detected - user must manually start playback.");break}switch(x){case"play":h.isPlaying||h.setIsPlaying(!0);break;case"pause":h.isPlaying&&h.setIsPlaying(!1);break;default:h.togglePlay();break}const k=S(),T=nt.getState(),m=T.isPlaying,O=T.tracks[T.currentIndex];let K;if(O){const J=`${O.title}${O.artist?` by ${O.artist}`:""}`;K=m?f.t("apps.chats.toolCalls.ipodPlayingTrack",{trackDesc:J}):f.t("apps.chats.toolCalls.ipodPausedTrack",{trackDesc:J})}else K=m?f.t("apps.chats.toolCalls.ipodPlaying"):f.t("apps.chats.toolCalls.ipodPaused");const V=[K];k.length>0&&V.push(...k);const rt=V.length>1?V.join(". ")+".":V[0];g({tool:t.toolName,toolCallId:t.toolCallId,output:rt}),a="",console.log(`[ToolCall] iPod is now ${m?"playing":"paused"}.`);break}if(x==="playKnown"){const h=nt.getState(),{tracks:k}=h,T=(W,tt)=>!W||!tt?!1:W.toLowerCase().includes(tt.toLowerCase());let m=[];const O=k.map((W,tt)=>({track:W,index:tt})),K=n?O.filter(({track:W})=>W.id===n):O,V=K.filter(({track:W})=>{const tt=r?T(W.title,r):!0,ut=o?T(W.artist,o):!0;return tt&&ut});if(V.length>0?m=V.map(({index:W})=>W):(r||o)&&(m=K.filter(({track:tt})=>{const ut=r?T(tt.artist,r):!1,At=o?T(tt.title,o):!1;return r&&o?ut||At:r?ut:o?At:!1}).map(({index:tt})=>tt)),m.length===0){const W=f.t("apps.chats.toolCalls.ipodSongNotFound");g({tool:t.toolName,toolCallId:t.toolCallId,output:W}),a="",console.log(`[ToolCall] ${W}`);break}const rt=m[Math.floor(Math.random()*m.length)],{setCurrentIndex:J,setIsPlaying:It}=nt.getState();J(rt);const Q=k[rt],Kt=`${Q.title}${Q.artist?` by ${Q.artist}`:""}`;if(I){const W=S(),tt=Q.artist?`${Q.title} by ${Q.artist}`:Q.title,ut=[f.t("apps.chats.toolCalls.ipodSelected",{trackDesc:tt})];W.length>0&&ut.push(...W);const At=ut.length>1?ut.join(". ")+".":ut[0];g({tool:t.toolName,toolCallId:t.toolCallId,output:At}),a="",console.log(`[ToolCall] iOS detected - selected ${Kt}, user must manually start playback.`);break}It(!0);const Xt=S(),wt=[Q.artist?f.t("apps.chats.toolCalls.playingByArtist",{title:Q.title,artist:Q.artist}):f.t("apps.chats.toolCalls.playing",{title:Q.title})];Xt.length>0&&wt.push(...Xt);const ge=wt.length>1?wt.join(". ")+".":wt[0];g({tool:t.toolName,toolCallId:t.toolCallId,output:ge}),a="",console.log(`[ToolCall] Playing ${Kt}.`);break}if(x==="addAndPlay"){if(!n){const h="The 'addAndPlay' action requires the 'id' parameter (YouTube ID or URL).";g({tool:t.toolName,toolCallId:t.toolCallId,output:h}),a="",console.error(`[ToolCall] ${h}`);break}try{const h=await nt.getState().addTrackFromVideoId(n,!I);if(h){const k=S(),T=I?[f.t("apps.chats.toolCalls.ipodAdded",{title:h.title})]:[f.t("apps.chats.toolCalls.ipodAddedAndPlaying",{title:h.title})];k.length>0&&T.push(...k);const m=T.length>1?T.join(". ")+".":T[0];g({tool:t.toolName,toolCallId:t.toolCallId,output:m}),a="",console.log(I?`[ToolCall] iOS detected - added '${h.title}' to iPod, user must manually start playback.`:`[ToolCall] Added '${h.title}' to iPod and started playing.`);break}else{const k=f.t("apps.chats.toolCalls.ipodFailedToAdd",{id:n});g({tool:t.toolName,toolCallId:t.toolCallId,output:k}),a="",console.error(`[ToolCall] ${k}`);break}}catch(h){const k=h instanceof Error?h.message:"Unknown error";console.error(`[iPod] Error adding ${n}:`,h);let T;k.includes("Failed to fetch video info")?T=f.t("apps.chats.toolCalls.ipodCannotAdd",{id:n}):T=f.t("apps.chats.toolCalls.ipodFailedToAddWithError",{id:n,error:k}),g({tool:t.toolName,toolCallId:t.toolCallId,output:T}),a="",console.error(`[ToolCall] ${T}`);break}}if(x==="next"||x==="previous"){const h=nt.getState(),k=x==="next"?h.nextTrack:h.previousTrack;typeof k=="function"&&k();const T=S(),m=nt.getState(),O=m.tracks[m.currentIndex];if(O){const rt=`${O.title}${O.artist?` by ${O.artist}`:""}`,J=[x==="next"?f.t("apps.chats.toolCalls.ipodSkippedTo",{trackDesc:rt}):f.t("apps.chats.toolCalls.ipodWentBackTo",{trackDesc:rt})];T.length>0&&J.push(...T);const It=J.length>1?J.join(". ")+".":J[0];g({tool:t.toolName,toolCallId:t.toolCallId,output:It}),a="",console.log(`[ToolCall] ${x==="next"?"Skipped to":"Went back to"} ${rt}.`);break}const K=[x==="next"?f.t("apps.chats.toolCalls.ipodSkippedToNext"):f.t("apps.chats.toolCalls.ipodWentBackToPrevious")];T.length>0&&K.push(...T);const V=K.length>1?K.join(". ")+".":K[0];g({tool:t.toolName,toolCallId:t.toolCallId,output:V}),a="",console.log(`[ToolCall] ${x==="next"?"Skipped to next track.":"Went back to previous track."}`);break}const _=S();if(_.length>0){const h=_.length>1?_.join(". ")+".":_[0];g({tool:t.toolName,toolCallId:t.toolCallId,output:h}),a=""}console.warn(`[ToolCall] ipodControl: Unhandled action "${x}".`);break}case"generateHtml":{const{html:e}=t.input;if(!e){console.error("[ToolCall] generateHtml: Missing required 'html' parameter");break}console.log("[ToolCall] generateHtml:",{htmlLength:e.length}),console.log("[ToolCall] Generated HTML:",e.substring(0,100)+"...");break}case"list":{const{path:e,query:n,limit:r}=t.input;if(!e){g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:"No path provided"}),a="";break}console.log("[ToolCall] list:",{path:e,query:n,limit:r});try{if(e==="/Music"){const d=nt.getState().tracks.map(u=>({path:`/Music/${u.id}`,id:u.id,title:u.title,artist:u.artist})),i=d.length>0?`${d.length===1?f.t("apps.chats.toolCalls.foundSongsInMusic",{count:d.length}):f.t("apps.chats.toolCalls.foundSongsInMusicPlural",{count:d.length})}:
${JSON.stringify(d,null,2)}`:f.t("apps.chats.toolCalls.musicLibraryEmpty");g({tool:t.toolName,toolCallId:t.toolCallId,output:i}),a=""}else if(e==="/Applets Store"){const o=n?Nt(n.trim()):"",d=o?o.split(/\s+/).filter(Boolean):[],i=o.length>0,u=r?Math.min(Math.max(r,1),100):50,I=await fetch(Mt("/api/share-applet?list=true"));if(!I.ok)throw new Error(`Failed to list shared applets (HTTP ${I.status})`);const U=await I.json(),S=Array.isArray(U==null?void 0:U.applets)?U.applets:[],x=i?De(o.length):0,_=S.map(m=>{const O=[typeof m.title=="string"?Nt(m.title):"",typeof m.name=="string"?Nt(m.name):"",typeof m.createdBy=="string"?Nt(m.createdBy):""].filter(V=>V.length>0),K=i?O.reduce((V,rt)=>{const J=Pe(rt,o,d);return J>V?J:V},0):1;return{applet:m,score:K}}),h=i?_.filter(({score:m})=>m>=x):_;h.sort((m,O)=>i&&O.score!==m.score?O.score-m.score:(O.applet.createdAt??0)-(m.applet.createdAt??0));const k=h.slice(0,u).map(({applet:m})=>({path:`/Applets Store/${m.id}`,id:m.id,title:m.title??m.name??"Untitled",name:m.name})),T=k.length>0?`${k.length===1?f.t("apps.chats.toolCalls.foundSharedApplets",{count:k.length}):f.t("apps.chats.toolCalls.foundSharedAppletsPlural",{count:k.length})}:
${JSON.stringify(k,null,2)}`:i?f.t("apps.chats.toolCalls.noSharedAppletsMatched",{query:n}):f.t("apps.chats.toolCalls.noSharedAppletsAvailable");g({tool:t.toolName,toolCallId:t.toolCallId,output:T}),a=""}else if(e==="/Applications"){const o=Object.entries($t).filter(([i])=>i!=="finder").map(([i,u])=>({path:`/Applications/${i}`,name:u.name})),d=o.length===1?f.t("apps.chats.toolCalls.foundApplicationsList",{count:o.length}):f.t("apps.chats.toolCalls.foundApplicationsListPlural",{count:o.length});g({tool:t.toolName,toolCallId:t.toolCallId,output:`${d}:
${JSON.stringify(o,null,2)}`}),a=""}else if(e==="/Applets"||e==="/Documents"){const o=et.getState(),u=Object.values(o.items).filter(S=>S.status==="active"&&S.path.startsWith(`${e}/`)&&!S.isDirectory&&S.path!==`${e}/`).map(S=>({path:S.path,name:S.name,type:S.type})),I=e==="/Applets"?"applet":"document",U=u.length>0?`${u.length===1?f.t("apps.chats.toolCalls.foundFileType",{count:u.length,fileType:I}):f.t("apps.chats.toolCalls.foundFileTypePlural",{count:u.length,fileType:I})}:
${JSON.stringify(u,null,2)}`:f.t("apps.chats.toolCalls.noFileTypeFound",{fileType:I,path:e});g({tool:t.toolName,toolCallId:t.toolCallId,output:U}),a=""}else g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:`Invalid path: ${e}. Supported paths: /Applets, /Documents, /Applications, /Music, /Applets Store`}),a=""}catch(o){console.error("list error:",o),g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:o instanceof Error?o.message:"Failed to list items"}),a=""}break}case"open":{const{path:e}=t.input;if(!e){g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:"No path provided"}),a="";break}console.log("[ToolCall] open:",{path:e});try{if(e.startsWith("/Music/")){const n=e.replace("/Music/",""),r=nt.getState(),o=r.tracks.findIndex(U=>U.id===n);if(o===-1)throw new Error(`Song not found: ${n}`);ot.getState().getInstancesByAppId("ipod").some(U=>U.isOpen)||y("ipod"),r.setCurrentIndex(o),r.setIsPlaying(!0);const u=r.tracks[o],I=u.artist?f.t("apps.chats.toolCalls.playingTrackByArtist",{title:u.title,artist:u.artist}):f.t("apps.chats.toolCalls.playingTrack",{title:u.title});g({tool:t.toolName,toolCallId:t.toolCallId,output:I}),a=""}else if(e.startsWith("/Applets Store/")){const n=e.replace("/Applets Store/","");let r=n;try{const o=await fetch(Mt(`/api/share-applet?id=${encodeURIComponent(n)}`));if(o.ok){const d=await o.json();r=d.title||d.name||n}}catch{}y("applet-viewer",{initialData:{path:"",content:"",shareCode:n}}),g({tool:t.toolName,toolCallId:t.toolCallId,output:f.t("apps.chats.toolCalls.openedApplet",{appletName:r})}),a=""}else if(e.startsWith("/Applications/")){const n=e.replace("/Applications/","");if(!$t[n])throw new Error(`Application not found: ${n}`);y(n),g({tool:t.toolName,toolCallId:t.toolCallId,output:`Launched ${be(n)}`}),a=""}else if(e.startsWith("/Applets/")){const r=et.getState().items[e];if(!r||r.status!=="active")throw new Error(`Applet not found: ${e}`);if(!r.uuid)throw new Error(`Applet missing content: ${e}`);const o=await pt.get(it.APPLETS,r.uuid);if(!o||!o.content)throw new Error(`Failed to read applet content: ${e}`);let d;o.content instanceof Blob?d=await o.content.text():d=o.content,y("applet-viewer",{initialData:{path:e,content:d}}),g({tool:t.toolName,toolCallId:t.toolCallId,output:f.t("apps.chats.toolCalls.openedFile",{fileName:r.name})}),a=""}else if(e.startsWith("/Documents/")){const r=et.getState().items[e];if(!r||r.status!=="active")throw new Error(`Document not found: ${e}`);if(!r.uuid)throw new Error(`Document missing content: ${e}`);const o=await pt.get(it.DOCUMENTS,r.uuid);if(!o||!o.content)throw new Error(`Failed to read document content: ${e}`);let d;o.content instanceof Blob?d=await o.content.text():d=o.content;const i=zt(d),u=Wt(i,[Et,Pt,Dt.configure({types:["heading","paragraph"]}),Ft,Lt.configure({nested:!0})]),I=y("textedit",{multiWindow:!0});await new Promise(S=>setTimeout(S,100)),bt.getState().updateInstance(I,{filePath:e,contentJson:u,hasUnsavedChanges:!1}),g({tool:t.toolName,toolCallId:t.toolCallId,output:f.t("apps.chats.toolCalls.openedDocument",{fileName:r.name})}),a=""}else g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:`Invalid path: ${e}`}),a=""}catch(n){console.error("open error:",n),g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:n instanceof Error?n.message:"Failed to open"}),a=""}break}case"read":{const{path:e}=t.input;if(!e){g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:"No path provided"}),a="";break}console.log("[ToolCall] read:",{path:e});try{if(e.startsWith("/Applets Store/")){const n=e.replace("/Applets Store/",""),r=await fetch(Mt(`/api/share-applet?id=${encodeURIComponent(n)}`));if(!r.ok)throw new Error(`Failed to fetch shared applet (HTTP ${r.status})`);const o=await r.json(),d=et.getState(),i=Object.values(d.items).find(I=>I.status==="active"&&typeof I.shareId=="string"&&I.shareId.toLowerCase()===n.toLowerCase()),u={id:n,title:(o==null?void 0:o.title)??null,name:(o==null?void 0:o.name)??null,icon:(o==null?void 0:o.icon)??null,createdBy:(o==null?void 0:o.createdBy)??null,installedPath:(i==null?void 0:i.path)??null,content:typeof(o==null?void 0:o.content)=="string"?o.content:""};g({tool:t.toolName,toolCallId:t.toolCallId,output:JSON.stringify(u,null,2)}),a=""}else if(e.startsWith("/Applets/")||e.startsWith("/Documents/")){const n=e.startsWith("/Applets/"),o=et.getState().items[e];if(!o||o.status!=="active")throw new Error(`File not found: ${e}`);if(!o.uuid)throw new Error(`File missing content: ${e}`);const d=n?it.APPLETS:it.DOCUMENTS,i=await pt.get(d,o.uuid);if(!i||i.content==null)throw new Error(`Failed to read file content: ${e}`);let u;if(typeof i.content=="string")u=i.content;else if(i.content instanceof Blob)u=await i.content.text();else throw new Error("Unsupported content type");const I=n?"Applet":"Document";g({tool:t.toolName,toolCallId:t.toolCallId,output:`${I} content: ${o.name} (${u.length} characters)

${u}`}),a=""}else g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:`Invalid path for read: ${e}. Use /Applets/*, /Documents/*, or /Applets Store/*`}),a=""}catch(n){console.error("read error:",n),g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:n instanceof Error?n.message:"Failed to read file"}),a=""}break}case"write":{const{path:e,content:n,mode:r="overwrite"}=t.input;if(!e){g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:"No path provided"}),a="";break}if(!e.startsWith("/Documents/")){g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:`Invalid path: ${e}. Use /Documents/filename.md for documents. For applets, use generateHtml (new) or edit (small changes).`}),a="";break}const o=e.split("/").pop()||"";if(!o.endsWith(".md")){g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:`Invalid filename: ${o}. Document files must end with .md extension (e.g., /Documents/my-notes.md)`}),a="";break}if(!n&&r==="overwrite"){g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:"No content provided"}),a="";break}console.log("[ToolCall] write:",{path:e,mode:r,contentLength:n==null?void 0:n.length});try{const d=ot.getState(),i=bt.getState(),u=et.getState().items[e],I=!u||u.status!=="active";let U=n||"";if(!I&&r!=="overwrite"&&(u!=null&&u.uuid)){const T=await pt.get(it.DOCUMENTS,u.uuid);if(T!=null&&T.content){const m=typeof T.content=="string"?T.content:await T.content.text();U=r==="prepend"?n+m:m+n}}et.getState().addItem({path:e,name:o,isDirectory:!1,type:"markdown",size:new Blob([U]).size,icon:"ðŸ“„"});const S=et.getState().items[e];if(!(S!=null&&S.uuid))throw new Error("Failed to save document metadata");await pt.put(it.DOCUMENTS,{name:o,content:U},S.uuid);let x=null;for(const[T,m]of Object.entries(i.instances))if(m.filePath===e){x=T;break}if(!x){const T=o.replace(/\.md$/,"")||"Untitled";x=d.launchApp("textedit",void 0,T,!0),Ne(x),await new Promise(m=>setTimeout(m,200))}const _=zt(U),h=Wt(_,[Et,Pt,Dt.configure({types:["heading","paragraph"]}),Ft,Lt.configure({nested:!0})]);i.updateInstance(x,{filePath:e,contentJson:h,hasUnsavedChanges:!1}),d.bringInstanceToForeground(x);const k=I?"Created":"Updated";g({tool:t.toolName,toolCallId:t.toolCallId,output:`${k} document: ${e}`}),a=""}catch(d){console.error("write error:",d),g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:d instanceof Error?d.message:"Failed to write file"}),a=""}break}case"edit":{const{path:e,old_string:n,new_string:r}=t.input;if(!e||typeof n!="string"||typeof r!="string"){g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:"Missing required parameters: path, old_string, and new_string"}),a="";break}console.log("[ToolCall] edit:",{path:e,old_string:n.substring(0,50)+"...",new_string:r.substring(0,50)+"..."});const o=n.replace(/\r\n?/g,`
`),d=r.replace(/\r\n?/g,`
`);try{if(e.startsWith("/Documents/")){const i=et.getState(),u=i.items[e];if(!u||u.status!=="active"||!u.uuid)throw new Error(`Document not found: ${e}. Use write tool to create new documents, or list({ path: "/Documents" }) to see available files.`);const I=await pt.get(it.DOCUMENTS,u.uuid);if(!(I!=null&&I.content))throw new Error(`Failed to read document content: ${e}`);const S=(typeof I.content=="string"?I.content:await I.content.text()).replace(/\r\n?/g,`
`),x=S.split(o).length-1;if(x===0){g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:"old_string not found in file. Use read tool to verify current content."}),a="";break}if(x>1){g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:`old_string matches ${x} locations. Include more context to make it unique.`}),a="";break}const _=S.replace(o,d);await pt.put(it.DOCUMENTS,{name:u.name,content:_},u.uuid),i.addItem({...u,size:new Blob([_]).size});const h=bt.getState();for(const[k,T]of Object.entries(h.instances))if(T.filePath===e){const m=zt(_),O=Wt(m,[Et,Pt,Dt.configure({types:["heading","paragraph"]}),Ft,Lt.configure({nested:!0})]);h.updateInstance(k,{contentJson:O,hasUnsavedChanges:!1});break}g({tool:t.toolName,toolCallId:t.toolCallId,output:`Successfully edited document: ${e}`}),a=""}else if(e.startsWith("/Applets/")){const i=et.getState(),u=i.items[e];if(!u||u.status!=="active"||!u.uuid)throw new Error(`Applet not found: ${e}. Use generateHtml tool to create new applets, or list({ path: "/Applets" }) to see available files.`);const I=await pt.get(it.APPLETS,u.uuid);if(!(I!=null&&I.content))throw new Error(`Failed to read applet content: ${e}`);const S=(typeof I.content=="string"?I.content:await I.content.text()).replace(/\r\n?/g,`
`),x=S.split(o).length-1;if(x===0){g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:"old_string not found in file. Use read tool to verify current content."}),a="";break}if(x>1){g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:`old_string matches ${x} locations. Include more context to make it unique.`}),a="";break}const _=S.replace(o,d);await pt.put(it.APPLETS,{name:u.uuid,content:_},u.uuid),i.addItem({...u,size:new Blob([_]).size}),g({tool:t.toolName,toolCallId:t.toolCallId,output:`Successfully edited applet: ${e}`}),a=""}else g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:`Invalid path for edit: ${e}. Use /Documents/* or /Applets/*`}),a=""}catch(i){console.error("edit error:",i),g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:i instanceof Error?i.message:"Failed to edit file"}),a=""}break}case"settings":{const{language:e,theme:n,masterVolume:r,speechEnabled:o,checkForUpdates:d}=t.input,i=[],u=ot.getState(),I=ee.getState(),U=te.getState();if(e!==void 0){const S=x=>{const h={en:"apps.ipod.translationLanguages.english","zh-TW":"apps.ipod.translationLanguages.chinese",ja:"apps.ipod.translationLanguages.japanese",ko:"apps.ipod.translationLanguages.korean",fr:"apps.ipod.translationLanguages.french",de:"apps.ipod.translationLanguages.german",es:"apps.ipod.translationLanguages.spanish",pt:"apps.ipod.translationLanguages.portuguese",it:"apps.ipod.translationLanguages.italian",ru:"apps.ipod.translationLanguages.russian"}[x];if(h){const k=f.t(h);return k!==h?k:x}return x};I.setLanguage(e),i.push(f.t("apps.chats.toolCalls.settingsLanguageChanged",{language:S(e)})),console.log(`[ToolCall] Language changed to: ${e}`)}if(n!==void 0&&U.current!==n){U.setTheme(n);const S=((b=ke[n])==null?void 0:b.name)||n;i.push(f.t("apps.chats.toolCalls.settingsThemeChanged",{theme:S})),console.log(`[ToolCall] Theme changed to: ${n}`)}if(r!==void 0){u.setMasterVolume(r);const S=Math.round(r*100);i.push(f.t("apps.chats.toolCalls.settingsMasterVolumeSet",{volume:S})),console.log(`[ToolCall] Master volume set to: ${r}`)}if(o!==void 0&&(u.setSpeechEnabled(o),i.push(o?f.t("apps.chats.toolCalls.settingsSpeechEnabled"):f.t("apps.chats.toolCalls.settingsSpeechDisabled")),console.log(`[ToolCall] Speech ${o?"enabled":"disabled"}`)),d&&(he(async()=>{const{forceRefreshCache:S}=await import("./index-BxS3VOwZ.js").then(x=>x.c4);return{forceRefreshCache:S}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12])).then(({forceRefreshCache:S})=>{S()}),i.push(f.t("apps.chats.toolCalls.settingsCheckingForUpdates")),console.log("[ToolCall] Checking for updates...")),i.length>0){const S=i.length===1?i[0]:i.join(". ")+".";g({tool:t.toolName,toolCallId:t.toolCallId,output:S}),a=""}else g({tool:t.toolName,toolCallId:t.toolCallId,output:f.t("apps.chats.toolCalls.settingsNoChanges")}),a="";break}default:console.warn("Unhandled tool call:",t.toolName),a="Tool executed";break}a&&(console.log(`[onToolCall] Adding result for ${t.toolName}:`,a),g({tool:t.toolName,toolCallId:t.toolCallId,output:a}))}catch(a){console.error("Error executing tool call:",a),g({tool:t.toolName,toolCallId:t.toolCallId,state:"output-error",errorText:a instanceof Error?a.message:"Unknown error"})}},onFinish:({messages:t})=>{const v=t.map(e=>{var n;return{...e,metadata:{createdAt:((n=e.metadata)==null?void 0:n.createdAt)||new Date}}});if(console.log(`AI finished, syncing ${v.length} final messages to store.`),p(v),!L)return;const $=v.at(-1);if(!$||$.role!=="assistant")return;const b=q.current[$.id]??0,a=kt($);if(console.log(`[onFinish] Progress: ${b}, Content length: ${a.length}`),b<a.length){const e=a.slice(b),n=M(e);if(console.log(`[onFinish] Speaking final content: "${n}"`),n){const r={messageId:$.id,start:b,end:a.length};G.current.push(r),G.current.length===1&&setTimeout(()=>{G.current[0]===r&&Z.current(r)},80),mt(n,()=>{G.current.shift(),Z.current(G.current[0]||null)}),q.current[$.id]=a.length}}},onError:t=>{console.error("AI Chat Error:",t);const v=$=>{console.error("Authentication error - clearing invalid token");const b=vt.getState().setAuthToken;b(null),dt.error("Login Required",{description:$||"Please login to continue chatting.",duration:5e3,action:l?{label:"Login",onClick:l}:void 0}),P(!0)};if(t.message){const $=t.message.match(/\{.*\}/);if($)try{const b=JSON.parse($[0]);if(b.error==="rate_limit_exceeded"){C(b),b.isAuthenticated||P(!0);return}if(b.error==="authentication_failed"||b.error==="unauthorized"||b.error==="username mismatch"){v("Your session has expired. Please login again.");return}}catch(b){console.error("Failed to parse error response:",b)}if(t.message.includes("429")||t.message.includes("rate_limit_exceeded")){P(!0),dt.error("Rate Limit Exceeded",{description:"You've reached the message limit. Please login to continue.",duration:5e3,action:l?{label:"Login",onClick:l}:void 0});return}if(t.message.includes("401")||t.message.includes("Unauthorized")||t.message.includes("unauthorized")||t.message.includes("authentication_failed")||t.message.includes("Authentication failed")||t.message.includes("username mismatch")||t.message.includes("Username mismatch")){v();return}}dt.error("AI Error",{description:t.message||"Failed to get response."})}}),Vt=N.useMemo(()=>j.map(t=>{var b,a;const v=c.find(e=>e.id===t.id);return{...t,metadata:{createdAt:((b=t.metadata)==null?void 0:b.createdAt)||((a=v==null?void 0:v.metadata)==null?void 0:a.createdAt)||new Date}}}),[j,c]),Ht=N.useRef([]);Ht.current=Vt,N.useEffect(()=>{var t;(c.length!==j.length||c.length>0&&c[c.length-1].id!==((t=j[j.length-1])==null?void 0:t.id))&&(console.log("Syncing Zustand store messages to SDK."),ct(c))},[c,ct]);const Ot=H==="streaming"||H==="submitted";N.useEffect(()=>{if(!L||!Ot)return;const t=j.at(-1);if(!t||t.role!=="assistant")return;const v=typeof q.current[t.id]=="number"?q.current[t.id]:0,$=kt(t);if(v>=$.length)return;let b=v;const a=e=>{const n=$.slice(b,e),r=M(n);if(r){const o={messageId:t.id,start:b,end:e};G.current.push(o),ft||setTimeout(()=>{G.current[0]===o&&at(o)},80),mt(r,()=>{G.current.shift(),at(G.current[0]||null)})}b=e,q.current[t.id]=b};for(;b<$.length;){const e=$.indexOf(`
`,b);if(e===-1)break;a(e),b=e+1,$[b]==="\r"&&(b+=1),q.current[t.id]=b}},[j,Ot,L,mt,ft]),N.useEffect(()=>{s&&F&&(P(!1),C(null))},[s,F]);const se=N.useCallback(async t=>{t.preventDefault();const v=ht;if(!v.trim())return;if(F&&!s){dt.error("Login Required",{description:"Please login to continue chatting.",duration:3e3});return}if(s&&!E&&(console.log("[useAiChat] Waiting for auth token generation before sending message..."),!(await B()).ok)){dt.error("Authentication Error",{description:"Failed to generate authentication token. Please try logging in again.",duration:3e3});return}C(null);const $=Bt();console.log("Submitting AI chat with system state:",$),yt({text:v,metadata:{createdAt:new Date}},{body:{systemState:$,model:D}}),Y("")},[yt,ht,F,s,E,B,D,Y]),jt=N.useCallback(async t=>{if(t.trim()){if(F&&!s){dt.error("Login Required",{description:"Please login to continue chatting.",duration:3e3});return}if(s&&!E&&(console.log("[useAiChat] Waiting for auth token generation before sending message..."),!(await B()).ok)){dt.error("Authentication Error",{description:"Failed to generate authentication token. Please try logging in again.",duration:3e3});return}C(null),console.log("Sending direct message to AI chat"),yt({text:t,metadata:{createdAt:new Date}},{body:{systemState:Bt(),model:D}})}},[yt,F,s,E,B,D]),ae=N.useCallback(()=>{jt(st("apps.chats.status.nudgeSent"))},[jt,st]),Ut=N.useCallback(()=>{console.log("Clearing AI chats"),lt(),q.current={},G.current=[],at(null);const t={id:"1",role:"assistant",parts:[{type:"text",text:f.t("apps.chats.messages.greeting")}],metadata:{createdAt:new Date}},v=kt(t);q.current[t.id]=v.length,p([t]),ct([t])},[p,ct,lt]),[re,Jt]=N.useState(!1),[ie,Rt]=N.useState(!1),[le,Gt]=N.useState(""),ce=N.useCallback(()=>{Jt(!1),setTimeout(()=>{Ut(),Y("")},100)},[Ut,Y]),ue=N.useCallback(()=>{const t=new Date,v=t.toISOString().split("T")[0],$=t.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}).toLowerCase().replace(":","-").replace(" ","");Gt(`chat-${v}-${$}.md`),Rt(!0)},[]),de=N.useCallback(async t=>{const $=Ht.current.map(r=>{var I;const o=(I=r.metadata)==null?void 0:I.createdAt,d=o?new Date(o).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}):"",i=r.role==="user"?s||"You":"Ryo",u=kt(r);return`**${i}** (${d}):
${u}`}).join(`

`),b=t.endsWith(".md")?t:`${t}.md`,a=`/Documents/${b}`,e=et.getState().items[a],n=e&&e.status==="active";try{await gt({path:a,name:b,content:$,type:"markdown",icon:"/icons/file-text.png"}),Rt(!1),dt.success(n?"Transcript updated":"Transcript saved",{description:`Saved to ${b}`,duration:5e3,action:{label:"Open",onClick:()=>{const o=bt.getState().getInstanceIdByPath(a);if(o){const d=ot.getState();d.updateInstanceInitialData(o,{path:a,content:$}),d.bringInstanceToForeground(o)}else y("textedit",{initialData:{path:a,content:$}})}}})}catch(r){console.error("Error saving transcript:",r),dt.error("Failed to save transcript",{description:r instanceof Error?r.message:"Unknown error"})}},[s,gt,y]),pe=N.useCallback(()=>{St(),lt()},[St,lt]);return{messages:Vt,input:ht,handleInputChange:Ct,handleSubmit:se,isLoading:Ot,reload:ne,error:xt,stop:pe,append:yt,handleDirectMessageSubmit:jt,handleNudge:ae,clearChats:Ut,handleSaveTranscript:ue,rateLimitError:A,needsUsername:F,isClearDialogOpen:re,setIsClearDialogOpen:Jt,confirmClearChats:ce,isSaveDialogOpen:ie,setIsSaveDialogOpen:Rt,saveFileName:le,setSaveFileName:Gt,handleSaveSubmit:de,isSpeaking:w,highlightSegment:ft}}function Fe(l){let c=0;if(l&&l.length>0)for(let p=0;p<l.length;p++)c=c+l.charCodeAt(p)|0;else c=Math.floor(Math.random()*2**31);return()=>{c|=0,c=c+1831565813|0;let p=Math.imul(c^c>>>15,1|c);return p=p+Math.imul(p^p>>>7,61|p)^p,((p^p>>>14)>>>0)/4294967296}}function Ve({seed:l,className:c}){const p=N.useRef(l);p.current===void 0&&(p.current=Math.floor(Math.random()*2**31).toString()),N.useEffect(()=>{l&&l!==p.current&&(p.current=l)},[l]);const s=Fe(p.current),E=N.useRef(null),[B,y]=N.useState(420);N.useLayoutEffect(()=>{const w=E.current;if(!w)return;const M=()=>y(w.clientWidth||420);M();const A=new ResizeObserver(()=>M());return A.observe(w),()=>A.disconnect()},[]);const z=236/420,D=B,L=Math.max(120,Math.round(B*z)),gt=Math.max(24,Math.round(L*.35)),{jellyCount:st,bubbleCount:ht,floorCount:Y}=N.useMemo(()=>({jellyCount:3,bubbleCount:5,floorCount:7}),[]),Ct=2,q=6,ft=["ðŸŸ","ðŸ ","ðŸ¡"],at=["ðŸ¦ˆ","ðŸ¬"],G=["ðŸª¸","âš“ï¸","ðŸª¨","ðŸŒ¿","ðŸ—¿","ðŸš","ðŸ¦‘","ðŸ¦€"],mt="ðŸ«§",lt=N.useMemo(()=>{const w=[];if(Y<=0)return w;const M=8,A=16,F=Math.max(0,D-M-A)/(Y+1);for(let P=0;P<Y;P++){const R=M+F*(P+1),Z=(s()-.5)*F*.5;let j=Math.max(M,Math.min(D-A,R+Z));if(P>0){const H=Math.min(40,F*.6);j-w[P-1]<H&&(j=w[P-1]+H,j>D-A&&(j=D-A))}w.push(j)}return w},[D,Y,p.current]);return X.jsx($e,{reducedMotion:"never",children:X.jsx("div",{className:qt("chat-bubble bg-blue-300 text-black !p-0 mb-2 w-full max-w-[420px] rounded",c),children:X.jsxs("div",{ref:E,className:qt("relative z-0 overflow-hidden rounded"),style:{width:"100%",height:L},children:[Array.from({length:q}).map((w,M)=>{const A=ft[Math.floor(s()*ft.length)],C=s()>.5,F=24,P=6+s()*8,R=20,Z=Math.max(R,L-F-P),j=R+s()*(Z-R),H=14+s()*16,xt=s()*4,St=C?-60:D+60,ct=C?D+60:-60;return X.jsx(Tt.span,{initial:{x:St,y:j},animate:{x:[St,ct],y:[j,j-P,j,j+P,j]},transition:{x:{duration:H,ease:"linear",repeat:1/0,repeatType:"loop",delay:xt},y:{duration:H/2,repeat:1/0,repeatType:"mirror",ease:"easeInOut"}},style:{position:"absolute",willChange:"transform"},className:"select-none z-30",children:X.jsx("span",{style:{display:"inline-block",transform:C?"scaleX(-1)":void 0,fontSize:`${F}px`},children:A})},`fish-small-${M}`)}),Array.from({length:Ct}).map((w,M)=>{const A=at[Math.floor(s()*at.length)],C=s()>.5,F=40,P=8+s()*10,R=40,Z=20,j=Math.max(Z+40,L-gt-R-F-P),H=Z+s()*(j-Z),xt=18+s()*18,St=s()*4,ct=C?-80:D+80,yt=C?D+80:-80;return X.jsx(Tt.span,{initial:{x:ct,y:H},animate:{x:[ct,yt],y:[H,H-P,H,H+P,H]},transition:{x:{duration:xt,ease:"linear",repeat:1/0,repeatType:"loop",delay:St},y:{duration:xt/2,repeat:1/0,repeatType:"mirror",ease:"easeInOut"}},style:{position:"absolute",willChange:"transform"},className:"select-none z-30",children:X.jsx("span",{style:{display:"inline-block",transform:C?"scaleX(-1)":void 0,fontSize:`${F}px`},children:A})},`fish-large-${M}`)}),Array.from({length:st}).map((w,M)=>{const A=40+s()*(D-80),C=20+s()*(L*.45),F=18+s()*10,P=s()*3,R=14+s()*24;return X.jsx(Tt.span,{initial:{x:A,y:C},animate:{x:[A-R,A+R,A-R],y:[C,C+18,C],opacity:[.85,1,.85]},transition:{duration:F,repeat:1/0,delay:P,ease:"easeInOut",x:{duration:F*1.4,repeat:1/0,repeatType:"mirror",ease:"easeInOut",delay:P}},style:{position:"absolute",willChange:"transform, opacity"},className:"text-[24px] select-none z-20",children:"ðŸª¼"},`jelly-${M}`)}),Array.from({length:Math.floor(ht/2)}).map((w,M)=>{const A=10+s()*(D-20),C=s()*(L*.65),F=(s()-.5)*20,P=15+s()*18,R=s()*6;return X.jsx(Tt.span,{initial:{x:A,y:L-C,opacity:0,scale:.4},animate:{x:[A,A+F],y:[L-C,-25],opacity:[0,.25,.5,.3,0],scale:[.4,.7,1,.9,.5]},transition:{duration:P,ease:"easeOut",repeat:1/0,delay:R},style:{position:"absolute",willChange:"transform, opacity"},className:"text-[24px] select-none z-25",children:mt},`bubble-back-${M}`)}),Array.from({length:Math.ceil(ht/2)}).map((w,M)=>{const A=10+s()*(D-20),C=s()*(L*.65),F=(s()-.5)*20,P=15+s()*18,R=s()*6;return X.jsx(Tt.span,{initial:{x:A,y:L-C,opacity:0,scale:.4},animate:{x:[A,A+F],y:[L-C,-25],opacity:[0,.3,.7,.4,0],scale:[.4,.8,1.2,1,.6]},transition:{duration:P,ease:"easeOut",repeat:1/0,delay:R},style:{position:"absolute",willChange:"transform, opacity"},className:"text-[28px] select-none z-40",children:mt},`bubble-front-${M}`)}),X.jsx("div",{className:"absolute left-0 right-0 bottom-0 z-0 bg-gradient-to-t from-yellow-200/80 via-yellow-100/40 to-transparent",style:{height:gt}}),Array.from({length:Y}).map((w,M)=>{const A=G[Math.floor(s()*G.length)],C=lt[M]??8+s()*(D-16),F=.2+M*.07+s()*.2,P=(s()-.5)*10,R=18+s()*8,Z=8+s()*4,j=Math.max(0,L-R-Z);return X.jsx(Tt.span,{initial:{x:C,y:-20,opacity:0,rotate:P},animate:{x:C,y:j,opacity:1,rotate:P},transition:{type:"spring",stiffness:380,damping:20,delay:F},style:{position:"absolute"},className:"select-none z-0",children:X.jsx("span",{style:{fontSize:`${R}px`},children:A})},`floor-${M}`)}),X.jsx(Tt.span,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{duration:.6,delay:.15},className:"absolute right-4 top-1.5 select-none text-[24px]",children:"ðŸ›Ÿ"})]})})})}export{Ve as E,Be as u};
