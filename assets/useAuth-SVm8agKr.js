import{r as n,z as W,j as t}from"./ui-core-BpsHYXg8.js";import{a as re,u as le,av as ce,aw as G,ax as R,a4 as i,ay as J,aA as de,B as ue,a5 as fe,a6 as xe,a7 as H,a8 as me,a9 as Se,az as q,aq as B,aC as pe,am as L,ai as K,bY as Q}from"./index-o--Dc4yZ.js";function ge(s){const d=s==="xp"||s==="win98",l=s==="macosx",f=s==="system7",P=l?"rgba(0, 0, 0, 0.2)":f||d?"#808080":"rgba(0, 0, 0, 0.2)",h=`flex w-full ${l?"":"h-6"} space-x-0.5 shadow-none`,N="bg-[#E3E3E3] border-b border-[#808080]",c="bg-[#D4D4D4] data-[state=active]:bg-[#E3E3E3] border border-[#808080] data-[state=active]:border-b-[#E3E3E3]",k="bg-[#E3E3E3] border border-t-0 border-[#808080]",x="aqua-tab-bar",j="aqua-tab",b="aqua-tab-content",y=`relative flex-1 ${l?"":"h-6"} px-2 ${l?"":"-mb-[1px]"} rounded-t shadow-none! text-[16px]`,w=`mt-0 h-[calc(100%-2rem)] ${l?"":"bg-white"} border border-black/20`;return{tabListClasses:`${h} ${f?N:l?x:""}`,tabTriggerClasses:`${y} ${f?c:l?j:""}`,tabContentClasses:`${w} ${f?k:l?b:""}`,separatorStyle:{borderColor:P}}}function ve({isOpen:s,onOpenChange:d,initialTab:l="login",usernameInput:f,onUsernameInputChange:C,passwordInput:P,onPasswordInputChange:h,onLoginSubmit:N,isLoginLoading:c,loginError:k,newUsername:x,onNewUsernameChange:j,newPassword:b,onNewPasswordChange:y,onSignUpSubmit:w,isSignUpLoading:g,signUpError:v}){const[r,m]=n.useState(l),T=re(a=>a.current),e=T==="xp"||T==="win98",_=ge(T),{t:o}=le(),F=o("common.auth.dialogTitle");n.useEffect(()=>{s&&m(l)},[s,l]);const M=async a=>{a==null||a.preventDefault(),r==="login"?c||await N():g||await w()},D=()=>t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(q,{className:i("text-gray-700",e?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:e?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:e?"11px":void 0},children:o("common.auth.username")}),t.jsx(B,{autoFocus:r==="login",value:f,onChange:a=>C(a.target.value),className:i("shadow-none h-8",e?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:e?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:e?"11px":void 0},disabled:c})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(q,{className:i("text-gray-700",e?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:e?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:e?"11px":void 0},children:o("common.auth.password")}),t.jsx(B,{type:"password",value:P,onChange:a=>h(a.target.value),className:i("shadow-none h-8",e?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:e?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:e?"11px":void 0},disabled:c})]})]}),z=()=>t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(q,{className:i("text-gray-700",e?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:e?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:e?"11px":void 0},children:o("common.auth.username")}),t.jsx(B,{autoFocus:r==="signup",value:x,onChange:a=>j(a.target.value),className:i("shadow-none h-8",e?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:e?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:e?"11px":void 0},disabled:g})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(q,{className:i("text-gray-700",e?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:e?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:e?"11px":void 0},children:o("common.auth.password")}),t.jsx(B,{type:"password",value:b,onChange:a=>y(a.target.value),className:i("shadow-none h-8",e?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:e?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:e?"11px":void 0},disabled:g})]})]}),U=r==="login"?c:g,E=r==="login"?k:v,V=W.useRef(c),S=W.useRef(g);W.useEffect(()=>{const a=V.current&&!c&&!k&&r==="login",X=S.current&&!g&&!v&&r==="signup";s&&(a||X)&&d(!1),V.current=c,S.current=g},[s,c,g,k,v,r,d]);const I=t.jsx("div",{className:"pt-3 pb-6 px-6",children:t.jsxs("form",{onSubmit:M,children:[t.jsxs(ce,{value:r,onValueChange:a=>m(a),className:"w-full",children:[e?t.jsx(G,{asChild:!0,children:t.jsxs("menu",{role:"tablist",className:"h-7! flex justify-start! p-0 -mt-1 -mb-[2px] bg-transparent shadow-none grid grid-cols-2 w-full",children:[t.jsx(R,{value:"signup",className:i("relative px-4 py-1.5 rounded-none bg-white data-[state=active]:bg-black data-[state=active]:text-white data-[state=active]:z-10 data-[state=inactive]:border-r-0","font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]"),style:{fontFamily:'"Pixelated MS Sans Serif", "ArkPixel", Arial',fontSize:"11px"},children:o("common.auth.createAccount")}),t.jsx(R,{value:"login",className:i("relative px-4 py-1.5 rounded-none bg-white data-[state=active]:bg-black data-[state=active]:text-white data-[state=active]:z-10","font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]"),style:{fontFamily:'"Pixelated MS Sans Serif", "ArkPixel", Arial',fontSize:"11px"},children:o("common.auth.logIn")})]})}):t.jsxs(G,{className:i(_.tabListClasses,"grid grid-cols-2 w-full"),children:[t.jsx(R,{value:"signup",className:i(_.tabTriggerClasses,"px-4 py-1.5",e?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:e?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:e?"11px":void 0},children:o("common.auth.createAccount")}),t.jsx(R,{value:"login",className:i(_.tabTriggerClasses,"px-4 py-1.5",e?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:e?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:e?"11px":void 0},children:o("common.auth.logIn")})]}),t.jsx(J,{value:"signup",className:_.tabContentClasses,children:t.jsx("div",{className:"p-4",children:z()})}),t.jsx(J,{value:"login",className:_.tabContentClasses,children:t.jsx("div",{className:"p-4",children:D()})})]}),E&&t.jsx("p",{className:i("text-red-600 mt-3",e?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:e?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:e?"11px":void 0},children:E}),t.jsx(de,{className:"mt-6 gap-1 sm:justify-end",children:t.jsx(ue,{type:"submit",variant:"retro",disabled:U||(r==="login"?!f.trim()||!P.trim():!x.trim()),className:i("w-full sm:w-auto h-7",e?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:e?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:e?"11px":void 0},children:o(U?r==="login"?"common.auth.loggingIn":"common.auth.creatingAccount":r==="login"?"common.auth.logIn":"common.auth.createAccount")})})]})});return t.jsx(fe,{open:s,onOpenChange:d,children:t.jsx(xe,{className:i("max-w-[400px]",e&&"p-0 overflow-hidden"),style:e?{fontSize:"11px"}:void 0,onKeyDown:a=>a.stopPropagation(),children:e?t.jsxs(t.Fragment,{children:[t.jsx(H,{children:F}),t.jsx("div",{className:"window-body",children:I})]}):T==="macosx"?t.jsxs(t.Fragment,{children:[t.jsx(H,{children:F}),I]}):t.jsxs(t.Fragment,{children:[t.jsxs(H,{children:[t.jsx(me,{className:"font-normal text-[16px]",children:F}),t.jsx(Se,{className:"sr-only",children:o(r==="login"?"common.auth.loginDescription":"common.auth.signupDescription")})]}),I]})})})}function be(){const{username:s,authToken:d,hasPassword:l,setAuthToken:f,setUsername:C,createUser:P,logout:h,checkHasPassword:N,setPassword:c}=pe(),[k,x]=n.useState(!1),[j,b]=n.useState(""),[y,w]=n.useState(""),[g,v]=n.useState(!1),[r,m]=n.useState(null),[T,e]=n.useState(!1),[_,o]=n.useState(""),[F,M]=n.useState(""),[D,z]=n.useState(""),[U,E]=n.useState(!1),[V,S]=n.useState(null),[I,a]=n.useState(!1),X=n.useCallback(()=>{b(""),w(""),m(null),x(!0)},[]),Z=n.useCallback(async()=>{v(!0),m(null);const u=j.trim();if(!u){m("Username cannot be empty."),v(!1);return}if(s&&s!==u&&(console.log("[useAuth] Clearing old user data for different user:",s,"->",u),await h()),!y.trim()){m("Password is required."),v(!1);return}if(y.length<8){m("Password must be at least 8 characters."),v(!1);return}const $=await P(u,y);$.ok?(x(!1),b(""),w(""),L.success("Logged In",{description:`Welcome, ${u}!`})):m($.error||"Failed to set username"),v(!1)},[j,y,P]),ee=n.useCallback(()=>{o(""),M(""),z(s||""),S(null),e(!0)},[s]),te=n.useCallback(async(u,$=!1)=>{if(!u.trim()){S($?"Password required":"Token required");return}E(!0),S(null);try{if($){const p=D.trim()||s||"";s&&s!==p&&(console.log("[useAuth] Clearing old user data for different user login:",s,"->",p),await h());const A=await fetch("/api/chat-rooms?action=authenticateWithPassword",{method:"POST",headers:{"Content-Type":"application/json",...d?{Authorization:`Bearer ${d}`}:{}},body:JSON.stringify({username:p,password:u.trim(),...d?{oldToken:d}:{}})});if(!A.ok){const ie=await A.json();S(ie.error||"Invalid username or password");return}const O=await A.json();O.token&&(f(O.token),O.username&&C(O.username),K(Q.USER_LOGIN_PASSWORD,{username:O.username||p}),L.success("Success",{description:"Logged in successfully with password"}),e(!1),M(""),x(!1))}else{(s||d)&&(console.log("[useAuth] Clearing existing user data before token login to prevent mixing"),await h());const p=await fetch("/api/chat-rooms?action=verifyToken",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u.trim()}`},body:JSON.stringify({})});if(!p.ok){p.status===401?S("Invalid token - authentication failed"):S(`Token validation failed (${p.status})`);return}const A=await p.json();console.log("[useAuth] Token validation successful:",A),f(u.trim()),A.username&&C(A.username),K(Q.USER_LOGIN_TOKEN,{username:A.username||""}),L.success("Success",{description:"Token verified and set successfully"}),e(!1),o(""),x(!1)}}catch(p){console.error("[useAuth] Error verifying:",p),S("Network error while verifying")}finally{E(!1)}},[f,C,s,D]),ae=n.useCallback(async()=>N(),[N]),se=n.useCallback(async u=>c(u),[c]),Y=n.useCallback(async()=>{console.log("[useAuth] Logging out user..."),x(!1),e(!1),a(!1),b(""),w(""),o(""),M(""),z(""),m(null),S(null),await h(),L.success("Logged Out",{description:"You have been successfully logged out."})},[h]),ne=n.useCallback(async()=>{a(!0)},[]),oe=n.useCallback(()=>{a(!1),Y()},[Y]);return{username:s,authToken:d,hasPassword:l,promptSetUsername:X,isUsernameDialogOpen:k,setIsUsernameDialogOpen:x,newUsername:j,setNewUsername:b,newPassword:y,setNewPassword:w,isSettingUsername:g,usernameError:r,submitUsernameDialog:Z,setUsernameError:m,promptVerifyToken:ee,isVerifyDialogOpen:T,setVerifyDialogOpen:e,verifyTokenInput:_,setVerifyTokenInput:o,verifyPasswordInput:F,setVerifyPasswordInput:M,verifyUsernameInput:D,setVerifyUsernameInput:z,isVerifyingToken:U,verifyError:V,handleVerifyTokenSubmit:te,checkHasPassword:ae,setPassword:se,logout:ne,confirmLogout:oe,isLogoutConfirmDialogOpen:I,setIsLogoutConfirmDialogOpen:a}}export{ve as L,ge as g,be as u};
