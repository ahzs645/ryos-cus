import{r as o,j as e,S as ia}from"./ui-core-D0pDhx0h.js";import{c as Ie,u as Le,a as $e,as as js,M as la,b as tt,d as st,e as at,f as ge,g as De,k as Be,S as ca,l as pa,m as Ss,a4 as $,at as ft,au as da,av as ua,aw as as,ax as dt,ay as ns,az as rs,aq as $t,L as rt,aA as ha,B as be,a5 as ma,a6 as xa,a7 as At,a8 as fa,a9 as ga,aB as ba,aC as ne,am as Ee,X as ya,Y as Cs,aa as He,ab as qe,ac as We,ae as Ve,V as va,C as Ns,aD as wa,a3 as Pt,n as Ts,o as As,aE as ka,A as ja,aF as Sa,ai as ut,aG as ht,a1 as Ps,af as os,a0 as is,$ as Ca,aH as Na,aI as Ta,aJ as Aa,E as Pa,an as Ea,aK as Et,Z as Ia,H as Ra,J as Ma,aL as La,G as ls,I as cs,aM as Da}from"./index-CoK7-gOT.js";import{S as $a,M as ps,u as Es,L as Oa}from"./LogoutDialog-bUnnUXBG.js";import{L as Is}from"./LoginDialog-DJhqAGfC.js";import{p as _a,q as Fa}from"./ui-form-Bg85K0S3.js";import{X as za}from"./x-ub5chxjV.js";import{E as Ua,u as Ba}from"./EmojiAquarium-ntFNLPNH.js";import{u as Ha}from"./useAuth-CyIdBQGY.js";import{H as It,u as qa,C as ds}from"./useTerminalSounds-D4QyG8Ob.js";import{u as Wa}from"./useTtsQueue-DNOiImb5.js";import{m as q,A as Me}from"./motion-DC7C-474.js";import{M as us}from"./message-square-BmyZBajy.js";import{P as Va}from"./plus-Bwe67tfS.js";import{u as Ya,D as Xa}from"./ai-sdk-CIHyILzO.js";import"./react-CyQK0IK8.js";import"./media-player-Dfptv93o.js";import"./zustand-CwjPl1Tm.js";import"./tiptap-CPHiBm_b.js";import"./audio-DxkJfdUY.js";import"./pusher-BvD42uFZ.js";import"./hangul-CIZ_Rl7P.js";import"./three-BOJBN814.js";import"./appletAuthBridge-gdg5QSWM.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ga=[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]],Ka=Ie("ArrowUp",Ga);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ja=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M16 8v5a3 3 0 0 0 6 0v-1a10 10 0 1 0-4 8",key:"7n84p3"}]],Za=Ie("AtSign",Ja);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qa=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],Rs=Ie("CircleAlert",Qa);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const en=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]],Je=Ie("ExternalLink",en);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tn=[["path",{d:"M18 11V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2",key:"1fvzgz"}],["path",{d:"M14 10V4a2 2 0 0 0-2-2a2 2 0 0 0-2 2v2",key:"1kc0my"}],["path",{d:"M10 10.5V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2v8",key:"10h0bg"}],["path",{d:"M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15",key:"1s1gnw"}]],sn=Ie("Hand",tn);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const an=[["rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",key:"zuxfzm"}],["rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",key:"1okwgv"}]],nn=Ie("Pause",an);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rn=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],on=Ie("Send",rn);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ln=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]],cn=Ie("Square",ln);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pn=[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}]],Ot=Ie("Trash",pn);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dn=[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"M2 8h20",key:"d11cs7"}],["circle",{cx:"8",cy:"14",r:"2",key:"1k2qr5"}],["path",{d:"M8 12h8",key:"1wcyev"}],["circle",{cx:"16",cy:"14",r:"2",key:"14k7lr"}]],hs=Ie("Videotape",dn);function un(s,a){if(!a)return s;const x=s.split(", ").map(h=>h.trim()).filter(h=>h.startsWith("@")).map(h=>h.substring(1)).filter(h=>h!==a);return x.length===0?s:x.map(h=>`@${h}`).join(", ")}function gt(s,a){if(Array.isArray(s.members)&&s.members.length>0){const d=s.members.filter(h=>!a||h!==a.toLowerCase());return(d.length>0?d:[a??s.members[0]]).map(h=>`@${h}`).join(", ")}return un(s.name,a)}function hn({onClose:s,onShowHelp:a,onShowAbout:d,onClearChats:x,onSaveTranscript:h,onSetUsername:A,onToggleSidebar:T,isSidebarVisible:j,onAddRoom:p,rooms:w,currentRoom:C,onRoomSelect:t,onIncreaseFontSize:c,onDecreaseFontSize:E,onResetFontSize:N,username:u,authToken:r,onVerifyToken:k,isVerifyDialogOpen:g,setVerifyDialogOpen:S,verifyPasswordInput:n,setVerifyPasswordInput:i,verifyUsernameInput:m,setVerifyUsernameInput:b,isVerifyingToken:y,verifyError:V,handleVerifyTokenSubmit:X,onLogout:te}){var je;const{t:M}=Le(),[I,U]=o.useState(!1),ie="chats",ye=(je=Ss[ie])==null?void 0:je.name,ue=$e(f=>f.current),ve=ue==="xp"||ue==="win98",{speechEnabled:ce,setSpeechEnabled:W,typingSynthEnabled:pe,setTypingSynthEnabled:xe,synthPreset:Z,setSynthPreset:he,keepTalkingEnabled:ke,setKeepTalkingEnabled:Pe}=js(f=>({speechEnabled:f.speechEnabled,setSpeechEnabled:f.setSpeechEnabled,typingSynthEnabled:f.typingSynthEnabled,setTypingSynthEnabled:f.setTypingSynthEnabled,synthPreset:f.synthPreset,setSynthPreset:f.setSynthPreset,keepTalkingEnabled:f.keepTalkingEnabled,setKeepTalkingEnabled:f.setKeepTalkingEnabled,debugMode:f.debugMode}));return e.jsxs(e.Fragment,{children:[e.jsxs(la,{inWindowFrame:ve,children:[e.jsxs(tt,{children:[e.jsx(st,{className:"text-md px-2 py-1 border-none focus-visible:ring-0",children:M("common.menu.file")}),e.jsxs(at,{align:"start",sideOffset:1,className:"px-0",children:[e.jsx(ge,{onClick:h,className:"text-md h-6 px-3",children:M("apps.chats.menu.saveTranscript")}),e.jsx(ge,{onClick:x,disabled:C!==null,className:"text-md h-6 px-3",children:M("apps.chats.menu.clearChat")}),e.jsx(De,{className:"h-[2px] bg-black my-1"}),u&&r?e.jsx(ge,{onClick:()=>te==null?void 0:te(),className:"text-md h-6 px-3",children:M("apps.chats.menu.logOut")}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{onClick:A,className:"text-md h-6 px-3",children:M("apps.chats.menu.createAccount")}),e.jsx(ge,{onClick:k,className:"text-md h-6 px-3",children:M("apps.chats.menu.login")})]}),e.jsx(De,{className:"h-[2px] bg-black my-1"}),e.jsx(ge,{onClick:s,className:"text-md h-6 px-3",children:M("common.menu.close")})]})]}),e.jsxs(tt,{children:[e.jsx(st,{className:"text-md px-2 py-1 border-none focus-visible:ring-0",children:M("apps.chats.menu.chats")}),e.jsxs(at,{align:"start",sideOffset:1,className:"px-0 max-h-[300px] overflow-y-auto",children:[e.jsx(ge,{onClick:p,className:"text-md h-6 px-3",children:M("apps.chats.menu.newChat")}),w.length>0&&e.jsx(De,{className:"h-[2px] bg-black my-1"}),e.jsx(Be,{checked:C===null,onCheckedChange:f=>{f&&t(null)},className:"text-md h-6 px-3",children:M("apps.chats.status.ryo")}),Array.isArray(w)&&(()=>{const f=w.filter(F=>F.type==="private"),D=w.filter(F=>F.type!=="private");return[...f,...D].map(F=>e.jsx(Be,{checked:(C==null?void 0:C.id)===F.id,onCheckedChange:l=>{l&&t(F)},className:"text-md h-6 px-3",children:F.type==="private"?gt(F,u??null):`#${F.name}`},F.id))})()]})]}),e.jsxs(tt,{children:[e.jsx(st,{className:"text-md px-2 py-1 border-none focus-visible:ring-0",children:M("apps.chats.menu.sound")}),e.jsxs(at,{align:"start",sideOffset:1,className:"px-0",children:[Object.entries($a).map(([f,D])=>e.jsx(Be,{checked:Z===f,onCheckedChange:z=>{z&&he(f)},className:"text-md h-6 px-3",children:D.name},f)),e.jsx(De,{className:"h-[2px] bg-black my-1"}),e.jsx(Be,{checked:ce,onCheckedChange:f=>W(f),className:"text-md h-6 px-3",children:M("apps.chats.menu.chatSpeech")}),e.jsx(Be,{checked:pe,onCheckedChange:f=>xe(f),className:"text-md h-6 px-3",children:M("apps.chats.menu.typingSynth")}),e.jsx(De,{className:"h-[2px] bg-black my-1"}),e.jsx(Be,{checked:ke,onCheckedChange:f=>Pe(f),className:"text-md h-6 px-3",children:M("apps.chats.menu.keepTalking")})]})]}),e.jsxs(tt,{children:[e.jsx(st,{className:"text-md px-2 py-1 border-none focus-visible:ring-0",children:M("common.menu.view")}),e.jsxs(at,{align:"start",sideOffset:1,className:"px-0",children:[e.jsx(ge,{onClick:c,className:"text-md h-6 px-3",children:M("apps.chats.menu.increaseFontSize")}),e.jsx(ge,{onClick:E,className:"text-md h-6 px-3",children:M("apps.chats.menu.decreaseFontSize")}),e.jsx(De,{className:"h-[2px] bg-black my-1"}),e.jsx(ge,{onClick:N,className:"text-md h-6 px-3",children:M("apps.chats.menu.resetFontSize")}),e.jsx(De,{className:"h-[2px] bg-black my-1"}),e.jsx(Be,{checked:j,onCheckedChange:f=>{console.log("[MenuBar] Toggle Sidebar menu item clicked"),f!==j&&T()},className:"text-md h-6 px-3",children:M("apps.chats.menu.showRooms")})]})]}),e.jsxs(tt,{children:[e.jsx(st,{className:"px-2 py-1 text-md focus-visible:ring-0",children:M("common.menu.help")}),e.jsxs(at,{align:"start",sideOffset:1,className:"px-0",children:[e.jsx(ge,{onClick:a,className:"text-md h-6 px-3",children:M("apps.chats.menu.chatsHelp")}),e.jsx(ge,{onSelect:()=>U(!0),className:"text-md h-6 px-3",children:M("common.menu.shareApp")}),e.jsx(De,{className:"h-[2px] bg-black my-1"}),e.jsx(ge,{onClick:d,className:"text-md h-6 px-3",children:M("apps.chats.menu.aboutChats")})]})]})]}),e.jsx(Is,{isOpen:g,onOpenChange:f=>{S(f)},usernameInput:m,onUsernameInputChange:b,passwordInput:n,onPasswordInputChange:i,onLoginSubmit:async()=>{await X(n,!0)},isLoginLoading:y,loginError:V,newUsername:m,onNewUsernameChange:b,newPassword:n,onNewPasswordChange:i,onSignUpSubmit:async()=>{S(!1),A()},isSignUpLoading:!1,signUpError:null}),e.jsx(ca,{isOpen:I,onClose:()=>U(!1),itemType:"App",itemIdentifier:ie,title:ye,generateShareUrl:pa})]})}function mn({className:s,...a}){return e.jsx(_a,{"data-slot":"checkbox",className:$("peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",s),...a,children:e.jsx(Fa,{"data-slot":"checkbox-indicator",className:"flex items-center justify-center text-current transition-none",children:e.jsx(ft,{className:"size-3.5"})})})}const xn=da("inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground"}},defaultVariants:{variant:"default"}});function fn({className:s,variant:a,asChild:d=!1,...x}){const h=d?ia:"span";return e.jsx(h,{"data-slot":"badge",className:$(xn({variant:a}),s),...x})}function gn({isOpen:s,onOpenChange:a,onSubmit:d,isAdmin:x,currentUsername:h,initialUsers:A=[]}){const{t:T}=Le(),[j,p]=o.useState(!1),[w,C]=o.useState(null),[t,c]=o.useState(""),[E,N]=o.useState([]),[u,r]=o.useState([]),[k,g]=o.useState(""),[S,n]=o.useState("private"),[i,m]=o.useState(!1),b=$e(I=>I.current),y=b==="xp"||b==="win98";o.useEffect(()=>{s&&(C(null),c(""),N(A),g(""),r([]),n("private"))},[s,A]),o.useEffect(()=>{if(k.length<2){r([]);return}const I=setTimeout(()=>{V(k)},300);return()=>clearTimeout(I)},[k]);const V=async I=>{m(!0);try{const U=await fetch(`/api/chat-rooms?action=getUsers&search=${encodeURIComponent(I)}`);if(U.ok){const ue=((await U.json()).users||[]).filter(ve=>ve.username!==(h==null?void 0:h.toLowerCase()));r(ue)}}catch(U){console.error("Failed to search users:",U)}finally{m(!1)}},X=async()=>{p(!0),C(null);try{const I=await d(t,S,E);I.ok?a(!1):C(I.error||T("apps.chats.dialogs.failedToCreateRoom"))}finally{p(!1)}},te=I=>{N(U=>U.includes(I)?U.filter(ie=>ie!==I):[...U,I])},M=e.jsxs("div",{className:y?"pt-2 pb-6 px-4":"pt-2 pb-6 px-6",children:[e.jsxs(ua,{value:S,onValueChange:I=>n(I),children:[x&&(y?e.jsx(as,{asChild:!0,children:e.jsxs("menu",{role:"tablist",className:"h-7! flex justify-start p-0 -mt-1 -mb-[2px] bg-transparent shadow-none /* Windows XP/98 tab strip */",children:[e.jsx(dt,{value:"private",children:T("apps.chats.sidebar.private")}),e.jsx(dt,{value:"public",children:T("apps.chats.dialogs.public")})]})}):e.jsxs(as,{className:"grid grid-cols-2 w-full h-fit mb-4 bg-transparent p-0.5 border border-black",children:[e.jsx(dt,{value:"private",className:"relative px-4 py-1.5 rounded-none bg-white data-[state=active]:bg-black data-[state=active]:text-white data-[state=active]:z-10 data-[state=inactive]:border-r-0 font-geneva-12 text-[12px]",children:T("apps.chats.sidebar.private")}),e.jsx(dt,{value:"public",className:"relative px-4 py-1.5 rounded-none bg-white data-[state=active]:bg-black data-[state=active]:text-white data-[state=active]:z-10 font-geneva-12 text-[12px]",children:T("apps.chats.dialogs.public")})]})),x&&e.jsx(ns,{value:"public",className:$("mt-0",y?"bg-white border border-[#919b9c] p-4":""),children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(rs,{htmlFor:"room-name",className:$("text-gray-700",y?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:y?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:y?"11px":void 0},children:T("apps.chats.dialogs.roomName")}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:$("absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none",y?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:y?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:y?"11px":void 0},children:"#"}),e.jsx($t,{id:"room-name",value:t,onChange:I=>{const U=I.target.value.replace(/^#/,"");c(U)},placeholder:T("apps.chats.dialogs.roomNamePlaceholder"),className:$("shadow-none h-8 pl-6",y?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:y?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:y?"11px":void 0},disabled:j})]})]})}),e.jsx(ns,{value:"private",className:$("mt-0",y?"bg-white border border-[#919b9c] p-4":""),children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(rs,{htmlFor:"search-users",className:$("text-gray-700",y?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:y?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:y?"11px":void 0},children:T("apps.chats.dialogs.addUsersToPrivateChat")}),e.jsxs("div",{className:"relative",children:[e.jsx($t,{id:"search-users",placeholder:T("apps.chats.dialogs.searchUsernamePlaceholder"),value:k,onChange:I=>g(I.target.value),className:$("shadow-none h-8 pr-8",y?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:y?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:y?"11px":void 0},disabled:j}),i&&k.length>=2&&e.jsx(rt,{className:"absolute right-2 top-1/2 -translate-y-1/2 h-4 w-4 animate-spin text-gray-500"})]}),E.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5 pt-1",children:E.map(I=>e.jsxs(fn,{variant:"secondary",className:$("py-0.5 pl-2 pr-1 bg-gray-100 hover:bg-gray-200 border-gray-300",y?"font-['Pixelated_MS_Sans_Serif',Arial] text-[10px]":"font-geneva-12 text-[11px]"),style:{fontFamily:y?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:y?"10px":void 0},children:["@",I,e.jsx("button",{type:"button",onClick:()=>te(I),className:"ml-1 hover:bg-gray-300 rounded-sm p-0.5",disabled:j,children:e.jsx(za,{className:"h-3 w-3"})})]},I))})]}),!i&&k.length>=2&&u.length>0&&e.jsx("div",{className:"border border-gray-300 rounded max-h-[180px] overflow-y-auto bg-white",children:e.jsx("div",{className:"p-1",children:u.map(I=>e.jsxs("label",{className:$("flex items-center p-2 hover:bg-gray-100 cursor-pointer rounded",y?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:y?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:y?"11px":void 0},children:[e.jsx(mn,{checked:E.includes(I.username),onCheckedChange:()=>te(I.username),className:"h-4 w-4",disabled:j}),e.jsxs("span",{className:"ml-2",children:["@",I.username]})]},I.username))})})]})})]}),w&&e.jsx("p",{className:$("text-red-600 mt-3",y?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:y?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:y?"11px":void 0},children:w}),e.jsxs(ha,{className:"mt-4 gap-1 sm:gap-0",children:[e.jsx(be,{variant:"retro",onClick:()=>a(!1),disabled:j,className:$("h-7",y?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:y?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:y?"11px":void 0},children:T("apps.chats.dialogs.cancel")}),e.jsx(be,{variant:"retro",onClick:X,disabled:j||S==="public"&&!t.trim()||S==="private"&&E.length===0,className:$("h-7",y?"font-['Pixelated_MS_Sans_Serif',Arial] text-[11px]":"font-geneva-12 text-[12px]"),style:{fontFamily:y?'"Pixelated MS Sans Serif", "ArkPixel", Arial':void 0,fontSize:y?"11px":void 0},children:T(j?"apps.chats.dialogs.creating":"apps.chats.dialogs.create")})]})]});return e.jsx(ma,{open:s,onOpenChange:a,children:e.jsx(xa,{className:$("max-w-[400px]",y&&"p-0 overflow-hidden"),style:y?{fontSize:"11px"}:void 0,children:y?e.jsxs(e.Fragment,{children:[e.jsx(At,{children:T("apps.chats.dialogs.newChatTitle")}),e.jsx("div",{className:"window-body",children:M})]}):b==="macosx"?e.jsxs(e.Fragment,{children:[e.jsx(At,{children:T("apps.chats.dialogs.newChatTitle")}),M]}):e.jsxs(e.Fragment,{children:[e.jsxs(At,{children:[e.jsx(fa,{className:"font-normal text-[16px]",children:T("apps.chats.dialogs.newChatTitle")}),e.jsx(ga,{className:"sr-only",children:T(x?"apps.chats.dialogs.newChatDescription":"apps.chats.dialogs.newChatDescriptionPrivate")})]}),M]})})})}const Rt=globalThis,bn="b47fd563805c8c42da1a",yn="us3";function vn(){return Rt.__pusherClient||(Rt.__pusherClient=new ba(bn,{cluster:yn,forceTLS:!0})),Rt.__pusherClient}const wn=s=>s?`chats-${s.toLowerCase().replace(/[^a-zA-Z0-9_\-.]/g,"_")}`:"chats-public",kn=s=>{if(!s)return s;if(typeof window<"u"&&typeof document<"u"){const a=document.createElement("textarea");return a.innerHTML=s,a.value}return s.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&apos;/g,"'")};function jn(s,a){const{username:d,authToken:x,rooms:h,currentRoomId:A,roomMessages:T,isSidebarVisible:j,toggleSidebarVisibility:p,fetchRooms:w,fetchBulkMessages:C,setRooms:t,switchRoom:c,createRoom:E,deleteRoom:N,sendMessage:u,addMessageToRoom:r,removeMessageFromRoom:k,incrementUnread:g,messageRenderLimit:S}=ne(),n=d==="ryo",i=o.useRef(null),m=o.useRef(null),b=o.useRef({}),y=o.useRef(!1),[V,X]=o.useState(!1),[te,M]=o.useState(!1),[I,U]=o.useState(null),ie=A?T[A]||[]:[],ye=A?(T[A]||[]).slice(-S):[],ue=o.useCallback(()=>{i.current||(console.log("[Pusher Hook] Getting singleton Pusher client..."),i.current=vn(),i.current.connection.bind("connected",()=>{console.log("[Pusher Hook] Connected to Pusher")}),i.current.connection.bind("error",f=>{console.error("[Pusher Hook] Connection error:",f)}))},[]),ve=o.useCallback(()=>{if(!i.current)return;const f=wn(d);if(m.current&&m.current.name!==f&&(console.log(`[Pusher Hook] Unsubscribing from old global channel: ${m.current.name}`),i.current.unsubscribe(m.current.name),m.current=null),!m.current){console.log(`[Pusher Hook] Subscribing to global channel: ${f}`),m.current=i.current.subscribe(f);const D=P=>{console.log("[Pusher Hook] Room created:",P.room);const{rooms:R}=ne.getState();R.some(de=>de.id===P.room.id)||t([...R,P.room])},z=P=>{console.log("[Pusher Hook] Room deleted:",P.roomId);const{rooms:R}=ne.getState();t(R.filter(O=>O.id!==P.roomId))},F=P=>{console.log("[Pusher Hook] Room updated:",P.room);const{rooms:R}=ne.getState(),O=R.map(de=>de.id===P.room.id?{...de,...P.room}:de);t(O)},l=P=>{console.log("[Pusher Hook] Rooms updated:",P.rooms.length,"rooms"),t(P.rooms)};m.current.unbind("room-created"),m.current.unbind("room-deleted"),m.current.unbind("room-updated"),m.current.unbind("rooms-updated"),m.current.bind("room-created",D),m.current.bind("room-deleted",z),m.current.bind("room-updated",F),m.current.bind("rooms-updated",l)}},[d,w,t]),ce=o.useCallback(f=>{if(!i.current||b.current[f])return;console.log(`[Pusher Hook] Subscribing to room channel: room-${f}`);const D=i.current.subscribe(`room-${f}`);b.current[f]=D;const z=l=>{console.log("[Pusher Hook] Received room-message:",l.message);const P={...l.message,timestamp:typeof l.message.timestamp=="string"||typeof l.message.timestamp=="number"?new Date(l.message.timestamp).getTime():l.message.timestamp};r(l.message.roomId,P);const{currentRoomId:R}=ne.getState();if(R!==l.message.roomId){g(l.message.roomId);const de=kn(String(l.message.content||"")).replace(/\s+/g," ").trim().slice(0,80);Ee(`@${l.message.username}`,{description:de,action:{label:"Open",onClick:()=>{c(l.message.roomId),ce(l.message.roomId)}}})}},F=l=>{console.log("[Pusher Hook] Message deleted:",l.messageId),k(l.roomId,l.messageId)};D.unbind("room-message"),D.unbind("message-deleted"),D.bind("room-message",z),D.bind("message-deleted",F)},[r,k,c,g]),W=o.useCallback(f=>{!i.current||!b.current[f]||(console.log(`[Pusher Hook] Unsubscribing from room channel: room-${f}`),i.current.unsubscribe(`room-${f}`),delete b.current[f])},[]),pe=o.useCallback(async f=>{if(f===A)return;console.log(`[Room Hook] Switching to room: ${f||"@ryo"}`);const{unreadCounts:D}=ne.getState(),z=f?(D[f]||0)>0:!1;return await c(f),f&&ce(f),{hadUnreads:z}},[A,c,ce]),xe=o.useCallback(async f=>{var z,F,l,P;if(!A||!d||!f.trim())return;const D=await u(A,f.trim());D.ok||(((z=D.error)==null?void 0:z.toLowerCase().includes("authentication required"))||((F=D.error)==null?void 0:F.toLowerCase().includes("unauthorized"))||((l=D.error)==null?void 0:l.toLowerCase().includes("authentication failed"))||((P=D.error)==null?void 0:P.toLowerCase().includes("username mismatch"))?Ee.error("Login Required",{description:"Please login to send messages.",duration:5e3,action:a?{label:"Login",onClick:a}:void 0}):Ee("Error",{description:D.error||"Failed to send message."}))},[A,d,u,a]),Z=o.useCallback(async(f,D="public",z=[])=>{if(!d)return{ok:!1,error:"Set a username first."};if(D==="public"&&!n)return{ok:!1,error:"Permission denied. Admin access required."};const F=await E(f,D,z);return F.ok&&F.roomId&&pe(F.roomId),F},[d,n,E,pe]),he=o.useCallback(async f=>{if(!f)return{ok:!1,error:"Invalid room."};const D=h.find(F=>F.id===f);if(!D)return{ok:!1,error:"Room not found."};if(D.type!=="private"&&!n)return{ok:!1,error:"Permission denied. Admin access required for public rooms."};const z=await N(f);return z.ok&&A===f&&pe(null),z},[n,N,A,pe,h]),ke=o.useCallback(()=>{X(!0)},[]),Pe=o.useCallback(f=>{U(f),M(!0)},[]),je=o.useCallback(async()=>{var D,z,F,l;if(!I)return;const f=await he(I.id);f.ok?(M(!1),U(null)):((D=f.error)==null?void 0:D.toLowerCase().includes("authentication required"))||((z=f.error)==null?void 0:z.toLowerCase().includes("unauthorized"))||((F=f.error)==null?void 0:F.toLowerCase().includes("authentication failed"))||((l=f.error)==null?void 0:l.toLowerCase().includes("username mismatch"))?Ee.error("Login Required",{description:"Please login to delete rooms.",duration:5e3,action:a?{label:"Login",onClick:a}:void 0}):Ee("Error",{description:f.error||"Failed to delete room."})},[I,he,a]);return o.useEffect(()=>{!s||y.current||(console.log("[Room Hook] Initializing chat room..."),y.current=!0,ue(),(async()=>{if((await w()).ok){const{rooms:D}=ne.getState();if(D.length>0){const z=D.slice(0,5).map(l=>l.id);if(console.log(`[useChatRoom] Initial bulk fetch of messages for ${z.length} rooms`),(await C(z)).ok){const{hasEverUsedChats:l,setHasEverUsedChats:P}=ne.getState();l?console.log("[useChatRoom] Experienced user - skipping unread recalculation on reload, will track new messages only"):(console.log("[useChatRoom] First-time user detected - skipping unread calculation and marking as experienced user"),P(!0))}}}})())},[s,ue,w,C]),o.useEffect(()=>{s&&ve()},[s,d,ve]),o.useEffect(()=>{s&&(h.forEach(f=>{ce(f.id)}),Object.keys(b.current).forEach(f=>{h.some(z=>z.id===f)||W(f)}))},[s,h,ce,W]),o.useEffect(()=>()=>{console.log("[Pusher Hook] Cleaning up..."),Object.keys(b.current).forEach(f=>{W(f)}),m.current&&i.current&&(i.current.unsubscribe(m.current.name),m.current=null)},[W]),{username:d,authToken:x,rooms:h,currentRoomId:A,currentRoomMessages:ie,currentRoomMessagesLimited:ye,isSidebarVisible:j,isAdmin:n,handleRoomSelect:pe,sendRoomMessage:xe,toggleSidebarVisibility:p,handleAddRoom:Z,promptAddRoom:ke,promptDeleteRoom:Pe,isNewRoomDialogOpen:V,setIsNewRoomDialogOpen:X,isDeleteRoomDialogOpen:te,setIsDeleteRoomDialogOpen:M,roomToDelete:I,confirmDeleteRoom:je}}/*!---------------------------------------------------------------------------------------------
 *  Copyright (c) StackBlitz. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/const Sn={damping:.7,stiffness:.05,mass:1.25},Cn=70,Nn=1e3/60,Tn=350;let yt=!1;var vs;(vs=globalThis.document)==null||vs.addEventListener("mousedown",()=>{yt=!0});var ws;(ws=globalThis.document)==null||ws.addEventListener("mouseup",()=>{yt=!1});var ks;(ks=globalThis.document)==null||ks.addEventListener("click",()=>{yt=!1});const An=(s={})=>{const[a,d]=o.useState(!1),[x,h]=o.useState(s.initial!==!1),[A,T]=o.useState(!1),j=o.useRef(null);j.current=s;const p=o.useCallback(()=>{var n;if(!yt)return!1;const g=window.getSelection();if(!g||!g.rangeCount)return!1;const S=g.getRangeAt(0);return S.commonAncestorContainer.contains(r.current)||((n=r.current)==null?void 0:n.contains(S.commonAncestorContainer))},[]),w=o.useCallback(g=>{t.isAtBottom=g,h(g)},[]),C=o.useCallback(g=>{t.escapedFromLock=g,d(g)},[]),t=o.useMemo(()=>{let g;return{escapedFromLock:a,isAtBottom:x,resizeDifference:0,accumulated:0,velocity:0,listeners:new Set,get scrollTop(){var S;return((S=r.current)==null?void 0:S.scrollTop)??0},set scrollTop(S){r.current&&(r.current.scrollTop=S,t.ignoreScrollToTop=r.current.scrollTop)},get targetScrollTop(){return!r.current||!k.current?0:r.current.scrollHeight-1-r.current.clientHeight},get calculatedTargetScrollTop(){if(!r.current||!k.current)return 0;const{targetScrollTop:S}=this;if(!s.targetScrollTop)return S;if((g==null?void 0:g.targetScrollTop)===S)return g.calculatedScrollTop;const n=Math.max(Math.min(s.targetScrollTop(S,{scrollElement:r.current,contentElement:k.current}),S),0);return g={targetScrollTop:S,calculatedScrollTop:n},requestAnimationFrame(()=>{g=void 0}),n},get scrollDifference(){return this.calculatedTargetScrollTop-this.scrollTop},get isNearBottom(){return this.scrollDifference<=Cn}}},[]),c=o.useCallback((g={})=>{var V;typeof g=="string"&&(g={animation:g}),g.preserveScrollPosition||w(!0);const S=Date.now()+(Number(g.wait)||0),n=Lt(j.current,g.animation),{ignoreEscapes:i=!1}=g;let m,b=t.calculatedTargetScrollTop;g.duration instanceof Promise?g.duration.finally(()=>{m=Date.now()}):m=S+(g.duration??0);const y=async()=>{const X=new Promise(requestAnimationFrame).then(()=>{var U;if(!t.isAtBottom)return t.animation=void 0,!1;const{scrollTop:te}=t,M=performance.now(),I=(M-(t.lastTick??M))/Nn;if(t.animation||(t.animation={behavior:n,promise:X,ignoreEscapes:i}),t.animation.behavior===n&&(t.lastTick=M),p()||S>Date.now())return y();if(te<Math.min(b,t.calculatedTargetScrollTop)){if(((U=t.animation)==null?void 0:U.behavior)===n){if(n==="instant")return t.scrollTop=t.calculatedTargetScrollTop,y();t.velocity=(n.damping*t.velocity+n.stiffness*t.scrollDifference)/n.mass,t.accumulated+=t.velocity*I,t.scrollTop+=t.accumulated,t.scrollTop!==te&&(t.accumulated=0)}return y()}return m>Date.now()?(b=t.calculatedTargetScrollTop,y()):(t.animation=void 0,t.scrollTop<t.calculatedTargetScrollTop?c({animation:Lt(j.current,j.current.resize),ignoreEscapes:i,duration:Math.max(0,m-Date.now())||void 0}):t.isAtBottom)});return X.then(te=>(requestAnimationFrame(()=>{t.animation||(t.lastTick=void 0,t.velocity=0)}),te))};return g.wait!==!0&&(t.animation=void 0),((V=t.animation)==null?void 0:V.behavior)===n?t.animation.promise:y()},[w,p,t]),E=o.useCallback(()=>{C(!0),w(!1)},[C,w]),N=o.useCallback(({target:g})=>{if(g!==r.current)return;const{scrollTop:S,ignoreScrollToTop:n}=t;let{lastScrollTop:i=S}=t;t.lastScrollTop=S,t.ignoreScrollToTop=void 0,n&&n>S&&(i=n),T(t.isNearBottom),setTimeout(()=>{var y;if(t.resizeDifference||S===n)return;if(p()){C(!0),w(!1);return}const m=S>i,b=S<i;if((y=t.animation)!=null&&y.ignoreEscapes){t.scrollTop=i;return}b&&(C(!0),w(!1)),m&&C(!1),!t.escapedFromLock&&t.isNearBottom&&w(!0)},1)},[C,w,p,t]),u=o.useCallback(({target:g,deltaY:S})=>{var i;let n=g;for(;!["scroll","auto"].includes(getComputedStyle(n).overflow);){if(!n.parentElement)return;n=n.parentElement}n===r.current&&S<0&&r.current.scrollHeight>r.current.clientHeight&&!((i=t.animation)!=null&&i.ignoreEscapes)&&(C(!0),w(!1))},[C,w,t]),r=ms(g=>{var S,n;(S=r.current)==null||S.removeEventListener("scroll",N),(n=r.current)==null||n.removeEventListener("wheel",u),g==null||g.addEventListener("scroll",N,{passive:!0}),g==null||g.addEventListener("wheel",u,{passive:!0})},[]),k=ms(g=>{var n,i;if((n=t.resizeObserver)==null||n.disconnect(),!g)return;let S;t.resizeObserver=new ResizeObserver(([m])=>{const{height:b}=m.contentRect,y=b-(S??b);if(t.resizeDifference=y,t.scrollTop>t.targetScrollTop&&(t.scrollTop=t.targetScrollTop),T(t.isNearBottom),y>=0){const V=Lt(j.current,S?j.current.resize:j.current.initial);c({animation:V,wait:!0,preserveScrollPosition:!0,duration:V==="instant"?void 0:Tn})}else t.isNearBottom&&(C(!1),w(!0));S=b,requestAnimationFrame(()=>{setTimeout(()=>{t.resizeDifference===y&&(t.resizeDifference=0)},1)})}),(i=t.resizeObserver)==null||i.observe(g)},[]);return{contentRef:k,scrollRef:r,scrollToBottom:c,stopScroll:E,isAtBottom:x||A,isNearBottom:A,escapedFromLock:a,state:t}};function ms(s,a){const d=o.useCallback(x=>(d.current=x,s(x)),a);return d}const Mt=new Map;function Lt(...s){const a={...Sn};let d=!1;for(const h of s){if(h==="instant"){d=!0;continue}typeof h=="object"&&(d=!1,a.damping=h.damping??a.damping,a.stiffness=h.stiffness??a.stiffness,a.mass=h.mass??a.mass)}const x=JSON.stringify(a);return Mt.has(x)||Mt.set(x,Object.freeze(a)),d?"instant":Mt.get(x)}const Ms=o.createContext(null),Pn=typeof window<"u"?o.useLayoutEffect:o.useEffect;function bt({instance:s,children:a,resize:d,initial:x,mass:h,damping:A,stiffness:T,targetScrollTop:j,contextRef:p,...w}){const C=o.useRef(null),t=o.useCallback((i,m)=>{const b=(n==null?void 0:n.targetScrollTop)??j;return(b==null?void 0:b(i,m))??i},[j]),c=An({mass:h,damping:A,stiffness:T,resize:d,initial:x,targetScrollTop:t}),{scrollRef:E,contentRef:N,scrollToBottom:u,stopScroll:r,isAtBottom:k,escapedFromLock:g,state:S}=s??c,n=o.useMemo(()=>({scrollToBottom:u,stopScroll:r,scrollRef:E,isAtBottom:k,escapedFromLock:g,contentRef:N,state:S,get targetScrollTop(){return C.current},set targetScrollTop(i){C.current=i}}),[u,k,N,E,r,g,S]);return o.useImperativeHandle(p,()=>n,[n]),Pn(()=>{E.current&&getComputedStyle(E.current).overflow==="visible"&&(E.current.style.overflow="auto")},[]),e.jsx(Ms.Provider,{value:n,children:e.jsx("div",{...w,children:typeof a=="function"?a(n):a})})}(function(s){function a({children:d,...x}){const h=_t();return e.jsx("div",{ref:h.scrollRef,style:{height:"100%",width:"100%"},children:e.jsx("div",{...x,ref:h.contentRef,children:typeof d=="function"?d(h):d})})}s.Content=a})(bt||(bt={}));function _t(){const s=o.useContext(Ms);if(!s)throw new Error("use-stick-to-bottom component context must be used within a StickToBottom component");return s}function En(s){return s.type.startsWith("tool-")?s.type.slice(5):s.type}function In({part:s,partKey:a,getAppName:d,formatToolName:x,setIsInteractingWithPreview:h,playElevatorMusic:A,stopElevatorMusic:T,playDingSound:j}){const{t:p}=Le(),w=En(s),{state:C,input:t,output:c,errorText:E}=s;let N=null,u=null;if(C==="input-streaming"||C==="input-available"&&!c)switch(w){case"list":{const r=typeof(t==null?void 0:t.path)=="string"?t.path:"";r==="/Music"?N=p("apps.chats.toolCalls.loadingMusicLibrary"):r==="/Applets Store"?N=p("apps.chats.toolCalls.listingSharedApplets"):r==="/Applications"?N=p("apps.chats.toolCalls.listingApplications"):N=p("apps.chats.toolCalls.findingFiles");break}case"open":{const r=typeof(t==null?void 0:t.path)=="string"?t.path:"";r.startsWith("/Music/")?N=p("apps.chats.toolCalls.playingSong"):r.startsWith("/Applets Store/")?N=p("apps.chats.toolCalls.openingAppletPreview"):r.startsWith("/Applications/")?N=p("apps.chats.toolCalls.launchingApp"):N=p("apps.chats.toolCalls.openingFile");break}case"read":{(typeof(t==null?void 0:t.path)=="string"?t.path:"").startsWith("/Applets Store/")?N=p("apps.chats.toolCalls.fetchingApplet"):N=p("apps.chats.toolCalls.readingFile");break}case"write":N=p("apps.chats.toolCalls.writingContent");break;case"edit":N=p("apps.chats.toolCalls.editingFile");break;case"launchApp":N=p("apps.chats.toolCalls.launching",{appName:d(t==null?void 0:t.id)});break;case"closeApp":N=p("apps.chats.toolCalls.closing",{appName:d(t==null?void 0:t.id)});break;case"ipodControl":{const r=(t==null?void 0:t.action)||"toggle";r==="next"?N=p("apps.chats.toolCalls.skippingToNext"):r==="previous"?N=p("apps.chats.toolCalls.skippingToPrevious"):r==="addAndPlay"?N=p("apps.chats.toolCalls.addingSong"):r==="playKnown"?N=p("apps.chats.toolCalls.playingSong"):N=p("apps.chats.toolCalls.controllingPlayback");break}case"settings":N=p("apps.chats.toolCalls.changingSettings");break;default:N=p("apps.chats.toolCalls.running",{toolName:x(w)})}if(C==="output-available")if(w==="list"){if(typeof c=="string"){let r=null,k=null;const g=c.match(/:\n(\[.*\])/s);if(g)try{const n=JSON.parse(g[1]);Array.isArray(n)&&(r=n.length)}catch{}if(r===null){const n=c.match(/(\d+)/);n&&(r=parseInt(n[1],10))}const S=typeof(t==null?void 0:t.path)=="string"?t.path:"";if(S==="/Music")k="songs";else if(S==="/Applets Store")k="sharedApplets";else if(S==="/Applications")k="applications";else if(S==="/Applets")k="applets";else if(S==="/Documents")k="documents";else{const n=c.toLowerCase();n.includes("song")||n.includes("morceau")||n.includes("曲")||n.includes("곡")||n.includes("Lied")?k="songs":n.includes("shared applet")||n.includes("applet partagée")||n.includes("共有アプレット")||n.includes("공유 앱릿")||n.includes("geteiltes applet")?k="sharedApplets":n.includes("application")||n.includes("アプリケーション")||n.includes("응용 프로그램")||n.includes("Anwendung")?k="applications":n.includes("document")||n.includes("ドキュメント")||n.includes("문서")||n.includes("Dokument")?k="documents":(n.includes("applet")||n.includes("アプレット")||n.includes("앱릿"))&&(k="applets")}r!==null&&r>0?k==="songs"?u=r===1?p("apps.chats.toolCalls.foundSongs",{count:r}):p("apps.chats.toolCalls.foundSongsPlural",{count:r}):k==="sharedApplets"?u=r===1?p("apps.chats.toolCalls.foundSharedApplets",{count:r}):p("apps.chats.toolCalls.foundSharedAppletsPlural",{count:r}):k==="applications"?u=r===1?p("apps.chats.toolCalls.foundApplications",{count:r}):p("apps.chats.toolCalls.foundApplicationsPlural",{count:r}):k==="documents"?u=r===1?p("apps.chats.toolCalls.foundDocuments",{count:r}):p("apps.chats.toolCalls.foundDocumentsPlural",{count:r}):k==="applets"?u=r===1?p("apps.chats.toolCalls.foundApplets",{count:r}):p("apps.chats.toolCalls.foundAppletsPlural",{count:r}):u=p("apps.chats.toolCalls.listedItems"):c.includes("empty")||c.toLowerCase().includes("no ")||c.toLowerCase().includes("pas de")||c.toLowerCase().includes("없습니다")||c.toLowerCase().includes("ありません")||c.toLowerCase().includes("keine")?u=p("apps.chats.toolCalls.noItemsFound"):u=p("apps.chats.toolCalls.listedItems")}}else if(w==="open")typeof c=="string"&&c.trim().length>0?u=c:u=p("apps.chats.toolCalls.opened");else if(w==="read"){const r=typeof(t==null?void 0:t.path)=="string"?t.path:"";let k=r.split("/").filter(Boolean).pop()||"file";if(r.startsWith("/Applets Store/")&&typeof c=="string")try{const g=JSON.parse(c);(g.title||g.name)&&(k=g.title||g.name)}catch{}u=p("apps.chats.toolCalls.read",{fileName:k})}else if(w==="write")typeof c=="string"?c.includes("Successfully")?u=p("apps.chats.toolCalls.contentWritten"):u=c:u=p("apps.chats.toolCalls.contentWritten");else if(w==="edit")if(typeof c=="string")if(c.includes("not found"))u=p("apps.chats.toolCalls.textNotFound");else if(c.includes("matches")&&c.includes("locations"))u=p("apps.chats.toolCalls.multipleMatchesFound");else if(c.includes("Successfully")||c.includes("edited")){const k=(typeof(t==null?void 0:t.path)=="string"?t.path:"").split("/").filter(Boolean).pop()||"file";u=p("apps.chats.toolCalls.edited",{fileName:k})}else c.includes("Created")?u=p("apps.chats.toolCalls.fileCreated"):u=c;else{const k=(typeof(t==null?void 0:t.path)=="string"?t.path:"").split("/").filter(Boolean).pop()||"file";u=p("apps.chats.toolCalls.edited",{fileName:k})}else if(w==="launchApp"&&(t==null?void 0:t.id)==="internet-explorer"){const r=t.url?String(t.url):"",k=t.year&&t.year!==""?String(t.year):"";r&&k?u=p("apps.chats.toolCalls.launchedWithUrlAndYear",{url:r,year:k}):r?u=p("apps.chats.toolCalls.launchedWithUrl",{url:r}):u=p("apps.chats.toolCalls.launched",{appName:d(t==null?void 0:t.id)})}else if(w==="launchApp")u=p("apps.chats.toolCalls.launched",{appName:d(t==null?void 0:t.id)});else if(w==="closeApp")u=p("apps.chats.toolCalls.closed",{appName:d(t==null?void 0:t.id)});else if(w==="ipodControl")if(typeof c=="string"&&c.trim().length>0)u=c;else{const r=(t==null?void 0:t.action)||"toggle";if(r==="addAndPlay")u=p("apps.chats.toolCalls.addedAndStartedPlaying");else if(r==="playKnown"){const k=t!=null&&t.title?String(t.title):null,g=t!=null&&t.artist?String(t.artist):null;k&&g?u=p("apps.chats.toolCalls.playingByArtist",{title:k,artist:g}):k?u=p("apps.chats.toolCalls.playing",{title:k}):g?u=p("apps.chats.toolCalls.playingSongByArtist",{artist:g}):t!=null&&t.id?u=p("apps.chats.toolCalls.playingSongWithId",{id:String(t.id)}):u=p("apps.chats.toolCalls.playingSongGeneric")}else r==="next"?u=p("apps.chats.toolCalls.skippedToNextTrack"):r==="previous"?u=p("apps.chats.toolCalls.skippedToPreviousTrack"):u=p(r==="play"?"apps.chats.toolCalls.playingIpod":r==="pause"?"apps.chats.toolCalls.pausedIpod":"apps.chats.toolCalls.toggledIpodPlayback")}else w==="settings"&&(typeof c=="string"&&c.trim().length>0?u=c:u=p("apps.chats.toolCalls.settingsUpdated"));if(C==="output-error"&&E&&(u=p("apps.chats.toolCalls.error",{errorText:E})),C==="output-available"&&w==="generateHtml"){let r="",k="",g="";if(typeof c=="string"&&c.trim().length>0?r=c:typeof c=="object"&&c!==null&&"html"in c&&(r=c.html,k=c.title||"",g=c.icon||""),r.trim().length>0)return e.jsx(It,{htmlContent:r,appletTitle:k,appletIcon:g,onInteractionChange:h,playElevatorMusic:A,stopElevatorMusic:T,playDingSound:j,className:"my-1"},a)}if(w==="generateHtml"){const r=typeof(t==null?void 0:t.html)=="string"?t.html:"",k=typeof(t==null?void 0:t.title)=="string"?t.title:"",g=typeof(t==null?void 0:t.icon)=="string"?t.icon:"";if(C==="input-streaming")return r?e.jsx(It,{htmlContent:r,appletTitle:k,appletIcon:g,isStreaming:!0,minWidth:"320px",onInteractionChange:h,playElevatorMusic:A,stopElevatorMusic:T,playDingSound:j,className:"my-1"},a):e.jsxs("div",{className:"mb-0 px-1 py-0.5 text-xs italic text-gray-600 flex items-center gap-1",children:[e.jsx(rt,{className:"h-3 w-3 animate-spin text-gray-500"}),e.jsx("span",{className:"shimmer",children:p("apps.chats.toolCalls.generating")})]},a);if(C==="input-available")return r?e.jsx(It,{htmlContent:r,appletTitle:k,appletIcon:g,isStreaming:!1,onInteractionChange:h,playElevatorMusic:A,stopElevatorMusic:T,playDingSound:j,className:"my-1"},a):e.jsx("div",{className:"mb-0 px-1 py-0.5 text-xs italic text-gray-500",children:"Preparing HTML preview..."},a)}return e.jsxs("div",{className:"mb-0 px-1 py-0.5 italic text-[12px]",children:[(C==="input-streaming"||C==="input-available")&&!c&&e.jsxs("div",{className:"flex items-center gap-1 text-gray-700",children:[e.jsx(rt,{className:"h-3 w-3 animate-spin text-gray-500"}),N?e.jsx("span",{className:"shimmer",children:N}):e.jsx("span",{children:p("apps.chats.toolCalls.calling",{toolName:x(w)})})]}),C==="output-available"&&e.jsxs("div",{className:"flex items-center gap-1 text-gray-700",children:[e.jsx(ft,{className:"h-3 w-3 text-blue-600"}),u?e.jsx("span",{children:u}):e.jsx("div",{className:"flex flex-col",children:typeof c=="string"&&c.length>0?e.jsx("span",{className:"text-gray-500",children:c}):e.jsx("span",{children:x(w)})})]}),C==="output-error"&&e.jsx("div",{className:"flex items-center gap-1 text-red-600",children:e.jsxs("span",{className:"text-xs",children:["⚠️ ",E||p("apps.chats.toolCalls.toolExecutionFailed")]})})]},a)}function Rn({url:s,className:a=""}){const d=i=>/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|os\.ryo\.lu\/ipod\/)/.test(i),[x,h]=o.useState(null),[A,T]=o.useState(!0),[j,p]=o.useState(null),[w,C]=o.useState(()=>d(s)),t=ya(),c=$e(i=>i.current),E=c==="macosx"||w,N=i=>{try{const m=b=>b&&/^[a-zA-Z0-9_-]{11}$/.test(b)?b:null;if(i.includes("os.ryo.lu/ipod/")){const b=i.match(/os\.ryo\.lu\/ipod\/([^&\n?#]+)/);return m(b?b[1]:null)}if(i.includes("youtu.be/")){const b=i.match(/youtu\.be\/([^&\n?#]+)/);return m(b?b[1]:null)}if(i.includes("youtube.com/")){const b=new URL(i);if(b.pathname==="/watch"){const y=b.searchParams.get("v");return m(y)}if(b.pathname.startsWith("/embed/")){const y=b.pathname.match(/\/embed\/([^&\n?#]+)/);return m(y?y[1]:null)}}return null}catch(m){return console.error("Error extracting YouTube video ID:",m),null}},u=i=>{try{return i.includes("os.ryo.lu/ipod/")?"https://www.google.com/s2/favicons?domain=youtube.com&sz=16":`https://www.google.com/s2/favicons?domain=${new URL(i).hostname}&sz=16`}catch{return"https://www.google.com/s2/favicons?domain=example.com&sz=16"}},r=i=>{i.stopPropagation();try{const m=N(s);m?t("ipod",{initialData:{videoId:m}}):(Ee.error("Could not extract video ID from this YouTube URL"),console.warn("Could not extract video ID from YouTube URL:",s))}catch(m){Ee.error("Failed to open video in iPod app"),console.error("Error launching iPod app:",m)}},k=i=>{i.stopPropagation();try{const m=N(s);m?(console.log(`[LinkPreview] Launching Videos app with videoId: ${m}`),t("videos",{initialData:{videoId:m}})):(console.warn("Could not extract video ID from URL, opening in browser:",s),window.open(s,"_blank","noopener,noreferrer"))}catch(m){console.error("Error launching Videos app, opening in browser:",m),window.open(s,"_blank","noopener,noreferrer")}},g=i=>{if(i.stopPropagation(),s.includes("os.ryo.lu/ipod/")){const m=N(s);if(m){const b=`https://www.youtube.com/watch?v=${m}`;window.open(b,"_blank","noopener,noreferrer");return}}window.open(s,"_blank","noopener,noreferrer")},S=i=>{i.stopPropagation(),window.open(s,"_blank","noopener,noreferrer")};if(o.useEffect(()=>{(async()=>{try{if(T(!0),p(null),s.includes("os.ryo.lu/ipod/")){const y=N(s);if(y){try{const V=await fetch(`/api/link-preview?url=${encodeURIComponent(`https://www.youtube.com/watch?v=${y}`)}`);if(V.ok){const X=await V.json();if(!X.error){h({title:X.title,description:X.description,image:X.image||`https://img.youtube.com/vi/${y}/maxresdefault.jpg`,siteName:"YouTube",url:s}),T(!1);return}}}catch(V){console.warn("Failed to fetch YouTube metadata, using fallback:",V)}h({title:`YouTube Video ${y}`,description:"Watch on YouTube",image:`https://img.youtube.com/vi/${y}/maxresdefault.jpg`,siteName:"YouTube",url:s}),T(!1);return}}const m=await fetch(`/api/link-preview?url=${encodeURIComponent(s)}`);if(!m.ok)throw new Error(`HTTP error! status: ${m.status}`);const b=await m.json();if(b.error)throw new Error(b.error);h({title:b.title,description:b.description,image:b.image,siteName:b.siteName,url:s})}catch(m){console.error("Error fetching link metadata:",m),p("Failed to load preview"),h({title:s,url:s})}finally{T(!1)}})()},[s]),A)return e.jsx(q.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:$("h-[106px] w-full min-w-[280px] max-w-[420px]","relative overflow-hidden","border border-gray-200 rounded","before:absolute before:inset-0","before:bg-gradient-to-r before:from-gray-200 before:via-gray-100 before:to-gray-200","before:animate-[shimmer_2s_linear_infinite]","before:bg-[length:200%_100%]",a)});if(j&&!x)return e.jsxs(q.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`flex items-center gap-2 p-3 bg-red-50 border border-red-200 text-sm font-geneva-12 max-w-[420px] ${a}`,style:{borderRadius:"3px"},children:[e.jsx(Rs,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"text-red-600",children:j})]});if(!x)return null;const n=i=>{const m=()=>"ontouchstart"in window||navigator.maxTouchPoints>0;if(i&&"touches"in i&&m()){i.stopPropagation(),window.open(s,"_blank","noopener,noreferrer");return}if(d(s))if(s.includes("os.ryo.lu/ipod/"))try{const b=N(s);b?(console.log(`[LinkPreview] Adding iPod link to iPod with videoId: ${b}`),t("ipod",{initialData:{videoId:b}})):(Ee.error("Could not extract video ID from this iPod URL"),console.warn("Could not extract video ID from iPod URL:",s))}catch(b){Ee.error("Failed to open video in iPod app"),console.error("Error launching iPod app:",b)}else try{const b=N(s);b?(console.log(`[LinkPreview] Launching Videos app with videoId: ${b}`),t("videos",{initialData:{videoId:b}})):(console.warn("Could not extract video ID from YouTube URL, opening in browser:",s),window.open(s,"_blank","noopener,noreferrer"))}catch(b){console.error("Error launching Videos app, opening in browser:",b),window.open(s,"_blank","noopener,noreferrer")}else{const b=new URL(s),y=b.hostname.replace(/^www\./,""),V=b.pathname+b.search,X=y+V;t("internet-explorer",{initialData:{url:X,year:"current"}})}};return e.jsxs(q.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:$("link-preview-container relative overflow-hidden cursor-pointer font-geneva-12 group max-w-[420px]",c==="macosx"?"chat-bubble macosx-link-preview bg-gray-100 border-none shadow-none":"bg-white border border-gray-200 rounded",a),onClick:n,onTouchStart:i=>{i.stopPropagation()},"data-link-preview":!0,children:[e.jsx("div",{className:"absolute inset-0 bg-black opacity-0 group-hover:opacity-5 transition-opacity z-10 pointer-events-none"}),E&&x.image?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:$("relative aspect-video bg-gray-100 overflow-hidden",c==="macosx"&&"-mx-3 -mt-[6px] rounded-t-[14px]"),children:[e.jsx("img",{src:x.image,alt:x.title||"Link preview",className:"w-full h-full object-cover",onError:i=>{i.currentTarget.style.display="none"}}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:u(s),alt:"Site favicon",className:"h-4 w-4 flex-shrink-0",onError:i=>{var m;i.currentTarget.style.display="none",(m=i.currentTarget.nextElementSibling)==null||m.classList.remove("hidden")}}),e.jsx("div",{className:"h-4 w-4 bg-gray-300 rounded-full flex-shrink-0 hidden"}),x.title&&e.jsx("h3",{className:"font-semibold text-white text-[10px] truncate",children:x.title})]})})]}),e.jsx("div",{className:"px-2 pb-2",children:d(s)?s.includes("os.ryo.lu/ipod/")?e.jsxs("div",{className:"flex gap-2 pt-2 border-t border-gray-100",children:[e.jsxs("button",{onClick:k,onTouchStart:i=>i.stopPropagation(),className:$(c==="macosx"?"aqua-button secondary flex-1":"flex items-center justify-center gap-1.5 px-3 py-2 text-[12px] bg-gray-100 hover:bg-gray-200 rounded-md transition-colors flex-1"),title:"Open in Videos","data-link-preview":!0,children:[c!=="macosx"&&e.jsx(hs,{className:"h-3 w-3"}),e.jsx("span",{children:"Open in Videos"})]}),e.jsxs("button",{onClick:g,onTouchStart:i=>i.stopPropagation(),className:$(c==="macosx"?"aqua-button secondary flex-1":"flex items-center justify-center gap-1.5 px-3 py-2 text-[12px] bg-gray-100 hover:bg-gray-200 rounded-md transition-colors flex-1"),title:"Open YouTube","data-link-preview":!0,children:[c!=="macosx"&&e.jsx(Je,{className:"h-3 w-3"}),e.jsx("span",{children:"Open YouTube"})]})]}):e.jsxs("div",{className:"flex gap-2 pt-2 border-t border-gray-100",children:[e.jsxs("button",{onClick:r,onTouchStart:i=>i.stopPropagation(),className:$(c==="macosx"?"aqua-button secondary flex-1":"flex items-center justify-center gap-1.5 px-3 py-2 text-[12px] bg-gray-100 hover:bg-gray-200 rounded-md transition-colors flex-1"),title:"Add to iPod","data-link-preview":!0,children:[c!=="macosx"&&e.jsx(ps,{className:"h-3 w-3"}),e.jsx("span",{children:"Add to iPod"})]}),e.jsxs("button",{onClick:g,onTouchStart:i=>i.stopPropagation(),className:$(c==="macosx"?"aqua-button secondary flex-1":"flex items-center justify-center gap-1.5 px-3 py-2 text-[12px] bg-gray-100 hover:bg-gray-200 rounded-md transition-colors flex-1"),title:"Open YouTube","data-link-preview":!0,children:[c!=="macosx"&&e.jsx(Je,{className:"h-3 w-3"}),e.jsx("span",{children:"Open YouTube"})]})]}):e.jsx("div",{className:"flex gap-2 pt-2 border-t border-gray-100",children:e.jsxs("button",{onClick:S,onTouchStart:i=>i.stopPropagation(),className:$(c==="macosx"?"aqua-button secondary w-full":"flex items-center justify-center gap-1.5 px-3 py-2 text-[12px] bg-gray-100 hover:bg-gray-200 rounded-md transition-colors w-full"),title:"Open Externally","data-link-preview":!0,children:[c!=="macosx"&&e.jsx(Je,{className:"h-3 w-3"}),e.jsx("span",{children:"Open Externally"})]})})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex",children:[x.image&&e.jsx("div",{className:$("w-18 h-18 bg-gray-100 relative overflow-hidden flex-shrink-0",c==="macosx"&&"hidden"),children:e.jsx("img",{src:x.image,alt:x.title||"Link preview",className:"w-full h-full object-cover",onError:i=>{i.currentTarget.style.display="none"},onLoad:i=>{const m=i.currentTarget,b=m.naturalWidth/m.naturalHeight;(d(s)||b>1.5)&&C(!0)}})}),e.jsxs("div",{className:`flex-1 min-w-0 p-3 ${x.image?"flex flex-col justify-center":""}`,children:[x.title&&e.jsx("h3",{className:"font-semibold text-gray-900 text-[10px]",style:{display:"-webkit-box",WebkitLineClamp:1,WebkitBoxOrient:"vertical",overflow:"hidden"},children:x.title}),x.description&&e.jsx("p",{className:`text-[10px] text-gray-600 ${x.image?"":"mb-2"}`,style:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:x.description}),!x.image&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:u(s),alt:"Site favicon",className:"h-4 w-4 flex-shrink-0",onError:i=>{var m;i.currentTarget.style.display="none",(m=i.currentTarget.nextElementSibling)==null||m.classList.remove("hidden")}}),e.jsx("div",{className:"h-4 w-4 bg-gray-300 rounded-full flex-shrink-0 hidden"}),e.jsx("p",{className:"text-[10px] text-gray-500 truncate",children:x.siteName||new URL(s).hostname})]})]})]}),e.jsx("div",{className:$("pb-2 border-t",c==="macosx"?"border-gray-300":"border-gray-200"),children:e.jsx("div",{className:"px-2 pt-2",children:d(s)?s.includes("os.ryo.lu/ipod/")?e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:k,onTouchStart:i=>i.stopPropagation(),className:$(c==="macosx"?"aqua-button secondary flex-1":"flex items-center justify-center gap-1.5 px-3 py-2 text-[12px] bg-gray-100 hover:bg-gray-200 rounded-md transition-colors flex-1"),title:"Open in Videos","data-link-preview":!0,children:[c!=="macosx"&&e.jsx(hs,{className:"h-3 w-3"}),e.jsx("span",{children:"Open in Videos"})]}),e.jsxs("button",{onClick:g,onTouchStart:i=>i.stopPropagation(),className:$(c==="macosx"?"aqua-button secondary flex-1":"flex items-center justify-center gap-1.5 px-3 py-2 text-[12px] bg-gray-100 hover:bg-gray-200 rounded-md transition-colors flex-1"),title:"Open YouTube","data-link-preview":!0,children:[c!=="macosx"&&e.jsx(Je,{className:"h-3 w-3"}),e.jsx("span",{children:"Open YouTube"})]})]}):e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:r,onTouchStart:i=>i.stopPropagation(),className:$(c==="macosx"?"aqua-button secondary flex-1":"flex items-center justify-center gap-1.5 px-3 py-2 text-[12px] bg-gray-100 hover:bg-gray-200 rounded-md transition-colors flex-1"),title:"Add to iPod","data-link-preview":!0,children:[c!=="macosx"&&e.jsx(ps,{className:"h-3 w-3"}),e.jsx("span",{children:"Add to iPod"})]}),e.jsxs("button",{onClick:g,onTouchStart:i=>i.stopPropagation(),className:$(c==="macosx"?"aqua-button secondary flex-1":"flex items-center justify-center gap-1.5 px-3 py-2 text-[12px] bg-gray-100 hover:bg-gray-200 rounded-md transition-colors flex-1"),title:"Open YouTube","data-link-preview":!0,children:[c!=="macosx"&&e.jsx(Je,{className:"h-3 w-3"}),e.jsx("span",{children:"Open YouTube"})]})]}):e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:S,onTouchStart:i=>i.stopPropagation(),className:$(c==="macosx"?"aqua-button secondary w-full":"flex items-center justify-center gap-1.5 px-3 py-2 text-[12px] bg-gray-100 hover:bg-gray-200 rounded-md transition-colors w-full"),title:"Open Externally","data-link-preview":!0,children:[c!=="macosx"&&e.jsx(Je,{className:"h-3 w-3"}),e.jsx("span",{children:"Open Externally"})]})})})})]})]})}const xs=["bg-pink-100 text-black","bg-purple-100 text-black","bg-indigo-100 text-black","bg-teal-100 text-black","bg-lime-100 text-black","bg-amber-100 text-black","bg-cyan-100 text-black","bg-rose-100 text-black"],Mn=s=>{if(!s)return"bg-gray-100 text-black";const a=s.split("").reduce((d,x)=>d+x.charCodeAt(0),0);return xs[a%xs.length]},Dt=s=>{if(!s)return s;if(typeof window<"u"&&typeof document<"u"){const a=document.createElement("textarea");return a.innerHTML=s,a.value}return s.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&apos;/g,"'")},Ln=s=>{const a=[];let d=0;const x=/(\[([^\]]+?)\]\((https?:\/\/[^\s]+?)\))|(\*\*(.*?)\*\*)|(\*(.*?)\*)|(https?:\/\/[^\s]+)|([\p{Emoji_Presentation}\p{Extended_Pictographic}]|[\p{Script=Han}\p{Script=Hiragana}\p{Script=Katakana}\p{Script=Hangul}]|[a-zA-Z0-9]+|[^\S\n]+|[^a-zA-Z0-9\s\p{Emoji_Presentation}\p{Extended_Pictographic}\p{Script=Han}\p{Script=Hiragana}\p{Script=Katakana}\p{Script=Hangul}*]+)/gu;let h;for(;(h=x.exec(s))!==null;)h[1]?a.push({type:"link",content:h[2],url:h[3]}):h[4]?a.push({type:"bold",content:h[5]}):h[6]?a.push({type:"italic",content:h[7]}):h[8]?a.push({type:"link",content:h[8],url:h[8]}):h[9]&&a.push({type:"text",content:h[9]}),d=x.lastIndex;return d<s.length&&a.push({type:"text",content:s.slice(d)}),a},mt=s=>s.split(/(\n)/).flatMap(a=>a===`
`?[{type:"text",content:`
`}]:Ln(a)),xt=s=>/^[\p{Emoji_Presentation}\p{Extended_Pictographic}\s]+$/u.test(s),fs=s=>{const a=s.trim();return/^https?:\/\/[^\s]+$/.test(a)},Dn=s=>{if(!s.message)return"An error occurred";const a=s.message.match(/\{.*\}/);if(a)try{const d=JSON.parse(a[0]);if(d.error==="rate_limit_exceeded")return d.isAuthenticated?Pt.t("apps.chats.status.dailyLimitReached"):Pt.t("apps.chats.status.loginToContinue");if(d.error==="authentication_failed")return Pt.t("apps.chats.status.sessionExpired");if(typeof d.error=="string")return d.error;if(typeof d.message=="string")return d.message}catch{}return s.message.startsWith("Error: ")?s.message.slice(7):s.message},Ls=s=>s.replace(/([A-Z])/g," $1").replace(/^./,a=>a.toUpperCase()).trim(),$n=s=>{if(!s)return"app";try{return wa(s)}catch{const a=Ss[s];return(a==null?void 0:a.name)||Ls(s)}},nt=s=>s.parts?s.parts.filter(a=>a.type==="text").map(a=>a.text||"").join(""):"";function On(){const{t:s}=Le(),d=$e(A=>A.current)==="macosx",{isAtBottom:x,scrollToBottom:h}=_t();return e.jsx(Me,{children:!x&&e.jsxs(q.button,{initial:{opacity:0,scale:.8,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.8,y:10},transition:{type:"spring",duration:.2},className:`absolute bottom-14 right-3 rounded-full z-20 flex items-center justify-center cursor-pointer select-none ${d?"relative overflow-hidden":""}`,style:{position:"absolute",bottom:"56px",right:"calc(12px + var(--sbw, 0px))",width:28,height:28,background:d?"linear-gradient(rgba(160,160,160,0.625), rgba(255,255,255,0.625))":"#ffffff",boxShadow:d?"0 2px 3px rgba(0,0,0,0.2), 0 1px 1px rgba(0,0,0,0.3), inset 0 0 0 0.5px rgba(0,0,0,0.3), inset 0 1px 2px rgba(0,0,0,0.4), inset 0 2px 3px 1px #bbbbbb":"0 1px 2px rgba(0,0,0,0.25)",border:d?void 0:"1px solid rgba(0,0,0,0.3)",backdropFilter:d?"blur(2px)":void 0},onClick:()=>h(),"aria-label":s("apps.chats.status.scrollToBottom"),children:[d&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"pointer-events-none absolute left-1/2 -translate-x-1/2",style:{top:"2px",height:"30%",width:"calc(100% - 12px)",borderRadius:"12px 12px 4px 4px",background:"linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,0.25))",filter:"blur(0.2px)",zIndex:2}}),e.jsx("div",{className:"pointer-events-none absolute left-1/2 -translate-x-1/2",style:{bottom:"1px",height:"38%",width:"calc(100% - 4px)",borderRadius:"4px 4px 8px 8px",background:"linear-gradient(rgba(255,255,255,0.15), rgba(255,255,255,0.55))",filter:"blur(0.3px)",zIndex:1}})]}),e.jsx(Ns,{className:`h-4 w-4 ${d?"text-black/70 relative z-10":"text-neutral-800"}`})]})})}function _n({messages:s,isLoading:a,error:d,onRetry:x,onClear:h,isRoomView:A,roomId:T,isAdmin:j,username:p,onMessageDeleted:w,fontSize:C,scrollToBottomTrigger:t,highlightSegment:c,isSpeaking:E,onSendMessage:N}){const{t:u}=Le(),{playNote:r}=Es(),{playElevatorMusic:k,stopElevatorMusic:g,playDingSound:S}=qa(),[n,i]=o.useState(null),{speak:m,stop:b,isSpeaking:y}=Wa(),V=Cs(l=>l.speechEnabled),X=$e(l=>l.current),[te,M]=o.useState(null),[I,U]=o.useState(null),[ie,ye]=o.useState(null),[ue,ve]=o.useState(!1),ce=()=>"ontouchstart"in window||navigator.maxTouchPoints>0,[W,pe]=o.useState(null),xe=o.useRef([]),Z=o.useRef([]),he=o.useRef(new Set),ke=o.useRef(!1),{scrollToBottom:Pe}=_t();o.useEffect(()=>{if(Z.current.length>0&&s.length>Z.current.length){const l=new Set(Z.current.map(O=>O.id||`${O.role}-${nt(O).substring(0,10)}`));s.filter(O=>!l.has(O.id||`${O.role}-${nt(O).substring(0,10)}`)).find(O=>O.role==="human")&&(r(),"vibrate"in navigator&&navigator.vibrate(100))}Z.current=s},[s,r]),o.useEffect(()=>{!ke.current&&s.length>0?(ke.current=!0,Z.current=s,he.current=new Set(s.map(l=>l.id||`${l.role}-${nt(l).substring(0,10)}`))):s.length===0&&(ke.current=!1)},[s]);const je=o.useRef(!0);o.useEffect(()=>{je.current?je.current=!1:Pe()},[t,Pe]),o.useEffect(()=>{y&&I&&U(null)},[y,I]);const f=async l=>{const P=nt(l);try{await navigator.clipboard.writeText(P),i(l.id||`${l.role}-${P.substring(0,10)}`),setTimeout(()=>i(null),2e3)}catch(R){console.error("Failed to copy message:",R);try{const O=document.createElement("textarea");O.value=P,document.body.appendChild(O),O.select(),document.execCommand("copy"),document.body.removeChild(O),i(l.id||`${l.role}-${P.substring(0,10)}`),setTimeout(()=>i(null),2e3)}catch(O){console.error("Fallback copy failed:",O)}}},D=async l=>{if(!T)return;const P=l.serverId||l.id;if(!P)return;const R=`/api/chat-rooms?action=deleteMessage&roomId=${T}&messageId=${P}`,O={"Content-Type":"application/json"},de=ne.getState().authToken;p&&de&&(O.Authorization=`Bearer ${de}`,O["X-Username"]=p);try{const Q=await fetch(R,{method:"DELETE",headers:O});if(Q.ok){w==null||w(P);return}if(Q.status===404||Q.status===410){console.warn(`Delete message ${P} returned ${Q.status}; removing locally as orphan.`),w==null||w(P);return}const we=await Q.json().catch(()=>({error:`HTTP error! status: ${Q.status}`}));console.error("Failed to delete message",we)}catch(Q){console.error("Error deleting message",Q)}},z=l=>l.startsWith("!!!!"),F=l=>{const P=new Set;return mt(l).forEach(O=>{O.type==="link"&&O.url&&P.add(O.url)}),Array.from(P)};return e.jsxs(Me,{initial:!1,mode:"sync",children:[s.length===0&&!A&&e.jsxs(q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex items-center gap-2 text-gray-500 font-['Geneva-9'] text-[16px] antialiased h-[12px]",children:[e.jsx(us,{className:"h-3 w-3"}),e.jsx("span",{children:u("apps.chats.status.startNewConversation")}),h&&e.jsx(be,{size:"sm",variant:"link",onClick:h,className:"m-0 p-0 text-[16px] h-0 text-gray-500 hover:text-gray-700",children:u("apps.chats.status.newChat")})]}),s.map(l=>{var B,_;const P=nt(l),R=l.id||`${l.role}-${P.substring(0,10)}`,O=he.current.has(R),de={initial:{opacity:0},animate:{opacity:1}},Q=z(P);let we="";Q?we="bg-transparent text-current":l.role==="user"?we="bg-yellow-100 text-black":l.role==="assistant"?we="bg-blue-100 text-black":l.role==="human"&&(we=Mn(l.username));const Ye=Q?P.slice(4).trimStart():P,Oe=Dt(Ye),Ze=Oe.includes("[[AQUARIUM]]"),Se=Oe.replace(/\[\[AQUARIUM\]\]/g,"").trim();let _e=!1;l.role==="assistant"&&l.parts&&(_e=l.parts.filter(ee=>ee.type==="tool-aquarium").length>0),(l.role==="human"||l.username==="ryo")&&Ze&&(_e=!0);const re=c||W,K=(E||y)&&re&&re.messageId===l.id;return e.jsxs(q.div,{variants:de,initial:O?"animate":"initial",animate:"animate",transition:{duration:.15,ease:"easeOut"},className:`flex flex-col z-10 w-full ${l.role==="user"?"items-end":"items-start"}`,style:{transformOrigin:l.role==="user"?"bottom right":"bottom left"},onMouseEnter:()=>!ue&&!ce()&&ye(R),onMouseLeave:()=>!ue&&!ce()&&ye(null),onTouchStart:H=>{!ue&&ce()&&(H.target.closest("[data-link-preview]")||(H.preventDefault(),ye(R)))},children:[e.jsxs("div",{className:`${X==="macosx"?"text-[10px]":"text-[16px]"} chat-messages-meta text-gray-500 mb-0.5 font-['Geneva-9'] mb-[-2px] select-text flex items-center gap-2`,children:[l.role==="user"&&e.jsxs(e.Fragment,{children:[j&&A&&e.jsx(He,{children:e.jsxs(qe,{children:[e.jsx(We,{asChild:!0,children:e.jsx(q.button,{initial:{opacity:0,scale:.8},animate:{opacity:ie===R?1:0,scale:1},className:"h-3 w-3 text-gray-400 hover:text-red-600 transition-colors",onClick:()=>D(l),"aria-label":u("apps.chats.ariaLabels.deleteMessage"),children:e.jsx(Ot,{className:"h-3 w-3"})})}),e.jsx(Ve,{children:e.jsx("p",{children:u("apps.chats.messages.delete")})})]})}),e.jsx(q.button,{initial:{opacity:0,scale:.8},animate:{opacity:ie===R?1:0,scale:1},className:"h-3 w-3 text-gray-400 hover:text-gray-600 transition-colors",onClick:()=>f(l),"aria-label":u("apps.chats.ariaLabels.copyMessage"),children:n===R?e.jsx(ft,{className:"h-3 w-3"}):e.jsx(ds,{className:"h-3 w-3"})})]}),e.jsx("span",{className:"max-w-[120px] inline-block overflow-hidden text-ellipsis whitespace-nowrap",title:l.username||(l.role==="user"?u("apps.chats.messages.you"):u("apps.chats.messages.ryo")),children:l.username||(l.role==="user"?u("apps.chats.messages.you"):u("apps.chats.messages.ryo"))})," ",e.jsx("span",{className:"text-gray-400 select-text",children:(B=l.metadata)!=null&&B.createdAt?(()=>{const H=new Date(l.metadata.createdAt),ee=new Date;return H.getDate()!==ee.getDate()||H.getMonth()!==ee.getMonth()||H.getFullYear()!==ee.getFullYear()?H.toLocaleDateString([],{month:"short",day:"numeric"}):H.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})})():e.jsx(rt,{className:"h-3 w-3 animate-spin"})}),l.role==="assistant"&&e.jsxs(e.Fragment,{children:[e.jsx(q.button,{initial:{opacity:0,scale:.8},animate:{opacity:ie===R?1:0,scale:1},className:"h-3 w-3 text-gray-400 hover:text-gray-600 transition-colors",onClick:()=>f(l),"aria-label":u("apps.chats.ariaLabels.copyMessage"),children:n===R?e.jsx(ft,{className:"h-3 w-3"}):e.jsx(ds,{className:"h-3 w-3"})}),V&&e.jsx(q.button,{initial:{opacity:0,scale:.8},animate:{opacity:ie===R?1:0,scale:1},className:"h-3 w-3 text-gray-400 hover:text-gray-600 transition-colors",onClick:()=>{if(te===R)b(),M(null);else{b(),pe(null),xe.current=[],U(null);const H=Se.trim();if(H){const ee=[],Y=H.split(/\r?\n/);for(const le of Y){const oe=le.trim();oe&&oe.length>0&&ee.push(oe)}if(ee.length===0){M(null),U(null);return}let G=0;const Ce=ee.map(le=>{const oe=mt(le).reduce((Te,Ae)=>Te+Ae.content.length,0),Ne={messageId:l.id||R,start:G,end:G+oe};return G+=oe,Ne});xe.current=Ce,pe(Ce[0]),U(R),ee.forEach(le=>{m(le,()=>{xe.current.shift(),xe.current.length>0?pe(xe.current[0]):(pe(null),M(null),U(null))})}),M(R)}else M(null),U(null)}},"aria-label":u(te===R?"apps.chats.ariaLabels.stopSpeech":"apps.chats.ariaLabels.speakMessage"),children:te===R?I===R?e.jsx(rt,{className:"h-3 w-3 animate-spin"}):e.jsx(nn,{className:"h-3 w-3"}):e.jsx(va,{className:"h-3 w-3"})})]}),A&&l.role==="human"&&N&&l.username&&e.jsx(He,{children:e.jsxs(qe,{children:[e.jsx(We,{asChild:!0,children:e.jsx(q.button,{initial:{opacity:0,scale:.8},animate:{opacity:ie===R?1:0,scale:1},className:"h-3 w-3 text-gray-400 hover:text-blue-600 transition-colors",onClick:()=>N(l.username),"aria-label":u("apps.chats.ariaLabels.messageUser",{username:l.username}),children:e.jsx(on,{className:"h-3 w-3"})})}),e.jsx(Ve,{children:e.jsx("p",{children:u("apps.chats.ariaLabels.messageUser",{username:l.username})})})]})}),j&&A&&l.role!=="user"&&e.jsx(He,{children:e.jsxs(qe,{children:[e.jsx(We,{asChild:!0,children:e.jsx(q.button,{initial:{opacity:0,scale:.8},animate:{opacity:ie===R?1:0,scale:1},className:"h-3 w-3 text-gray-400 hover:text-red-600 transition-colors",onClick:()=>D(l),"aria-label":u("apps.chats.ariaLabels.deleteMessage"),children:e.jsx(Ot,{className:"h-3 w-3"})})}),e.jsx(Ve,{children:e.jsx("p",{children:u("apps.chats.messages.delete")})})]})})]}),_e&&e.jsx(Ua,{}),!fs(Se)&&e.jsx(q.div,{initial:Q?{opacity:0,backgroundColor:"#bfdbfe",color:"#111827"}:{opacity:0},animate:Q?{opacity:1,backgroundColor:["#bfdbfe","#fecaca","#fee2e2"],color:["#111827","#b91c1c","#b91c1c"]}:{opacity:1},transition:Q?{opacity:{duration:.12,ease:"easeOut"},backgroundColor:{duration:.9,ease:"easeInOut",times:[0,.5,1]},color:{duration:.9,ease:"easeInOut",times:[0,.5,1]}}:void 0,className:`p-1.5 px-2 chat-bubble ${we||(l.role==="user"?"bg-yellow-100 text-black":"bg-blue-100 text-black")} w-fit max-w-[90%] min-h-[12px] rounded leading-snug font-geneva-12 break-words select-text`,style:{fontSize:`${C}px`},children:l.role==="assistant"?e.jsx(q.div,{className:"select-text flex flex-col gap-1",children:(_=l.parts)==null?void 0:_.map((H,ee)=>{const Y=`${R}-part-${ee}`;switch(H.type){case"text":{const G=H.text||"";if(/<textedit:(insert|replace|delete)/i.test(G)){const Te=(G.match(/<textedit:(insert|replace|delete)/g)||[]).length,Ae=(G.match(/<\/textedit:(insert|replace)>|<textedit:delete[^>]*\/>/g)||[]).length;if(Te!==Ae)return e.jsx(q.span,{initial:{opacity:1},animate:{opacity:1},transition:{duration:0},className:"select-text italic",children:u("apps.chats.status.editing")},Y)}const le=z(G)?G.slice(4).trimStart():G,Ne=Dt(le);return e.jsx("div",{className:"w-full",children:e.jsx("div",{className:"whitespace-pre-wrap",children:Ne&&(()=>{const Te=mt(Ne.trim());let Ae=0;return Te.map((me,Xe)=>{const vt=Ae,ot=Ae+me.content.length;return Ae=ot,e.jsx(q.span,{initial:O?{opacity:1,y:0}:{opacity:0,y:12},animate:{opacity:1,y:0},className:`select-text ${xt(Ne)?"text-[24px]":""} ${me.type==="bold"?"font-bold":me.type==="italic"?"italic":""}`,style:{userSelect:"text",fontSize:xt(Ne)?void 0:`${C}px`},transition:{duration:.08,delay:Xe*.02,ease:"easeOut",onComplete:()=>{Xe%2===0&&r()}},children:K&&vt<((re==null?void 0:re.end)??0)&&ot>((re==null?void 0:re.start)??0)?e.jsx("span",{className:"animate-highlight",children:me.type==="link"&&me.url?e.jsx("a",{href:me.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline",style:{color:Q?"inherit":void 0},onClick:fe=>fe.stopPropagation(),children:me.content}):me.content}):me.type==="link"&&me.url?e.jsx("a",{href:me.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline",style:{color:Q?"inherit":void 0},onClick:fe=>fe.stopPropagation(),children:me.content}):me.content},`${Y}-segment-${Xe}`)})})()})},Y)}default:{if(H.type.startsWith("tool-")){const G=H;return H.type.slice(5)==="aquarium"?null:e.jsx(In,{part:G,partKey:Y,isLoading:a,getAppName:$n,formatToolName:Ls,setIsInteractingWithPreview:ve,playElevatorMusic:k,stopElevatorMusic:g,playDingSound:S},Y)}return null}}})}):e.jsx(e.Fragment,{children:e.jsx("span",{className:`select-text whitespace-pre-wrap ${xt(Se)?"text-[24px]":""}`,style:{userSelect:"text",fontSize:xt(Se)?void 0:`${C}px`},children:(()=>{const H=mt(Se);let ee=0;return H.map((Y,G)=>{const Ce=ee,le=ee+Y.content.length;ee=le;const oe=K&&Ce<((re==null?void 0:re.end)??0)&&le>((re==null?void 0:re.start)??0),Ne=Y.type==="link"&&Y.url?e.jsx("a",{href:Y.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline",style:{color:Q?"inherit":void 0},onClick:Te=>Te.stopPropagation(),children:Y.content}):Y.content;return e.jsx("span",{className:`${Y.type==="bold"?"font-bold":Y.type==="italic"?"italic":""}`,children:oe?e.jsx("span",{className:"bg-yellow-200 animate-highlight",children:Ne}):Ne},`${R}-segment-${G}`)})})()})})}),(()=>{var ee;const H=new Set;return l.role==="assistant"?(ee=l.parts)==null||ee.forEach(Y=>{if(Y.type==="text"){const G=Y.text||"",Ce=z(G)?G.slice(4).trimStart():G,le=Dt(Ce);F(le).forEach(oe=>H.add(oe))}}):F(Se).forEach(Y=>H.add(Y)),H.size===0?null:e.jsx("div",{className:`flex flex-col gap-2 w-full ${fs(Se)?"":"mt-2"} ${l.role==="user"?"items-end":"items-start"}`,children:Array.from(H).map((Y,G)=>e.jsx(Rn,{url:Y,className:"max-w-[90%]"},`${R}-link-${G}`))})})()]},R)}),d&&(()=>{const l=Dn(d);return l==="Daily AI message limit reached."||l==="Set a username to continue chatting with Ryo."?null:l===u("apps.chats.status.loginToContinue")?p?null:e.jsxs(q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex items-center gap-2 text-gray-500 font-['Geneva-9'] text-[16px] antialiased h-[12px]",children:[e.jsx(us,{className:"h-3 w-3"}),e.jsx("span",{children:l})]},"login-message"):e.jsxs(q.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"flex items-start gap-2 text-red-600 font-['Geneva-9'] text-[16px] antialiased pl-1 py-1",children:[e.jsx(Rs,{className:"h-3 w-3 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 flex flex-row items-start justify-between gap-1",children:[e.jsx("span",{className:"leading-none",children:l}),x&&e.jsx(be,{size:"sm",variant:"link",onClick:x,className:"m-0 p-0 h-auto text-red-600 text-[16px] h-[16px] hover:text-red-700",children:u("apps.chats.status.retry")})]})]},"error-indicator")})()]})}function Fn({messages:s,isLoading:a,error:d,onRetry:x,onClear:h,isRoomView:A,roomId:T,isAdmin:j=!1,username:p,onMessageDeleted:w,fontSize:C,scrollToBottomTrigger:t,highlightSegment:c,isSpeaking:E,onSendMessage:N}){return e.jsxs(bt,{className:"flex-1 relative flex flex-col overflow-hidden w-full h-full",resize:"smooth",initial:"instant",children:[e.jsx(bt.Content,{className:"flex flex-col gap-1 p-3 pt-12 pb-14",children:e.jsx(_n,{messages:s,isLoading:a,error:d,onRetry:x,onClear:h,isRoomView:A,roomId:T,isAdmin:j,username:p,onMessageDeleted:w,fontSize:C,scrollToBottomTrigger:t,highlightSegment:c,isSpeaking:E,onSendMessage:N})}),e.jsx(On,{})]})}const gs=48;function zn(){const[s,a]=o.useState("");return o.useEffect(()=>{const d=[".","..","...","..",".",".","..","..."];let x=0;const h=setInterval(()=>{a(d[x]),x=(x+1)%d.length},200);return()=>clearInterval(h)},[]),e.jsx("span",{children:s})}function Un({input:s,isLoading:a,isForeground:d=!1,onInputChange:x,onSubmit:h,onStop:A,onDirectMessageSubmit:T,onNudge:j,previousMessages:p=[],showNudgeButton:w=!0,isInChatRoom:C=!1,isSpeechPlaying:t=!1,rateLimitError:c,needsUsername:E=!1,isOffline:N=!1,onManualStop:u}){var re;const{t:r}=Le(),[k,g]=o.useState(!1),[S,n]=o.useState(!1),[i,m]=o.useState(!1),[b,y]=o.useState(null),[V,X]=o.useState(!1),[te,M]=o.useState(0),[I,U]=o.useState(-1),[ie,ye]=o.useState(Array(gs).fill(0)),[ue,ve]=o.useState(!0),[ce,W]=o.useState(!1),pe=o.useRef(a),xe=o.useRef(t),Z=o.useRef(null),he=o.useRef(null),{playNote:ke}=Es(),{play:Pe}=Ts(As.MSN_NUDGE),{typingSynthEnabled:je,debugMode:f,aiModel:D,keepTalkingEnabled:z}=js(L=>({typingSynthEnabled:L.typingSynthEnabled,debugMode:L.debugMode,aiModel:L.aiModel,keepTalkingEnabled:L.keepTalkingEnabled})),F=$e(L=>L.current),l=F==="macosx",P=F==="xp"||F==="win98",R=D?(re=ka[D])==null?void 0:re.name:null,O=C&&(s.startsWith("@ryo ")||s==="@ryo");o.useEffect(()=>{X("ontouchstart"in window||navigator.maxTouchPoints>0)},[]),o.useEffect(()=>{if(!d)return;const L=K=>{if(K.key==="ArrowUp"&&p.length>0){K.preventDefault();const B=I+1;if(B<p.length){U(B);const _={target:{value:p[B]}};x(_)}}else if(K.key==="ArrowDown"&&I>-1){K.preventDefault();const B=I-1;U(B);const _={target:{value:B===-1?"":p[B]}};x(_)}};return window.addEventListener("keydown",L),()=>window.removeEventListener("keydown",L)},[d,I,p,x]),o.useEffect(()=>{U(-1)},[s]),o.useEffect(()=>{const L=pe.current||xe.current,K=!a&&!t;pe.current=a,xe.current=t,!(!ce||!z)&&L&&K&&setTimeout(()=>{var B;!i&&!S&&((B=he.current)==null||B.click())},300)},[a,t,ce,z,i,S]);const de=L=>{x(L),U(-1);const K=Date.now();je&&K-te>50&&(ke(),M(K))},Q=L=>{if(n(!1),m(!1),y(null),!L){y(r("apps.chats.status.noTranscriptionText")),W(!1);return}if(ut(ht.VOICE_MESSAGE),z&&!C&&W(!0),T)T(L.trim());else{const K={target:{value:L.trim()}};x(K);const B=new Event("submit");h(B),x({target:{value:""}})}},we=()=>{n(!0)},Ye=L=>{m(L)},Oe=o.useCallback((L,K)=>{ye(L),ve(K)},[]),Ze=()=>{var L;(L=he.current)==null||L.click()},Se=()=>{ut(ht.NUDGE),Pe(),j==null||j()},_e=()=>{var B,_;let L=s;if(s.startsWith("@ryo ")){(B=Z.current)==null||B.focus(),setTimeout(()=>{Z.current&&Z.current.setSelectionRange(Z.current.value.length,Z.current.value.length)},0);return}else s.startsWith("@ryo")?L=s.replace("@ryo","@ryo "):L=`@ryo ${s}`.trim()+(s.endsWith(" ")?"":" ");x({target:{value:L}}),(_=Z.current)==null||_.focus(),setTimeout(()=>{Z.current&&Z.current.setSelectionRange(Z.current.value.length,Z.current.value.length)},0)};return o.useEffect(()=>{const L=B=>{var _;B.code==="Space"&&!B.repeat&&d&&!k&&!S&&(B.preventDefault(),(_=he.current)==null||_.click())},K=B=>{var _;B.code==="Space"&&d&&!k&&S&&(B.preventDefault(),(_=he.current)==null||_.click())};return window.addEventListener("keydown",L),window.addEventListener("keyup",K),()=>{window.removeEventListener("keydown",L),window.removeEventListener("keyup",K)}},[d,k,S]),e.jsx(Me,{initial:!1,children:e.jsxs(q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},transition:{duration:.2,ease:"easeOut"},className:"w-full",children:[e.jsxs("form",{onSubmit:L=>{if(N){L.preventDefault(),Ps(r("apps.chats.status.chatRequiresInternet"));return}s.trim()!==""&&ut(ht.TEXT_MESSAGE,{message:s}),h(L)},className:`flex ${l?"gap-2":"gap-1"}`,children:[e.jsx("div",{className:"sr-only",children:e.jsx(ja,{ref:he,onTranscriptionComplete:Q,onTranscriptionStart:we,onRecordingStateChange:Ye,onFrequenciesChange:Oe,isLoading:S,silenceThreshold:1200,externalWaveform:!0,frequencyBands:gs})}),e.jsxs(Me,{mode:"popLayout",initial:!1,children:[i?e.jsxs(q.div,{initial:{opacity:0,scale:.98},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.98},transition:{duration:.15},className:`flex-1 relative h-9 flex items-center px-3 gap-2 ${l?"rounded-full":P?"rounded-none":"rounded-md"}`,style:l?{border:"1px solid rgba(0, 0, 0, 0.2)",backgroundColor:"rgba(255, 255, 255, 1)",boxShadow:"inset 0 1px 2px rgba(0, 0, 0, 0.1)"}:P?{border:"1px solid #7f9db9",backgroundColor:"white"}:{border:"1px solid #000",backgroundColor:"rgba(255, 255, 255, 0.8)"},children:[e.jsx("div",{className:"flex items-center shrink-0",children:e.jsx("span",{className:"text-muted-foreground text-xs font-geneva-12",children:r("apps.chats.status.listening")})}),e.jsx("div",{className:"flex-1 flex items-center h-full overflow-hidden",children:e.jsx("div",{className:"flex gap-[2px] items-center justify-between w-full",style:{opacity:ue?.4:1},children:ie.map((L,K)=>e.jsx(q.div,{className:"flex-1 max-w-[2px] rounded-full origin-center bg-neutral-300",initial:{scaleY:.3},animate:{scaleY:ue?.3:Math.max(.3,Math.min(L*2,1))},style:{height:20},transition:{type:"spring",bounce:.5,duration:.12}},K))})})]},"recording-ui"):e.jsxs(q.div,{initial:{opacity:0,scale:.98},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.98},transition:{duration:.15},className:"flex-1 relative",children:[e.jsx($t,{ref:Z,value:s,onChange:de,placeholder:a?"":r(S?"apps.chats.status.transcribing":E&&!C?"apps.chats.status.createAccountToContinue":k||V?"apps.chats.status.typeMessage":"apps.chats.status.typeOrPushSpace"),className:`w-full border-1 border-gray-800 text-xs font-geneva-12 h-9 ${l?"pl-3 pr-16 rounded-full":"pl-2 pr-16"} backdrop-blur-lg bg-white/80 ${k?"input--focused":""} ${O?"border-blue-600 bg-blue-50":""} ${E&&!C?"border-orange-600 bg-orange-50":""}`,onFocus:()=>g(!0),onBlur:()=>g(!1),onTouchStart:L=>{L.preventDefault()},disabled:E&&!C||N}),e.jsx(Me,{children:a&&s.trim()===""&&e.jsx(q.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.15},className:"absolute top-0 left-0 w-full h-full pointer-events-none flex items-center pl-3",children:e.jsxs("span",{className:"text-gray-500 opacity-70 shimmer-gray text-[13px] font-geneva-12",children:[r("apps.chats.status.thinking"),e.jsx(zn,{})]})},"thinking-overlay")}),e.jsxs("div",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 flex items-center gap-1",children:[w&&e.jsx(He,{children:e.jsxs(qe,{children:[e.jsx(We,{asChild:!0,children:e.jsx("div",{className:"relative",children:e.jsx("button",{type:"button",onClick:Se,className:`w-[22px] h-[22px] flex items-center justify-center ${l?"text-neutral-400 hover:text-neutral-800 transition-colors":""}`,disabled:a,"aria-label":r("apps.chats.ariaLabels.sendNudge"),children:e.jsx(sn,{className:"h-4 w-4 -rotate-40"})})})}),e.jsx(Ve,{children:e.jsx("p",{children:r("apps.chats.ariaLabels.sendNudge")})})]})}),C&&e.jsx(He,{children:e.jsxs(qe,{children:[e.jsx(We,{asChild:!0,children:e.jsx("div",{className:"relative",children:e.jsx("button",{type:"button",onClick:_e,className:`w-[22px] h-[22px] flex items-center justify-center ${l?"text-neutral-400 hover:text-neutral-800 transition-colors":""}`,disabled:a,"aria-label":r("apps.chats.ariaLabels.mentionRyo"),children:e.jsx(Za,{className:"h-4 w-4"})})})}),e.jsx(Ve,{children:e.jsx("p",{children:r("apps.chats.ariaLabels.mentionRyo")})})]})}),e.jsx(He,{children:e.jsxs(qe,{children:[e.jsx(We,{asChild:!0,children:e.jsx("button",{type:"button",onClick:()=>{var L;return(L=he.current)==null?void 0:L.click()},className:`w-[22px] h-[22px] flex items-center justify-center ${l?"text-neutral-400 hover:text-neutral-800 transition-colors":""}`,disabled:S,"aria-label":r("apps.chats.ariaLabels.pushToTalk"),children:e.jsx(Sa,{className:"h-4 w-4"})})}),e.jsx(Ve,{children:e.jsx("p",{children:r("apps.chats.ariaLabels.pushToTalk")})})]})})]})]},"input-ui"),a||t||i?e.jsx(q.div,{initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.8,opacity:0},transition:{duration:.15},children:e.jsxs(be,{type:"button",onClick:()=>{W(!1),i?Ze():(ut(ht.STOP_GENERATION),A(),u==null||u())},className:`text-xs w-9 h-9 p-0 flex items-center justify-center ${l?"rounded-full":"rounded-none"} ${l?"relative overflow-hidden transition-transform hover:scale-105":P?"text-black":"bg-black hover:bg-black/80 text-white border-2 border-gray-800"}`,style:l?{background:"linear-gradient(rgba(254, 205, 211, 0.9), rgba(252, 165, 165, 0.9))",boxShadow:"0 2px 3px rgba(0,0,0,0.2), 0 1px 1px rgba(0,0,0,0.3), inset 0 0 0 0.5px rgba(0,0,0,0.3), inset 0 1px 2px rgba(0,0,0,0.4), inset 0 2px 3px 1px rgba(254, 205, 211, 0.5)",backdropFilter:"blur(2px)"}:{},children:[l&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"pointer-events-none absolute left-1/2 -translate-x-1/2",style:{top:"2px",height:"30%",width:"calc(100% - 18px)",borderRadius:"8px 8px 4px 4px",background:"linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,0.25))",filter:"blur(0.2px)",zIndex:2}}),e.jsx("div",{className:"pointer-events-none absolute left-1/2 -translate-x-1/2",style:{bottom:"1px",height:"38%",width:"calc(100% - 4px)",borderRadius:"4px 4px 100% 100%",background:"linear-gradient(rgba(255,255,255,0.15), rgba(255,255,255,0.55))",filter:"blur(0.3px)",zIndex:1}})]}),e.jsx(cn,{className:`h-4 w-4 ${l?"text-black/70 relative z-10":P?"text-black":""}`,fill:"currentColor"})]})},"stop"):s.trim()!==""?e.jsx(q.div,{initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.8,opacity:0},transition:{duration:.15},children:e.jsxs(be,{type:"submit",className:`text-xs w-9 h-9 p-0 flex items-center justify-center ${l?"rounded-full":"rounded-none"} ${l?"relative overflow-hidden transition-transform hover:scale-105":P?"text-black":"bg-black hover:bg-black/80 text-white border-2 border-gray-800"}`,style:l?{background:"linear-gradient(rgba(217, 249, 157, 0.9), rgba(190, 227, 120, 0.9))",boxShadow:"0 2px 3px rgba(0,0,0,0.2), 0 1px 1px rgba(0,0,0,0.3), inset 0 0 0 0.5px rgba(0,0,0,0.3), inset 0 1px 2px rgba(0,0,0,0.4), inset 0 2px 3px 1px rgba(217, 249, 157, 0.5)",backdropFilter:"blur(2px)"}:{},disabled:a||N,children:[l&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"pointer-events-none absolute left-1/2 -translate-x-1/2",style:{top:"2px",height:"30%",width:"calc(100% - 16px)",borderRadius:"12px 12px 4px 4px",background:"linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,0.25))",filter:"blur(0.2px)",zIndex:2}}),e.jsx("div",{className:"pointer-events-none absolute left-1/2 -translate-x-1/2",style:{bottom:"1px",height:"38%",width:"calc(100% - 4px)",borderRadius:"4px 4px 100% 100%",background:"linear-gradient(rgba(255,255,255,0.15), rgba(255,255,255,0.55))",filter:"blur(0.3px)",zIndex:1}})]}),e.jsx(Ka,{className:`h-6 w-6 ${l?"text-black/70 relative z-10":P?"text-black":""}`})]})},"send"):null]})]}),e.jsx(Me,{children:(O||!C&&f&&R)&&e.jsx(q.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},transition:{duration:.15},className:"mt-2 px-1 text-xs text-neutral-700 font-geneva-12",children:O?r("apps.chats.status.ryoWillRespond")+(f&&R?` (${R})`:""):r("apps.chats.status.usingModel",{model:R})},"model-info")}),e.jsx(Me,{children:b&&e.jsx(q.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},transition:{duration:.15},className:"mt-1 text-red-600 text-xs font-geneva-12",children:b},"transcription-error")}),e.jsx(Me,{children:c&&!C&&e.jsx(q.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},transition:{duration:.15},className:"mt-1 text-red-600 text-xs font-geneva-12",children:c.message},"rate-limit-error")})]})})}const bs=({rooms:s,currentRoom:a,onRoomSelect:d,onAddRoom:x,onDeleteRoom:h,isVisible:A,isAdmin:T,isOverlay:j=!1,username:p})=>{const{t:w}=Le(),{play:C}=Ts(As.BUTTON_CLICK),t=ne(n=>n.unreadCounts),c=$e(n=>n.current),N=c==="xp"||c==="win98",u=ne(n=>n.isChannelsOpen),r=ne(n=>n.isPrivateOpen),k=ne(n=>n.toggleChannelsOpen),g=ne(n=>n.togglePrivateOpen);if(!A)return null;const S=n=>{const i=t[n.id]||0,m=i>0,b=(a==null?void 0:a.id)===n.id;return e.jsxs("div",{className:$("group relative py-1 px-5",b?"":"hover:bg-black/5"),style:b?{background:"var(--os-color-selection-bg)",color:"var(--os-color-selection-text)"}:void 0,onClick:()=>{C(),d(n)},children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{children:n.type==="private"?gt(n,p??null):`#${n.name}`}),(m||n.type!=="private")&&e.jsx("span",{className:$("text-[10px] ml-1.5 transition-opacity",m?"text-orange-600":(a==null?void 0:a.id)===n.id?"text-white/40":"text-black/40",m||n.userCount>0||(a==null?void 0:a.id)===n.id?"opacity-100":"opacity-0 group-hover:opacity-100"),children:m?`${i>=20?"20+":i} ${w("apps.chats.sidebar.new")}`:`${n.userCount} ${w("apps.chats.sidebar.online")}`})]}),(T&&n.type!=="private"||n.type==="private")&&h&&e.jsx("button",{className:$("absolute right-1 top-1/2 transform -translate-y-1/2 transition-opacity text-gray-500 hover:text-red-500 p-1 rounded hover:bg-black/5",(a==null?void 0:a.id)===n.id?"opacity-100":"opacity-0 group-hover:opacity-100"),onClick:y=>{y.stopPropagation(),C(),h(n)},"aria-label":n.type==="private"?w("apps.chats.ariaLabels.leaveConversation"):w("apps.chats.ariaLabels.deleteRoom"),title:n.type==="private"?w("apps.chats.ariaLabels.leaveConversation"):w("apps.chats.ariaLabels.deleteRoom"),children:e.jsx(Ot,{className:"w-3 h-3 text-black/30"})})]},n.id)};return e.jsx("div",{className:$("flex flex-col font-geneva-12 text-[12px] bg-neutral-100",j?`w-full border-b ${N?"border-[#919b9c]":c==="macosx"?"border-black/10":"border-black"}`:`w-56 border-r h-full overflow-hidden ${N?"border-[#919b9c]":c==="macosx"?"border-black/10":"border-black"}`),children:e.jsxs("div",{className:$("pt-3 flex flex-col",j?"pb-3":"flex-1 overflow-hidden"),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 flex-shrink-0 px-3",children:[e.jsx("div",{className:"flex items-baseline gap-1.5",children:e.jsx("h2",{className:"text-[14px] pl-1",children:w("apps.chats.sidebar.chats")})}),e.jsx(He,{children:e.jsxs(qe,{children:[e.jsx(We,{asChild:!0,children:e.jsx(be,{variant:"ghost",size:"sm",onClick:x,className:"flex items-center text-xs hover:bg-black/5 w-[24px] h-[24px]",children:e.jsx(Va,{className:"w-3 h-3"})})}),e.jsx(Ve,{children:e.jsx("p",{children:w("apps.chats.ariaLabels.newChat")})})]})})]}),e.jsxs("div",{className:$("space-y-1 overscroll-contain w-full","flex-1 overflow-y-auto min-h-0"),style:{WebkitOverflowScrolling:"touch"},children:[e.jsx("div",{className:$("py-1 px-5",a===null?"":"hover:bg-black/5"),style:a===null?{background:"var(--os-color-selection-bg)",color:"var(--os-color-selection-text)"}:void 0,onClick:()=>{C(),d(null)},children:w("apps.chats.status.ryo")}),Array.isArray(s)&&e.jsx(e.Fragment,{children:(()=>{const n=s.filter(V=>V.type!=="private"),i=s.filter(V=>V.type==="private"),m=n.length>0&&i.length>0,b=i.length>0,y=b?u:!0;return e.jsx(e.Fragment,{children:m?e.jsxs(e.Fragment,{children:[n.length>0&&e.jsxs("div",{className:$("mt-2 px-4 pt-2 pb-1 w-full flex items-center group","!text-[11px] uppercase tracking-wide text-black/50"),onClick:()=>{b&&(C(),k())},role:"button","aria-expanded":u,children:[e.jsx("span",{children:w("apps.chats.sidebar.rooms")}),b&&e.jsx("span",{className:"ml-2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(os,{className:$("w-3 h-3 text-black/50 transition-transform",u?"rotate-90":"rotate-0")})})]}),y&&n.map(S),i.length>0&&e.jsxs("div",{className:$("mt-2 px-4 pt-2 pb-1 w-full flex items-center group","!text-[11px] uppercase tracking-wide text-black/50"),onClick:()=>{C(),g()},role:"button","aria-expanded":r,children:[e.jsx("span",{children:w("apps.chats.sidebar.private")}),e.jsx("span",{className:"ml-2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(os,{className:$("w-3 h-3 text-black/50 transition-transform",r?"rotate-90":"rotate-0")})})]}),r&&i.map(S)]}):e.jsx(e.Fragment,{children:n.length>0?n.map(S):i.map(S)})})})()})]})]})})},ys=()=>{const s=Cs.getState(),a=Ca.getState(),d=Na.getState(),x=Ta.getState(),h=ne.getState(),A=Aa.getState(),T=d.getCurrentVideo(),j=x.tracks[x.currentIndex],p=Object.values(s.instances).filter(E=>E.isOpen),w=s.instanceOrder.length>0?s.instanceOrder[s.instanceOrder.length-1]:null,C=w?s.instances[w]:null,t=(C==null?void 0:C.appId)||null,c=p.filter(E=>E.instanceId!==w).map(E=>E.appId);return{apps:s.apps,instances:s.instances,username:h.username,locale:A.current,runningApps:{foreground:t,background:c,instanceWindowOrder:s.instanceOrder},internetExplorer:{url:a.url,year:a.year,status:a.status,currentPageTitle:a.currentPageTitle,aiGeneratedHtml:a.aiGeneratedHtml},video:{currentVideo:T?{id:T.id,url:T.url,title:T.title,artist:T.artist}:null,isPlaying:d.isPlaying,loopAll:d.loopAll,loopCurrent:d.loopCurrent,isShuffled:d.isShuffled},ipod:{currentTrack:j?{id:j.id,url:j.url,title:j.title,artist:j.artist}:null,isPlaying:x.isPlaying,loopAll:x.loopAll,loopCurrent:x.loopCurrent,isShuffled:x.isShuffled}}};function Bn({currentRoomId:s,onScrollToBottom:a,roomMessages:d=[]}){const{t:x}=Le(),{authToken:h,username:A}=ne(),T={};h&&A&&(T.Authorization=`Bearer ${h}`,T["X-Username"]=A);const{messages:j,status:p,stop:w}=Ya({transport:new Xa({api:is("/api/chat"),body:{systemState:ys()},headers:T})}),C=p==="streaming"||p==="submitted",t=o.useCallback(async E=>{const N=d.slice(-20).map(k=>`${k.username}: ${k.content}`).join(`
`),u={...ys(),chatRoomContext:{roomId:s,recentMessages:N,mentionedMessage:E}},r={"Content-Type":"application/json"};h&&A&&(r.Authorization=`Bearer ${h}`,r["X-Username"]=A),await fetch(is("/api/chat-rooms?action=generateRyoReply"),{method:"POST",headers:r,body:JSON.stringify({roomId:s,prompt:E,systemState:u})}),a()},[d,s,h,A,a]),c=o.useCallback(E=>E.startsWith("@ryo ")?{isMention:!0,messageContent:E.substring(4).trim()}:E==="@ryo"?{isMention:!0,messageContent:x("apps.chats.status.nudgeSent")}:{isMention:!1,messageContent:""},[x]);return{ryoMessages:j,isRyoLoading:C,stopRyo:w,handleRyoMention:t,detectAndProcessMention:c}}function hr({isWindowOpen:s,onClose:a,isForeground:d,skipInitialSound:x,instanceId:h,onNavigateNext:A,onNavigatePrevious:T}){const{t:j}=Le(),p=Pa("chats",Da),{aiMessages:w}=ne(),C=Ha(),{promptSetUsername:t}=C,c=jn(s??!1,t),{messages:E,input:N,handleInputChange:u,handleSubmit:r,isLoading:k,reload:g,error:S,stop:n,isSpeaking:i,handleDirectMessageSubmit:m,handleNudge:b,handleSaveTranscript:y,isClearDialogOpen:V,setIsClearDialogOpen:X,confirmClearChats:te,isSaveDialogOpen:M,setIsSaveDialogOpen:I,saveFileName:U,setSaveFileName:ie,handleSaveSubmit:ye,highlightSegment:ue,rateLimitError:ve,needsUsername:ce}=Ba(t),{username:W,authToken:pe,isUsernameDialogOpen:xe,setIsUsernameDialogOpen:Z,newUsername:he,setNewUsername:ke,newPassword:Pe,setNewPassword:je,isSettingUsername:f,usernameError:D,submitUsernameDialog:z,promptVerifyToken:F,isVerifyDialogOpen:l,setVerifyDialogOpen:P,verifyPasswordInput:R,setVerifyPasswordInput:O,verifyUsernameInput:de,setVerifyUsernameInput:Q,isVerifyingToken:we,verifyError:Ye,handleVerifyTokenSubmit:Oe,hasPassword:Ze,setPassword:Se,logout:_e,confirmLogout:re,isLogoutConfirmDialogOpen:L,setIsLogoutConfirmDialogOpen:K}=C,{rooms:B,currentRoomId:_,currentRoomMessages:H,currentRoomMessagesLimited:ee,isSidebarVisible:Y,isAdmin:G,handleRoomSelect:Ce,sendRoomMessage:le,toggleSidebarVisibility:oe,handleAddRoom:Ne,promptAddRoom:Te,promptDeleteRoom:Ae,isNewRoomDialogOpen:me,setIsNewRoomDialogOpen:Xe,isDeleteRoomDialogOpen:vt,setIsDeleteRoomDialogOpen:ot,roomToDelete:fe,confirmDeleteRoom:Ds}=c,$s=ne(v=>v.fontSize),Ge=ne(v=>v.setFontSize),[Os,Ft]=o.useState(!1),[_s,zt]=o.useState(!1),[Fs,Ut]=o.useState(!1),[zs,Ke]=o.useState(0),[Us,wt]=o.useState(!1),[Bs,kt]=o.useState(""),[Hs,jt]=o.useState(!1),[qs,Qe]=o.useState(null),[Bt,Ht]=o.useState(""),J=Array.isArray(B)&&_?B.find(v=>v.id===_):null,St=(J==null?void 0:J.type)!=="private"?(J==null?void 0:J.users)??[]:[],qt=St.slice(0,3),Wt=St.length-qt.length,Ws=qt.join(", ")+(Wt>0?`, ${Wt}+`:""),{isRyoLoading:Vt,stopRyo:Yt,handleRyoMention:Xt,detectAndProcessMention:Gt}=Bn({currentRoomId:_,onScrollToBottom:()=>Ke(v=>v+1),roomMessages:H==null?void 0:H.map(v=>({username:v.username,content:v.content,userId:v.id,timestamp:new Date(v.timestamp).toISOString()}))}),it=o.useCallback(v=>{Ce(v).then(ae=>{ae!=null&&ae.hadUnreads&&(console.log(`[ChatsApp] Triggering scroll for room with unreads: ${v}`),Ke(se=>se+1))})},[Ce]),Fe=Y??!1,Vs=o.useCallback(v=>{it(v?v.id:null),Fe&&oe()},[it,Fe,oe]),Ys=o.useCallback(async v=>{if(v.preventDefault(),!Ps(j("apps.chats.status.chatRequiresInternet")))if(_&&W){const ae=N.trim(),{isMention:se,messageContent:Ue}=Gt(ae);se?(u({target:{value:""}}),le(N),Xt(Ue),Ke(Re=>Re+1)):(le(N),u({target:{value:""}}),Ke(Re=>Re+1))}else r(v),Ke(ae=>ae+1)},[_,W,le,r,N,u,Xt,Gt]),Xs=o.useCallback(v=>{_&&W?le(v):m(v)},[_,W,le,m]),Gs=o.useCallback(()=>{Ft(!0),setTimeout(()=>Ft(!1),400),b(),Ke(v=>v+1)},[b]),Ks=o.useCallback(()=>{n(),Yt()},[n,Yt]),Js=o.useCallback(()=>{Ge(v=>Math.min(v+1,24))},[Ge]),Zs=o.useCallback(()=>{Ge(v=>Math.max(v-1,10))},[Ge]),Qs=o.useCallback(()=>{Ge(13)},[Ge]),lt=o.useRef(null),Kt=o.useRef(null),Jt=o.useRef(null),[ze,ea]=o.useState(!1);o.useEffect(()=>{if(!lt.current)return;const v=se=>{ea(se<550)};v(lt.current.getBoundingClientRect().width);const ae=new ResizeObserver(se=>{se[0]&&v(se[0].contentRect.width)});return ae.observe(lt.current),()=>ae.disconnect()},[]);const ta=_?Array.isArray(H)?H.length:0:E.length;o.useEffect(()=>{const v=Kt.current,ae=Jt.current;if(!v||!ae)return;let se=null;const Ue=()=>{const Tt=ae.querySelectorAll("*");for(const et of Tt){const ss=window.getComputedStyle(et);if((ss.overflowY==="auto"||ss.overflowY==="scroll")&&et.clientHeight>0&&et.scrollHeight>et.clientHeight+1)return et}return null},Re=()=>{if(v)if(se||(se=Ue()),se){const Tt=se.offsetWidth-se.clientWidth;v.style.setProperty("--sbw",`${Math.max(0,Tt)}px`)}else v.style.setProperty("--sbw","0px")};Re();const Nt=new ResizeObserver(()=>Re()),ts=new MutationObserver(()=>Re());return Nt.observe(ae),se&&Nt.observe(se),ts.observe(ae,{childList:!0,subtree:!0}),window.addEventListener("resize",Re),()=>{Nt.disconnect(),ts.disconnect(),window.removeEventListener("resize",Re)}},[_,ta]);const Zt=o.useRef(ze);o.useEffect(()=>{Zt.current&&!ze&&(Fe||oe()),Zt.current=ze},[ze,Fe,oe]);const sa=async v=>{if(jt(!0),Qe(null),!v||v.length<8){Qe(j("apps.chats.dialogs.passwordMinLengthError")),jt(!1);return}const ae=await Se(v);ae.ok?(Ee.success(j("apps.chats.dialogs.passwordSetSuccess"),{description:j("apps.chats.dialogs.passwordSetSuccessDescription")}),wt(!1),kt("")):Qe(ae.error||j("apps.chats.dialogs.passwordSetFailed")),jt(!1)},aa=o.useCallback(()=>{kt(""),Qe(null),wt(!0)},[]),na=o.useCallback(v=>{Ht(v),Xe(!0)},[]),Ct=$e(v=>v.current),ct=Ct==="xp"||Ct==="win98",Qt=ct,pt=Ct==="macosx",ra=Ea(),es=e.jsx(hn,{onClose:a,onShowHelp:()=>zt(!0),onShowAbout:()=>Ut(!0),onClearChats:()=>X(!0),onSaveTranscript:y,onSetUsername:t,onToggleSidebar:oe,isSidebarVisible:Fe,onAddRoom:Te,rooms:B,currentRoom:J??null,onRoomSelect:v=>it(v?v.id:null),onIncreaseFontSize:Js,onDecreaseFontSize:Zs,onResetFontSize:Qs,username:W,authToken:pe,onVerifyToken:F,isVerifyDialogOpen:l,setVerifyDialogOpen:P,verifyPasswordInput:R,setVerifyPasswordInput:O,verifyUsernameInput:de,setVerifyUsernameInput:Q,isVerifyingToken:we,verifyError:Ye,handleVerifyTokenSubmit:Oe,onLogout:_e});if(!s)return null;const oa=_?ee.map(v=>({id:v.clientId||v.id,serverId:v.id,role:v.username===W?"user":"human",parts:[{type:"text",text:v.content}],metadata:{createdAt:new Date(v.timestamp)},username:v.username})):E.map(v=>({...v,username:v.role==="user"?W||"You":Et().name}));return e.jsxs(e.Fragment,{children:[!ct&&d&&es,e.jsxs(Ia,{title:J?J.type==="private"?gt(J,W):`#${J.name}`:`@${Et().name.toLowerCase()}`,onClose:a,isForeground:d,appId:"chats",skipInitialSound:x,instanceId:h,onNavigateNext:A,onNavigatePrevious:T,isShaking:Os,menuBar:ct?es:void 0,children:[e.jsxs("div",{ref:lt,className:`relative h-full w-full ${Qt?"border-t border-[#919b9c]":""}`,children:[e.jsx(Me,{children:Fe&&ze&&e.jsxs(q.div,{className:"absolute inset-0 z-20",style:{perspective:"2000px"},children:[e.jsx(q.div,{initial:{opacity:0},animate:{opacity:.4},exit:{opacity:0},transition:{duration:.2,ease:[.4,0,.2,1]},className:"absolute inset-0 bg-black",onClick:oe}),e.jsx(q.div,{initial:{rotateX:-60,y:"-30%",scale:.9,opacity:0,transformOrigin:"top center"},animate:{rotateX:0,y:"0%",scale:1,opacity:1,transformOrigin:"top center"},exit:{rotateX:-60,y:"-30%",scale:.9,opacity:0,transformOrigin:"top center"},transition:{type:"spring",damping:40,stiffness:300,mass:1},className:"relative w-full bg-neutral-100 z-10",style:{transformPerspective:"2000px",backfaceVisibility:"hidden",willChange:"transform",maxHeight:"70%"},children:e.jsx(bs,{rooms:B,currentRoom:J??null,onRoomSelect:Vs,onAddRoom:Te,onDeleteRoom:v=>Ae(v),isVisible:!0,isAdmin:G,username:W,isOverlay:!0})})]})}),e.jsxs("div",{className:`flex h-full ${ze?"flex-col":"flex-row"}`,children:[e.jsx("div",{className:`${ze?"hidden":"block"} h-full`,children:e.jsx(bs,{rooms:B,currentRoom:J??null,onRoomSelect:v=>it(v?v.id:null),onAddRoom:Te,onDeleteRoom:v=>Ae(v),isVisible:Fe,isAdmin:G,username:W})}),e.jsxs("div",{className:"relative flex flex-col flex-1 h-full bg-white/85",children:[e.jsxs("div",{className:`sticky top-0 z-10 flex items-center justify-between px-2 py-1 border-b ${pt?"":"bg-neutral-200/90 backdrop-blur-lg"} ${Qt?"border-[#919b9c]":pt?"":"border-black"}`,style:pt?{backgroundImage:"var(--os-pinstripe-window)",opacity:.95,borderBottom:"var(--os-metrics-titlebar-border-width, 1px) solid var(--os-color-titlebar-border-inactive, rgba(0, 0, 0, 0.2))"}:void 0,children:[e.jsxs("div",{className:"flex items-center",children:[e.jsxs(be,{variant:"ghost",onClick:oe,className:"flex items-center gap-0.5 px-2 py-1 h-7",children:[e.jsx("h2",{className:"font-geneva-12 text-[12px] font-medium truncate",children:J?J.type==="private"?gt(J,W):`#${J.name}`:`@${Et().name.toLowerCase()}`}),e.jsx(Ns,{className:"h-3 w-3 transform transition-transform duration-200 text-neutral-400"})]}),J&&J.type!=="private"&&St.length>0&&e.jsx("span",{className:"font-geneva-12 text-[11px] text-neutral-500",children:Ws})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!J&&!W&&e.jsx(be,{variant:"ghost",onClick:t,className:"flex items-center gap-1 px-2 py-1 h-7",children:e.jsx("span",{className:"font-geneva-12 text-[11px] text-orange-600 hover:text-orange-700",children:j("apps.chats.status.loginToRyOS")})}),!J&&e.jsx(be,{variant:"ghost",onClick:()=>X(!0),className:"flex items-center gap-1 px-2 py-1 h-7",children:e.jsx("span",{className:"font-geneva-12 text-[11px]",children:j("apps.chats.status.clear")})}),J&&J.type==="private"&&e.jsx(be,{variant:"ghost",onClick:()=>Ae(J),className:"flex items-center gap-1 px-2 py-1 h-7",children:e.jsx("span",{className:"font-geneva-12 text-[11px]",children:j("apps.chats.status.leave")})})]})]}),e.jsxs("div",{ref:Kt,"data-chat-root":!0,className:"absolute inset-0 flex flex-col z-0",children:[e.jsx("div",{className:"flex-1 overflow-hidden",ref:Jt,children:e.jsx(Fn,{messages:oa,isLoading:k&&!_||!!_&&Vt,error:_?void 0:S,onRetry:g,onClear:()=>X(!0),isRoomView:!!_,roomId:_??void 0,isAdmin:G,username:W||void 0,onMessageDeleted:v=>{_&&ne.getState().removeMessageFromRoom(_,v)},fontSize:$s,scrollToBottomTrigger:zs,highlightSegment:ue,isSpeaking:i,onSendMessage:na},_||"ryo")}),e.jsx("div",{className:"absolute bottom-0 left-0 z-10 p-2",style:{width:"calc(100% - var(--sbw, 0px))"},children:_&&!W||!_&&ce&&!W?pt?e.jsx(be,{variant:"secondary",onClick:t,className:"w-full !h-9 !rounded-full orange",children:j("apps.chats.status.loginToChat")}):e.jsx(be,{onClick:t,className:`w-full h-9 font-geneva-12 text-[12px] ${ct?"text-black":"bg-orange-600 text-white hover:bg-orange-700 transition-all duration-200"}`,children:j("apps.chats.status.loginToChat")}):(()=>{const v=w.filter(se=>se.role==="user"),ae=Array.from(new Set(v.map(se=>se.parts?se.parts.filter(Ue=>Ue.type==="text").map(Ue=>Ue.text||"").join(""):""))).filter(Boolean).reverse();return e.jsx(Un,{input:N,isLoading:k||Vt,isForeground:d,onInputChange:u,onSubmit:Ys,onStop:Ks,isSpeechPlaying:i,onDirectMessageSubmit:Xs,onNudge:Gs,previousMessages:ae,showNudgeButton:!_,isInChatRoom:!!_,rateLimitError:ve,isOffline:ra,needsUsername:ce&&!W})})()})]})]})]})]}),e.jsx(Ra,{isOpen:_s,onOpenChange:zt,helpItems:p,appId:"chats"}),e.jsx(Ma,{isOpen:Fs,onOpenChange:Ut,metadata:La,appId:"chats"}),e.jsx(ls,{isOpen:V,onOpenChange:X,onConfirm:te,title:j("apps.chats.dialogs.clearChatsTitle"),description:j("apps.chats.dialogs.clearChatsDescription")}),e.jsx(cs,{isOpen:M,onOpenChange:I,onSubmit:ye,title:j("apps.chats.dialogs.saveTranscriptTitle"),description:j("apps.chats.dialogs.saveTranscriptDescription"),value:U,onChange:ie}),e.jsx(Is,{initialTab:"signup",isOpen:xe,onOpenChange:v=>{console.log(`[ChatApp Debug] Username LoginDialog onOpenChange called with: ${v}`),Z(v)},usernameInput:de,onUsernameInputChange:Q,passwordInput:R,onPasswordInputChange:O,onLoginSubmit:async()=>{await Oe(R,!0)},isLoginLoading:we,loginError:Ye,newUsername:he,onNewUsernameChange:ke,newPassword:Pe,onNewPasswordChange:je,onSignUpSubmit:z,isSignUpLoading:f,signUpError:D}),e.jsx(gn,{isOpen:me,onOpenChange:v=>{v||Ht(""),Xe(v)},onSubmit:Ne,isAdmin:G,currentUsername:W,initialUsers:Bt?[Bt]:[]}),e.jsx(ls,{isOpen:vt,onOpenChange:ot,onConfirm:Ds,title:(fe==null?void 0:fe.type)==="private"?j("apps.chats.dialogs.leaveConversationTitle"):j("apps.chats.dialogs.deleteChatRoomTitle"),description:(fe==null?void 0:fe.type)==="private"?j("apps.chats.dialogs.leaveConversationDescription",{name:fe.name}):j("apps.chats.dialogs.deleteChatRoomDescription",{name:fe==null?void 0:fe.name})}),e.jsx(Oa,{isOpen:L,onOpenChange:K,onConfirm:re,hasPassword:Ze,onSetPassword:aa}),e.jsx(cs,{isOpen:Us,onOpenChange:wt,onSubmit:sa,title:j("apps.chats.dialogs.setPasswordTitle"),description:j("apps.chats.dialogs.setPasswordDescription"),value:Bs,onChange:v=>{kt(v),Qe(null)},isLoading:Hs,errorMessage:qs,submitLabel:j("apps.chats.dialogs.setPasswordButton")})]})]})}export{hr as ChatsAppComponent};
