import{r as t}from"./ui-core-D0pDhx0h.js";import{Y as s,aI as z,a1 as F,bQ as O,aC as N,bR as U}from"./index-BxS3VOwZ.js";function D(I="/api/speech"){const u=t.useRef(null),w=t.useRef(0),d=t.useRef(new Set),[b,C]=t.useState(!1),h=t.useRef(new Set),v=t.useRef(Promise.resolve()),x=t.useRef(!1),G=3,g=t.useRef(0),R=t.useRef([]),n=t.useRef(null),E=s(e=>e.speechVolume),T=s(e=>e.masterVolume),k=s(e=>e.setIpodVolume),V=s(e=>e.setChatSynthVolume),y=s(e=>e.ttsModel),A=s(e=>e.ttsVoice),i=t.useRef(null),l=t.useRef(null),B=z(e=>e.isPlaying),M=typeof navigator<"u"&&/iP(hone|od|ad)/.test(navigator.userAgent),Q=()=>{if(u.current=U(),!n.current||n.current.context!==u.current){if(n.current)try{n.current.disconnect()}catch{console.error("Error disconnecting gain node")}n.current=u.current.createGain(),n.current.gain.value=E*T,n.current.connect(u.current.destination)}return u.current},q=t.useCallback(()=>{for(;R.current.length>0&&g.current<G;){const e=R.current.shift();g.current++,(async()=>{const o=new AbortController;d.current.add(o);try{const r={text:e.text,model:y};y==="elevenlabs"?r.voice_id=A:y==="openai"&&(r.voice=A);const{authToken:a,username:m}=N.getState(),S={"Content-Type":"application/json"};a&&m&&(S.Authorization=`Bearer ${a}`,S["X-Username"]=m);const f=await fetch(I,{method:"POST",headers:S,body:JSON.stringify(r),signal:o.signal});if(d.current.delete(o),!f.ok){console.error("TTS request failed",await f.text()),e.resolve(null);return}const c=await f.arrayBuffer();e.resolve(c)}catch(r){d.current.delete(o),(r==null?void 0:r.name)!=="AbortError"&&console.error("TTS fetch error",r),e.resolve(null)}finally{g.current--,q()}})()}},[I,y,A]),L=t.useCallback(e=>new Promise((p,o)=>{R.current.push({text:e,resolve:p,reject:o}),q()}),[q]),_=t.useCallback((e,p)=>{if(!e||!e.trim()||F("Text-to-speech requires an internet connection"))return;x.current=!1;const o=L(e.trim());v.current=v.current.then(async()=>{if(x.current){console.debug("TTS queue stopped, skipping scheduled chunk.");return}try{const r=await o;if(!r)return;await O();const a=Q(),m=await a.decodeAudioData(r),S=a.currentTime,f=Math.max(S,w.current),c=a.createBufferSource();c.buffer=m,n.current?c.connect(n.current):c.connect(a.destination),h.current.add(c),C(!0),c.onended=()=>{h.current.delete(c),h.current.size===0&&C(!1),p&&p()},c.start(f),w.current=f+m.duration}catch(r){(r==null?void 0:r.name)!=="AbortError"&&console.error("Error during speak()",r)}})},[L]),P=t.useCallback(()=>{console.debug("Stopping TTS queue..."),x.current=!0,d.current.forEach(e=>e.abort()),d.current.clear(),v.current=Promise.resolve(),R.current=[],g.current=0,h.current.forEach(e=>{try{e.stop()}catch{}}),h.current.clear(),C(!1),u.current&&(w.current=u.current.currentTime)},[]);return t.useEffect(()=>()=>{P()},[P]),t.useEffect(()=>{const e=async()=>{await O()};return window.addEventListener("focus",e),()=>{window.removeEventListener("focus",e)}},[]),t.useEffect(()=>{n.current&&(n.current.gain.value=E*T)},[E,T]),t.useEffect(()=>{if(b){if(i.current===null&&B&&!M){i.current=s.getState().ipodVolume;const e=Math.max(0,i.current*.35);k(e)}if(l.current===null){l.current=s.getState().chatSynthVolume;const e=Math.max(0,l.current*.6);V(e)}}else i.current!==null&&(k(i.current),i.current=null),l.current!==null&&(V(l.current),l.current=null)},[b,B,k,V,M]),{speak:_,stop:P,isSpeaking:b}}export{D as u};
