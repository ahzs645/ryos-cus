import{r as s,j as e,k as ds}from"./ui-core-D0pDhx0h.js";import{R as us}from"./index-B2E7WcJr.js";import{u as $e,bw as ps,bx as Pe,by as Je,bz as G,a as vt,M as Ds,b as nt,d as at,e as rt,f as ue,g as Ie,k as he,h as ft,i as mt,j as xt,bA as Fs,bB as Vs,a4 as me,S as hs,l as Bs,m as Us,am as fe,bC as _s,Y as fs,aI as k,bD as ts,a0 as ss,n as ns,o as as,b1 as zs,an as jt,bE as Ws,E as Ys,as as rs,ai as Hs,bF as Xs,Z as Ks,aD as qs,H as Gs,J as Js,bG as Zs,G as Qs,I as en,bH as tn,bI as sn,bJ as nn}from"./index-CoK7-gOT.js";import{C as an}from"./opencc-DdAalh07.js";import{m as Oe,A as Ze}from"./motion-DC7C-474.js";import"./react-CyQK0IK8.js";import"./media-player-Dfptv93o.js";import"./zustand-CwjPl1Tm.js";import"./tiptap-CPHiBm_b.js";import"./ui-form-Bg85K0S3.js";import"./audio-DxkJfdUY.js";import"./pusher-BvD42uFZ.js";import"./hangul-CIZ_Rl7P.js";import"./three-BOJBN814.js";function rn({onClose:a,onShowHelp:r,onShowAbout:p,onClearLibrary:A,onSyncLibrary:y,onAddTrack:x,onShareSong:I}){var ge;const{t:l}=$e(),[c,g]=s.useState(!1),L="ipod",N=(ge=Us[L])==null?void 0:ge.name,m=[{label:l("apps.ipod.translationLanguages.original"),code:null},{label:"English",code:"en"},{label:"中文",code:"zh-TW"},{label:"日本語",code:"ja"},{label:"한국어",code:"ko"},{label:"Español",code:"es"},{label:"Français",code:"fr"},{label:"Deutsch",code:"de"},{label:"Português",code:"pt"},{label:"Italiano",code:"it"},{label:"Русский",code:"ru"}],{tracks:h,currentIndex:C,isLoopAll:Z,isLoopCurrent:Y,isPlaying:D,isShuffled:B,isBacklightOn:v,isVideoOn:H,isLcdFilterOn:J,currentTheme:Q,showLyrics:ee,isFullScreen:U,lyricsAlignment:S,chineseVariant:b,koreanDisplay:u,lyricsTranslationLanguage:P,setCurrentIndex:j,setIsPlaying:X,toggleLoopAll:T,toggleLoopCurrent:w,toggleShuffle:F,togglePlay:O,nextTrack:z,previousTrack:se,toggleBacklight:Se,toggleVideo:Ce,toggleLcdFilter:xe,toggleFullScreen:f,setTheme:n,toggleLyrics:V,setLyricsAlignment:te,refreshLyrics:K,setChineseVariant:ce,setKoreanDisplay:ie,setLyricsTranslationLanguage:_,importLibrary:q,exportLibrary:ae}=ps(i=>({tracks:i.tracks,currentIndex:i.currentIndex,isLoopAll:i.loopAll,isLoopCurrent:i.loopCurrent,isPlaying:i.isPlaying,isShuffled:i.isShuffled,isBacklightOn:i.backlightOn,isVideoOn:i.showVideo,isLcdFilterOn:i.lcdFilterOn,currentTheme:i.theme,showLyrics:i.showLyrics,isFullScreen:i.isFullScreen,lyricsAlignment:i.lyricsAlignment??G.FocusThree,chineseVariant:i.chineseVariant??Je.Traditional,koreanDisplay:i.koreanDisplay??Pe.Original,lyricsTranslationLanguage:i.lyricsTranslationLanguage,setCurrentIndex:i.setCurrentIndex,setIsPlaying:i.setIsPlaying,toggleLoopAll:i.toggleLoopAll,toggleLoopCurrent:i.toggleLoopCurrent,toggleShuffle:i.toggleShuffle,togglePlay:i.togglePlay,nextTrack:i.nextTrack,previousTrack:i.previousTrack,toggleBacklight:i.toggleBacklight,toggleVideo:i.toggleVideo,toggleLcdFilter:i.toggleLcdFilter,toggleFullScreen:i.toggleFullScreen,setTheme:i.setTheme,toggleLyrics:i.toggleLyrics,setLyricsAlignment:i.setLyricsAlignment,refreshLyrics:i.refreshLyrics,setChineseVariant:i.setChineseVariant,setKoreanDisplay:i.setKoreanDisplay,setLyricsTranslationLanguage:i.setLyricsTranslationLanguage,importLibrary:i.importLibrary,exportLibrary:i.exportLibrary})),de=vt(i=>i.current),oe=de==="xp"||de==="win98",ye=i=>{j(i),X(!0)},Le=h.reduce((i,re,we)=>{const ke=re.artist||l("apps.ipod.menu.unknownArtist");return i[ke]||(i[ke]=[]),i[ke].push({track:re,index:we}),i},{}),Ee=Object.keys(Le).sort((i,re)=>i.localeCompare(re,void 0,{sensitivity:"base"})),it=()=>{try{const i=ae(),re=new Blob([i],{type:"application/json"}),we=URL.createObjectURL(re),ke=document.createElement("a");ke.href=we,ke.download="ipod-library.json",document.body.appendChild(ke),ke.click(),document.body.removeChild(ke),URL.revokeObjectURL(we),fe.success(l("apps.ipod.dialogs.libraryExportedSuccessfully"))}catch(i){console.error("Failed to export library:",i),fe.error(l("apps.ipod.dialogs.failedToExportLibrary"))}},Be=()=>{const i=document.createElement("input");i.type="file",i.accept=".json",i.onchange=re=>{var Qe;const we=(Qe=re.target.files)==null?void 0:Qe[0];if(!we)return;const ke=new FileReader;ke.onload=bt=>{var Ue;try{const et=(Ue=bt.target)==null?void 0:Ue.result;q(et),fe.success(l("apps.ipod.dialogs.libraryImportedSuccessfully"))}catch(et){console.error("Failed to import library:",et),fe.error(l("apps.ipod.dialogs.failedToImportLibrary"))}},ke.readAsText(we)},i.click()};return e.jsxs(Ds,{inWindowFrame:oe,children:[e.jsxs(nt,{children:[e.jsx(at,{className:"text-md px-2 py-1 border-none focus-visible:ring-0",children:l("apps.ipod.menu.file")}),e.jsxs(rt,{align:"start",sideOffset:1,className:"px-0",children:[e.jsx(ue,{onClick:x,className:"text-md h-6 px-3",children:l("apps.ipod.menu.addSong")}),e.jsx(ue,{onClick:I,className:"text-md h-6 px-3",disabled:h.length===0||C===-1,children:l("apps.ipod.menu.shareSong")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(ue,{onClick:it,className:"text-md h-6 px-3",disabled:h.length===0,children:l("apps.ipod.menu.exportLibrary")}),e.jsx(ue,{onClick:Be,className:"text-md h-6 px-3",children:l("apps.ipod.menu.importLibrary")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(ue,{onClick:a,className:"text-md h-6 px-3",children:l("common.menu.close")})]})]}),e.jsxs(nt,{children:[e.jsx(at,{className:"px-2 py-1 text-md focus-visible:ring-0",children:l("apps.ipod.menu.controls")}),e.jsxs(rt,{align:"start",sideOffset:1,className:"px-0",children:[e.jsx(ue,{onClick:O,className:"text-md h-6 px-3",disabled:h.length===0,children:l(D?"apps.ipod.menu.pause":"apps.ipod.menu.play")}),e.jsx(ue,{onClick:se,className:"text-md h-6 px-3",disabled:h.length===0,children:l("apps.ipod.menu.previous")}),e.jsx(ue,{onClick:z,className:"text-md h-6 px-3",disabled:h.length===0,children:l("apps.ipod.menu.next")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(he,{checked:B,onCheckedChange:()=>F(),className:"text-md h-6 px-3",children:l("apps.ipod.menu.shuffle")}),e.jsx(he,{checked:Z,onCheckedChange:()=>T(),className:"text-md h-6 px-3",children:l("apps.ipod.menu.repeatAll")}),e.jsx(he,{checked:Y,onCheckedChange:()=>w(),className:"text-md h-6 px-3",children:l("apps.ipod.menu.repeatOne")})]})]}),e.jsxs(nt,{children:[e.jsx(at,{className:"px-2 py-1 text-md focus-visible:ring-0",children:l("apps.ipod.menu.view")}),e.jsxs(rt,{align:"start",sideOffset:1,className:"px-0",children:[e.jsxs(ft,{children:[e.jsx(mt,{className:"text-md h-6 px-3",children:l("apps.ipod.menu.lyrics")}),e.jsxs(xt,{className:"px-0",children:[e.jsx(he,{checked:ee,onCheckedChange:()=>V(),className:"text-md h-6 px-3",children:l("apps.ipod.menu.showLyrics")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(he,{checked:b===Je.Traditional,onCheckedChange:i=>ce(i?Je.Traditional:Je.Original),className:"text-md h-6 px-3",children:l("apps.ipod.menu.traditionalChinese")}),e.jsx(he,{checked:u===Pe.Original,onCheckedChange:i=>ie(i?Pe.Original:Pe.Romanized),className:"text-md h-6 px-3",children:l("apps.ipod.menu.korean")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(he,{checked:S===G.FocusThree,onCheckedChange:i=>{i&&te(G.FocusThree)},className:"text-md h-6 pr-3",children:l("apps.ipod.menu.multi")}),e.jsx(he,{checked:S===G.Center,onCheckedChange:i=>{i&&te(G.Center)},className:"text-md h-6 pr-3",children:l("apps.ipod.menu.single")}),e.jsx(he,{checked:S===G.Alternating,onCheckedChange:i=>{i&&te(G.Alternating)},className:"text-md h-6 pr-3",children:l("apps.ipod.menu.alternating")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(ue,{onClick:K,className:"text-md h-6 px-3",disabled:h.length===0||C===-1,children:l("apps.ipod.menu.refreshLyrics")})]})]}),e.jsxs(ft,{children:[e.jsx(mt,{className:"text-md h-6 px-3",children:l("apps.ipod.menu.translate")}),e.jsx(xt,{className:"px-0 max-h-[400px] overflow-y-auto",children:e.jsx(Fs,{value:P||"off",onValueChange:i=>{_(i==="off"?null:i)},children:m.map(i=>{const re=i.code||"off";return e.jsx(Vs,{value:re,className:"text-md h-6 pr-3",children:i.label},re)})})})]}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(he,{checked:v,onCheckedChange:()=>Se(),className:"text-md h-6 px-3",children:l("apps.ipod.menu.backlight")}),e.jsx(he,{checked:J,onCheckedChange:()=>xe(),className:"text-md h-6 px-3",children:l("apps.ipod.menu.lcdFilter")}),e.jsx(he,{checked:H,onCheckedChange:()=>Ce(),className:"text-md h-6 px-3",disabled:!D,children:l("apps.ipod.menu.video")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(he,{checked:Q==="classic",onCheckedChange:i=>{i&&n("classic")},className:"text-md h-6 pr-3",children:l("apps.ipod.menu.classic")}),e.jsx(he,{checked:Q==="black",onCheckedChange:i=>{i&&n("black")},className:"text-md h-6 pr-3",children:l("apps.ipod.menu.black")}),e.jsx(he,{checked:Q==="u2",onCheckedChange:i=>{i&&n("u2")},className:"text-md h-6 pr-3",children:l("apps.ipod.menu.u2")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(he,{checked:U,onCheckedChange:()=>f(),className:"text-md h-6 px-3",children:l("apps.ipod.menu.fullScreen")})]})]}),e.jsxs(nt,{children:[e.jsx(at,{className:"px-2 py-1 text-md focus-visible:ring-0",children:l("apps.ipod.menu.library")}),e.jsxs(rt,{align:"start",sideOffset:1,className:"px-0 max-w-[180px] sm:max-w-[220px]",children:[e.jsx(ue,{onClick:x,className:"text-md h-6 px-3",children:l("apps.ipod.menu.addToLibrary")}),h.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsxs(ft,{children:[e.jsx(mt,{className:"text-md h-6 px-3",children:e.jsx("div",{className:"flex justify-between w-full items-center overflow-hidden",children:e.jsx("span",{className:"truncate min-w-0",children:l("apps.ipod.menu.allSongs")})})}),e.jsx(xt,{className:"px-0 max-w-[180px] sm:max-w-[220px] max-h-[400px] overflow-y-auto",children:h.map((i,re)=>e.jsx(ue,{onClick:()=>ye(re),className:me("text-md h-6 px-3 max-w-[220px] truncate",re===C&&"bg-gray-200"),children:e.jsxs("div",{className:"flex items-center w-full",children:[e.jsx("span",{className:me("flex-none whitespace-nowrap",re===C?"mr-1":"pl-5"),children:re===C?"♪ ":""}),e.jsx("span",{className:"truncate min-w-0",children:i.title})]})},`all-${i.id}`))})]}),e.jsx("div",{className:"max-h-[300px] overflow-y-auto",children:Ee.map(i=>e.jsxs(ft,{children:[e.jsx(mt,{className:"text-md h-6 px-3",children:e.jsx("div",{className:"flex justify-between w-full items-center overflow-hidden",children:e.jsx("span",{className:"truncate min-w-0",children:i})})}),e.jsx(xt,{className:"px-0 max-w-[180px] sm:max-w-[220px] max-h-[200px] overflow-y-auto",children:Le[i].map(({track:re,index:we})=>e.jsx(ue,{onClick:()=>ye(we),className:me("text-md h-6 px-3 max-w-[160px] sm:max-w-[200px] truncate",we===C&&"bg-gray-200"),children:e.jsxs("div",{className:"flex items-center w-full",children:[e.jsx("span",{className:me("flex-none whitespace-nowrap",we===C?"mr-1":"pl-5"),children:we===C?"♪ ":""}),e.jsx("span",{className:"truncate min-w-0",children:re.title})]})},`${i}-${re.id}`))})]},i))}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"})]}),e.jsx(ue,{onClick:A,className:"text-md h-6 px-3",children:l("apps.ipod.menu.clearLibrary")}),e.jsx(ue,{onClick:y,className:"text-md h-6 px-3",children:l("apps.ipod.menu.syncLibrary")})]})]}),e.jsxs(nt,{children:[e.jsx(at,{className:"px-2 py-1 text-md focus-visible:ring-0",children:l("common.menu.help")}),e.jsxs(rt,{align:"start",sideOffset:1,className:"px-0",children:[e.jsx(ue,{onClick:r,className:"text-md h-6 px-3",children:l("apps.ipod.menu.ipodHelp")}),e.jsx(ue,{onSelect:()=>g(!0),className:"text-md h-6 px-3",children:l("apps.ipod.menu.shareApp")}),e.jsx(Ie,{className:"h-[2px] bg-black my-1"}),e.jsx(ue,{onClick:p,className:"text-md h-6 px-3",children:l("apps.ipod.menu.aboutIpod")})]})]}),e.jsx(hs,{isOpen:c,onClose:()=>g(!1),itemType:"App",itemIdentifier:L,title:N,generateShareUrl:Bs})]})}const gt={spring:{type:"spring",stiffness:200,damping:30,mass:1},fade:{duration:.2}},on=({bottomPaddingClass:a="pb-5",textSizeClass:r="text-[12px]",fontClassName:p="font-geneva-12"})=>{const{t:A}=$e();return e.jsx("div",{className:`absolute inset-x-0 top-0 left-0 right-0 bottom-0 pointer-events-none flex items-end justify-center z-40 ${a}`,children:e.jsx("div",{className:`${r} ${p} shimmer opacity-60`,children:A("apps.ipod.status.loadingLyrics")})})},ln=({bottomPaddingClass:a="pb-5",textSizeClass:r="text-[12px]",fontClassName:p="font-geneva-12"})=>{const{t:A}=$e();return e.jsx("div",{className:`absolute inset-x-0 top-0 left-0 right-0 bottom-0 pointer-events-none flex items-end justify-center z-40 ${a}`,children:e.jsx("div",{className:`${r} ${p} shimmer opacity-60`,children:A("apps.ipod.status.translatingLyrics")})})},is=({bottomPaddingClass:a="pb-5",textSizeClass:r="text-[12px]",fontClassName:p="font-geneva-12"})=>e.jsx("div",{className:`absolute inset-x-0 top-0 left-0 right-0 bottom-0 pointer-events-none flex items-end justify-center z-40 ${a}`,children:e.jsx("div",{className:`text-white/70 ${r} ${p}`})}),cn=(a,r,p)=>({initial:{opacity:0,scale:.93,filter:"none",y:10,textShadow:"0 0 2px black, 0 0 2px black, 0 0 2px black, 0 0 0px rgba(255,255,255,0)"},animate:{opacity:r?p?1:.5:p?1:a===1||a===-1?.5:.1,scale:r||p||a===1||a===-1?1:.9,filter:"none",y:0,textShadow:p?"0 0 8px rgba(255,255,255,0.9), 0 0 2px black, 0 0 2px black, 0 0 2px black":"0 0 2px black, 0 0 2px black, 0 0 2px black"},exit:{opacity:0,scale:.9,filter:"none",y:-10,textShadow:"0 0 2px black, 0 0 2px black, 0 0 2px black, 0 0 0px rgba(255,255,255,0)"}});function ms({lines:a,currentLine:r,isLoading:p,error:A,visible:y=!0,videoVisible:x=!0,alignment:I=G.FocusThree,chineseVariant:l=Je.Traditional,koreanDisplay:c=Pe.Original,onAdjustOffset:g,isTranslating:L=!1,textSizeClass:N="text-[12px]",lineHeightClass:m="leading-[1.1]",interactive:h=!0,bottomPaddingClass:C="pb-5",gapClass:Z="gap-2",fontClassName:Y="font-geneva-12",containerStyle:D}){const B=s.useMemo(()=>an({from:"cn",to:"tw"}),[]),v=T=>{const w=/[\u4E00-\u9FFF]/,F=/[\u3040-\u309F\u30A0-\u30FF]/;return w.test(T)&&!F.test(T)},H=T=>{let w=T;return l===Je.Traditional&&v(w)&&(w=B(w)),c===Pe.Romanized&&/[\u3131-\u314e\u314f-\u3163\uac00-\ud7a3]/.test(w)&&(w=_s.convert(w)),w},J=(T,w,F)=>T===G.Center||T===G.FocusThree?"center":T===G.Alternating?F===1?"center":w===0?"left":"right":F===1?"center":F===2?w===0?"left":"right":w===0?"left":w===1?"center":w===2?"right":"center",Q=(T,w)=>{if(!T.length)return[];if(w<0)return T.slice(0,2).filter(Boolean);const F=Math.min(w,T.length-1),O=T[F+1];return F%2===0?[T[F],O].filter(Boolean):[O,T[F]].filter(Boolean)},[ee,U]=s.useState(()=>Q(a,r));s.useEffect(()=>{if(I!==G.Alternating)return;const T=Math.min(Math.max(0,r),a.length-1),w=T>=0&&a[T]?parseInt(a[T].startTimeMs):null,F=T+1<a.length&&a[T+1]?parseInt(a[T+1].startTimeMs):null,O=w!==null&&F!==null?F-w:0,z=Math.max(20,Math.floor(O*.2)),se=setTimeout(()=>{U(Q(a,r))},z);return()=>clearTimeout(se)},[I,a,r]);const S=s.useMemo(()=>{if(!a.length)return[];if(r<0)return a.slice(0,1).filter(Boolean);if(I===G.Center){const T=Math.min(Math.max(0,r),a.length-1),w=a[T];return w?[w]:[]}return a.slice(Math.max(0,r-1),r+2)},[a,r,I]),b=I===G.Alternating?ee:S,u=s.useRef(null),P=T=>{if(!h||!g||!x)return;const O=T.deltaY>0?50:-50;g(O)},j=T=>{h&&T.touches.length===1&&(u.current=T.touches[0].clientY)},X=T=>{if(!h||u.current===null||!g||!x)return;const w=T.touches[0].clientY,F=w-u.current;if(Math.abs(F)>10){const z=F>0?50:-50;g(z),u.current=w}};return y?p?e.jsx(on,{bottomPaddingClass:C,textSizeClass:N,fontClassName:Y}):L?e.jsx(ln,{bottomPaddingClass:C,textSizeClass:N,fontClassName:Y}):A?e.jsx(is,{bottomPaddingClass:C,textSizeClass:N,fontClassName:Y}):!a.length&&!p&&!L?e.jsx(is,{bottomPaddingClass:C,textSizeClass:N,fontClassName:Y}):e.jsx(Oe.div,{layout:I===G.Alternating,transition:gt.spring,className:`absolute inset-x-0 mx-auto top-0 left-0 right-0 bottom-0 w-full h-full overflow-hidden flex flex-col items-center justify-end ${Z} z-40 select-none px-0 ${C}`,style:{...D||{},pointerEvents:h?"auto":"none"},onWheel:P,onTouchStart:j,onTouchMove:X,children:e.jsx(Ze,{mode:"popLayout",children:b.map((T,w)=>{const F=T===a[r];let O=0;if(I===G.Alternating)O=F?0:1;else{const Ce=a.indexOf(a[r]);O=a.indexOf(T)-Ce}const z=cn(O,I===G.Alternating,F),se={...gt.spring,opacity:gt.fade,filter:gt.fade,duration:.15},Se=J(I,w,b.length);return e.jsx(Oe.div,{layoutId:`${T.startTimeMs}-${T.words.substring(0,10)}`,initial:"initial",animate:"animate",exit:"exit",variants:z,transition:se,className:`px-2 md:px-6 ${N} ${Y} ${m} whitespace-pre-wrap break-words max-w-full text-white`,style:{textAlign:Se,width:"100%",paddingLeft:I===G.Alternating&&w===0&&b.length>1?"5%":void 0,paddingRight:I===G.Alternating&&w===1&&b.length>1?"5%":void 0},children:H(T.words)},T.startTimeMs)})})}):null}function dn({backlightOn:a}){const[r,p]=s.useState(null),[A,y]=s.useState(!1),[x,I]=s.useState(1);s.useEffect(()=>{(async()=>{try{if("getBattery"in navigator){const L=await navigator.getBattery();p(L.level),y(L.charging);const N=()=>p(L.level),m=()=>y(L.charging);return L.addEventListener("levelchange",N),L.addEventListener("chargingchange",m),()=>{L.removeEventListener("levelchange",N),L.removeEventListener("chargingchange",m)}}}catch{p(1),y(!1)}})()},[]),s.useEffect(()=>{if(!A)return;const g=setInterval(()=>{I(L=>L%4+1)},500);return()=>clearInterval(g)},[A]);const c=A?x:Math.ceil((r??1)*4);return e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"relative w-[19px] h-[10px] border border-[#0a3667] bg-transparent",children:e.jsx("div",{className:"absolute inset-[1px] flex gap-[1px]",children:[1,2,3,4].map(g=>e.jsx("div",{className:`flex-1 h-full transition-colors duration-200 ${g<=c?"bg-[#0a3667]":"bg-transparent"}`},g))})}),e.jsx("div",{className:"w-[2px] h-[4px] bg-[#0a3667] relative",children:e.jsx("div",{className:`w-[2px] h-[2px] absolute top-[1px] left-[-2px] right-[0px] mx-auto ${a?"bg-[#c5e0f5]":"bg-[#8a9da9]"}`})})]})}function un({containerRef:a,backlightOn:r,menuMode:p}){const A=s.useRef(null),y=s.useRef(null);return s.useLayoutEffect(()=>{const x=a.current,I=A.current,l=y.current;if(!x||!I||!l||!p)return;const c=()=>{const{scrollTop:L,scrollHeight:N,clientHeight:m}=x;if(N>m){l.style.opacity="1",I.style.display="block";const C=m+3,Z=Math.max(m/N*C,20),Y=N-m,D=C-Z,B=Y>0?L/Y*D:0;I.style.height=`${Z-4}px`,I.style.top=`${B+2}px`}else l.style.opacity="0",I.style.display="none"};c(),x.addEventListener("scroll",c,{passive:!0});const g=new ResizeObserver(c);return g.observe(x),()=>{x.removeEventListener("scroll",c),g.disconnect()}},[a,p]),p?e.jsxs("div",{className:"absolute right-0 top-[-1px] bottom-[-2px] w-2 z-20",children:[e.jsx("div",{ref:y,className:me("w-full h-full border border-[#0a3667] transition-all duration-500",r?"bg-[#c5e0f5] bg-gradient-to-b from-[#d1e8fa] to-[#e0f0fc]":"bg-[#8a9da9]"),style:{opacity:0}}),e.jsx("div",{ref:A,className:"absolute right-0 bg-[#0a3667]",style:{marginLeft:"2px",marginRight:"2px",width:"calc(100% - 4px)",display:"none"}})]}):null}function pn({text:a,isSelected:r,onClick:p,backlightOn:A=!0,showChevron:y=!0,value:x}){return e.jsxs("div",{onClick:p,className:me("pl-2 cursor-pointer font-chicago text-[16px] flex justify-between items-center",y||x?"pr-4":"pr-2",r?A?"bg-[#0a3667] text-[#c5e0f5] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)]":"bg-[#0a3667] text-[#8a9da9] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)]":"text-[#0a3667] hover:bg-[#c0d8f0] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)]"),children:[e.jsx("span",{className:"whitespace-nowrap overflow-hidden text-ellipsis flex-1 mr-2",children:a}),x?e.jsx("span",{className:"flex-shrink-0",children:x}):y&&e.jsx("span",{className:"flex-shrink-0",children:">"})]})}function os({text:a,className:r,isPlaying:p=!0}){const A=s.useRef(null),y=s.useRef(null),[x,I]=s.useState(!1),[l,c]=s.useState(0),g=20;return s.useEffect(()=>{if(A.current&&y.current){const L=A.current.clientWidth,N=y.current.scrollWidth;c(N),I(N>L)}},[a,A,y]),e.jsx("div",{ref:A,className:me("relative overflow-hidden",!x&&"flex justify-center",r),children:x?e.jsx("div",{className:"inline-block whitespace-nowrap",children:e.jsxs(Oe.div,{animate:{x:p?[0,-(l+g)]:0},transition:p?{duration:Math.max(a.length*.15,8),ease:"linear",repeat:1/0}:{duration:.3},style:{display:"inline-flex"},children:[e.jsx("span",{ref:y,style:{paddingRight:`${g}px`},children:a}),e.jsx("span",{style:{paddingRight:`${g}px`},"aria-hidden":!0,children:a})]})}):e.jsx("div",{ref:y,className:"whitespace-nowrap text-center",children:a})})}function hn({message:a}){return e.jsx("div",{className:"absolute top-4 left-4 pointer-events-none",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"font-chicago text-white text-xl relative z-10",children:a}),e.jsx("div",{className:"font-chicago text-black text-xl absolute inset-0",style:{WebkitTextStroke:"3px black",textShadow:"none"},children:a})]})})}function fn({currentTrack:a,isPlaying:r,elapsedTime:p,totalTime:A,menuMode:y,menuHistory:x,selectedMenuItem:I,onSelectMenuItem:l,currentIndex:c,tracksLength:g,backlightOn:L,menuDirection:N,onMenuItemAction:m,showVideo:h,playerRef:C,handleTrackEnd:Z,handleProgress:Y,handleDuration:D,handlePlay:B,handlePause:v,handleReady:H,loopCurrent:J,statusMessage:Q,onToggleVideo:ee,lcdFilterOn:U,ipodVolume:S,showStatusCallback:b,showLyrics:u,lyricsAlignment:P,chineseVariant:j,koreanDisplay:X,lyricOffset:T,adjustLyricOffset:w,registerActivity:F,isFullScreen:O,lyricsControls:z}){const{t:se}=$e(),Se={enter:_=>({x:_==="forward"?"100%":"-100%"}),center:{x:0},exit:_=>({x:_==="forward"?"-100%":"100%"})},Ce=y?x.length>0?x[x.length-1].title:se("apps.ipod.menuItems.ipod"):se("apps.ipod.menuItems.nowPlaying"),xe=s.useRef(null),f=s.useRef([]),n=s.useRef(!1),V=fs(_=>_.masterVolume),te=S*V,K=_=>{f.current=Array(_).fill(null)},ce=()=>{if(!y||x.length===0)return;const _=document.querySelector(".ipod-menu-container");if(!_)return;const q=Array.from(_.querySelectorAll(".ipod-menu-item"));if(!q.length||I<0||I>=q.length)return;const ae=q[I];if(!ae)return;const de=_.clientHeight,oe=ae.offsetTop,ye=ae.offsetHeight,Le=_.scrollTop,Ee=2;oe+ye>Le+de-Ee?_.scrollTo({top:oe+ye-de+Ee,behavior:"instant"}):oe<Le+Ee&&_.scrollTo({top:Math.max(0,oe-Ee),behavior:"instant"}),I===0&&_.scrollTo({top:0,behavior:"instant"}),I===q.length-1&&_.scrollTo({top:Math.max(0,oe-(de-ye)+Ee),behavior:"instant"}),n.current=!1};s.useEffect(()=>{y&&x.length>0&&(n.current=!0,ce(),[50,100,250,500,1e3].forEach(q=>{setTimeout(()=>{n.current&&ce()},q)}))},[y,I,x.length]),s.useEffect(()=>{if(y&&x.length>0){const _=x[x.length-1];K(_.items.length)}},[y,x.length]);const ie=u;return e.jsxs("div",{className:me("relative w-full h-[150px] border border-black border-2 rounded-[2px] overflow-hidden transition-all duration-500 select-none",U?"lcd-screen":"",L?"bg-[#c5e0f5] bg-gradient-to-b from-[#d1e8fa] to-[#e0f0fc]":"bg-[#8a9da9] contrast-65 saturate-50",U&&L&&"shadow-[0_0_10px_2px_rgba(197,224,245,0.05)]"),style:{minWidth:"100%",minHeight:"150px",maxWidth:"100%",maxHeight:"150px",position:"relative",contain:"layout style paint"},children:[U&&e.jsx("div",{className:"absolute inset-0 pointer-events-none z-25 lcd-scan-lines"}),U&&e.jsx("div",{className:"absolute inset-0 pointer-events-none z-25 lcd-reflection"}),a&&e.jsx("div",{className:me("absolute inset-0 transition-opacity duration-300 overflow-hidden",y?"z-0":"z-20",y||!h?"opacity-0 pointer-events-none":"opacity-100"),children:e.jsxs("div",{className:"w-full h-[calc(100%+120px)] mt-[-60px]",onClick:_=>{_.stopPropagation(),F(),r?ee():h?B():(ee(),setTimeout(()=>{B()},100))},children:[e.jsx(us,{ref:C,url:a.url,playing:r,controls:h,width:"100%",height:"100%",onEnded:O?void 0:Z,onProgress:O?void 0:Y,onDuration:O?void 0:D,onPlay:O?void 0:B,onPause:O?void 0:v,onReady:O?void 0:H,loop:J,volume:te,playsinline:!0,config:{youtube:{playerVars:{modestbranding:1,rel:0,showinfo:0,iv_load_policy:3,fs:0,disablekb:1,playsinline:1,enablejsapi:1,origin:window.location.origin},embedOptions:{referrerPolicy:"strict-origin-when-cross-origin"}}}}),h&&ie&&e.jsx("div",{className:"absolute inset-0 bg-black/30 z-25"}),h&&e.jsx("div",{className:"absolute inset-0 z-30",onClick:_=>{_.stopPropagation(),r?ee():B()}}),e.jsx(Ze,{children:Q&&e.jsx(Oe.div,{className:"absolute inset-0 z-40",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},children:e.jsx(hn,{message:Q})})}),e.jsx(ms,{lines:z.lines,currentLine:z.currentLine,isLoading:z.isLoading,error:z.error,visible:ie,videoVisible:h,alignment:P,chineseVariant:j,koreanDisplay:X,isTranslating:z.isTranslating,onAdjustOffset:_=>{w(_);const q=T+_,ae=q>0?"+":(q<0,"");b(`${se("apps.ipod.status.offset")} ${ae}${(q/1e3).toFixed(2)}s`);const de=p+q/1e3;z.updateCurrentTimeManually(de)}})]})}),e.jsxs("div",{className:"border-b border-[#0a3667] py-0 px-2 font-chicago text-[16px] flex items-center sticky top-0 z-10 text-[#0a3667] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)]",children:[e.jsx("div",{className:`w-6 flex items-center justify-start font-chicago ${r?"text-xs":"text-[18px]"}`,children:e.jsx("div",{className:"w-4 h-4 mt-0.5 flex items-center justify-center",children:r?"▶":"⏸︎"})}),e.jsx("div",{className:"flex-1 truncate text-center",children:Ce}),e.jsx("div",{className:"w-6 flex items-center justify-end",children:e.jsx(dn,{backlightOn:L})})]}),e.jsx("div",{className:"relative h-[calc(100%-26px)]",children:e.jsx(Ze,{initial:!1,custom:N,mode:"sync",children:y?e.jsx(Oe.div,{className:"absolute inset-0 flex flex-col h-full",initial:"enter",animate:"center",exit:"exit",variants:Se,transition:{duration:.2,ease:"easeInOut"},custom:N,onAnimationComplete:()=>{n.current=!0,ce()},children:e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("div",{ref:xe,className:"absolute inset-0 overflow-auto ipod-menu-container",children:x.length>0&&x[x.length-1].items.map((_,q)=>e.jsx("div",{ref:ae=>{f.current[q]=ae},className:`ipod-menu-item ${q===I?"selected":""}`,children:e.jsx(pn,{text:_.label,isSelected:q===I,backlightOn:L,onClick:()=>{l(q),m(_.action)},showChevron:_.showChevron!==!1,value:_.value})},q))}),e.jsx(un,{containerRef:xe,backlightOn:L,menuMode:y})]})},`menu-${x.length}-${Ce}`):e.jsx(Oe.div,{className:"absolute inset-0 flex flex-col h-full",initial:"enter",animate:"center",exit:"exit",variants:Se,transition:{duration:.2,ease:"easeInOut"},custom:N,onClick:()=>{!y&&a&&(F(),r?ee():h?B():(ee(),setTimeout(()=>{B()},100)))},children:e.jsx("div",{className:"flex-1 flex flex-col p-1 px-2 overflow-auto",children:a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"font-chicago text-[12px] mb-1 text-[#0a3667] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)]",children:[c+1," of ",g]}),e.jsxs("div",{className:"font-chicago text-[16px] text-center text-[#0a3667] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)]",children:[e.jsx(os,{text:a.title,isPlaying:r}),e.jsx(os,{text:a.artist||"",isPlaying:r})]}),e.jsx("div",{className:"mt-auto w-full h-[8px] rounded-full border border-[#0a3667] overflow-hidden",children:e.jsx("div",{className:"h-full bg-[#0a3667]",style:{width:`${A>0?p/A*100:0}%`}})}),e.jsxs("div",{className:"font-chicago text-[16px] w-full h-[22px] flex justify-between text-[#0a3667] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)]",children:[e.jsxs("span",{children:[Math.floor(p/60),":",String(Math.floor(p%60)).padStart(2,"0")]}),e.jsxs("span",{children:["-",Math.floor((A-p)/60),":",String(Math.floor((A-p)%60)).padStart(2,"0")]})]})]}):e.jsxs("div",{className:"text-center font-geneva-12 text-[12px] text-[#0a3667] [text-shadow:1px_1px_0_rgba(0,0,0,0.15)] h-full flex flex-col justify-center items-center",children:[e.jsx("p",{children:"Don't steal music"}),e.jsx("p",{children:"Ne volez pas la musique"}),e.jsx("p",{children:"Bitte keine Musik stehlen"}),e.jsx("p",{children:"音楽を盗用しないでください"})]})})},"nowplaying")})})]})}const ls=15;function mn({theme:a,onWheelClick:r,onWheelRotation:p,onMenuButton:A}){const{t:y}=$e(),x=s.useRef(null),[I,l]=s.useState(0),c=s.useRef(null),g=s.useRef(0),L=s.useRef(!1),N=s.useRef(!1),m=s.useRef(null),h=s.useRef(!1),C=s.useRef(!1),Z=s.useRef(!1),Y=(S,b)=>{if(!x.current)return 0;const u=x.current.getBoundingClientRect(),P=u.left+u.width/2,j=u.top+u.height/2;return Math.atan2(b-j,S-P)*180/Math.PI},D=(S,b)=>{if(!x.current)return 0;const u=x.current.getBoundingClientRect(),P=u.left+u.width/2,j=u.top+u.height/2;return Math.atan2(b-j,S-P)},B=S=>{const b=S*Math.PI/180;return b>=-Math.PI/4&&b<Math.PI/4?"right":b>=Math.PI/4&&b<3*Math.PI/4?"bottom":b>=3*Math.PI/4||b<-3*Math.PI/4?"left":"top"},v=(S,b)=>{if(!x.current)return!1;const u=x.current.getBoundingClientRect(),P=u.left+u.width/2,j=u.top+u.height/2;return Math.sqrt((S-P)**2+(b-j)**2)<=32},H=S=>{S.preventDefault();const b=S.touches[0];if(v(b.clientX,b.clientY))return;const u=D(b.clientX,b.clientY);c.current=u,g.current=0,N.current=!1,m.current={x:b.clientX,y:b.clientY}},J=S=>{if(S.preventDefault(),c.current===null)return;const b=S.touches[0],u=D(b.clientX,b.clientY);let P=u-c.current;P>Math.PI&&(P-=2*Math.PI),P<-Math.PI&&(P+=2*Math.PI),g.current+=P,c.current=u;const j=ls*Math.PI/180;for(!N.current&&Math.abs(g.current)>j&&(N.current=!0,Z.current=!0);g.current>j;)p("clockwise"),g.current-=j;for(;g.current<-j;)p("counterclockwise"),g.current+=j},Q=()=>{if(!N.current&&m.current){const S=Y(m.current.x,m.current.y),b=B(S);r(b),h.current=!0,setTimeout(()=>{h.current=!1},500)}c.current=null,g.current=0,N.current=!1,m.current=null,Z.current&&setTimeout(()=>{Z.current=!1},100)},ee=S=>{const b=I+Math.abs(S.deltaY);l(b),b>=50&&(S.deltaY<0?p("counterclockwise"):p("clockwise"),l(0))},U=S=>{if(h.current)return;C.current=S.target&&S.target.classList.contains("menu-button"),S.preventDefault();const b=D(S.clientX,S.clientY);c.current=b,g.current=0,L.current=!1;const u=ls*Math.PI/180,P=X=>{if(c.current===null)return;const T=D(X.clientX,X.clientY);let w=T-c.current;for(w>Math.PI&&(w-=2*Math.PI),w<-Math.PI&&(w+=2*Math.PI),g.current+=w,c.current=T,!L.current&&Math.abs(g.current)>u&&(L.current=!0);g.current>u;)p("clockwise"),g.current-=u;for(;g.current<-u;)p("counterclockwise"),g.current+=u},j=X=>{if(window.removeEventListener("mousemove",P),window.removeEventListener("mouseup",j),!L.current&&!C.current){const T=Y(X.clientX,X.clientY),w=B(T);r(w)}c.current=null,g.current=0,L.current=!1,C.current=!1};window.addEventListener("mousemove",P),window.addEventListener("mouseup",j)};return e.jsxs("div",{className:me("mt-6 relative w-[180px] h-[180px] rounded-full flex items-center justify-center select-none",a==="classic"?"bg-gray-300/60":a==="u2"?"bg-red-700/60":"bg-neutral-800/50"),children:[e.jsx("div",{role:"button",tabIndex:0,"aria-label":y("apps.ipod.ariaLabels.select"),onClick:()=>{h.current||Z.current||r("center")},onKeyDown:S=>{h.current||Z.current||(S.key==="Enter"||S.key===" ")&&(S.preventDefault(),r("center"))},className:me("ipod-wheel-center absolute w-16 h-16 rounded-full z-10 flex items-center justify-center outline-none focus:outline-none focus-visible:outline-none",a==="classic"?"bg-white/30":a==="u2"?"bg-black/70":"bg-black/30")}),e.jsxs("div",{ref:x,className:"absolute w-full h-full rounded-full touch-none select-none",onMouseDown:U,onTouchStart:H,onTouchMove:J,onTouchEnd:Q,onWheel:ee,children:[e.jsx("div",{className:"absolute top-1.5 text-center left-1/2 transform -translate-x-1/2 font-chicago text-xs text-white menu-button cursor-default select-none",onClick:S=>{h.current||Z.current||(S.stopPropagation(),A())},children:"MENU"}),e.jsx("div",{className:"absolute right-2 text-right top-1/2 transform -translate-y-1/2 font-chicago text-[12px] text-white cursor-default select-none",children:"⏭"}),e.jsx("div",{className:"absolute bottom-1 text-center left-1/2 transform -translate-x-1/2 font-chicago text-[12px] text-white cursor-default select-none",children:"⏯"}),e.jsx("div",{className:"absolute left-2 text-left top-1/2 transform -translate-y-1/2 font-chicago text-[12px] text-white cursor-default select-none",children:"⏮"})]})]})}const xn=["作词","作曲","编曲","制作","发行","出品","监制","策划","统筹","录音","混音","母带","和声","版权","吉他","贝斯","鼓","键盘","企划","词","詞：","曲","OP","SP","Produced","Composed","Arranged","Mixed","Lyrics","Keyboard","Guitar","Bass","Drum","Vocal","Original Publisher","Sub-publisher","Electric Piano","Synth by","Recorded by","Mixed by","Mastered by","Produced by","Composed by","Digital Editing by","Mix Assisted by","Mix by","Mix Engineer","Background vocals","Background vocals by","Chorus by","Percussion by","String by","Harp by","Piano by","Piano Arranged by","Written by","Additional Production by","Synthesizer","Programming","Background Vocals","Recording Engineer","Digital Editing"],cs=(a,r,p)=>{const A=[...xn,`${r} - ${p}`,`${p} - ${r}`];return a.split(`
`).map(y=>{const x=y.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.+)/);if(!x)return null;const[,I,l,c,g]=x,L=g.trim();return A.some(m=>L.startsWith(m))?null:{startTimeMs:(parseInt(I)*6e4+parseInt(l)*1e3+parseInt(c.padEnd(3,"0"))).toString(),words:L}}).filter(y=>y!==null)};function gn({title:a="",artist:r="",album:p="",currentTime:A,translateTo:y}){const[x,I]=s.useState([]),[l,c]=s.useState(null),[g,L]=s.useState(-1),[N,m]=s.useState(!1),[h,C]=s.useState(!1),[Z,Y]=s.useState(),D=s.useRef(null),B=s.useRef(A),v=k(U=>U.lyricsRefreshNonce),H=s.useRef(0);s.useEffect(()=>{if(I([]),c(null),L(-1),m(!0),C(!1),Y(void 0),!a&&!r&&!p){m(!1);return}if(ts()){m(!1),Y("iPod requires an internet connection");return}const U=`${a}__${r}__${p}`,S=H.current!==v;if(!S&&U===D.current){m(!1),H.current=v;return}let b=!1;const u=new AbortController,P=setTimeout(()=>{u.abort(),console.warn("Lyrics fetch timed out")},15e3);return fetch(ss("/api/lyrics"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:a,artist:r,album:p,force:S}),signal:u.signal}).then(async j=>{if(clearTimeout(P),!j.ok){if(j.status===404||u.signal.aborted)return null;throw new Error(`Failed to fetch lyrics (status ${j.status})`)}return j.json()}).then(j=>{if(b)return;if(!j)throw new Error("No lyrics found or fetch timed out");const X=j==null?void 0:j.lyrics;if(!X)throw new Error("No lyrics found");const T=X.replace(/\u200b/g,""),w=cs(T,(j==null?void 0:j.title)??a,(j==null?void 0:j.artist)??r);I(w),D.current=U,k.setState({currentLyrics:{lines:w}})}).catch(j=>{b||(console.error("useLyrics original fetch error",j),j instanceof DOMException&&j.name==="AbortError"?Y("Lyrics search timed out."):Y(j instanceof Error?j.message:"Unknown error fetching lyrics"),I([]),L(-1),k.setState({currentLyrics:null}))}).finally(()=>{b||m(!1),H.current=v,clearTimeout(P)}),()=>{b=!0,u.abort(),clearTimeout(P)}},[a,r,p,v]),s.useEffect(()=>{if(!y||x.length===0){c(null),C(!1),y&&x.length>0;return}if(N){C(!1);return}if(ts()){C(!1),Y("iPod requires an internet connection");return}let U=!1;C(!0),Y(void 0);const S=new AbortController,b=setTimeout(()=>{S.abort(),console.warn("Lyrics translation timed out")},12e4);return fetch(ss("/api/translate-lyrics"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lines:x,targetLanguage:y}),signal:S.signal}).then(async u=>{clearTimeout(b);const P=await u.text();if(!u.ok){const j=P.startsWith("Error: ")?P.substring(7):P;throw new Error(j||`Translation request failed with status ${u.status}`)}return P}).then(u=>{if(!U)if(u){const P=cs(u,a,r);c(P)}else c([])}).catch(u=>{U||(console.error("useLyrics translation error",u),u instanceof DOMException&&u.name==="AbortError"?Y("Lyrics translation timed out."):Y(u instanceof Error?u.message:"Unknown error during translation"),c(null))}).finally(()=>{U||C(!1),clearTimeout(b)}),()=>{U=!0,S.abort(),clearTimeout(b)}},[x,y,N,a,r]);const J=l||x,Q=s.useCallback(U=>{if(!J.length)return-1;const S=U*1e3;let b=J.findIndex((u,P)=>{const j=P+1<J.length?parseInt(J[P+1].startTimeMs):1/0;return S>=parseInt(u.startTimeMs)&&S<j});return b===-1&&J.length>0&&S>=parseInt(J[J.length-1].startTimeMs)&&(b=J.length-1),b},[J]);s.useEffect(()=>{B.current=A,L(Q(A))},[A,Q]);const ee=s.useCallback(U=>{B.current=U,L(Q(U))},[Q]);return{lines:J,currentLine:g,isLoading:N,isTranslating:h,error:Z,updateCurrentTimeManually:ee}}const bn=5*60*1e3;function yn(a){const{t:r}=$e(),p=k(l=>l.syncLibrary),A=s.useRef(null),y=s.useRef(0);return s.useEffect(()=>{if(!a){A.current&&(clearInterval(A.current),A.current=null);return}const l=async()=>{try{const g=k.getState().tracks,L=g.length===0,m=await(await fetch("/data/ipod-videos.json")).json(),h=(m.videos||m).map(v=>({id:v.id,url:v.url,title:v.title,artist:v.artist,album:v.album??"",lyricOffset:v.lyricOffset})),C=m.version||1,Z=new Set(g.map(v=>v.id)),Y=h.filter(v=>!Z.has(v.id)).length;let D=0;const B=new Map(h.map(v=>[v.id,v]));if(g.forEach(v=>{const H=B.get(v.id);H&&(v.title!==H.title||v.artist!==H.artist||v.album!==H.album||v.url!==H.url||v.lyricOffset!==H.lyricOffset)&&D++}),console.log("[iPod] Auto update check:",{newTracksCount:Y,tracksUpdated:D,currentTracksCount:g.length,serverTracksCount:h.length,serverVersion:C,currentLastKnownVersion:k.getState().lastKnownVersion}),Y>0||D>0)try{const v=await p(),H=L&&v.newTracksAdded>0?r("apps.ipod.dialogs.addedSongsToTop",{count:v.newTracksAdded,plural:v.newTracksAdded===1?"":"s"}):v.newTracksAdded>0?r("apps.ipod.dialogs.autoUpdatedLibraryAddedSongs",{newCount:v.newTracksAdded,newPlural:v.newTracksAdded===1?"":"s",updatedText:v.tracksUpdated>0?r("apps.ipod.dialogs.andUpdated",{count:v.tracksUpdated,plural:v.tracksUpdated===1?"":"s"}):""}):r("apps.ipod.dialogs.autoUpdatedTrackMetadata",{count:v.tracksUpdated});fe.success(r("apps.ipod.dialogs.libraryAutoUpdated"),{description:H,duration:4e3}),console.log(`[iPod] Auto-updated: ${v.newTracksAdded} new tracks, ${v.tracksUpdated} updated tracks`)}catch(v){console.error("Error auto-updating library:",v),fe.error(r("apps.ipod.dialogs.autoUpdateFailed"),{description:r("apps.ipod.dialogs.failedToAutoUpdateLibrary"),duration:4e3})}}catch(g){console.error("Error checking for library updates:",g)}},c=setTimeout(()=>{console.log("[iPod] Running immediate library update check on app activation"),l(),y.current=Date.now()},100);return A.current=setInterval(()=>{l(),y.current=Date.now()},bn),()=>{clearTimeout(c),A.current&&(clearInterval(A.current),A.current=null)}},[a,p]),{manualCheck:async()=>{try{const l=k.getState().tracks.length===0,c=await p();if(c.newTracksAdded>0||c.tracksUpdated>0){const g=l&&c.newTracksAdded>0?r("apps.ipod.dialogs.addedSongsToTop",{count:c.newTracksAdded,plural:c.newTracksAdded===1?"":"s"}):r("apps.ipod.dialogs.addedNewSongsToTop",{newCount:c.newTracksAdded,newPlural:c.newTracksAdded===1?"":"s",updatedText:c.tracksUpdated>0?r("apps.ipod.dialogs.andUpdated",{count:c.tracksUpdated,plural:c.tracksUpdated===1?"":"s"}):"",total:c.totalTracks});return fe.success(r("apps.ipod.dialogs.libraryUpdated"),{description:g}),!0}else return fe.info(r("apps.ipod.dialogs.noUpdates"),{description:r("apps.ipod.dialogs.libraryAlreadyUpToDate")}),!1}catch(l){return console.error("Error during manual library update check:",l),fe.error(r("apps.ipod.dialogs.updateCheckFailed"),{description:r("apps.ipod.dialogs.failedToCheckForLibraryUpdates")}),!1}},manualSync:async()=>{try{const l=k.getState().tracks.length===0,c=await p();if(c.newTracksAdded>0||c.tracksUpdated>0){const g=l&&c.newTracksAdded>0?r("apps.ipod.dialogs.addedSongsToTop",{count:c.newTracksAdded,plural:c.newTracksAdded===1?"":"s"}):r("apps.ipod.dialogs.addedNewSongsToTop",{newCount:c.newTracksAdded,newPlural:c.newTracksAdded===1?"":"s",updatedText:c.tracksUpdated>0?r("apps.ipod.dialogs.andUpdated",{count:c.tracksUpdated,plural:c.tracksUpdated===1?"":"s"}):"",total:c.totalTracks});fe.success(r("apps.ipod.dialogs.librarySynced"),{description:g})}else fe.info(r("apps.ipod.dialogs.librarySynced"),{description:r("apps.ipod.dialogs.libraryUpToDateWithSongs",{count:c.totalTracks})});return!0}catch(l){return console.error("Error during library sync:",l),fe.error(r("apps.ipod.dialogs.syncFailed"),{description:r("apps.ipod.dialogs.failedToSyncWithServerLibrary")}),!1}}}}function wn(a){const r=a.match(/(?:youtube\.com\/(?:[^/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?/\s]{11})/);return r?r[1]:null}function kn({currentTrack:a,isPlaying:r,onTogglePlay:p,onNextTrack:A,onPreviousTrack:y,onRestore:x}){const{t:I}=$e(),l=jt(),c=vt(C=>C.current),g=nn(),L=s.useMemo(()=>c==="xp"||c==="win98"?"calc(env(safe-area-inset-bottom, 0px) + 42px)":c==="macosx"?"calc(env(safe-area-inset-bottom, 0px) + 72px)":"calc(env(safe-area-inset-bottom, 0px) + 16px)",[c]),N=a!=null&&a.url?(()=>{const C=wn(a.url);return C?`https://img.youtube.com/vi/${C}/mqdefault.jpg`:null})():null,h=g||c==="macosx";return ds.createPortal(e.jsxs(Oe.div,{initial:{opacity:0,y:20,scale:.9,x:h?"-50%":0},animate:{opacity:1,y:0,scale:1,x:h?"-50%":0},exit:{opacity:0,y:20,scale:.9,x:h?"-50%":0},transition:{duration:.2,ease:"easeOut"},className:me("fixed z-[1] flex items-center gap-3 bg-black/40 backdrop-blur-xl rounded-xl shadow-2xl p-2 pr-3 cursor-pointer select-none",h?"left-1/2":"right-3"),style:{...g?{width:"min(92vw, 980px)",maxWidth:"min(92vw, 980px)"}:{maxWidth:"min(400px, calc(100vw - 2rem))"},bottom:L},onClick:x,children:[e.jsxs("div",{className:"relative w-14 h-14 flex-shrink-0 overflow-hidden",style:{borderRadius:"8px"},children:[N?e.jsx("img",{src:N,alt:(a==null?void 0:a.title)||"",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-white/10 text-white/40",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"})})}),r&&e.jsx("div",{className:"absolute inset-0 bg-black/30 flex items-center justify-center",children:e.jsx("div",{className:"flex items-end gap-[2px] h-4",children:[0,1,2].map(C=>e.jsx(Oe.div,{className:"w-1 bg-white rounded-full",animate:{height:["40%","100%","40%"]},transition:{duration:.6,repeat:1/0,delay:C*.15,ease:"easeInOut"}},C))})})]}),e.jsxs("div",{className:"flex-1 min-w-0 mr-1",children:[e.jsx("div",{className:"text-white text-sm font-medium truncate",children:(a==null?void 0:a.title)||I("apps.ipod.status.noTrack")}),(a==null?void 0:a.artist)&&e.jsx("div",{className:"text-white/60 text-xs truncate",children:a.artist})]}),e.jsxs("div",{className:"flex items-center gap-1",onClick:C=>C.stopPropagation(),children:[e.jsx("button",{onClick:y,className:"w-8 h-8 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors","aria-label":I("apps.ipod.ariaLabels.previousTrack"),children:e.jsx("span",{className:"text-sm font-chicago",children:"⏮"})}),e.jsx("button",{onClick:p,disabled:l,className:"w-9 h-9 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors disabled:opacity-50","aria-label":I("apps.ipod.ariaLabels.playPause"),children:e.jsx("span",{className:"text-base font-chicago",children:r?"⏸":"▶"})}),e.jsx("button",{onClick:A,className:"w-8 h-8 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors","aria-label":I("apps.ipod.ariaLabels.nextTrack"),children:e.jsx("span",{className:"text-sm font-chicago",children:"⏭"})})]})]}),document.body)}function vn({children:a,onClose:r,togglePlay:p,nextTrack:A,previousTrack:y,seekTime:x,showStatus:I,showOfflineStatus:l,registerActivity:c,isPlaying:g,statusMessage:L,currentTranslationCode:N,onSelectTranslation:m,currentAlignment:h,onCycleAlignment:C,currentKoreanDisplay:Z,onToggleKoreanDisplay:Y,fullScreenPlayerRef:D}){const{t:B}=$e(),v=s.useRef(null),[H,J]=s.useState(!1),[Q,ee]=s.useState(!0),U=s.useRef(null),S=jt(),[b,u]=s.useState(!1),P=s.useMemo(()=>tn(),[]),j=s.useMemo(()=>[{label:B("apps.ipod.translationLanguages.original"),code:null},{label:"English",code:"en"},{label:"中文",code:"zh-TW"},{label:"日本語",code:"ja"},{label:"한국어",code:"ko"},{label:"Español",code:"es"},{label:"Français",code:"fr"},{label:"Deutsch",code:"de"},{label:"Português",code:"pt"},{label:"Italiano",code:"it"},{label:"Русский",code:"ru"}],[B]),X=s.useCallback(()=>{var n,V;const f=(V=(n=D==null?void 0:D.current)==null?void 0:n.getInternalPlayer)==null?void 0:V.call(n);return f&&typeof f.getPlayerState=="function"?f.getPlayerState()===1:!1},[D]),T=s.useCallback(()=>{ee(!0),U.current&&clearTimeout(U.current),X()&&!H&&(U.current=window.setTimeout(()=>{ee(!1)},2e3))},[X,H]),w=s.useRef({onClose:r,togglePlay:p,nextTrack:A,previousTrack:y,seekTime:x,showStatus:I,registerActivity:c,onSelectTranslation:m,onCycleAlignment:C,onToggleKoreanDisplay:Y,setIsLangMenuOpen:J});s.useEffect(()=>{w.current={onClose:r,togglePlay:p,nextTrack:A,previousTrack:y,seekTime:x,showStatus:I,registerActivity:c,onSelectTranslation:m,onCycleAlignment:C,onToggleKoreanDisplay:Y,setIsLangMenuOpen:J}},[r,p,A,y,x,I,c,m,C,Y]);const F=s.useRef(null),O=80,z=500,se=100,Se=s.useCallback(f=>{if(f.target.closest("[data-toolbar]"))return;b||u(!0);const V=f.touches[0];F.current={x:V.clientX,y:V.clientY,time:Date.now()}},[b]),Ce=s.useCallback(f=>{if(!F.current)return;if(f.target.closest("[data-toolbar]")){F.current=null;return}if(P&&!g&&b){F.current=null;return}const te=f.changedTouches[0],K=te.clientX-F.current.x,ce=te.clientY-F.current.y,ie=Date.now()-F.current.time,_=Math.abs(K)>O&&Math.abs(ce)<se&&ie<z,q=ce>O&&Math.abs(K)<se&&ie<z;if(_){f.preventDefault();const ae=w.current;ae.registerActivity(),K>0?(ae.previousTrack(),setTimeout(()=>{const de=k.getState().currentIndex,oe=k.getState().tracks[de];if(oe){const ye=oe.artist?` - ${oe.artist}`:"";ae.showStatus(`⏮ ${oe.title}${ye}`)}},100)):(ae.nextTrack(),setTimeout(()=>{const de=k.getState().currentIndex,oe=k.getState().tracks[de];if(oe){const ye=oe.artist?` - ${oe.artist}`:"";ae.showStatus(`⏭ ${oe.title}${ye}`)}},100))}else q&&(f.preventDefault(),w.current.onClose());F.current=null},[P,g,b]);s.useEffect(()=>{const f=setTimeout(()=>{v.current&&v.current.requestFullscreen().catch(n=>{console.error("Error attempting to enable fullscreen:",n)})},100);return()=>clearTimeout(f)},[]);const xe=s.useMemo(()=>{var f;if(!N)return null;switch(N){case"zh-TW":return"中";case"en":return"En";case"ja":return"日";case"ko":return"한";case"es":return"Es";case"fr":return"Fr";case"de":return"De";case"pt":return"Pt";case"it":return"It";case"ru":return"Ru";default:return((f=N[0])==null?void 0:f.toUpperCase())??"?"}},[N]);return s.useEffect(()=>{const f=v.current;if(f)return f.addEventListener("touchstart",Se),f.addEventListener("touchend",Ce),()=>{f.removeEventListener("touchstart",Se),f.removeEventListener("touchend",Ce)}},[]),s.useEffect(()=>{const f=()=>{b||u(!0);const te=X();P&&!te&&b||w.current.registerActivity(),ee(!0),U.current&&clearTimeout(U.current),te&&!H&&(U.current=window.setTimeout(()=>{ee(!1)},2e3))},n=X();return(H||!n)&&ee(!0),window.addEventListener("mousemove",f,{passive:!0}),window.addEventListener("keydown",f),window.addEventListener("touchstart",f,{passive:!0}),window.addEventListener("click",f,{passive:!0}),X()?f():ee(!0),()=>{window.removeEventListener("mousemove",f),window.removeEventListener("keydown",f),window.removeEventListener("touchstart",f),window.removeEventListener("click",f),U.current&&(clearTimeout(U.current),U.current=null)}},[H,g,b,P,X]),s.useEffect(()=>{const f=n=>{const V=w.current;V.registerActivity(),n.key==="Escape"?V.onClose():n.key===" "?(n.preventDefault(),S?l():(V.togglePlay(),V.showStatus(g?"⏸":"▶"))):n.key==="ArrowLeft"?V.seekTime(-5):n.key==="ArrowRight"?V.seekTime(5):n.key==="ArrowUp"?(V.previousTrack(),setTimeout(()=>{const te=k.getState().currentIndex,K=k.getState().tracks[te];if(K){const ce=K.artist?` - ${K.artist}`:"";V.showStatus(`⏮ ${K.title}${ce}`)}},800)):n.key==="ArrowDown"&&(V.nextTrack(),setTimeout(()=>{const te=k.getState().currentIndex,K=k.getState().tracks[te];if(K){const ce=K.artist?` - ${K.artist}`:"";V.showStatus(`⏭ ${K.title}${ce}`)}},800))};return window.addEventListener("keydown",f),()=>window.removeEventListener("keydown",f)},[g]),ds.createPortal(e.jsxs("div",{ref:v,className:"ipod-force-font fixed inset-0 z-[9999] bg-black select-none flex flex-col",onClick:f=>{var K,ce;if(f.target.closest("[data-toolbar]"))return;b||u(!0);const V=X();if(!(P&&!V&&b)&&!V){const ie=w.current;ie.registerActivity(),S?l():(ie.togglePlay(),ie.showStatus("▶"))}if(P&&g&&b){const ie=(ce=(K=D==null?void 0:D.current)==null?void 0:K.getInternalPlayer)==null?void 0:ce.call(K);if(ie&&typeof ie.getPlayerState=="function"&&ie.getPlayerState()!==1){const q=w.current;q.registerActivity(),typeof ie.playVideo=="function"&&(ie.playVideo(),q.showStatus("▶"))}}},children:[e.jsx(Ze,{children:L&&e.jsx(Oe.div,{className:"absolute inset-0 z-40",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},children:e.jsx("div",{className:"absolute pointer-events-none",style:{top:"calc(max(env(safe-area-inset-top), 0.75rem) + clamp(1rem, 6dvh, 3rem))",left:"calc(max(env(safe-area-inset-left), 0.75rem) + clamp(1rem, 6dvw, 4rem))"},children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"font-chicago text-white text-[min(5vw,5vh)] relative z-10",children:L}),e.jsx("div",{className:"font-chicago text-black text-[min(5vw,5vh)] absolute inset-0",style:{WebkitTextStroke:"5px black",textShadow:"none"},children:L})]})})})}),e.jsx("div",{className:"flex-1 min-h-0",children:typeof a=="function"?a({controlsVisible:Q||H||!X(),isLangMenuOpen:H}):a}),e.jsx("div",{"data-toolbar":!0,className:me("w-full flex justify-center z-[10001] transition-opacity duration-200",Q||H||!X()?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none"),style:{paddingBottom:"calc(max(env(safe-area-inset-bottom), 0.75rem) + clamp(1rem, 6dvh, 4rem))"},onClick:f=>{f.stopPropagation(),T()},children:e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"bg-neutral-800/35 border border-white/10 backdrop-blur-sm rounded-full shadow-lg flex items-center gap-1 md:gap-2 px-2 py-1 font-geneva-12",children:[e.jsx("button",{onClick:f=>{f.stopPropagation(),c(),y(),setTimeout(()=>{const n=k.getState().currentIndex,V=k.getState().tracks[n];if(V){const te=V.artist?` - ${V.artist}`:"";I(`⏮ ${V.title}${te}`)}},100)},"aria-label":B("apps.ipod.ariaLabels.previousTrack"),className:"w-9 h-9 md:w-12 md:h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors focus:outline-none",title:B("apps.ipod.menu.previous"),children:e.jsx("span",{className:"text-[18px] md:text-[22px]",children:"⏮"})}),e.jsx("button",{onClick:f=>{f.stopPropagation(),c();const n=X();if(S)l();else{p();const V=X();I(V?"⏸":"▶"),n||setTimeout(()=>T(),100)}},"aria-label":B("apps.ipod.ariaLabels.playPause"),className:"w-9 h-9 md:w-12 md:h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors focus:outline-none",title:B("apps.ipod.ariaLabels.playPause"),children:e.jsx("span",{className:"text-[18px] md:text-[22px]",children:X()?"⏸":"▶"})}),e.jsx("button",{onClick:f=>{f.stopPropagation(),c(),A(),setTimeout(()=>{const n=k.getState().currentIndex,V=k.getState().tracks[n];if(V){const te=V.artist?` - ${V.artist}`:"";I(`⏭ ${V.title}${te}`)}},100)},"aria-label":B("apps.ipod.ariaLabels.nextTrack"),className:"w-9 h-9 md:w-12 md:h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors focus:outline-none",title:B("apps.ipod.menu.next"),children:e.jsx("span",{className:"text-[18px] md:text-[22px]",children:"⏭"})}),e.jsx("button",{onClick:f=>{f.stopPropagation(),c(),C()},"aria-label":B("apps.ipod.ariaLabels.cycleLyricLayout"),className:"w-9 h-9 md:w-12 md:h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors focus:outline-none",title:h,children:h==="focusThree"?e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"md:w-[26px] md:h-[26px]",children:[e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"6"}),e.jsx("line",{x1:"4",y1:"12",x2:"20",y2:"12"}),e.jsx("line",{x1:"6",y1:"18",x2:"18",y2:"18"})]}):h==="center"?e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"md:w-[26px] md:h-[26px]",children:e.jsx("line",{x1:"6",y1:"12",x2:"18",y2:"12"})}):e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"md:w-[26px] md:h-[26px]",children:[e.jsx("line",{x1:"4",y1:"8",x2:"13",y2:"8"}),e.jsx("line",{x1:"11",y1:"16",x2:"20",y2:"16"})]})}),e.jsx("button",{onClick:f=>{f.stopPropagation(),c(),Y()},"aria-label":B("apps.ipod.ariaLabels.toggleHangulRomanization"),className:"w-9 h-9 md:w-12 md:h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors focus:outline-none",children:e.jsx("span",{className:"text-[16px] md:text-[18px]",children:Z==="romanized"?"Ko":"한"})}),e.jsx("button",{onClick:f=>{f.stopPropagation(),J(n=>!n),c()},"aria-label":B("apps.ipod.ariaLabels.translateLyrics"),className:"w-9 h-9 md:w-12 md:h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors focus:outline-none",children:xe?e.jsx("span",{className:"inline-flex items-center justify-center w-[24px] h-[24px] md:w-[28px] md:h-[28px] leading-none text-[16px] md:text-[18px]",children:xe}):e.jsx("span",{className:"inline-flex items-center justify-center w-[24px] h-[24px] md:w-[28px] md:h-[28px] leading-none text-[16px] md:text-[18px]",children:"Aa"})}),e.jsx("button",{onClick:r,className:"w-9 h-9 md:w-12 md:h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-colors focus:outline-none","aria-label":B("apps.ipod.ariaLabels.closeFullscreen"),title:B("common.dialog.close"),children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"22",height:"22",className:"md:w-[26px] md:h-[26px]",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsx(Ze,{children:H&&e.jsx(Oe.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.15},className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 max-h-[50vh] overflow-y-auto rounded-lg border border-white/10 bg-neutral-900/80 backdrop-blur-md shadow-xl",onClick:f=>f.stopPropagation(),children:e.jsx("div",{className:"py-2",children:j.map(f=>{const n=N===f.code||!f.code&&!N;return e.jsxs("button",{onClick:()=>{w.current.onSelectTranslation(f.code),w.current.setIsLangMenuOpen(!1),w.current.registerActivity()},className:me("w-full text-left px-4 py-2 text-[16px] font-geneva-12 transition-colors",n?"text-white bg-white/10":"text-white/80 hover:text-white hover:bg-white/10"),children:[e.jsx("span",{className:"inline-block w-4",children:n?"✓":""}),e.jsx("span",{children:f.label})]},f.code||"off")})})})})]})})]}),document.body)}function Dn({isWindowOpen:a,onClose:r,isForeground:p,skipInitialSound:A,initialData:y,instanceId:x,onNavigateNext:I,onNavigatePrevious:l}){var Ht,Xt,Kt,qt,Gt,Jt,Zt,Qt;const{play:c}=ns(as.BUTTON_CLICK),{play:g}=ns(as.IPOD_CLICK_WHEEL),L=zs(100,50),N=jt(),{tracks:m,currentIndex:h,loopCurrent:C,loopAll:Z,isShuffled:Y,isPlaying:D,showVideo:B,backlightOn:v}=k(Ws(t=>({tracks:t.tracks,currentIndex:t.currentIndex,loopCurrent:t.loopCurrent,loopAll:t.loopAll,isShuffled:t.isShuffled,isPlaying:t.isPlaying,showVideo:t.showVideo,backlightOn:t.backlightOn}))),{theme:H,lcdFilterOn:J,showLyrics:Q,lyricsAlignment:ee,chineseVariant:U,koreanDisplay:S,lyricsTranslationLanguage:b,isFullScreen:u,toggleFullScreen:P,setCurrentIndex:j,toggleLoopAll:X,toggleLoopCurrent:T,toggleShuffle:w,togglePlay:F,setIsPlaying:O,toggleVideo:z,toggleBacklight:se,setTheme:Se,clearLibrary:Ce,nextTrack:xe,previousTrack:f}=ps(t=>({theme:t.theme,lcdFilterOn:t.lcdFilterOn,showLyrics:t.showLyrics,lyricsAlignment:t.lyricsAlignment,chineseVariant:t.chineseVariant,koreanDisplay:t.koreanDisplay,lyricsTranslationLanguage:t.lyricsTranslationLanguage,isFullScreen:t.isFullScreen,toggleFullScreen:t.toggleFullScreen,setCurrentIndex:t.setCurrentIndex,toggleLoopAll:t.toggleLoopAll,toggleLoopCurrent:t.toggleLoopCurrent,toggleShuffle:t.toggleShuffle,togglePlay:t.togglePlay,setIsPlaying:t.setIsPlaying,toggleVideo:t.toggleVideo,toggleBacklight:t.toggleBacklight,setTheme:t.setTheme,clearLibrary:t.clearLibrary,nextTrack:t.nextTrack,previousTrack:t.previousTrack})),{t:n}=$e(),V=Ys("ipod",sn),te=k(t=>{var o;return((o=t.tracks[t.currentIndex])==null?void 0:o.lyricOffset)??0}),K=s.useRef(p),{bringToForeground:ce,clearIpodInitialData:ie,instances:_,restoreInstance:q}=rs(t=>({bringToForeground:t.bringToForeground,clearIpodInitialData:t.clearInstanceInitialData,instances:t.instances,restoreInstance:t.restoreInstance})),ae=x?((Ht=_[x])==null?void 0:Ht.isMinimized)??!1:!1,de=s.useRef(null),[oe,ye]=s.useState(Date.now()),Le=s.useRef(null),[Ee,it]=s.useState(null),Be=s.useRef(null),[ge,i]=s.useState(0),[re,we]=s.useState(0),[ke,Qe]=s.useState(""),[bt,Ue]=s.useState(!1),[et,St]=s.useState(!1),[xs,Tt]=s.useState(!1),[gs,yt]=s.useState(!1),[bs,It]=s.useState(!1),[ys,Ct]=s.useState(!1),ws=s.useMemo(()=>{const t=k.getState();return!(t.tracks.length>0&&t.currentIndex>=0&&t.currentIndex<t.tracks.length)},[]),[_e,Ne]=s.useState(ws),[ot,Ae]=s.useState(0),[ks,je]=s.useState("forward"),[pe,Te]=s.useState([]),[Lt,De]=s.useState(!1),We=s.useRef(null),Me=s.useRef(null),Nt=s.useRef(null),Ye=s.useRef(!1),lt=s.useRef(!1),{manualSync:vs}=yn(a&&(p??!1)),ct=navigator.userAgent,js=/iP(hone|od|ad)/.test(ct),Ss=/Safari/.test(ct)&&!/Chrome/.test(ct)&&!/CriOS/.test(ct),tt=js&&Ss,R=s.useCallback(t=>{it(t),Be.current&&clearTimeout(Be.current),Be.current=setTimeout(()=>{it(null)},2e3)},[]),Re=s.useCallback(()=>{fe.error(n("apps.ipod.dialogs.youreOffline"),{id:"ipod-offline",description:n("apps.ipod.dialogs.ipodRequiresInternet")}),R("🚫")},[R,n]),W=s.useCallback(()=>{ye(Date.now()),lt.current=!0,k.getState().backlightOn||se()},[se]),dt=s.useCallback(()=>{w(),R(k.getState().isShuffled?n("apps.ipod.status.shuffleOn"):n("apps.ipod.status.shuffleOff")),W()},[w,R,W,n]),He=s.useCallback(()=>{se();const t=k.getState().backlightOn;R(n(t?"apps.ipod.status.lightOn":"apps.ipod.status.lightOff")),t?W():(ye(Date.now()),lt.current=!0)},[se,R,W,ye,n]),At=s.useCallback(t=>{Se(t),R(n(t==="classic"?"apps.ipod.status.themeClassic":t==="black"?"apps.ipod.status.themeBlack":"apps.ipod.status.themeU2")),W()},[Se,R,W,n]),Ts=s.useCallback(t=>{t===He||W(),t()},[W,He]),Mt=s.useCallback(()=>{W();const t=k.getState().loopAll;k.getState().loopCurrent?(T(),R(n("apps.ipod.status.repeatOff"))):t?(X(),T(),R(n("apps.ipod.status.repeatOne"))):(X(),R(n("apps.ipod.status.repeatAll")))},[W,X,T,R,n]),Et=s.useCallback(()=>{const t=k.getState().theme;At(t==="classic"?"black":t==="black"?"u2":"classic")},[At]);s.useEffect(()=>(Le.current&&clearTimeout(Le.current),v&&(Le.current=setTimeout(()=>{const t=k.getState().showVideo,o=k.getState().isPlaying;Date.now()-oe>=5e3&&!(t&&o)&&se()},5e3)),()=>{Le.current&&clearTimeout(Le.current)}),[v,oe,se]),s.useEffect(()=>{p&&!K.current?(k.getState().backlightOn||se(),W()):!p&&K.current&&k.getState().backlightOn&&se(),K.current=p},[p,se,W]),s.useEffect(()=>{i(0),k.setState({currentLyrics:null})},[h]),s.useEffect(()=>()=>{Be.current&&clearTimeout(Be.current)},[]);const[ut,Xe]=s.useState([]),Ke=s.useMemo(()=>{const t=m.reduce((d,M,E)=>{const $=M.artist||n("apps.ipod.menu.unknownArtist");return d[$]||(d[$]=[]),d[$].push({track:M,index:E}),d},{}),o=Object.keys(t).sort((d,M)=>d.localeCompare(M,void 0,{sensitivity:"base"}));return[{label:n("apps.ipod.menuItems.allSongs"),action:()=>{W(),je("forward");const d=n("apps.ipod.menuItems.allSongs"),M=n("apps.ipod.menuItems.music"),E=m.map(($,ne)=>({label:$.title,action:()=>{if(W(),N){Re();return}j(ne),O(!0),je("forward"),Ne(!1),De(!1),Xe([M,d]),k.getState().showVideo&&z()},showChevron:!1}));Te($=>[...$,{title:d,items:E,selectedIndex:0}]),Ae(0)},showChevron:!0},...o.map(d=>({label:d,action:()=>{W(),je("forward");const M=t[d].map(({track:E,index:$})=>({label:E.title,action:()=>{W(),j($),O(!0),je("forward"),Ne(!1),De(!1),Xe([n("apps.ipod.menuItems.music"),d]),k.getState().showVideo&&z()},showChevron:!1}));Te(E=>[...E,{title:d,items:M,selectedIndex:0}]),Ae(0)},showChevron:!0}))]},[m,W,j,O,z,R,n]),pt=s.useMemo(()=>{const t=C,o=Z,d=Y,M=v,E=H;return[{label:n("apps.ipod.menuItems.repeat"),action:Mt,showChevron:!1,value:n(t?"apps.ipod.menuItems.one":o?"apps.ipod.menuItems.all":"apps.ipod.menuItems.off")},{label:n("apps.ipod.menuItems.shuffle"),action:dt,showChevron:!1,value:n(d?"apps.ipod.menuItems.on":"apps.ipod.menuItems.off")},{label:n("apps.ipod.menuItems.backlight"),action:He,showChevron:!1,value:n(M?"apps.ipod.menuItems.on":"apps.ipod.menuItems.off")},{label:n("apps.ipod.menuItems.theme"),action:Et,showChevron:!1,value:n(E==="classic"?"apps.ipod.menu.classic":E==="black"?"apps.ipod.menu.black":"apps.ipod.menu.u2")}]},[C,Z,Y,v,H,Mt,dt,He,Et,n]),qe=s.useMemo(()=>{const t=n("apps.ipod.menuItems.music"),o=n("apps.ipod.menuItems.settings");return[{label:t,action:()=>{W(),k.getState().showVideo&&z(),je("forward"),Te(d=>[...d,{title:t,items:Ke,selectedIndex:0}]),Ae(0)},showChevron:!0},{label:n("apps.ipod.menuItems.extras"),action:()=>{W(),k.getState().showVideo&&z(),Ue(!0)},showChevron:!0},{label:o,action:()=>{W(),k.getState().showVideo&&z(),je("forward"),Te(d=>[...d,{title:o,items:pt,selectedIndex:0}]),Ae(0)},showChevron:!0},{label:n("apps.ipod.menuItems.shuffleSongs"),action:()=>{W(),k.getState().showVideo&&z(),dt(),Ne(!1)},showChevron:!1},{label:n("apps.ipod.menuItems.backlight"),action:()=>{He()},showChevron:!1},{label:n("apps.ipod.menuItems.nowPlaying"),action:()=>{W(),je("forward"),Ne(!1),De(!0)},showChevron:!0}]},[W,z,Ke,pt,dt,He,R,n]);s.useEffect(()=>{pe.length===0&&Te([{title:n("apps.ipod.menuItems.ipod"),items:qe,selectedIndex:0}])},[n,qe,pe.length]),s.useEffect(()=>{Te(t=>{if(t.length===0)return t;const o=t.length-1,d=t[o];let M=null;const E=n("apps.ipod.menuItems.ipod"),$=n("apps.ipod.menuItems.music"),ne=n("apps.ipod.menuItems.settings"),ve=n("apps.ipod.menuItems.allSongs");if(d.title===E)M=qe;else if(d.title===$)M=Ke;else if(d.title===ne)M=pt;else if(d.title===ve)M=m.map((le,be)=>({label:le.title,action:()=>{W(),j(be),O(!0),je("forward"),Ne(!1),De(!1),Xe([n("apps.ipod.menuItems.music"),n("apps.ipod.menuItems.allSongs")]),k.getState().showVideo&&z()},showChevron:!1}));else{const le=m.reduce((be,Ve,st)=>{const Ge=Ve.artist||n("apps.ipod.menu.unknownArtist");return be[Ge]||(be[Ge]=[]),be[Ge].push({track:Ve,index:st}),be},{});le[d.title]&&(M=le[d.title].map(({track:Ve,index:st})=>({label:Ve.title,action:()=>{W(),j(st),O(!0),je("forward"),Ne(!1),De(!1),Xe([n("apps.ipod.menuItems.music"),d.title]),k.getState().showVideo&&z()},showChevron:!1})))}if(M&&d.items!==M){const le=[...t];return le[o]={...d,items:M},le}return t})},[qe,Ke,pt,pe.length,m,W,j,O,z,n]);const wt=s.useCallback(async t=>{It(!0);try{if(await k.getState().addTrackFromVideoId(t))R(n("apps.ipod.status.added")),Qe(""),Ue(!1);else throw new Error("Failed to add track")}catch(o){console.error("Failed to add track:",o),R(`❌ Error adding: ${o instanceof Error?o.message:"Unknown error"}`)}finally{It(!1)}},[R]),Pt=s.useCallback(async t=>{const o=`https://www.youtube.com/watch?v=${t}`;try{await wt(o)}catch(d){console.error(`[iPod] Error adding track for videoId ${t}:`,d),R(`❌ Error adding ${t}`)}},[wt,R]),ht=s.useCallback(async t=>{const d=k.getState().tracks.findIndex(ve=>ve.id===t),M=navigator.userAgent,E=/iP(hone|od|ad)/.test(M),$=/Safari/.test(M)&&!/Chrome/.test(M)&&!/CriOS/.test(M),ne=!(E||$);if(d!==-1)fe.info(n("apps.ipod.dialogs.openedSharedTrack")),console.log(`[iPod] Video ID ${t} found in tracks. Playing.`),j(d),ne&&O(!0),Ne(!1);else if(fe.info(n("apps.ipod.dialogs.addingNewTrack")),console.log(`[iPod] Video ID ${t} not found. Adding and playing.`),await Pt(t),ne&&!N){const ve=k.getState().currentIndex,le=k.getState().tracks[ve];(le==null?void 0:le.id)===t?O(!0):console.warn("[iPod] Index mismatch after adding track, autoplay skipped.")}else N&&Re()},[j,O,Ne,Pt]);s.useEffect(()=>{if(a&&(y!=null&&y.videoId)&&typeof y.videoId=="string"){if(de.current===y)return;const t=y.videoId;console.log(`[iPod] Processing initialData.videoId on mount: ${t}`),setTimeout(()=>{ht(t).then(()=>{x&&ie(x),console.log(`[iPod] Cleared initialData after processing ${t}`)}).catch(o=>{console.error(`[iPod] Error processing initial videoId ${t}:`,o)})},100),de.current=y}},[a,y,ht,ie,x]),s.useEffect(()=>{const t=o=>{var d;if(o.detail.appId==="ipod"&&((d=o.detail.initialData)!=null&&d.videoId)){if(de.current===o.detail.initialData)return;const M=o.detail.initialData.videoId;console.log(`[iPod] Received updateApp event with videoId: ${M}`),ce("ipod"),ht(M).catch(E=>{console.error(`[iPod] Error processing videoId ${M} from updateApp event:`,E),fe.error("Failed to load shared track",{description:`Video ID: ${M}`})}),de.current=o.detail.initialData}};return window.addEventListener("updateApp",t),()=>{window.removeEventListener("updateApp",t)}},[ht,ce]);const Ot=s.useCallback(()=>{if(C){const t=u?Me.current:We.current;t==null||t.seekTo(0),O(!0)}else xe()},[C,xe,O,u]),Rt=s.useCallback(t=>{i(Math.floor(t.playedSeconds))},[]),$t=s.useCallback(t=>{we(t)},[]),Dt=s.useCallback(()=>{O(!0),Ye.current||R("▶"),Ye.current=!1;const t=m[h];if(t){const o=Nt.current,d=!o||o.trackId!==t.id,M=ge<1;(d||M)&&(Hs(Xs.SONG_PLAY,{trackId:t.id,title:t.title,artist:t.artist||""}),Nt.current={trackId:t.id,elapsedTime:ge})}},[O,R,m,h,ge]),Ft=s.useCallback(()=>{O(!1),R("⏸︎")},[O,R]),Vt=s.useCallback(()=>{},[]);s.useEffect(()=>{if(!D||!tt||lt.current)return;const t=ge,o=setTimeout(()=>{k.getState().isPlaying&&ge===t&&(O(!1),R("⏸"))},1200);return()=>clearTimeout(o)},[D,ge,O,R,tt]);const kt=s.useCallback(()=>{if(c(),L(),W(),B&&z(),_e)if(pe.length>1){je("backward"),Te(o=>o.slice(0,-1));const t=pe[pe.length-2];t&&Ae(t.selectedIndex)}else c();else{je("backward");const t=k.getState().currentIndex,o=pe.length>0?pe[0]:{title:n("apps.ipod.menuItems.ipod"),items:qe,selectedIndex:0},d=Ke;if(Lt)Te([o]),Ae((o==null?void 0:o.selectedIndex)||0),De(!1);else{const M=m.reduce(($,ne,ve)=>{const le=ne.artist||n("apps.ipod.menu.unknownArtist");return $[le]||($[le]=[]),$[le].push({track:ne,index:ve}),$},{}),E={title:n("apps.ipod.menuItems.allSongs"),items:m.map(($,ne)=>({label:$.title,action:()=>{W(),j(ne),O(!0),je("forward"),Ne(!1),De(!1),Xe([n("apps.ipod.menuItems.music"),n("apps.ipod.menuItems.allSongs")]),k.getState().showVideo&&z()},showChevron:!1})),selectedIndex:t};if(ut.length>0&&ut[1]!==n("apps.ipod.menuItems.allSongs")){const $=ut[1];if(M[$]){const ne=M[$],ve=ne.findIndex(be=>be.index===t),le={title:$,items:ne.map(({track:be,index:Ve})=>({label:be.title,action:()=>{W(),j(Ve),O(!0),je("forward"),Ne(!1),De(!1),Xe([n("apps.ipod.menuItems.music"),$]),k.getState().showVideo&&z()},showChevron:!1})),selectedIndex:ve!==-1?ve:0};Te([o,{title:n("apps.ipod.menuItems.music"),items:d,selectedIndex:d.findIndex(be=>be.label===$)},le]),Ae(ve!==-1?ve:0)}else Te([o,{title:n("apps.ipod.menuItems.music"),items:d,selectedIndex:0},E]),Ae(t)}else Te([o,{title:n("apps.ipod.menuItems.music"),items:d,selectedIndex:0},E]),Ae(t)}Ne(!0)}},[c,L,W,B,z,_e,pe,qe,Ke,m,Lt,ut,n]),Is=s.useCallback(t=>{switch(c(),L(),W(),t){case"top":kt();break;case"right":N?Re():(Ye.current=!0,xe(),R("⏭"));break;case"bottom":N?Re():(F(),R(k.getState().isPlaying?"▶":"⏸"));break;case"left":N?Re():(Ye.current=!0,f(),R("⏮"));break;case"center":if(_e){const o=pe[pe.length-1];o&&o.items[ot]&&o.items[ot].action()}else m[h]&&(D?N?Re():z():N?Re():(F(),R("▶"),setTimeout(()=>{k.getState().showVideo||z()},200)));break}},[c,L,W,xe,R,F,f,_e,pe,ot,m,h,D,z,kt,N,Re]),Cs=s.useCallback(t=>{if(g(),W(),_e){const o=pe[pe.length-1];if(!o)return;const d=o.items.length;if(d===0)return;let M=null;Ae(E=>{let $=E;return t==="clockwise"?$=Math.min(d-1,E+1):$=Math.max(0,E-1),M=$,$}),M!==null&&Te(E=>{const $=E.length-1,ne=[...E];return ne[$]={...E[$],selectedIndex:M},ne})}else{const o=u?Me.current:We.current,d=(o==null?void 0:o.getCurrentTime())||0,M=5;let E=d;t==="clockwise"?(E=d+M,o==null||o.seekTo(E),R(`⏩︎ ${Math.floor(E/60)}:${String(Math.floor(E%60)).padStart(2,"0")}`)):(E=Math.max(0,d-M),o==null||o.seekTo(E),R(`⏪︎ ${Math.floor(E/60)}:${String(Math.floor(E%60)).padStart(2,"0")}`))}},[g,W,_e,pe,R,u]),ze=s.useRef(null),[Ls,Ns]=s.useState(1),Bt=s.useRef(ae);s.useEffect(()=>{let t;const o=()=>{ze.current&&requestAnimationFrame(()=>{if(!ze.current)return;const M=ze.current.clientWidth,E=ze.current.clientHeight,$=250,ne=400,ve=M-50,le=E-50,be=ve/$,Ve=le/ne,st=Math.min(be,Ve,2),Ge=Math.max(1,st);Ns(es=>Math.abs(es-Ge)>.01?Ge:es)})};t=window.setTimeout(o,10),Bt.current&&!ae&&[50,100,200,300,500].forEach(E=>{window.setTimeout(o,E)}),Bt.current=ae;const d=new ResizeObserver(()=>{clearTimeout(t),t=window.setTimeout(o,10)});return ze.current&&d.observe(ze.current),()=>{clearTimeout(t),d.disconnect()}},[a,ae]);const As=s.useCallback(()=>{m.length>0&&h>=0&&Ct(!0)},[m,h]),Ms=t=>`${window.location.origin}/ipod/${t}`,{ipodVolume:Ut}=rs(t=>({ipodVolume:t.ipodVolume})),Fe=gn({title:((Xt=m[h])==null?void 0:Xt.title)??"",artist:((Kt=m[h])==null?void 0:Kt.artist)??"",album:((qt=m[h])==null?void 0:qt.album)??"",currentTime:ge+(((Gt=m[h])==null?void 0:Gt.lyricOffset)??0)/1e3,translateTo:b}),_t=s.useRef(u);s.useEffect(()=>{var t,o;if(u!==_t.current){if(u){const d=((t=We.current)==null?void 0:t.getCurrentTime())||ge,M=D;setTimeout(()=>{Me.current&&(Me.current.seekTo(d),M&&tt&&lt.current&&setTimeout(()=>{var $,ne;const E=(ne=($=Me.current)==null?void 0:$.getInternalPlayer)==null?void 0:ne.call($);E&&typeof E.playVideo=="function"&&E.playVideo()},200))},100)}else{const d=((o=Me.current)==null?void 0:o.getCurrentTime())||ge,M=D;setTimeout(()=>{We.current&&(We.current.seekTo(d),setTimeout(()=>{M&&!k.getState().isPlaying&&O(!0)},50))},200)}_t.current=u}},[u,ge,D,O,tt]);const Es=s.useCallback(t=>{if(Me.current){const o=Me.current.getCurrentTime()||0,d=Math.max(0,o+t);Me.current.seekTo(d),R(`${t>0?"⏩︎":"⏪︎"} ${Math.floor(d/60)}:${String(Math.floor(d%60)).padStart(2,"0")}`)}},[R]),Ps=b,Os=s.useCallback(t=>{const o=k.getState().setLyricsTranslationLanguage;o(t)},[]),Rs=s.useCallback(()=>{const t=k.getState(),o=t.lyricsAlignment;let d;o===G.FocusThree?d=G.Center:o===G.Center?d=G.Alternating:d=G.FocusThree,t.setLyricsAlignment(d),R(d===G.FocusThree?n("apps.ipod.status.layoutFocus"):d===G.Center?n("apps.ipod.status.layoutCenter"):n("apps.ipod.status.layoutAlternating"))},[R,n]),$s=s.useCallback(()=>{const t=k.getState(),d=t.koreanDisplay===Pe.Original?Pe.Romanized:Pe.Original;t.setKoreanDisplay(d),R(d===Pe.Romanized?n("apps.ipod.status.romanizationOn"):n("apps.ipod.status.hangulOn"))},[R,n]);s.useEffect(()=>{const t=()=>{!document.fullscreenElement&&u&&P()};return document.addEventListener("fullscreenchange",t),()=>{document.removeEventListener("fullscreenchange",t)}},[u,P]);const zt=vt(t=>t.current),Wt=zt==="xp"||zt==="win98",Yt=e.jsx(rn,{onClose:r,onShowHelp:()=>St(!0),onShowAbout:()=>Tt(!0),onClearLibrary:()=>{yt(!0)},onSyncLibrary:vs,onAddTrack:()=>Ue(!0),onShareSong:As});return a?e.jsxs(e.Fragment,{children:[!Wt&&p&&Yt,e.jsxs(Ks,{title:qs("ipod"),onClose:r,isForeground:p,appId:"ipod",transparentBackground:!0,skipInitialSound:A,instanceId:x,onNavigateNext:I,onNavigatePrevious:l,menuBar:Wt?Yt:void 0,keepMountedWhenMinimized:!0,children:[e.jsx("div",{ref:ze,className:"ipod-force-font flex flex-col items-center justify-center w-full h-full bg-gradient-to-b from-gray-100/20 to-gray-300/20 backdrop-blur-lg p-4 select-none",style:{position:"relative",overflow:"hidden",contain:"layout style paint"},children:e.jsxs("div",{className:me("ipod-force-font w-[250px] h-[400px] rounded-2xl shadow-xl border border-black/40 flex flex-col items-center p-4 pb-8",H==="classic"?"bg-white/85":"bg-black/85"),style:{transform:`scale(${Ls})`,transformOrigin:"center",transition:"transform 0.2s ease",minWidth:"250px",minHeight:"400px",maxWidth:"250px",maxHeight:"400px",contain:"layout style paint",willChange:"transform",backfaceVisibility:"hidden"},children:[e.jsx(fn,{currentTrack:m[h]||null,isPlaying:D&&!u,elapsedTime:ge,totalTime:re,menuMode:_e,menuHistory:pe,selectedMenuItem:ot,onSelectMenuItem:Ae,currentIndex:h,tracksLength:m.length,backlightOn:v,menuDirection:ks,onMenuItemAction:Ts,showVideo:B,playerRef:We,handleTrackEnd:Ot,handleProgress:Rt,handleDuration:$t,handlePlay:Dt,handlePause:Ft,handleReady:Vt,loopCurrent:C,statusMessage:Ee,onToggleVideo:z,lcdFilterOn:J,ipodVolume:Ut,showStatusCallback:R,showLyrics:Q,lyricsAlignment:ee,chineseVariant:U,koreanDisplay:S,lyricOffset:te??0,adjustLyricOffset:t=>k.getState().adjustLyricOffset(h,t),registerActivity:W,isFullScreen:u,lyricsControls:Fe}),e.jsx(mn,{theme:H,onWheelClick:Is,onWheelRotation:Cs,onMenuButton:kt})]})}),u&&e.jsx(vn,{onClose:()=>{P()},togglePlay:F,nextTrack:()=>{Ye.current=!0,xe(),setTimeout(()=>{const t=m[k.getState().currentIndex];if(t){const o=t.artist?` - ${t.artist}`:"";R(`⏭ ${t.title}${o}`)}},100)},previousTrack:()=>{Ye.current=!0,f(),setTimeout(()=>{const t=m[k.getState().currentIndex];if(t){const o=t.artist?` - ${t.artist}`:"";R(`⏮ ${t.title}${o}`)}},100)},seekTime:Es,showStatus:R,showOfflineStatus:Re,registerActivity:W,isPlaying:D,statusMessage:Ee,currentTranslationCode:Ps,onSelectTranslation:Os,currentAlignment:ee,onCycleAlignment:Rs,currentKoreanDisplay:S,onToggleKoreanDisplay:$s,fullScreenPlayerRef:Me,children:({controlsVisible:t})=>e.jsx("div",{className:"flex flex-col w-full h-full",children:e.jsx("div",{className:"relative w-full h-full overflow-visible",children:e.jsx("div",{className:"w-full relative",style:{height:"calc(100% + clamp(200px, 30dvh, 360px))",transform:"translateY(-100px)"},children:m[h]&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full h-full pointer-events-none",children:e.jsx(us,{ref:Me,url:m[h].url,playing:D&&u,controls:!0,width:"100%",height:"100%",volume:Ut*fs.getState().masterVolume,loop:C,onEnded:Ot,onProgress:Rt,onDuration:$t,onPlay:Dt,onPause:Ft,onReady:Vt,config:{youtube:{playerVars:{modestbranding:1,rel:0,showinfo:0,iv_load_policy:3,cc_load_policy:0,fs:1,playsinline:1,enablejsapi:1,origin:window.location.origin},embedOptions:{referrerPolicy:"strict-origin-when-cross-origin"}}}})}),Q&&m[h]&&e.jsx("div",{className:"absolute inset-0 bg-black/50 z-10 pointer-events-none"}),Q&&e.jsx("div",{className:"absolute bottom-0 inset-0 pointer-events-none z-20",style:{transform:t?"translateY(-3rem)":"translateY(clamp(1rem, 4dvh, 5rem))",transition:"transform 200ms ease"},children:e.jsx(ms,{lines:Fe.lines,currentLine:Fe.currentLine,isLoading:Fe.isLoading,error:Fe.error,visible:!0,videoVisible:!0,alignment:ee,chineseVariant:U,koreanDisplay:S,fontClassName:"font-lyrics-rounded",onAdjustOffset:o=>{var $;k.getState().adjustLyricOffset(h,o);const d=((($=m[h])==null?void 0:$.lyricOffset)??0)+o,M=d>0?"+":(d<0,"");R(`${n("apps.ipod.status.offset")} ${M}${(d/1e3).toFixed(2)}s`);const E=ge+d/1e3;Fe.updateCurrentTimeManually(E)},isTranslating:Fe.isTranslating,textSizeClass:"text-[min(10vw,10vh)]",gapClass:"gap-0",containerStyle:{gap:"clamp(0.25rem, calc(min(10vw,10vh) * 0.12), 2.5rem)",paddingLeft:"env(safe-area-inset-left, 0px)",paddingRight:"env(safe-area-inset-right, 0px)"},interactive:tt?!1:D,bottomPaddingClass:"pb-[calc(max(env(safe-area-inset-bottom),1.5rem)+clamp(5rem,16dvh,12rem))]"})}),Fe.isTranslating&&!Q&&e.jsx("div",{className:"absolute inset-0 pointer-events-none z-20 flex items-end justify-center pb-[calc(max(env(safe-area-inset-bottom),1.5rem)+clamp(5rem,16dvh,12rem))]",style:{transform:t?"translateY(0)":"translateY(clamp(2rem, 8dvh, 10rem))",transition:"transform 200ms ease"},children:e.jsx("div",{className:me("shimmer opacity-60 text-[min(10vw,10vh)]","font-lyrics-rounded"),children:n("apps.ipod.status.translatingLyrics")})})]})})})})}),e.jsx(Gs,{isOpen:et,onOpenChange:St,helpItems:V,appId:"ipod"}),e.jsx(Js,{isOpen:xs,onOpenChange:Tt,metadata:Zs,appId:"ipod"}),e.jsx(Qs,{isOpen:gs,onOpenChange:yt,onConfirm:()=>{Ce(),yt(!1),R(n("apps.ipod.status.libraryCleared"))},title:n("apps.ipod.dialogs.clearLibraryTitle"),description:n("apps.ipod.dialogs.clearLibraryDescription")}),e.jsx(en,{isOpen:bt,onOpenChange:Ue,onSubmit:wt,title:n("apps.ipod.dialogs.addSongTitle"),description:n("apps.ipod.dialogs.addSongDescription"),value:ke,onChange:Qe,isLoading:bs}),e.jsx(hs,{isOpen:ys,onClose:()=>Ct(!1),itemType:"Song",itemIdentifier:((Jt=m[h])==null?void 0:Jt.id)||"",title:(Zt=m[h])==null?void 0:Zt.title,details:(Qt=m[h])==null?void 0:Qt.artist,generateShareUrl:Ms})]}),e.jsx(Ze,{children:ae&&!u&&m.length>0&&h>=0&&e.jsx(kn,{currentTrack:m[h]||null,isPlaying:D,onTogglePlay:F,onNextTrack:xe,onPreviousTrack:f,onRestore:()=>{x&&q(x)}})})]}):null}export{Dn as IpodAppComponent};
