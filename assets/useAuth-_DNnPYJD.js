import{r as e}from"./ui-core-D0pDhx0h.js";import{aC as X,am as S,ai as V,c2 as E}from"./index-BxS3VOwZ.js";function se(){const{username:s,authToken:i,hasPassword:N,setAuthToken:C,setUsername:T,createUser:I,logout:l,checkHasPassword:O,setPassword:v}=X(),[D,u]=e.useState(!1),[P,p]=e.useState(""),[c,h]=e.useState(""),[j,f]=e.useState(!1),[_,r]=e.useState(null),[x,m]=e.useState(!1),[R,k]=e.useState(""),[$,y]=e.useState(""),[U,b]=e.useState(""),[q,A]=e.useState(!1),[H,o]=e.useState(null),[W,w]=e.useState(!1),z=e.useCallback(()=>{p(""),h(""),r(null),u(!0)},[]),B=e.useCallback(async()=>{f(!0),r(null);const t=P.trim();if(!t){r("Username cannot be empty."),f(!1);return}if(s&&s!==t&&(console.log("[useAuth] Clearing old user data for different user:",s,"->",t),await l()),!c.trim()){r("Password is required."),f(!1);return}if(c.length<8){r("Password must be at least 8 characters."),f(!1);return}const d=await I(t,c);d.ok?(u(!1),p(""),h(""),S.success("Logged In",{description:`Welcome, ${t}!`})):r(d.error||"Failed to set username"),f(!1)},[P,c,I]),G=e.useCallback(()=>{k(""),y(""),b(s||""),o(null),m(!0)},[s]),J=e.useCallback(async(t,d=!1)=>{if(!t.trim()){o(d?"Password required":"Token required");return}A(!0),o(null);try{if(d){const a=U.trim()||s||"";s&&s!==a&&(console.log("[useAuth] Clearing old user data for different user login:",s,"->",a),await l());const n=await fetch("/api/chat-rooms?action=authenticateWithPassword",{method:"POST",headers:{"Content-Type":"application/json",...i?{Authorization:`Bearer ${i}`}:{}},body:JSON.stringify({username:a,password:t.trim(),...i?{oldToken:i}:{}})});if(!n.ok){const Q=await n.json();o(Q.error||"Invalid username or password");return}const g=await n.json();g.token&&(C(g.token),g.username&&T(g.username),V(E.USER_LOGIN_PASSWORD,{username:g.username||a}),S.success("Success",{description:"Logged in successfully with password"}),m(!1),y(""),u(!1))}else{(s||i)&&(console.log("[useAuth] Clearing existing user data before token login to prevent mixing"),await l());const a=await fetch("/api/chat-rooms?action=verifyToken",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.trim()}`},body:JSON.stringify({})});if(!a.ok){a.status===401?o("Invalid token - authentication failed"):o(`Token validation failed (${a.status})`);return}const n=await a.json();console.log("[useAuth] Token validation successful:",n),C(t.trim()),n.username&&T(n.username),V(E.USER_LOGIN_TOKEN,{username:n.username||""}),S.success("Success",{description:"Token verified and set successfully"}),m(!1),k(""),u(!1)}}catch(a){console.error("[useAuth] Error verifying:",a),o("Network error while verifying")}finally{A(!1)}},[C,T,s,U]),Y=e.useCallback(async()=>O(),[O]),F=e.useCallback(async t=>v(t),[v]),L=e.useCallback(async()=>{console.log("[useAuth] Logging out user..."),u(!1),m(!1),w(!1),p(""),h(""),k(""),y(""),b(""),r(null),o(null),await l(),S.success("Logged Out",{description:"You have been successfully logged out."})},[l]),K=e.useCallback(async()=>{w(!0)},[]),M=e.useCallback(()=>{w(!1),L()},[L]);return{username:s,authToken:i,hasPassword:N,promptSetUsername:z,isUsernameDialogOpen:D,setIsUsernameDialogOpen:u,newUsername:P,setNewUsername:p,newPassword:c,setNewPassword:h,isSettingUsername:j,usernameError:_,submitUsernameDialog:B,setUsernameError:r,promptVerifyToken:G,isVerifyDialogOpen:x,setVerifyDialogOpen:m,verifyTokenInput:R,setVerifyTokenInput:k,verifyPasswordInput:$,setVerifyPasswordInput:y,verifyUsernameInput:U,setVerifyUsernameInput:b,isVerifyingToken:q,verifyError:H,handleVerifyTokenSubmit:J,checkHasPassword:Y,setPassword:F,logout:K,confirmLogout:M,isLogoutConfirmDialogOpen:W,setIsLogoutConfirmDialogOpen:w}}export{se as u};
